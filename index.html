<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema Acquisizione Incarichi ‚Äî Operativo + Materiali Scaricabili</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#243045;
      --accent:#60a5fa;
      --ok:#34d399;
      --warn:#fbbf24;
      --danger:#f87171;
      --shadow: 0 12px 34px rgba(0,0,0,.40);
      --radius: 16px;
      --radius2: 20px;
      --max: 1200px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(1000px 500px at 80% 0%, rgba(52,211,153,.14), transparent 55%),
        radial-gradient(900px 500px at 50% 110%, rgba(248,113,113,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: rgba(11,15,23,.72);
      border-bottom:1px solid rgba(36,48,69,.6);
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:18px 16px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(96,165,250,.9), rgba(52,211,153,.9));
      box-shadow: var(--shadow);
    }
    h1{font-size:16px; margin:0;}
    .sub{margin:2px 0 0; font-size:12px; color:var(--muted);}
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(17,24,39,.65);
      border-radius:999px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .pill label{font-size:12px; color:var(--muted);}
    input[type="datetime-local"]{
      background: transparent; border: none; color: var(--text);
      font-family: var(--mono); font-size: 12px; outline: none;
      min-width: 210px;
    }
    .btn{
      cursor:pointer;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(17,24,39,.7);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(96,165,250,.9);}
    .btn.primary{background: rgba(96,165,250,.18); border-color: rgba(96,165,250,.55);}
    .btn.ok{background: rgba(52,211,153,.16); border-color: rgba(52,211,153,.55);}
    .btn.warn{background: rgba(251,191,36,.14); border-color: rgba(251,191,36,.55);}
    main{padding: 18px 0 50px;}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }
    .card{
      background: linear-gradient(180deg, rgba(17,24,39,.78), rgba(15,23,42,.70));
      border: 1px solid rgba(36,48,69,.9);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding: 14px 14px 12px;
      border-bottom:1px solid rgba(36,48,69,.75);
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .card .head h2{margin:0; font-size:14px;}
    .tag{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(36,48,69,.9);
      color: var(--muted);
      background: rgba(11,15,23,.25);
    }
    .card .body{padding: 14px;}
    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{
      cursor:pointer; user-select:none;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(11,15,23,.20);
      color: var(--muted);
      font-size:12px;
      transition: all .12s ease;
    }
    .tab.active{
      background: rgba(96,165,250,.18);
      border-color: rgba(96,165,250,.55);
      color: var(--text);
    }
    .timeline{display:flex; flex-direction:column; gap:10px; padding: 10px 0 0;}
    .event{
      display:flex; gap:12px;
      padding: 12px 12px;
      border-radius: var(--radius);
      border:1px solid rgba(36,48,69,.85);
      background: rgba(11,15,23,.20);
      cursor:pointer;
      transition: transform .10s ease, border-color .10s ease, background .10s ease;
    }
    .event:hover{
      transform: translateY(-1px);
      border-color: rgba(96,165,250,.65);
      background: rgba(96,165,250,.06);
    }
    .event .left{
      min-width: 135px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      display:flex; flex-direction:column; gap:6px;
    }
    .event .left .rel{font-weight:800; color: rgba(229,231,235,.95);}
    .event .title{font-weight:800; font-size:13px; margin: 0 0 4px;}
    .event .desc{margin:0; font-size:12px; color: var(--muted); line-height:1.35;}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:11px; color: var(--muted);
      border:1px solid rgba(36,48,69,.9);
      background: rgba(11,15,23,.25);
      padding:4px 8px; border-radius:999px; width: fit-content;
    }
    .badge .dot{width:7px;height:7px;border-radius:99px;background: var(--accent);}
    .badge.ok .dot{background: var(--ok);}
    .badge.warn .dot{background: var(--warn);}
    .badge.danger .dot{background: var(--danger);}

    .rules{display:flex; flex-direction:column; gap:10px;}
    .rule{
      border:1px solid rgba(36,48,69,.85);
      background: rgba(11,15,23,.18);
      border-radius: var(--radius);
      padding: 12px;
    }
    .rule h3{margin:0 0 6px; font-size:13px;}
    .rule p{margin:0; color: var(--muted); font-size:12px; line-height:1.35;}
    .mini{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(229,231,235,.85);
      margin-top: 8px;
      padding:8px;
      border-radius: 12px;
      border:1px solid rgba(36,48,69,.8);
      background: rgba(0,0,0,.22);
      white-space: pre-wrap;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none; align-items:center; justify-content:center;
      padding: 16px; z-index: 999;
    }
    .backdrop.show{display:flex;}
    .modal{
      width: min(1100px, 100%);
      max-height: min(88vh, 900px);
      overflow:auto;
      background: linear-gradient(180deg, rgba(17,24,39,.97), rgba(15,23,42,.97));
      border:1px solid rgba(36,48,69,.95);
      border-radius: 22px;
      box-shadow: var(--shadow);
    }
    .modal header{
      position:sticky; top:0;
      background: rgba(17,24,39,.92);
      border-bottom:1px solid rgba(36,48,69,.8);
      padding: 14px 14px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modal header .m-title{margin:0; font-size:14px; line-height:1.25; font-weight:900;}
    .modal header .m-sub{
      margin:4px 0 0;
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
      white-space: pre-wrap;
    }
    .close{
      cursor:pointer;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(11,15,23,.25);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-size:12px;
      white-space:nowrap;
    }
    .modal .content{padding: 14px;}
    .m-tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 10px;}
    .m-tab{
      cursor:pointer; user-select:none;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(11,15,23,.20);
      color: var(--muted);
      font-size:12px;
    }
    .m-tab.active{
      background: rgba(96,165,250,.18);
      border-color: rgba(96,165,250,.55);
      color: var(--text);
    }
    .section{
      border:1px solid rgba(36,48,69,.85);
      background: rgba(11,15,23,.18);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .section h4{margin:0 0 8px; font-size:13px; font-weight:900;}
    .section ul{margin:0; padding-left: 18px; color: var(--muted); font-size:12px; line-height:1.55;}
    .script{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(36,48,69,.85);
      border-radius: 14px;
      padding: 10px;
      font-family: var(--mono);
      color: rgba(229,231,235,.92);
      font-size: 12px;
      white-space: pre-wrap;
      line-height:1.5;
    }
    .checklist{display:flex; flex-direction:column; gap:8px;}
    .chk{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px;
      border:1px solid rgba(36,48,69,.8);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
    }
    .chk input{margin-top: 2px;}
    .chk .t{font-size:12px; font-weight:800;}
    .chk .d{font-size:12px; color: var(--muted); margin-top:2px; line-height:1.45;}

    /* Downloadables */
    .dl-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 900px){ .dl-grid{grid-template-columns:1fr;} input[type="datetime-local"]{min-width: 180px;} .event .left{min-width:120px;} }
    .dl{
      border:1px solid rgba(36,48,69,.8);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .dl .name{font-weight:900; font-size:12px;}
    .dl .meta{font-family:var(--mono); font-size:11px; color: var(--muted);}
    .dl .desc{font-size:12px; color: var(--muted); line-height:1.45;}
    .dl .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:2px;}
    .btn.small{padding:8px 10px; font-size:12px;}
    .btn.ghost{background: rgba(11,15,23,.20);}
    .footer-note{margin-top: 10px; color: var(--muted); font-size:11px; line-height:1.4;}
    textarea.preview{
      width:100%;
      min-height: 220px;
      border-radius: 14px;
      border:1px solid rgba(36,48,69,.85);
      background: rgba(0,0,0,.22);
      color: rgba(229,231,235,.92);
      font-family: var(--mono);
      font-size: 12px;
      padding: 10px;
      outline:none;
      resize: vertical;
      line-height:1.5;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Sistema Acquisizione Incarichi ‚Äî Operativo + Materiali Scaricabili</h1>
        <div class="sub">Clicca un blocco ‚Üí tab üì¶ MATERIALI ‚Üí scarichi file pronti (SMS, brochure, schede, moduli, checklist).</div>
      </div>
    </div>
    <div class="controls">
      <div class="pill">
        <label for="appt">Ora appuntamento (CASA o UFFICIO):</label>
        <input id="appt" type="datetime-local" />
      </div>
      <button class="btn primary" id="apply">Applica orari</button>
      <button class="btn" id="reset">Reset</button>
      <button class="btn ok" id="exportAll">Scarica KIT completo</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="head">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <h2>Timeline operativa (cliccabile)</h2>
          <span class="tag" id="modeTag">Processo: Standard (90‚Äì95%)</span>
        </div>
        <div class="tabs" role="tablist" aria-label="Seleziona processo">
          <div class="tab active" id="tab-standard" role="tab" tabindex="0">Standard</div>
          <div class="tab" id="tab-previsita" role="tab" tabindex="0">Con previsita</div>
          <div class="tab" id="tab-kit" role="tab" tabindex="0">Kit & Script</div>
        </div>
      </div>
      <div class="body">
        <div id="timeline" class="timeline" aria-live="polite"></div>
        <div class="footer-note">
          Regola: se il venditore NON ha letto ci√≤ che gli hai mandato, l‚Äôappuntamento si sposta. Sempre.
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="head">
        <h2>Regole non negoziabili</h2>
        <span class="tag">Sempre</span>
      </div>
      <div class="body rules">
        <div class="rule">
          <h3>1) Se NON legge ‚Üí si rinvia</h3>
          <p>Non ti presenti finch√© non ha letto/guardato con attenzione relazione/pacchetto. Altrimenti entri in difesa e perdi status.</p>
        </div>
        <div class="rule">
          <h3>2) Relazione ‚â• 48 ore prima</h3>
          <p>Serve a sbollire aspettative, far emergere domande e posizionarti come professionista prima del vis-√†-vis.</p>
        </div>
        <div class="rule">
          <h3>3) Presentazione ‚â§ 30 minuti</h3>
          <p>Oltre 30 minuti stai chiacchierando. Conduci e chiudi deciso.</p>
        </div>
        <div class="rule">
          <h3>4) Tu selezioni chi rappresenti</h3>
          <p>Inversione preda/predatore: educato ma non subordinato.</p>
          <div class="mini">"Non ho bisogno dell‚Äôincarico. Prendo solo incarichi che posso portare a risultato con metodo."</div>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- Modal -->
<div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-label="Dettaglio operazione">
  <div class="modal">
    <header>
      <div>
        <p class="m-title" id="mTitle"></p>
        <p class="m-sub" id="mSub"></p>
      </div>
      <button class="close" id="close">Chiudi ‚úï</button>
    </header>

    <div class="content">
      <div class="m-tabs" id="mTabs"></div>
      <div id="mBody"></div>
    </div>
  </div>
</div>

<script>
/* ------------------------
   Helper: download files
   ------------------------ */
function downloadFile(filename, mime, content){
  const blob = new Blob([content], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1200);
}
function esc(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function pad2(n){ return String(n).padStart(2,"0"); }
function formatDateTime(dt){
  const y = dt.getFullYear();
  const m = pad2(dt.getMonth()+1);
  const d = pad2(dt.getDate());
  const hh = pad2(dt.getHours());
  const mm = pad2(dt.getMinutes());
  return `${y}-${m}-${d} ${hh}:${mm}`;
}
function formatLocalInputValue(dt){
  const y = dt.getFullYear();
  const m = pad2(dt.getMonth()+1);
  const d = pad2(dt.getDate());
  const hh = pad2(dt.getHours());
  const mm = pad2(dt.getMinutes());
  return `${y}-${m}-${d}T${hh}:${mm}`;
}
function relToAbsolute(appt, relativeHours){
  if(!appt || relativeHours === null || relativeHours === undefined) return null;
  return new Date(appt.getTime() + relativeHours * 3600 * 1000);
}
function badgeClass(importance){
  if(importance==="ok") return "badge ok";
  if(importance==="warn") return "badge warn";
  if(importance==="danger") return "badge danger";
  return "badge";
}
function badgeText(importance){
  if(importance==="ok") return "Operativo";
  if(importance==="warn") return "Attenzione";
  if(importance==="danger") return "Critico";
  return "Info";
}

/* ------------------------
   Material Templates (downloadables)
   - You can later personalize placeholders [NOME], [DATA], etc.
   ------------------------ */
function makeBrochureHTML(){
  return `<!doctype html>
<html lang="it"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Brochure Servizi ‚Äî Metodo Operativo</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:40px;line-height:1.35}
h1{margin:0 0 8px} h2{margin:18px 0 8px;font-size:16px}
.box{border:1px solid #222;padding:12px;margin:10px 0}
.small{font-size:12px;color:#333}
ul{margin:6px 0 0 18px}
hr{margin:14px 0}
</style></head><body>
<h1>Brochure Servizi ‚Äî Vendita con Metodo</h1>
<div class="small">Versione 1 pagina (stampabile) ‚Ä¢ Personalizza logo/contatti</div>
<hr>
<div class="box">
<b>Cosa faccio</b><br>
Massimizzo il risultato economico della vendita attraverso un processo strutturato: analisi, posizionamento, marketing, gestione visite, negoziazione e chiusura.
</div>

<h2>Il mio metodo (in 5 step)</h2>
<ul>
  <li>Prequalifica: capisco obiettivo, tempi, vincoli e target.</li>
  <li>Relazione di mercato: comparabili, range e prezzo corretto.</li>
  <li>Piano marketing e posizionamento: presentazione e visibilit√†.</li>
  <li>Gestione visite e selezione acquirenti: qualit√† prima della quantit√†.</li>
  <li>Negoziazione e chiusura: protezione del risultato e tempi certi.</li>
</ul>

<h2>Perch√© funziona</h2>
<ul>
  <li>Riduce improvvisazione e abbassa lo stress del venditore.</li>
  <li>Allinea le aspettative prima dell‚Äôappuntamento.</li>
  <li>Fa emergere obiezioni prima (recall) e accelera la firma.</li>
</ul>

<h2>Prove (da inserire)</h2>
<ul>
  <li>Case study #1: problema ‚Üí strategia ‚Üí risultato</li>
  <li>Case study #2: problema ‚Üí strategia ‚Üí risultato</li>
  <li>Case study #3: problema ‚Üí strategia ‚Üí risultato</li>
</ul>

<hr>
<div class="box">
<b>Contatti</b><br>
Nome: [TUO NOME] ‚Ä¢ Agenzia: [AGENZIA] ‚Ä¢ Tel: [NUMERO] ‚Ä¢ Email: [EMAIL]<br>
<b>Video metodo:</b> inserisci qui un QR con link al tuo video (YouTube/Drive).
</div>
</body></html>`;
}

function makeSchedaMetodoMD(){
  return `# Scheda Metodo Operativo (stampabile)

## Obiettivo
Massimizzare il risultato economico con un processo strutturato, riducendo improvvisazione e obiezioni in appuntamento.

## Timeline (Standard)
1. **Fissaggio appuntamento (‚â• 4 giorni)** + slot prequalifica
2. **SMS riepilogo + video informativo**
3. **Prequalifica telefonica** (motivazione / tempi / obiettivo ‚Ç¨ / vincoli)
4. **Relazione di mercato professionale**
5. **Invio/Consegna relazione ‚â• 48 ore prima**
6. **Recall -24h** (ricevuta? letta? impressioni? domande?)
   - Se non letta: **rinvio appuntamento**
7. **Appuntamento (‚â§ 30 minuti)**: status ‚Üí metodo ‚Üí prove ‚Üí chiusura
8. **Debrief + miglioramento** (role play + registrazione)

## Regole non negoziabili
- Se non legge: **si rinvia**
- Presentazione: **max 30 minuti**
- Chiusura: **decisa, senza tentennare**
- Tu selezioni chi rappresenti (status alto)

## Asset da mostrare in presentazione
- Relazione di mercato
- Book presentazione
- Prove sociali (3 casi simili)
- Brochure servizi (1 pagina)
- QR al video metodo
`;
}

function makeModuloPrequalificaTXT(){
  return `MODULO PREQUALIFICA (da compilare prima dell‚Äôappuntamento)

DATI CLIENTE
- Nome/Cognome:
- Telefono:
- Email:
- Indirizzo immobile:

MOTIVAZIONE & TEMPISTICHE
1) Perch√© vende?
2) Entro quando vuole completare lo spostamento?
3) C‚Äô√® urgenza? (S√¨/No) Perch√©?

OBIETTIVO ECONOMICO
4) Qual √® la cifra che vuole realizzare?
5) √à un obiettivo netto o ha margine? (quanto)
6) Ha gi√† ricevuto valutazioni? Da chi? A quanto?

DATI IMMOBILE
7) Tipologia, metratura, piano, ascensore:
8) Stato interno (ristrutturato / buono / da fare):
9) Esposizione, pertinenze (box/cantina/terrazzo):
10) Spese condominiali:
11) Lavori condominiali in programma:
12) Elementi distintivi (vista, luminosit√†, ecc.):

VINCOLI / CRITICIT√Ä
13) Mutuo/Ipoteche:
14) Eredi / compropriet√†:
15) Abusi / difformit√† / pratiche:
16) Documenti disponibili (atto, planimetria, APE):

OBIEZIONI EMERSE (se gi√† presenti)
- Prezzo:
- Esclusiva:
- Commissione:
- Tempistiche:

NOTE IMPORTANTI
- Cliente in target? (S√¨/No)
- Prossimo step: relazione di mercato + invio ‚â• 48 ore prima + recall
`;
}

function makeTemplateSMS_TXT(){
  return `TEMPLATE SMS / WHATSAPP (copia-incolla)

1) RIEPILOGO APPUNTAMENTI + VIDEO
"Ciao [Nome], come anticipato: prequalifica telefonica [DATA/ORA] e appuntamento [DATA/ORA].
Intanto ti mando un breve video dove spiego come lavoro e cosa significa affidarmi l‚Äôincarico, cos√¨ arriviamo con le idee chiarissime."

2) INVIO RELAZIONE + PREANNUNCIO RECALL
"Ciao [Nome], ti ho inviato la relazione di mercato e il pacchetto informativo.
Ti chiedo di leggerli con attenzione: domani ti richiamo per le tue impressioni e le eventuali domande."

3) RECALL (se preferisci messaggio breve prima della chiamata)
"Ciao [Nome], domani ti chiamo al volo per sentire le tue impressioni sulla relazione che ti ho inviato."
`;
}

function makeRecallScriptTXT(){
  return `SCRIPT RECALL (telefonata -24h)

OBIETTIVO
- Verificare lettura e far emergere obiezioni prima dell‚Äôappuntamento.
- Se NON ha letto: rinvio (non negoziabile).

APERTURA
"Ciao [Nome], ti chiamo al volo: hai ricevuto la relazione?"

VERIFICA LETTURA
"L‚Äôhai letta con attenzione?"

IMPRESSIONI + DOMANDE
"Che impressione ti sei fatto? Quali sono le tue domande o dubbi?"

SE OBIEZIONE PREZZO
"Perfetto, √® normale. Domani ti faccio vedere come arriviamo a quel valore e come proteggiamo il miglior risultato."

SE OBIEZIONE ESCLUSIVA/INCARICO
"Chiaro. Domani ti spiego perch√© il processo funziona solo se √® applicato in modo coerente e misurabile."

SE NON HA LETTO (RINVIO)
"Capito. Allora spostiamo l‚Äôappuntamento: per me √® fondamentale che tu abbia letto almeno con attenzione le informazioni, cos√¨ domani non perdiamo tempo e arriviamo gi√† allineati."
`;
}

function makeChecklistPreRoutineTXT(){
  return `CHECKLIST PRE-ROUTINE (10 minuti prima di suonare)

IMMAGINE
[ ] Outfit professionale (contesto/target)
[ ] Cura dettagli (scarpe, capelli, ordine)

TEMPO
[ ] Arrivo 10 minuti prima (zero fretta)

RIPASSO CLIENTE
[ ] Motivazione vendita
[ ] Tempistiche
[ ] Obiettivo economico
[ ] Vincoli (mutuo/eredi/documenti)
[ ] Obiezioni emerse al recall

MATERIALI
[ ] Book presentazione (ordine corretto)
[ ] Prove sociali (3 casi simili)
[ ] Relazione (per riferimento)
[ ] Brochure servizi + scheda metodo + QR video
[ ] Moduli incarico + penna (se chiusura prevista)

MENTALIT√Ä
[ ] ‚ÄúIo seleziono chi rappresento‚Äù
[ ] Presentazione max 30 minuti
[ ] Chiusura decisa
`;
}

function makeDebriefTXT(){
  return `DEBRIEF POST APPUNTAMENTO (da compilare in auto - 5 minuti)

DATA:
CLIENTE:
ESITO: (incarico firmato / follow-up / rinviato)

1) COSA HA FUNZIONATO (max 3 bullet)
- 
- 
- 

2) DOVE HO PERSO CONTROLLO (1 punto)
- 

3) OBIEZIONI EMERSE (con risposta data)
- Prezzo:
- Esclusiva/incarico:
- Commissione:
- Altro:

4) TEMPO
- Ho rispettato i 30 minuti? (S√¨/No) Perch√©?

5) UNA SOLA COSA DA MIGLIORARE NEL PROSSIMO APPUNTAMENTO
- 

6) NUOVA FRASE / MIGLIORIA SCRIPT (se utile)
- 
`;
}

function makeMiniBookIndexMD(){
  return `# Book Presentazione ‚Äî Indice (ordine consigliato)

1) Apertura: status + obiettivo incontro
2) Metodo operativo (scheda metodo / timeline)
3) Relazione di mercato (range e logica)
4) Piano marketing e gestione visite
5) Prove sociali: 3 casi simili (storytelling)
6) Domande/obiezioni (prezzo, incarico, commissione)
7) Chiusura: richiesta firma incarico (diretta)
`;
}

/* ------------------------
   Per-event "downloadables"
   Each downloadable: {name, filename, mime, contentFn or content, notes}
   ------------------------ */
const DOWNLOAD_LIBRARY = {
  "BROCHURE_HTML": { name:"Brochure servizi (1 pagina)", filename:"brochure-servizi.html", mime:"text/html", contentFn: makeBrochureHTML,
    notes:"Stampala o aprila in Chrome e ‚ÄòStampa‚Äô ‚Üí Salva in PDF." },
  "SCHEDA_METODO_MD": { name:"Scheda metodo (stampabile)", filename:"scheda-metodo.md", mime:"text/markdown", contentFn: makeSchedaMetodoMD,
    notes:"Aprila in Google Docs/Notion e formattala." },
  "PREQUALIFICA_TXT": { name:"Modulo prequalifica", filename:"modulo-prequalifica.txt", mime:"text/plain", contentFn: makeModuloPrequalificaTXT,
    notes:"Copialo in Word/Docs e trasformalo in modulo compilabile." },
  "SMS_TXT": { name:"Template SMS/WhatsApp", filename:"template-sms.txt", mime:"text/plain", contentFn: makeTemplateSMS_TXT,
    notes:"Salvalo nelle note del telefono." },
  "RECALL_TXT": { name:"Script Recall (-24h)", filename:"script-recall.txt", mime:"text/plain", contentFn: makeRecallScriptTXT,
    notes:"Tienilo aperto durante la chiamata." },
  "PREROUTINE_TXT": { name:"Checklist Pre-routine (-10m)", filename:"checklist-pre-routine.txt", mime:"text/plain", contentFn: makeChecklistPreRoutineTXT,
    notes:"Stampala e mettila nella cartellina." },
  "DEBRIEF_TXT": { name:"Debrief post appuntamento", filename:"debrief-post-appuntamento.txt", mime:"text/plain", contentFn: makeDebriefTXT,
    notes:"Da compilare in auto in 5 minuti." },
  "BOOK_INDEX_MD": { name:"Indice Book Presentazione", filename:"book-indice.md", mime:"text/markdown", contentFn: makeMiniBookIndexMD,
    notes:"Usalo per sistemare l‚Äôordine del book." }
};

/* ------------------------
   DATA (timeline)
   Each event popup includes downloadKeys: array of keys into DOWNLOAD_LIBRARY
   ------------------------ */
const DATA = {
  standard: [
    {
      id:"std-96", relativeHours:-96, relLabel:"-96h", importance:"info",
      title:"Primo contatto: controllo + fissaggio appuntamenti (‚â• 4 giorni)",
      short:"Blocchi prequalifica + appuntamento dal vivo. Imposti il processo.",
      popup:{
        obiettivo:[
          "Impostare status e controllo del processo.",
          "Fissare due appuntamenti (telefonico + di persona)."
        ],
        fareChecklist:[
          {t:"Mai fissare prima di 4 giorni", d:"Anticipo = controllo + tempo per educare."},
          {t:"Blocca 2 slot (prequalifica + incontro)", d:"Standard operativo, non opzione."},
          {t:"Preannuncia relazione + recall", d:"Cos√¨ guidi l‚Äôaspettativa."}
        ],
        direScript:
`"Perfetto. Per lavorare bene e farle risparmiare tempo, io faccio sempre una breve prequalifica telefonica prima dell‚Äôincontro. Cos√¨ arrivo preparato.

Facciamo cos√¨: ci sentiamo al telefono [giorno/ora] e poi ci vediamo a casa sua [giorno/ora].

Dopo la prequalifica, se ha senso procedere, preparo una relazione di mercato professionale e gliela anticipo. Poi la richiamo il giorno prima per le sue impressioni."`,
        preparare:[
          "Agenda: due slot fissati.",
          "Template SMS pronto.",
          "Modulo prequalifica pronto."
        ],
        materiali:[
          "Template SMS/WhatsApp (download).",
          "Modulo prequalifica (download)."
        ],
        errori:[
          "Accettare appuntamento subito.",
          "Parlare di prezzo prima del contesto."
        ],
        downloadKeys:["SMS_TXT","PREQUALIFICA_TXT"]
      }
    },

    {
      id:"std-90", relativeHours:-90, relLabel:"-90h", importance:"ok",
      title:"SMS riepilogo + invio video (subito)",
      short:"Riepiloghi tutto e ‚Äòpre-educhi‚Äô sul metodo.",
      popup:{
        obiettivo:["Confermare appuntamenti e posizionare il metodo prima di vederti."],
        fareChecklist:[
          {t:"Invia SMS entro 5 minuti", d:"Precisione = professionalit√†."},
          {t:"Invia il video informativo", d:"Spiega incarico/collaborazione e come lavori."}
        ],
        direScript:
`SMS:
"Ciao [Nome], come anticipato: prequalifica telefonica [DATA/ORA] e appuntamento [DATA/ORA].
Intanto ti mando un breve video dove spiego come lavoro e cosa significa affidarmi l‚Äôincarico, cos√¨ arriviamo con le idee chiarissime."`,
        preparare:[
          "Link video pronto (Drive/YouTube).",
          "Template SMS salvato."
        ],
        materiali:[
          "Template SMS (download).",
          "Brochure servizi (1 pagina) per spiegare il metodo (download)."
        ],
        errori:["Messaggi lunghi/confusi.", "Non inviare nulla (perdi impatto)."],
        downloadKeys:["SMS_TXT","BROCHURE_HTML"]
      }
    },

    {
      id:"std-72", relativeHours:-72, relLabel:"-72h", importance:"warn",
      title:"Prequalifica telefonica (selezione target)",
      short:"Domande precise ‚Üí decidi se andare avanti.",
      popup:{
        obiettivo:["Decidere se il cliente √® in target e raccogliere dati per relazione/presentazione."],
        fareChecklist:[
          {t:"Fai domande su motivazione e tempistica", d:"Senza, la vendita ‚Äòmuore‚Äô."},
          {t:"Chiedi obiettivo economico", d:"Ti serve per gestire prezzo e aspettative."},
          {t:"Verifica vincoli", d:"Mutuo/eredi/documenti."}
        ],
        direScript:
`"Le faccio domande specifiche perch√© voglio arrivare con una relazione seria.

Perch√© vende? Entro quando vuole completare lo spostamento?
Qual √® la cifra che vuole realizzare?
Ci sono vincoli (mutuo, eredi, documenti)?"`,
        preparare:["Modulo prequalifica compilato.", "Note per relazione."],
        materiali:["Modulo prequalifica (download).", "Scheda metodo (download)."],
        errori:["Chiamata improvvisata.", "Non prendere appunti."],
        downloadKeys:["PREQUALIFICA_TXT","SCHEDA_METODO_MD"]
      }
    },

    {
      id:"std-48", relativeHours:-48, relLabel:"-48h", importance:"danger",
      title:"Relazione di mercato + pacchetto (invio ‚â• 48h)",
      short:"Allinei prezzo, mostri metodo, fai emergere obiezioni prima.",
      popup:{
        obiettivo:["Inviare materiale 48h prima per sbollire aspettative e preparare il recall."],
        fareChecklist:[
          {t:"Prepara relazione professionale", d:"Comparabili + range + logica."},
          {t:"Inserisci metodo e incarico", d:"Pre-educazione: non scoprire tutto in faccia a te."},
          {t:"Invia ‚â• 48 ore prima", d:"Non negoziabile."}
        ],
        direScript:
`"Ciao [Nome], ti ho inviato la relazione di mercato e il pacchetto informativo.
Ti chiedo di leggerli con attenzione: domani ti richiamo per impressioni e domande."`,
        preparare:["Book in ordine.", "3 prove sociali (casi simili)."],
        materiali:[
          "Brochure servizi (download).",
          "Scheda metodo (download).",
          "Indice Book (download)."
        ],
        errori:["Inviare tardi.", "Relazione confusa senza conclusione."],
        downloadKeys:["BROCHURE_HTML","SCHEDA_METODO_MD","BOOK_INDEX_MD"]
      }
    },

    {
      id:"std-24", relativeHours:-24, relLabel:"-24h", importance:"danger",
      title:"Recall (-24h): verifica lettura + obiezioni (se non letto ‚Üí rinvio)",
      short:"Telefonata di controllo, non conferma orario.",
      popup:{
        obiettivo:["Verificare lettura e far emergere obiezioni prima dell‚Äôappuntamento."],
        fareChecklist:[
          {t:"Chiama: ricevuta? letta? impressioni?", d:"Sequenza fissa."},
          {t:"Se non ha letto: rinvia", d:"Protegge status e risultato."}
        ],
        direScript:
`"Ciao [Nome], hai ricevuto la relazione? L‚Äôhai letta con attenzione?
Che impressione ti sei fatto e che domande vuoi farmi?

Se NON l‚Äôha letta:
"Allora spostiamo: per me √® fondamentale che lei la legga prima, cos√¨ arriviamo gi√† allineati."`,
        preparare:["Lista obiezioni emerse.", "Scaletta presentazione."],
        materiali:["Script recall (download)."],
        errori:["Andare lo stesso anche se non ha letto."],
        downloadKeys:["RECALL_TXT"]
      }
    },

    {
      id:"std-0_10", relativeHours:-0.1667, relLabel:"-10m", importance:"warn",
      title:"Pre-routine (-10m): immagine + ripasso + materiali",
      short:"Arrivi con status alto e zero dimenticanze.",
      popup:{
        obiettivo:["Entrare con controllo emotivo e materiali completi."],
        fareChecklist:[
          {t:"Arriva 10 min prima", d:"Mai in affanno."},
          {t:"Ripassa obiettivo ‚Ç¨, motivazione, obiezioni", d:"Leadership."},
          {t:"Controlla book e prove sociali", d:"Ordine e impatto."}
        ],
        direScript:`Self-talk: "Show time. Io seleziono chi rappresento. 30 minuti. Chiusura decisa."`,
        preparare:["Book pronto.", "Moduli incarico pronti.", "Penna."],
        materiali:["Checklist pre-routine (download)."],
        errori:["Arrivare di corsa.", "Dimenticare materiali."],
        downloadKeys:["PREROUTINE_TXT"]
      }
    },

    {
      id:"std-0", relativeHours:0, relLabel:"0h", importance:"danger",
      title:"Appuntamento (‚â§ 30 min): presentazione + chiusura",
      short:"Status ‚Üí metodo ‚Üí prove ‚Üí chiusura decisa.",
      popup:{
        obiettivo:["Uscire con incarico firmato il giorno stesso."],
        fareChecklist:[
          {t:"Conduci tu (max 30 min)", d:"Se sfori, chiacchieri."},
          {t:"Mostra prove sociali", d:"Immedesimazione."},
          {t:"Chiudi deciso", d:"Chiedi la firma."}
        ],
        direScript:
`"Oggi le do un quadro chiaro del mercato e del mio metodo, e poi lei decide.

Se √® d‚Äôaccordo sul prezzo corretto e sul processo, firmiamo oggi e partiamo subito."`,
        preparare:["Book (ordine perfetto).", "Moduli incarico + penna.", "Prove sociali."],
        materiali:["Indice Book (download).", "Scheda metodo (download).", "Brochure (download)."],
        errori:["Chiusura timida.", "Sforare 30 min."],
        downloadKeys:["BOOK_INDEX_MD","SCHEDA_METODO_MD","BROCHURE_HTML"]
      }
    },

    {
      id:"std+1", relativeHours:1, relLabel:"+1h", importance:"ok",
      title:"Debrief (+1h): scrivi miglioramenti + allenamento",
      short:"Sistemi il processo appuntamento dopo appuntamento.",
      popup:{
        obiettivo:["Migliorare costantemente script e performance."],
        fareChecklist:[
          {t:"Compila debrief in auto (5 min)", d:"Se aspetti, perdi dettagli."},
          {t:"Role play 30 min/die", d:"Allenamento deliberato."},
          {t:"Registrati 1 volta/mese", d:"Vedi esitazioni e punti deboli."}
        ],
        direScript:"Debrief rapido: cosa ha funzionato? cosa migliorare? quale obiezione? ho rispettato i 30 min?",
        preparare:["Template debrief pronto."],
        materiali:["Debrief (download)."],
        errori:["Non debriefare ‚Üí ripeti errori."],
        downloadKeys:["DEBRIEF_TXT"]
      }
    }
  ],

  previsita: [
    {
      id:"pre-96", relativeHours:-96, relLabel:"-96h", importance:"info",
      title:"Immobile speciale: fissa PREVISITA a casa",
      short:"Oggetto particolare ‚Üí devi vederlo prima della relazione.",
      popup:{
        obiettivo:["Fissare previsita e impostare il percorso: previsita ‚Üí relazione ‚Üí recall ‚Üí firma."],
        fareChecklist:[
          {t:"Fissa previsita", d:"Spiega che serve per una relazione seria."},
          {t:"Imposta gi√† invio ‚â• 48h + recall", d:"Processo guidato."}
        ],
        direScript:
`"Per immobili come questo devo vederlo di persona: solo cos√¨ posso costruire una relazione seria.
Poi le invio la relazione e la richiamo il giorno prima per le impressioni."`,
        preparare:["Checklist sopralluogo (tua).", "Modulo prequalifica."],
        materiali:["Modulo prequalifica (download).", "Scheda metodo (download)."],
        errori:["Fare relazione senza vedere l‚Äôoggetto (in questi casi)."],
        downloadKeys:["PREQUALIFICA_TXT","SCHEDA_METODO_MD"]
      }
    },
    {
      id:"pre-72", relativeHours:-72, relLabel:"-72h", importance:"warn",
      title:"PREVISITA: perlustrazione + conoscenza venditore",
      short:"Raccogli dati reali e motivazioni.",
      popup:{
        obiettivo:["Raccogliere info reali per relazione professionale e scelta target."],
        fareChecklist:[
          {t:"Perlustra punti forti e criticit√†", d:"Appunti concreti."},
          {t:"Chiedi motivazione, tempi, obiettivo ‚Ç¨", d:"Base della chiusura."}
        ],
        direScript:`"Oggi raccolgo tutto. Poi le preparo una relazione professionale e gliela anticipo."`,
        preparare:["Note/Foto se consentite.", "Scheda immobile."],
        materiali:["Modulo prequalifica (download)."],
        errori:["Trasformare previsita in ‚Äòpresentazione lunga‚Äô."],
        downloadKeys:["PREQUALIFICA_TXT"]
      }
    },
    {
      id:"pre-48", relativeHours:-48, relLabel:"-48h", importance:"danger",
      title:"Relazione post-previsita + invio ‚â• 48h",
      short:"Identico allo standard: educazione e obiezioni prima.",
      popup:{
        obiettivo:["Inviare materiale 48h prima e preparare recall."],
        fareChecklist:[
          {t:"Invia ‚â• 48 ore prima", d:"Non negoziabile."},
          {t:"Prepara recall -24h", d:"Obiezioni prima."}
        ],
        direScript:`"Le ho inviato la relazione. Domani la richiamo per impressioni e domande."`,
        preparare:["Book + prove sociali su immobili simili."],
        materiali:["Brochure (download).", "Indice Book (download)."],
        errori:["Inviare tardi."],
        downloadKeys:["BROCHURE_HTML","BOOK_INDEX_MD"]
      }
    },
    {
      id:"pre-24", relativeHours:-24, relLabel:"-24h", importance:"danger",
      title:"Recall (se non letto ‚Üí rinvio)",
      short:"Controllo lettura e impressioni.",
      popup:{
        obiettivo:["Verificare lettura e obiezioni prima."],
        fareChecklist:[
          {t:"Chiama e verifica lettura", d:"Ricevuta? letta? impressioni?"},
          {t:"Se non letta: rinvia", d:"Status."}
        ],
        direScript:`Vedi script recall (scaricabile).`,
        preparare:["Lista obiezioni."],
        materiali:["Script recall (download)."],
        errori:["Andare a freddo."],
        downloadKeys:["RECALL_TXT"]
      }
    },
    {
      id:"pre-0", relativeHours:0, relLabel:"0h", importance:"danger",
      title:"Appuntamento in UFFICIO: firma incarico",
      short:"Chiusura pulita: quadro chiaro ‚Üí firma.",
      popup:{
        obiettivo:["Firmare incarico con controllo su prezzo e processo."],
        fareChecklist:[
          {t:"Ricapitola 3 punti", d:"Mercato, prezzo, metodo."},
          {t:"Firma", d:"Chiusura diretta."}
        ],
        direScript:`"Abbiamo un quadro chiaro. Se √® d‚Äôaccordo su prezzo e strategia, firmiamo oggi e partiamo subito."`,
        preparare:["Moduli incarico pronti.", "Book."],
        materiali:["Indice Book (download).", "Scheda metodo (download)."],
        errori:["Riaprire tutto da capo."],
        downloadKeys:["BOOK_INDEX_MD","SCHEDA_METODO_MD"]
      }
    }
  ],

  kit: [
    {
      id:"kit-1", relativeHours:null, relLabel:"KIT", importance:"ok",
      title:"KIT COMPLETO ‚Äî scarica e imposta tutti i materiali",
      short:"Qui crei tutto il pacchetto: brochure, scheda metodo, moduli, checklist, script.",
      popup:{
        obiettivo:[
          "Avere tutti i materiali pronti e coerenti con il processo.",
          "Standardizzare presentazioni e conversione incarichi."
        ],
        fareChecklist:[
          {t:"Scarica e personalizza ogni file", d:"Sostituisci [TUO NOME], contatti, loghi, esempi."},
          {t:"Stampa: brochure + checklist", d:"Materiale fisico = impatto."},
          {t:"Sistema il book seguendo l‚Äôindice", d:"Ordine fisso = presentazione veloce."},
          {t:"Crea QR al video", d:"Inseriscilo in brochure (poi stampi)."}
        ],
        direScript:`"Il mio metodo √® un processo strutturato: la differenza la fa la coerenza nell‚Äôesecuzione."`,
        preparare:[
          "Logo + contatti + link video.",
          "3 case study reali da inserire.",
          "Cartellina (fisica o digitale) ordinata."
        ],
        materiali:[
          "Brochure (HTML) ‚Üí stampa/PDF",
          "Scheda metodo (MD/TXT)",
          "Modulo prequalifica (TXT)",
          "Template SMS (TXT)",
          "Script recall (TXT)",
          "Checklist pre-routine (TXT)",
          "Debrief post appuntamento (TXT)",
          "Indice book (MD)"
        ],
        errori:["Avere materiali disallineati tra loro.", "Non avere prove sociali."],
        downloadKeys:["BROCHURE_HTML","SCHEDA_METODO_MD","PREQUALIFICA_TXT","SMS_TXT","RECALL_TXT","PREROUTINE_TXT","DEBRIEF_TXT","BOOK_INDEX_MD"]
      }
    }
  ]
};

/* ------------------------
   UI
   ------------------------ */
const $ = (s)=>document.querySelector(s);
const timelineEl = $("#timeline");
const backdrop = $("#backdrop");
const mTitle = $("#mTitle");
const mSub = $("#mSub");
const mTabs = $("#mTabs");
const mBody = $("#mBody");
let activeMode = "standard";
let activeTab = "fare";
let activePopup = null;

function setMode(mode){
  activeMode = mode;
  $("#tab-standard").classList.toggle("active", mode==="standard");
  $("#tab-previsita").classList.toggle("active", mode==="previsita");
  $("#tab-kit").classList.toggle("active", mode==="kit");
  $("#modeTag").textContent =
    mode==="standard" ? "Processo: Standard (90‚Äì95%)" :
    mode==="previsita" ? "Processo: Con previsita (immobili particolari)" :
    "Sezione: Kit & Script (sempre)";
  renderTimeline();
}

function renderTimeline(){
  const apptVal = $("#appt").value;
  const appt = apptVal ? new Date(apptVal) : null;

  const items = DATA[activeMode] ?? [];
  timelineEl.innerHTML = "";

  items.forEach(item=>{
    const abs = (appt && item.relativeHours !== null && item.relativeHours !== undefined)
      ? relToAbsolute(appt, item.relativeHours) : null;

    const leftTop = abs ? `${formatDateTime(abs)}` : "Orario assoluto: ‚Äî";

    const el = document.createElement("div");
    el.className = "event";
    el.setAttribute("role","button");
    el.setAttribute("tabindex","0");

    el.innerHTML = `
      <div class="left">
        <div class="rel">${esc(item.relLabel)}</div>
        <div>${esc(leftTop)}</div>
        <div class="${badgeClass(item.importance)}"><span class="dot"></span>${esc(badgeText(item.importance))}</div>
      </div>
      <div class="right">
        <div class="title">${esc(item.title)}</div>
        <p class="desc">${esc(item.short)}</p>
      </div>
    `;
    el.addEventListener("click", ()=> openModal(item, abs));
    el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openModal(item, abs);} });
    timelineEl.appendChild(el);
  });
}

function renderTabs(popup){
  const tabs = [
    {id:"fare", label:"‚úÖ Cosa fare"},
    {id:"dire", label:"üó£Ô∏è Cosa dire"},
    {id:"prep", label:"üß∞ Cosa preparare"},
    {id:"mat", label:"üì¶ Materiali scaricabili"},
    {id:"err", label:"üö´ Errori"},
    {id:"obj", label:"üéØ Obiettivo"}
  ];
  mTabs.innerHTML = "";
  tabs.forEach(t=>{
    const b = document.createElement("div");
    b.className = "m-tab" + (t.id===activeTab ? " active":"");
    b.textContent = t.label;
    b.tabIndex = 0;
    b.addEventListener("click", ()=>{ activeTab=t.id; renderModalBody(popup); renderTabs(popup); });
    b.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ activeTab=t.id; renderModalBody(popup); renderTabs(popup);} });
    mTabs.appendChild(b);
  });
}

function listSection(title, items){
  const li = (items||[]).map(x=>`<li>${esc(x)}</li>`).join("");
  return `<div class="section"><h4>${esc(title)}</h4><ul>${li}</ul></div>`;
}
function checklistSection(title, rows){
  const html = (rows||[]).map(r=>`
    <div class="chk">
      <input type="checkbox" />
      <div>
        <div class="t">${esc(r.t)}</div>
        <div class="d">${esc(r.d||"")}</div>
      </div>
    </div>
  `).join("");
  return `<div class="section"><h4>${esc(title)}</h4><div class="checklist">${html}</div></div>`;
}
function scriptSection(title, text){
  return `<div class="section"><h4>${esc(title)}</h4><div class="script">${esc(text||"")}</div></div>`;
}

function renderDownloadables(popup){
  const keys = popup.downloadKeys || [];
  if(!keys.length){
    return `<div class="section"><h4>üì¶ Materiali scaricabili</h4>
      <div class="mini">Nessun file associato a questo blocco. Vai su ‚ÄúKit & Script‚Äù per scaricare tutto.</div>
    </div>`;
  }

  const cards = keys.map(k=>{
    const it = DOWNLOAD_LIBRARY[k];
    if(!it) return "";
    const content = typeof it.contentFn === "function" ? it.contentFn() : (it.content || "");
    const safeContent = esc(content);
    return `
      <div class="dl">
        <div class="name">${esc(it.name)}</div>
        <div class="meta">${esc(it.filename)} ‚Ä¢ ${esc(it.mime)}</div>
        <div class="desc">${esc(it.notes || "")}</div>
        <div class="actions">
          <button class="btn small ok" data-dl="${esc(k)}">Scarica</button>
          <button class="btn small ghost" data-prev="${esc(k)}">Anteprima</button>
        </div>
      </div>
    `;
  }).join("");

  return `
    <div class="section">
      <h4>üì¶ Materiali scaricabili (gi√† progettati)</h4>
      <div class="dl-grid">${cards}</div>
      <div class="footer-note">Suggerimento: apri i file in Google Docs/Word per personalizzare, poi esporta in PDF se ti serve stampare.</div>
    </div>
    <div class="section" id="previewBox" style="display:none;">
      <h4>üëÄ Anteprima contenuto</h4>
      <textarea class="preview" id="previewArea" readonly></textarea>
      <div class="footer-note">Puoi copiare/incollare questo contenuto direttamente in Word/Docs.</div>
    </div>
  `;
}

function renderModalBody(popup){
  const p = popup || {};
  activePopup = p;

  if(activeTab==="fare"){
    mBody.innerHTML = checklistSection("‚úÖ Cosa fare (passi eseguibili)", p.fareChecklist);
  } else if(activeTab==="dire"){
    mBody.innerHTML = scriptSection("üó£Ô∏è Cosa dire (script parola per parola)", p.direScript || "");
  } else if(activeTab==="prep"){
    mBody.innerHTML = listSection("üß∞ Cosa preparare (prima di muoverti)", p.preparare);
  } else if(activeTab==="mat"){
    mBody.innerHTML = renderDownloadables(p);
    wireDownloadButtons();
  } else if(activeTab==="err"){
    mBody.innerHTML = listSection("üö´ Errori da evitare", p.errori);
  } else if(activeTab==="obj"){
    mBody.innerHTML = listSection("üéØ Obiettivo del blocco", p.obiettivo);
  }
}

function wireDownloadButtons(){
  // Download buttons
  document.querySelectorAll("button[data-dl]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.getAttribute("data-dl");
      const it = DOWNLOAD_LIBRARY[key];
      if(!it) return;
      const content = typeof it.contentFn === "function" ? it.contentFn() : (it.content || "");
      downloadFile(it.filename, it.mime, content);
    });
  });
  // Preview buttons
  document.querySelectorAll("button[data-prev]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.getAttribute("data-prev");
      const it = DOWNLOAD_LIBRARY[key];
      if(!it) return;
      const content = typeof it.contentFn === "function" ? it.contentFn() : (it.content || "");
      const box = document.getElementById("previewBox");
      const area = document.getElementById("previewArea");
      if(box && area){
        box.style.display = "block";
        area.value = content;
        area.scrollTop = 0;
      }
    });
  });
}

function openModal(item, abs){
  const apptVal = $("#appt").value;
  const appt = apptVal ? new Date(apptVal) : null;

  const absLine = abs ? `Orario: ${formatDateTime(abs)}` : "Orario: (imposta l‚Äôappuntamento in alto per calcolarlo)";
  const relLine = item.relLabel + (item.relativeHours !== null && item.relativeHours !== undefined ? " (relativo)" : "");

  mTitle.textContent = item.title;
  mSub.textContent = `${relLine}\n${absLine}`;

  activeTab = "fare";
  renderTabs(item.popup);
  renderModalBody(item.popup);

  backdrop.classList.add("show");
}
function closeModal(){ backdrop.classList.remove("show"); }

$("#close").addEventListener("click", closeModal);
backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) closeModal(); });
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });

$("#apply").addEventListener("click", renderTimeline);
$("#reset").addEventListener("click", ()=>{
  $("#appt").value = "";
  renderTimeline();
});

$("#tab-standard").addEventListener("click", ()=> setMode("standard"));
$("#tab-previsita").addEventListener("click", ()=> setMode("previsita"));
$("#tab-kit").addEventListener("click", ()=> setMode("kit"));

$("#tab-standard").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") setMode("standard"); });
$("#tab-previsita").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") setMode("previsita"); });
$("#tab-kit").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") setMode("kit"); });

/* Download KIT completo: scarica tutti i file della libreria */
$("#exportAll").addEventListener("click", ()=>{
  const keys = Object.keys(DOWNLOAD_LIBRARY);
  keys.forEach((k, idx)=>{
    const it = DOWNLOAD_LIBRARY[k];
    const content = typeof it.contentFn === "function" ? it.contentFn() : (it.content || "");
    // small stagger to avoid browser blocking multiple downloads at same instant
    setTimeout(()=> downloadFile(it.filename, it.mime, content), idx * 250);
  });
});

/* Init: default domani 16:00 */
(function init(){
  const now = new Date();
  const d = new Date(now);
  d.setHours(16,0,0,0);
  if(now.getTime() > d.getTime()) d.setDate(d.getDate()+1);
  $("#appt").value = formatLocalInputValue(d);
  renderTimeline();
})();
</script>
</body>
</html>
