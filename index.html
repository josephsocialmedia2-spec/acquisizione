
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Video Creator ‚Äî Redesign (Zoom sotto)</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#12141b;
      --panel2:#0f1218;
      --text:#e9eef8;
      --muted:#9aa3b2;
      --border:rgba(255,255,255,.10);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius:18px;
      --accent:#22c55e;
      --danger:#ef4444;
      --gold:#d8a23a;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 520px at 12% 0%, rgba(216,162,58,.16), transparent 60%),
        radial-gradient(900px 620px at 90% 20%, rgba(239,68,68,.12), transparent 55%),
        radial-gradient(900px 620px at 70% 90%, rgba(34,197,94,.12), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background: rgba(18,20,27,.72);
      backdrop-filter: blur(10px);
    }
    header .title{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    header h1{
      margin:0;
      font-size:13px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      font-size:11px;
      color:var(--muted);
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(0,0,0,.20);
      font-weight:800;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:14px 12px 60px; }
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .hd h2{ margin:0; font-size:12px; letter-spacing:.6px; text-transform:uppercase; color:var(--muted); }
    .bd{ padding:12px; }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    textarea, input, select{
      width:100%;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      font-size:13px;
      font-family:var(--sans);
    }
    textarea{ min-height:120px; resize:vertical; line-height:1.35; font-weight:650; }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .col{ flex:1; min-width:160px; }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      font-size:12px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform .12s ease, filter .12s ease, background .16s ease, border-color .16s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); border-color: rgba(216,162,58,.22); }
    .btn:active{ transform: translateY(0px); filter: brightness(0.98); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(34,197,94,.92), rgba(34,197,94,.55));
      border-color: rgba(34,197,94,.45);
      color:#07120b;
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(239,68,68,.92), rgba(239,68,68,.55));
      border-color: rgba(239,68,68,.45);
      color:#170707;
    }
    .btn.gold{
      background: linear-gradient(135deg, rgba(216,162,58,.95), rgba(216,162,58,.68));
      border-color: rgba(216,162,58,.55);
      color:#111;
    }
    .btn.ghost{ background:rgba(255,255,255,.04); }
    .btn.small{ padding:8px 10px; font-size:11px; border-radius:12px; }

    .muted{ color:var(--muted); font-size:12px; line-height:1.35; }
    .sep{ height:1px; background:rgba(255,255,255,.08); margin:12px 0; }

    /* Stage */
    .stageWrap{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .stageWrap{ grid-template-columns: 1fr; }
    }

    .stageBlock{ display:flex; flex-direction:column; gap:10px; }
    .stage916{
      position:relative;
      width:100%;
      aspect-ratio: 9/16;
      border-radius: 22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:#000;
      box-shadow: var(--shadow);
    }
    #camPreview{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      opacity:0; /* preview si vede dal canvas overlayato */
      pointer-events:none;
    }
    #recCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
    }

    .overlay{
      position:absolute;
      inset:0;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      pointer-events:none;
      z-index:3;
    }
    .qBox{
      font-size:12px;
      font-weight:950;
      line-height:1.15;
      padding:8px 10px;
      border-radius:14px;
      background: rgba(0,0,0,.32);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(6px);
      white-space:pre-wrap;
    }
    .teleArea{
      flex:1;
      position:relative;
      overflow:hidden;
      border-radius:14px;
    }
    .teleText{
      position:absolute;
      left:0; right:0;
      white-space:pre-wrap;
      font-size:18px;
      line-height:1.35;
      font-weight:850;
      color: rgba(243,244,246,.94);
      text-shadow: 0 2px 12px rgba(0,0,0,.78);
      transform: translateY(20px);
      padding: 0 4px 80px;
    }

    /* HUD */
    .hud{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .lamp{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      font-size:12px;
      color:#cbd5e1;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background:rgba(255,255,255,.20);
      box-shadow: 0 0 0 0 rgba(239,68,68,.0);
    }
    .dot.rec{
      background: var(--danger);
      box-shadow: 0 0 0 8px rgba(239,68,68,.12);
      animation: pulse 1.1s infinite ease-in-out;
    }
    @keyframes pulse{
      0%,100%{ transform:scale(1); box-shadow: 0 0 0 8px rgba(239,68,68,.12); }
      50%{ transform:scale(1.08); box-shadow: 0 0 0 12px rgba(239,68,68,.06); }
    }

    /* Zoom control ALWAYS below stage */
    .zoomCard{
      padding:10px 12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .zoomRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .zoomRow .zLabel{ font-weight:950; color:var(--muted); font-size:12px; }
    input[type="range"]{ width: 220px; accent-color: var(--gold); }
    .zVal{
      font-family:var(--mono);
      font-weight:950;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }

    /* Right side list */
    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 520px; overflow:auto; padding-right:6px;
    }
    .item{
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background:rgba(0,0,0,.14);
      padding:10px;
      cursor:pointer;
    }
    .item.selected{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.07);
    }
    .item h3{ margin:0 0 6px; font-size:13px; }
    .item .meta{
      font-size:12px; color:var(--muted);
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .k{ padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06); }

    video.player{
      width:100%;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:#000;
      aspect-ratio: 9/16;
      box-shadow: var(--shadow);
    }
  </style>
</head>

<body>
<header>
  <div class="title">
    <span class="pill"><span id="videoCount">Video: 0</span></span>
    <h1>Video Creator ‚Äî redesign (zoom sotto, sempre visibile)</h1>
  </div>
  <div class="row">
    <button class="btn small ghost" id="btnHelp" type="button">üìò Istruzioni</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: flow -->
    <section class="card">
      <div class="hd">
        <h2>Flow</h2>
        <span class="pill">Profilo: <b id="profileNext" style="color:#e5e7eb">‚Äî</b></span>
      </div>
      <div class="bd">

        <div class="row">
          <button class="btn gold" id="btnNewQ" type="button">‚ú® Nuova domanda</button>
          <button class="btn ghost" id="btnCopyQuestion" type="button">üìã Copia domanda</button>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="col">
            <label>Risposta (incolla o scrivi)</label>
            <textarea id="answerBox" placeholder="Incolla qui la risposta (o scrivila tu)‚Ä¶"></textarea>
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnSendTele" type="button">‚û°Ô∏è Invia al teleprompter</button>
          <button class="btn ghost" id="btnPasteAnswer" type="button">üìã Incolla dagli appunti</button>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="col">
            <label>Velocit√† teleprompter</label>
            <select id="teleSpeed">
              <option value="120">120s</option>
              <option value="105" selected>105s</option>
              <option value="90">90s</option>
            </select>
          </div>
          <div class="col">
            <label>Rotazione profili</label>
            <select id="profiles">
              <option value="tiktok,instagram,shorts,facebook" selected>Tutti</option>
              <option value="tiktok,instagram">TikTok + Instagram</option>
              <option value="instagram">Solo Instagram</option>
              <option value="tiktok">Solo TikTok</option>
              <option value="shorts">Solo Shorts</option>
              <option value="facebook">Solo Facebook</option>
            </select>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn ghost" id="btnCamera" type="button">üì∑ Camera</button>
          <button class="btn danger" id="btnStop" type="button">‚èπ Stop</button>
          <button class="btn ghost" id="btnRestartTele" type="button">‚Üª Riavvia tele</button>
          <button class="btn danger" id="btnTeleRec" type="button">üî¥ Teleprompter + REC</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Sequenza: <b>Nuova domanda</b> ‚Üí incolla risposta ‚Üí <b>Invia al teleprompter</b> ‚Üí <b>Teleprompter + REC</b>.
        </div>

      </div>
    </section>

    <!-- RIGHT: stage + list -->
    <section class="stageWrap">

      <div class="stageBlock">

        <div class="stage916" aria-label="Stage 9:16">
          <video id="camPreview" autoplay playsinline muted></video>
          <canvas id="recCanvas" width="1080" height="1920"></canvas>

          <div class="overlay">
            <div class="qBox" id="qOverlay">Premi ‚ÄúNuova domanda‚Äù.</div>
            <div class="teleArea">
              <div class="teleText" id="teleText">Incolla/scrivi una risposta ‚Üí ‚ÄúInvia al teleprompter‚Äù ‚Üí ‚ÄúTeleprompter + REC‚Äù.</div>
            </div>
          </div>
        </div>

        <!-- HUD -->
        <div class="hud">
          <div class="lamp">
            <span class="dot" id="recDot"></span>
            <span><b id="recLabel">PRONTO</b> ¬∑ <span id="recTime">00:00</span></span>
          </div>
          <div class="row">
            <button class="btn small ghost" id="btnUpload" type="button">‚¨ÜÔ∏è Carica video</button>
            <button class="btn small ghost" id="btnDownload" type="button">üì• Scarica selezionato</button>
            <button class="btn small ghost" id="btnClear" type="button">üóëÔ∏è Svuota</button>
          </div>
        </div>

        <!-- ZOOM: sempre sotto, SEMPRE VISIBILE -->
        <div class="zoomCard" aria-label="Zoom sotto stage">
          <div class="zoomRow">
            <span class="zLabel">Zoom</span>
            <input id="zoom" type="range" min="1" max="2.5" step="0.1" value="1.1" />
            <span class="zVal" id="zoomVal">1.1√ó</span>
            <span class="muted">vale anche nel video registrato</span>
          </div>
        </div>

        <video class="player" id="player" controls playsinline></video>
        <div class="muted">Il player mostra il video selezionato (registrato o caricato).</div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>Video</h2>
          <span class="pill"><span id="totalCount">0</span></span>
        </div>
        <div class="bd">
          <div class="list" id="videoList"></div>
        </div>
      </div>

    </section>

  </div>
</div>

<!-- Hidden upload input -->
<input type="file" id="fileInput" accept="video/*" style="display:none" />

<!-- Simple instructions modal -->
<div id="modal" style="position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; padding:14px; z-index:99;">
  <div class="card" style="width:min(860px,96vw); max-height:min(80vh,760px); overflow:auto;">
    <div class="hd">
      <h2 style="margin:0; font-size:12px; letter-spacing:.6px; text-transform:uppercase;">Istruzioni</h2>
      <button class="btn small ghost" id="btnCloseModal" type="button">‚úï Chiudi</button>
    </div>
    <div class="bd" style="font-size:13px; line-height:1.5; color:#e5e7eb;">
      <div style="border:1px solid rgba(216,162,58,.25); background:rgba(216,162,58,.10); border-radius:14px; padding:10px 12px; margin-bottom:10px;">
        Obiettivo: video verticali <b>9:16</b> con <b>domanda ‚Üí risposta ‚Üí teleprompter ‚Üí REC</b>.
      </div>
      <ol>
        <li><b>Nuova domanda</b> ‚Üí la vedi nell‚Äôoverlay.</li>
        <li>Incolla o scrivi la risposta nel box ‚ÄúRisposta‚Äù.</li>
        <li><b>Invia al teleprompter</b> ‚Üí il testo va nel teleprompter.</li>
        <li>Regola <b>Zoom</b> (slider sotto il video) e <b>Velocit√†</b>.</li>
        <li><b>Teleprompter + REC</b> per registrare. <b>Stop</b> per fermare.</li>
        <li>Seleziona un video dalla lista ‚Üí rivedi nel player ‚Üí <b>Scarica selezionato</b>.</li>
      </ol>
      <div class="muted">Tip: premi <b>ESC</b> per chiudere.</div>
    </div>
  </div>
</div>

<script>
/* ==========================
   DOM helpers
========================== */
const $ = (id) => document.getElementById(id);

/* ==========================
   Question bank (demo)
========================== */
const QUESTION_BANK = [
  "Perch√© ricevo poche chiamate anche se l'annuncio √® online da settimane?",
  "Se arrivano solo curiosi e nessuna proposta, cosa significa?",
  "Come capisco se il prezzo sta bloccando la vendita?",
  "Meglio partire alto e poi scendere o partire subito con il prezzo giusto?",
  "Ha senso provare a vendere da privato oppure rischio solo di perdere tempo?",
  "Se un agente mi chiede l'esclusiva, come capisco se conviene davvero?",
  "Quali sono le fasi reali di una vendita fatta bene, dall'inizio alla firma?",
  "Cosa devo controllare settimana per settimana per capire se la vendita sta andando bene?",
  "Se dopo le visite non succede nulla, qual √® la sequenza corretta per intervenire?"
];
let qIdx = -1;
let currentQuestion = "";

/* ==========================
   Rotation profiles
========================== */
let rotation = ["tiktok","instagram","shorts","facebook"];
let rotIdx = 0;

function refreshProfile(){
  if(!rotation.length){
    $("profileNext").textContent = "‚Äî";
    return;
  }
  rotIdx = rotIdx % rotation.length;
  $("profileNext").textContent = rotation[rotIdx];
}
function advanceProfile(){
  if(!rotation.length) return;
  rotIdx = (rotIdx + 1) % rotation.length;
  refreshProfile();
}

/* ==========================
   Clipboard
========================== */
async function copyText(text){
  const t = String(text || "");
  if(!t.trim()) return false;
  try{
    await navigator.clipboard.writeText(t);
    return true;
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    return true;
  }
}
async function readClipboardText(){
  return await navigator.clipboard.readText(); // requires https/localhost
}

/* ==========================
   Teleprompter
========================== */
let teleSeconds = 105;
let teleRunning = false;
let teleStart = 0;
let teleRAF = null;

function resetTele(){
  $("teleText").style.transform = "translateY(20px)";
}
function startTele(){
  if(teleRunning) return;
  teleRunning = true;
  teleStart = performance.now()/1000;
  tickTele();
}
function stopTele(){
  teleRunning = false;
  if(teleRAF) cancelAnimationFrame(teleRAF);
  teleRAF = null;
}
function restartTele(){
  stopTele();
  resetTele();
  setTimeout(startTele, 120);
}
function tickTele(){
  if(!teleRunning) return;

  const el = $("teleText");
  const now = performance.now()/1000;
  const elapsed = now - teleStart;
  const progress = (elapsed % teleSeconds) / teleSeconds;

  const th = el.scrollHeight || 900;
  const startY = 20;
  const endY = -th - 40;
  const y = startY + (endY - startY) * progress;
  el.style.transform = `translateY(${y}px)`;

  teleRAF = requestAnimationFrame(tickTele);
}
function applyAnswerToTele(text){
  const t = String(text || "").trim();
  if(!t) return false;
  $("teleText").textContent = t;
  resetTele();
  stopTele();
  return true;
}

/* ==========================
   Camera + Canvas render (ZOOM REALE)
========================== */
const camEl = $("camPreview");
const canvas = $("recCanvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

let camStream = null;
let rafCanvas = null;

let zoomValue = 1.1;
function setZoom(v){
  zoomValue = Math.max(1, Math.min(Number(v) || 1, 2.5));
  $("zoomVal").textContent = zoomValue.toFixed(1) + "√ó";
}
$("zoom").addEventListener("input", (e)=> setZoom(e.target.value));
setZoom($("zoom").value);

function drawVideoZoomed(){
  const W = canvas.width, H = canvas.height;

  if(!camEl || camEl.readyState < 2){
    ctx.fillStyle = "black";
    ctx.fillRect(0,0,W,H);
    return;
  }
  const vw = camEl.videoWidth || 1280;
  const vh = camEl.videoHeight || 720;

  const z = zoomValue;
  const srcW = vw / z;
  const srcH = vh / z;
  const srcX = (vw - srcW)/2;
  const srcY = (vh - srcH)/2;

  ctx.drawImage(camEl, srcX, srcY, srcW, srcH, 0, 0, W, H);
}

function startCanvasLoop(){
  function loop(){
    drawVideoZoomed();
    rafCanvas = requestAnimationFrame(loop);
  }
  if(!rafCanvas) loop();
}

async function startCamera(){
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      audio:true,
      video:{ facingMode:"user", width:{ideal:1280}, height:{ideal:720} }
    });
    camEl.srcObject = camStream;
    await new Promise(res => camEl.onloadedmetadata = () => res());
    try{ await camEl.play(); }catch(e){}
    startCanvasLoop();
    return true;
  }catch(err){
    alert("Errore camera/mic: " + err.message);
    return false;
  }
}

async function ensureReady(){
  if(!camStream){
    const ok = await startCamera();
    if(!ok) return false;
  }
  if(!rafCanvas) startCanvasLoop();
  return true;
}

/* ==========================
   Recording
========================== */
let recorder = null;
let chunks = [];
let isRecording = false;

let recStartTs = null;
let recTimerId = null;

function fmtTime(ms){
  const sec = Math.floor(ms/1000);
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function setRecUI(on){
  const dot = $("recDot");
  const label = $("recLabel");
  if(on){
    dot.classList.add("rec");
    label.textContent = "REC";
  }else{
    dot.classList.remove("rec");
    label.textContent = "PRONTO";
    $("recTime").textContent = "00:00";
  }
}
function startRecTimer(){
  recStartTs = Date.now();
  $("recTime").textContent = "00:00";
  recTimerId = setInterval(()=> {
    $("recTime").textContent = fmtTime(Date.now()-recStartTs);
  }, 250);
}
function stopRecTimer(){
  if(recTimerId) clearInterval(recTimerId);
  recTimerId = null;
  recStartTs = null;
}

function nowStamp(){
  const d = new Date();
  const pad2 = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}_${pad2(d.getHours())}-${pad2(d.getMinutes())}-${pad2(d.getSeconds())}`;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

/* List */
let videos = []; // {title, url, blob, name, question, platform}
let selected = -1;

function renderList(){
  const list = $("videoList");
  $("totalCount").textContent = String(videos.length);
  $("videoCount").textContent = "Video: " + String(videos.length);

  if(!videos.length){
    list.innerHTML = `<div class="muted">‚Äî Nessun video ancora</div>`;
    return;
  }
  list.innerHTML = videos.map((v,i)=>{
    const sel = i===selected ? "item selected" : "item";
    const q = (v.question || "").slice(0,90);
    return `
      <div class="${sel}" data-i="${i}">
        <h3>${v.title}</h3>
        <div class="meta">
          <span class="k">${v.platform || "‚Äî"}</span>
          <span class="k">${v.kind}</span>
        </div>
        <div class="muted" style="margin-top:8px">${q}</div>
      </div>
    `;
  }).join("");

  list.querySelectorAll("[data-i]").forEach(el=>{
    el.addEventListener("click", ()=>{
      selected = Number(el.getAttribute("data-i"));
      $("player").src = videos[selected].url;
      $("player").play().catch(()=>{});
      renderList();
    });
  });
}

function startRecording(){
  if(!camStream){ alert("Attiva la camera."); return; }
  if(recorder && recorder.state !== "inactive") return;

  const ans = ($("answerBox").value || "").trim();
  if(!ans){
    alert("Scrivi o incolla una risposta prima di registrare.");
    return;
  }

  // ensure tele shows current answer
  applyAnswerToTele(ans);

  // start teleprompter
  startTele();

  chunks = [];
  const stream = canvas.captureStream(30);
  const audioTrack = camStream.getAudioTracks?.()[0];
  if(audioTrack) stream.addTrack(audioTrack);

  const mimeCandidates = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  const mimeType = mimeCandidates.find(m => MediaRecorder.isTypeSupported(m)) || "";

  recorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
  recorder.ondataavailable = (e)=>{ if(e.data.size) chunks.push(e.data); };

  recorder.onstart = ()=>{
    isRecording = true;
    setRecUI(true);
    startRecTimer();
  };

  const platform = rotation.length ? rotation[rotIdx] : "‚Äî";
  const title = `#${String(videos.length+1).padStart(3,"0")} ‚Ä¢ ${platform} ‚Ä¢ ${nowStamp()}`;
  const name = `video_${String(videos.length+1).padStart(3,"0")}_${platform}_${nowStamp()}.webm`;
  const question = currentQuestion;

  recorder.onstop = ()=>{
    isRecording = false;
    setRecUI(false);
    stopRecTimer();
    stopTele();

    const blob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
    const url = URL.createObjectURL(blob);

    videos.unshift({ title, url, blob, name, question, platform, kind:"recorded" });
    selected = 0;
    $("player").src = url;
    $("player").load();
    renderList();

    advanceProfile();
  };

  recorder.start(1000);
}

function stopRecording(){
  if(recorder && recorder.state !== "inactive") recorder.stop();
}

/* ==========================
   Upload video
========================== */
function addUploadedVideo(file){
  if(!file) return;
  if(!String(file.type || "").startsWith("video/")){
    alert("Seleziona un file video valido.");
    return;
  }
  const url = URL.createObjectURL(file);
  const platform = rotation.length ? rotation[rotIdx] : "‚Äî";
  const title = `#${String(videos.length+1).padStart(3,"0")} ‚Ä¢ ${platform} ‚Ä¢ UPLOAD ‚Ä¢ ${file.name || "video"}`;
  videos.unshift({ title, url, blob:file, name: file.name || ("upload_"+nowStamp()+".mp4"), question: currentQuestion || "Upload", platform, kind:"uploaded" });
  selected = 0;
  $("player").src = url;
  $("player").load();
  renderList();
}

/* ==========================
   UI wiring
========================== */
document.addEventListener("DOMContentLoaded", ()=>{
  // initial
  renderList();
  refreshProfile();
  $("player").removeAttribute("src");

  $("teleSpeed").addEventListener("change", (e)=>{
    teleSeconds = Number(e.target.value) || 105;
  });

  $("profiles").addEventListener("change", (e)=>{
    rotation = String(e.target.value || "").split(",").map(s=>s.trim()).filter(Boolean);
    rotIdx = 0;
    refreshProfile();
  });

  $("btnNewQ").addEventListener("click", ()=>{
    qIdx = (qIdx + 1) % QUESTION_BANK.length;
    currentQuestion = QUESTION_BANK[qIdx];
    $("qOverlay").textContent = currentQuestion;
  });

  $("btnCopyQuestion").addEventListener("click", async ()=>{
    if(!currentQuestion){
      qIdx = (qIdx + 1) % QUESTION_BANK.length;
      currentQuestion = QUESTION_BANK[qIdx];
      $("qOverlay").textContent = currentQuestion;
    }
    await copyText(currentQuestion);
  });

  $("btnPasteAnswer").addEventListener("click", async ()=>{
    try{
      const t = await readClipboardText();
      $("answerBox").value = t || "";
    }catch(e){
      alert("Clipboard bloccata: incolla manualmente.");
    }
  });

  $("btnSendTele").addEventListener("click", ()=>{
    const ok = applyAnswerToTele($("answerBox").value || "");
    if(!ok) alert("Scrivi o incolla una risposta prima.");
  });

  $("btnCamera").addEventListener("click", async ()=>{ await ensureReady(); });

  $("btnTeleRec").addEventListener("click", async ()=>{
    const ok = await ensureReady();
    if(!ok) return;
    if(!currentQuestion){
      qIdx = (qIdx + 1) % QUESTION_BANK.length;
      currentQuestion = QUESTION_BANK[qIdx];
      $("qOverlay").textContent = currentQuestion;
    }
    startRecording();
  });

  $("btnStop").addEventListener("click", ()=> stopRecording());
  $("btnRestartTele").addEventListener("click", ()=> restartTele());

  // download selected
  $("btnDownload").addEventListener("click", ()=>{
    if(selected < 0 || !videos[selected]){
      alert("Seleziona un video dalla lista.");
      return;
    }
    downloadBlob(videos[selected].blob, videos[selected].name);
  });

  // upload
  $("btnUpload").addEventListener("click", ()=> $("fileInput").click());
  $("fileInput").addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) addUploadedVideo(f);
    e.target.value = "";
  });

  // clear
  $("btnClear").addEventListener("click", ()=>{
    if(!videos.length) return;
    if(confirm("Svuotare la lista video?")){
      videos.forEach(v => { try{ URL.revokeObjectURL(v.url); }catch(e){} });
      videos = [];
      selected = -1;
      $("player").removeAttribute("src");
      $("player").load();
      renderList();
      rotIdx = 0;
      refreshProfile();
    }
  });

  // modal
  const modal = $("modal");
  $("btnHelp").addEventListener("click", ()=> modal.style.display = "flex");
  $("btnCloseModal").addEventListener("click", ()=> modal.style.display = "none");
  modal.addEventListener("click", (e)=>{ if(e.target === modal) modal.style.display = "none"; });
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") modal.style.display = "none"; });

  // set default speed
  teleSeconds = Number($("teleSpeed").value) || 105;
});
</script>
</body>
</html>
