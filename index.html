<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Macchina Operativa ‚Äî Step by Step (Verticale)</title>
  <style>
    :root{
      --bg:#070a12; --card:#0b1220; --line:#22304d; --txt:#e9eefc; --muted:#93a4c7;
      --ok:#34d399; --warn:#fbbf24; --bad:#fb7185; --accent:#3c568d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;background:linear-gradient(180deg,#050711 0%, #070a12 60%, #050711 100%);color:var(--txt)}
    header{position:sticky;top:0;z-index:5;background:rgba(7,10,18,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:14px 14px}
    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:12px}
    main{max-width:860px;margin:0 auto;padding:14px}
    .card{background:rgba(11,18,32,.9);border:1px solid var(--line);border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    input,select,textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid #2a3b5f;background:#070c16;color:var(--txt);outline:none
    }
    textarea{min-height:88px;resize:vertical}
    .btn{
      appearance:none;border:1px solid #2a3b5f;background:#070c16;color:var(--txt);
      padding:10px 12px;border-radius:12px;cursor:pointer
    }
    .btn:hover{border-color:#3c568d}
    .btn.primary{background:linear-gradient(180deg,#15264a,#0a1533);border-color:var(--accent)}
    .btn.ok{border-color:rgba(52,211,153,.6)}
    .btn.bad{border-color:rgba(251,113,133,.7)}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#070c16;border-radius:999px;padding:8px 10px;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .mini{color:var(--muted);font-size:12px}
    .step{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .stepHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .stepTitle{font-weight:750}
    .badge{font-size:11px;color:var(--muted);border:1px solid var(--line);padding:4px 8px;border-radius:999px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .timerBox{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .timeBig{font-variant-numeric:tabular-nums;font-size:18px;font-weight:800}
    .toast{position:fixed;right:14px;bottom:14px;background:#070c16;border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:none;z-index:10}
    .successBox{border:1px solid rgba(52,211,153,.35);background:rgba(52,211,153,.08);border-radius:14px;padding:12px}
    .warnBox{border:1px solid rgba(251,191,36,.35);background:rgba(251,191,36,.08);border-radius:14px;padding:12px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#070c16;border:1px solid #243252;color:var(--txt);padding:2px 6px;border-radius:8px;font-size:12px}
  </style>
</head>
<body>
<header>
  <h1>MACCHINA OPERATIVA ‚Äî VERTICALE (CLICK ‚Üí BOOM)</h1>
  <div class="sub">Zero decisioni. Solo operativit√†. Timer incluso. Confronto con ieri + ‚ÄúCheck al capo‚Äù automatico quando migliori.</div>
</header>

<main>
  <!-- CONFIG -->
  <div class="card">
    <div class="row">
      <div style="flex:1;min-width:240px">
        <label>Area</label>
        <select id="area">
          <option>Torino</option>
          <option>Valle di Susa</option>
          <option selected>Torino + Valle di Susa</option>
        </select>
      </div>
      <div style="flex:1;min-width:240px">
        <label>WhatsApp / Telefono (pubblico)</label>
        <input id="phone" placeholder="+39..." />
      </div>
      <div style="flex:1;min-width:240px">
        <label>Link Form (opt-in) / QR</label>
        <input id="formLink" placeholder="https://..." />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="flex:1;min-width:240px">
        <label>Firma (facoltativa)</label>
        <input id="sign" placeholder="Nome Cognome" />
      </div>
      <div style="flex:1;min-width:240px">
        <label>Orari pubblicazione (6 slot)</label>
        <input id="times" value="08:30,11:00,13:30,16:00,18:30,21:00" />
      </div>
      <div style="flex:1;min-width:240px">
        <label>Data start ciclo 3 giorni</label>
        <input id="cycleStart" type="date" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn primary ok" id="save">Salva</button>
      <button class="btn" id="demo">Esempio</button>
      <span class="pill" id="killPill"><span class="dot ok"></span><span id="killTxt">KILL SWITCH: OFF</span></span>
      <button class="btn bad" id="toggleKill">Toggle Kill</button>
    </div>

    <div class="sep"></div>

    <div class="row">
      <span class="pill"><span class="dot warn"></span><span id="cycleLabel">Oggi: Giorno ?</span></span>
      <span class="pill"><span class="dot ok"></span><span id="todayLabel">Oggi: ?</span></span>
      <span class="pill"><span class="dot warn"></span><span id="yesterdayLabel">Ieri: ?</span></span>
    </div>

    <div class="sep"></div>

    <!-- DAILY TOTAL TIMER -->
    <div class="step">
      <div class="stepHead">
        <div>
          <div class="stepTitle">TIMER GIORNATA (totale)</div>
          <div class="mini">Start quando inizi. Stop quando hai schedulato tutto + copiato teleprompter.</div>
        </div>
        <span class="badge" id="totalStatus">IN ATTESA</span>
      </div>

      <div class="timerBox">
        <div class="timeBig" id="totalTime">00:00:00</div>
        <div class="actions">
          <button class="btn primary" id="startTotal">START</button>
          <button class="btn" id="stopTotal">STOP</button>
          <button class="btn" id="resetTotal">RESET</button>
        </div>
        <span class="pill"><span class="dot ok"></span><span id="challengeText">Oggi riuscirai a fare meglio?</span></span>
      </div>

      <div id="improveBox" style="display:none" class="successBox">
        <div style="font-weight:800">‚úÖ MIGLIORAMENTO RILEVATO ‚Üí CHECK AL CAPO (AUTOMATICO)</div>
        <div class="mini" id="improveMsg" style="margin-top:6px"></div>
        <div class="actions" style="margin-top:10px">
          <button class="btn ok" id="copyCapoMsg">Copia messaggio ‚ÄúCheck al capo‚Äù</button>
        </div>
      </div>

      <div id="noImproveBox" style="display:none" class="warnBox">
        <div style="font-weight:800">üü° Oggi non hai migliorato (ancora)</div>
        <div class="mini" id="noImproveMsg" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <!-- STEPS (VERTICAL, CLICK->BOOM) -->
  <div class="card" style="margin-top:12px">
    <div class="step">
      <div class="stepHead">
        <div>
          <div class="stepTitle">STEP 1 ‚Äî APRI CHATGPT ‚Üí COPIA & INCOLLA ‚Üí BOOM (testi + teleprompter)</div>
          <div class="mini">Click ‚ÄúCopia prompt‚Äù ‚Üí incolla in ChatGPT ‚Üí copia output.</div>
        </div>
        <span class="badge">CLICK ‚Üí BOOM</span>
      </div>
      <div class="actions">
        <button class="btn primary" id="copyChatGPT">Copia prompt ChatGPT</button>
      </div>
      <pre id="promptChatGPT" style="margin:0"></pre>
    </div>

    <div class="sep"></div>

    <div class="step">
      <div class="stepHead">
        <div>
          <div class="stepTitle">STEP 2 ‚Äî APRI CANVA IA ‚Üí INCOLLA PROMPT (EN) ‚Üí BOOM (layout)</div>
          <div class="mini">Canva AI / Magic Design ‚Üí prompt EN ‚Üí esporta.</div>
        </div>
        <span class="badge">CLICK ‚Üí BOOM</span>
      </div>
      <div class="actions">
        <button class="btn primary" id="copyCanva">Copia prompt Canva (EN)</button>
      </div>
      <pre id="promptCanva" style="margin:0"></pre>
    </div>

    <div class="sep"></div>

    <div class="step">
      <div class="stepHead">
        <div>
          <div class="stepTitle">STEP 3 ‚Äî APRI LATER ‚Üí SCHEDULA 6 POST (rotazione 3 giorni)</div>
          <div class="mini">Click ‚ÄúApri Later‚Äù ‚Üí incolla piano orari+canali ‚Üí schedula.</div>
        </div>
        <span class="badge">CLICK ‚Üí BOOM</span>
      </div>
      <div class="actions">
        <button class="btn primary" id="openLater">Apri Later</button>
        <button class="btn" id="copyLaterPlan">Copia piano per Later</button>
      </div>
      <pre id="laterPlan" style="margin:0"></pre>
      <div class="mini">Later URL: <span class="kbd">https://app.later.com/9H8EZ/schedule/calendar</span></div>
    </div>

    <div class="sep"></div>

    <div class="step">
      <div class="stepHead">
        <div>
          <div class="stepTitle">STEP 4 ‚Äî TELEPROMPTER (CapCut) ‚Üí COPIA TESTO ‚Üí BOOM (registri)</div>
          <div class="mini">Incolla qui l‚Äôoutput di ChatGPT (sezione TELEPROMPTER_1..6) ‚Üí Split ‚Üí ‚ÄúCopia per CapCut‚Äù.</div>
        </div>
        <span class="badge">CLICK ‚Üí BOOM</span>
      </div>

      <label>Incolla output ChatGPT (tutto)</label>
      <textarea id="raw" placeholder="Incolla qui l'output completo di ChatGPT..."></textarea>

      <div class="actions">
        <button class="btn primary" id="split">SPLIT TELEPROMPTER (1..6)</button>
      </div>

      <div class="sep"></div>

      <!-- Recording timer (optional) -->
      <div class="stepHead">
        <div>
          <div class="stepTitle">TIMER REGISTRAZIONE (CapCut)</div>
          <div class="mini">Start quando inizi a registrare. Stop quando hai finito il 6¬∞ video.</div>
        </div>
        <span class="badge" id="recStatus">IN ATTESA</span>
      </div>
      <div class="timerBox">
        <div class="timeBig" id="recTime">00:00:00</div>
        <div class="actions">
          <button class="btn primary" id="startRec">START</button>
          <button class="btn" id="stopRec">STOP</button>
          <button class="btn" id="resetRec">RESET</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div style="flex:1;min-width:260px" class="card">
          <label>TELEPROMPTER 1</label><textarea id="tp1"></textarea>
          <div class="actions"><button class="btn ok" onclick="copyVal('tp1')">Copia (CapCut)</button></div>
        </div>
        <div style="flex:1;min-width:260px" class="card">
          <label>TELEPROMPTER 2</label><textarea id="tp2"></textarea>
          <div class="actions"><button class="btn ok" onclick="copyVal('tp2')">Copia (CapCut)</button></div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:260px" class="card">
          <label>TELEPROMPTER 3</label><textarea id="tp3"></textarea>
          <div class="actions"><button class="btn ok" onclick="copyVal('tp3')">Copia (CapCut)</button></div>
        </div>
        <div style="flex:1;min-width:260px" class="card">
          <label>TELEPROMPTER 4</label><textarea id="tp4"></textarea>
          <div class="actions"><button class="btn ok" onclick="copyVal('tp4')">Copia (CapCut)</button></div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1;min-width:260px" class="card">
          <label>TELEPROMPTER 5</label><textarea id="tp5"></textarea>
          <div class="actions"><button class="btn ok" onclick="copyVal('tp5')">Copia (CapCut)</button></div>
        </div>
        <div style="flex:1;min-width:260px" class="card">
          <label>TELEPROMPTER 6</label><textarea id="tp6"></textarea>
          <div class="actions"><button class="btn ok" onclick="copyVal('tp6')">Copia (CapCut)</button></div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast">Copiato ‚úÖ</div>
</main>

<script>
  const $ = (id)=>document.getElementById(id);
  const LATER_URL = "https://app.later.com/9H8EZ/schedule/calendar";

  // 6 canali ‚Äî in 3 giorni giri tutto con pattern fisso
  const CHANNELS = [
    "Instagram Reels",
    "Facebook Reels",
    "TikTok",
    "YouTube Shorts",
    "LinkedIn",
    "Facebook Gruppi (post informativo)"
  ];
  const ROTATION = {
    1: [0,1,2,3,4,5],
    2: [2,3,4,5,0,1],
    3: [4,5,0,1,2,3],
  };
  const ASSETS = [
    "Video (Teleprompter 1)",
    "Video (Teleprompter 2)",
    "Video (Teleprompter 3)",
    "Video (Teleprompter 4)",
    "Video (Teleprompter 5)",
    "Video (Teleprompter 6)"
  ];

  const state = {
    kill:false,
    totalTimer: { running:false, start:0, elapsed:0, raf:null },
    recTimer:   { running:false, start:0, elapsed:0, raf:null },
  };

  const STORAGE_KEY = "macchina_vertical_v1";
  function pad(n){return String(n).padStart(2,"0")}
  function todayISO(){
    const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function yesterdayISO(){
    const d=new Date(); d.setDate(d.getDate()-1);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function fmt(ms){
    const s=Math.floor(ms/1000);
    const hh=Math.floor(s/3600);
    const mm=Math.floor((s%3600)/60);
    const ss=s%60;
    return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
  }
  function toast(msg){
    const el=$("toast"); el.textContent=msg; el.style.display="block";
    clearTimeout(window.__t); window.__t=setTimeout(()=>el.style.display="none",1100);
  }
  async function copyText(t){ await navigator.clipboard.writeText(t); toast("Copiato ‚úÖ"); }
  function copyVal(id){ copyText($(id).value||""); }

  function load(){
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    $("area").value = saved.area || "Torino + Valle di Susa";
    $("phone").value = saved.phone || "";
    $("formLink").value = saved.formLink || "";
    $("sign").value = saved.sign || "";
    $("times").value = saved.times || "08:30,11:00,13:30,16:00,18:30,21:00";
    if (saved.cycleStart) $("cycleStart").value = saved.cycleStart;
    if (!$("cycleStart").value) $("cycleStart").valueAsDate = new Date();
    state.kill = !!saved.kill;

    // restore today elapsed (if any)
    if (saved.dayTimes && saved.dayTimes[todayISO()]){
      state.totalTimer.elapsed = saved.dayTimes[todayISO()].totalElapsed || 0;
      state.recTimer.elapsed = saved.dayTimes[todayISO()].recElapsed || 0;
    }

    renderKill();
    renderCycle();
    renderPrompts();
    renderLaterPlan();
    updateTotalsUI();
    updateChallenge();
  }

  function save(){
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    saved.area = $("area").value;
    saved.phone = $("phone").value.trim();
    saved.formLink = $("formLink").value.trim();
    saved.sign = $("sign").value.trim();
    saved.times = $("times").value.trim();
    saved.cycleStart = $("cycleStart").value;
    saved.kill = state.kill;

    // persist per-day timings
    saved.dayTimes = saved.dayTimes || {};
    const t = todayISO();
    saved.dayTimes[t] = saved.dayTimes[t] || {};
    saved.dayTimes[t].totalElapsed = state.totalTimer.elapsed;
    saved.dayTimes[t].recElapsed = state.recTimer.elapsed;

    localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
  }

  function demo(){
    $("area").value="Torino + Valle di Susa";
    $("phone").value="+39 3XX XXX XXXX";
    $("formLink").value="https://forms.gle/tuo-link";
    $("sign").value="Nome Cognome";
    $("times").value="08:30,11:00,13:30,16:00,18:30,21:00";
    $("cycleStart").valueAsDate=new Date();
    save(); renderPrompts(); renderLaterPlan(); renderCycle(); toast("Esempio ‚úÖ");
  }

  function toggleKill(){
    state.kill = !state.kill;
    save(); renderKill(); renderPrompts(); toast(state.kill ? "KILL ON üõë" : "KILL OFF ‚úÖ");
  }
  function renderKill(){
    const pill=$("killPill"); const dot=pill.querySelector(".dot"); const txt=$("killTxt");
    if (state.kill){
      dot.className="dot bad"; txt.textContent="KILL SWITCH: ON (STOP)";
    } else {
      dot.className="dot ok"; txt.textContent="KILL SWITCH: OFF";
    }
  }

  function cycleDay(){
    const startStr=$("cycleStart").value;
    const start=new Date((startStr||todayISO())+"T00:00:00");
    const now=new Date(); const t=new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const diffDays=Math.floor((t-start)/(1000*60*60*24));
    const idx=((diffDays%3)+3)%3;
    return idx+1;
  }
  function parseTimes(){
    const parts=($("times").value||"").split(",").map(s=>s.trim()).filter(Boolean);
    while(parts.length<6) parts.push("00:00");
    return parts.slice(0,6);
  }
  function renderCycle(){
    const d=cycleDay();
    $("cycleLabel").textContent=`Oggi: Giorno ${d} (ciclo 3 giorni)`;
    $("todayLabel").textContent=`Oggi: ${todayISO()}`;
    $("yesterdayLabel").textContent=`Ieri: ${yesterdayISO()}`;
  }

  function renderPrompts(){
    const area=$("area").value;
    const phone=$("phone").value.trim() || "[WHATSAPP]";
    const form=$("formLink").value.trim() || "[FORM]";
    const sign=$("sign").value.trim() || "[FIRMA]";
    const times=parseTimes().join(", ");
    const d=cycleDay();

    const promptChatGPT = `
Sei una IA centrale per acquisizione immobiliare.
DEVI generare SOLO testi in ITALIANO pronti da incollare.
Area: ${area}
Data: ${todayISO()}
Ciclo pubblicazioni: Giorno ${d} (3 giorni, 6 post/giorno)
Orari (Europe/Rome): ${times}

VINCOLI (OBBLIGATORI):
- zero vendita aggressiva
- zero promesse o prezzi
- zero contatto a freddo
- solo inbound e consenso (GDPR)
- CTA soft (sempre): "Checklist gratuita: ${form} oppure WhatsApp ${phone}"

GENERA SOLO QUESTO (OUTPUT SECCO, NO SPIEGAZIONI):

1) TELEPROMPTER_1 ... TELEPROMPTER_6 (6 script)
- Durata: 35‚Äì55 secondi ciascuno
- Hook 1 frase + 2-3 punti + CTA soft finale
- Linguaggio parlato, naturale
- Ogni script tema diverso, stesso stile
- Nessuna parentesi, nessuna regia

2) POST_CAPTION_1 ... POST_CAPTION_6 (6 didascalie)
- Max 80 parole ciascuna
- Coerenti con i rispettivi teleprompter
- CTA soft finale

3) VOLANTINO_AL_RESIDENTE (max 120 parole) con CTA (QR/form + WhatsApp)

4) LETTERA_AL_RESIDENTE (max 180 parole), chiusura con firma: ${sign}

5) INBOX_REPLY_CONSENSO (S√¨/No), tono naturale
`.trim();

    const promptCanva = `
Vertical, easy-to-understand, step-by-step layout.
Clean and minimal real estate design.
White background, neutral colors, modern sans-serif.
Create 2 vertical templates:
A) A4 vertical flyer (headline + 3 bullet steps + QR placeholder + contacts)
B) 1080x1920 vertical story/reel cover (headline + 3 steps + QR/CTA area)
No luxury, no sales tone. Local community feel.
`.trim();

    $("promptChatGPT").textContent = promptChatGPT;
    $("promptCanva").textContent = promptCanva;
  }

  function renderLaterPlan(){
    const d=cycleDay();
    const times=parseTimes();
    const map=ROTATION[d];
    const lines=[];
    lines.push(`PIANO OGGI ‚Äî Giorno ${d} (ciclo 3 giorni) ‚Äî ${todayISO()}`);
    for(let i=0;i<6;i++){
      lines.push(`${times[i]} ‚Äî ${CHANNELS[map[i]]} ‚Äî ${ASSETS[i]}`);
    }
    lines.push("");
    lines.push(`CTA: ${$("formLink").value.trim()||"[FORM]"} | WhatsApp: ${$("phone").value.trim()||"[WHATSAPP]"}`);
    $("laterPlan").textContent = lines.join("\n");
  }

  // ---------- Timers ----------
  function tick(timer, labelEl){
    const now=Date.now();
    const elapsed = timer.elapsed + (timer.running ? (now - timer.start) : 0);
    labelEl.textContent = fmt(elapsed);
    timer.raf = requestAnimationFrame(()=>tick(timer,labelEl));
  }
  function startTimer(timer, labelEl, statusEl, statusText){
    if (timer.running) return;
    timer.running=true;
    timer.start=Date.now();
    statusEl.textContent = statusText || "IN CORSO";
    tick(timer,labelEl);
    toast("START ‚úÖ");
  }
  function stopTimer(timer, labelEl, statusEl, statusText){
    if (!timer.running) return;
    const now=Date.now();
    timer.elapsed += (now - timer.start);
    timer.running=false;
    cancelAnimationFrame(timer.raf);
    labelEl.textContent = fmt(timer.elapsed);
    statusEl.textContent = statusText || "FERMO";
    save();
    toast("STOP ‚úÖ");
  }
  function resetTimer(timer, labelEl, statusEl){
    timer.running=false;
    timer.start=0;
    timer.elapsed=0;
    cancelAnimationFrame(timer.raf);
    labelEl.textContent="00:00:00";
    statusEl.textContent="IN ATTESA";
    save();
    toast("RESET ‚úÖ");
  }

  function updateTotalsUI(){
    $("totalTime").textContent = fmt(state.totalTimer.elapsed + (state.totalTimer.running ? (Date.now()-state.totalTimer.start) : 0));
    $("recTime").textContent = fmt(state.recTimer.elapsed + (state.recTimer.running ? (Date.now()-state.recTimer.start) : 0));
  }

  function getSavedDayTime(day){
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    return saved.dayTimes?.[day]?.totalElapsed || 0;
  }

  function updateChallenge(){
    const y = getSavedDayTime(yesterdayISO());
    const t = state.totalTimer.elapsed;
    const challenge = y > 0
      ? `Ieri hai fatto ${fmt(y)}. Oggi riuscirai a fare meglio?`
      : `Nessun tempo salvato ieri. Oggi imposta il tuo baseline.`;
    $("challengeText").textContent = challenge;

    // improvement check (only when today stopped and yesterday exists)
    const improveBox = $("improveBox");
    const noImproveBox = $("noImproveBox");
    improveBox.style.display="none";
    noImproveBox.style.display="none";

    if (y > 0 && t > 0){
      if (t < y){
        const delta = y - t;
        $("improveMsg").textContent = `Oggi: ${fmt(t)} ‚Ä¢ Ieri: ${fmt(y)} ‚Ä¢ Miglioramento: -${fmt(delta)}.`;
        improveBox.style.display="block";
      } else {
        const delta = t - y;
        $("noImproveMsg").textContent = `Oggi: ${fmt(t)} ‚Ä¢ Ieri: ${fmt(y)} ‚Ä¢ Peggioramento: +${fmt(delta)}.`;
        noImproveBox.style.display="block";
      }
    }
  }

  function buildCapoMessage(){
    const y = getSavedDayTime(yesterdayISO());
    const t = state.totalTimer.elapsed;
    const area = $("area").value;
    const delta = y - t;
    return `CHECK AL CAPO ‚úÖ
Area: ${area}
Oggi: ${fmt(t)}
Ieri: ${fmt(y)}
Miglioramento: -${fmt(delta)} (tempo produzione)
Note: 6 pubblicazioni schedulate + teleprompter pronto.`;
  }

  // ---------- Teleprompter split ----------
  function splitTeleprompter(){
    const raw=($("raw").value||"").trim();
    if(!raw){ toast("Incolla l‚Äôoutput ChatGPT"); return; }

    const getSection=(n)=>{
      const re=new RegExp(`TELEPROMPTER_${n}\\s*[:\\-]?\\s*([\\s\\S]*?)(?=\\n\\s*TELEPROMPTER_\\d\\s*[:\\-]?|\\n\\s*POST_CAPTION_\\d\\s*[:\\-]?|$)`,"i");
      const m=raw.match(re);
      return m ? m[1].trim() : "";
    };

    $("tp1").value=getSection(1);
    $("tp2").value=getSection(2);
    $("tp3").value=getSection(3);
    $("tp4").value=getSection(4);
    $("tp5").value=getSection(5);
    $("tp6").value=getSection(6);

    toast("Split ‚úÖ");
  }

  // ---------- Buttons ----------
  $("save").addEventListener("click", ()=>{ save(); renderPrompts(); renderLaterPlan(); renderCycle(); updateChallenge(); toast("Salvato ‚úÖ"); });
  $("demo").addEventListener("click", demo);
  $("toggleKill").addEventListener("click", toggleKill);

  $("copyChatGPT").addEventListener("click", ()=>copyText($("promptChatGPT").textContent));
  $("copyCanva").addEventListener("click", ()=>copyText($("promptCanva").textContent));

  $("openLater").addEventListener("click", ()=>window.open(LATER_URL,"_blank","noopener,noreferrer"));
  $("copyLaterPlan").addEventListener("click", ()=>copyText($("laterPlan").textContent));

  $("split").addEventListener("click", splitTeleprompter);

  // timers
  $("startTotal").addEventListener("click", ()=>{
    if(state.kill){ toast("KILL ON: solo bozze"); }
    startTimer(state.totalTimer, $("totalTime"), $("totalStatus"), "IN CORSO");
  });
  $("stopTotal").addEventListener("click", ()=>{
    stopTimer(state.totalTimer, $("totalTime"), $("totalStatus"), "FERMO");
    updateChallenge();
  });
  $("resetTotal").addEventListener("click", ()=>{
    resetTimer(state.totalTimer, $("totalTime"), $("totalStatus"));
    updateChallenge();
  });

  $("startRec").addEventListener("click", ()=>startTimer(state.recTimer, $("recTime"), $("recStatus"), "REGISTRAZIONE"));
  $("stopRec").addEventListener("click", ()=>{ stopTimer(state.recTimer, $("recTime"), $("recStatus"), "FERMO"); save(); });
  $("resetRec").addEventListener("click", ()=>resetTimer(state.recTimer, $("recTime"), $("recStatus")));

  $("copyCapoMsg").addEventListener("click", ()=>copyText(buildCapoMessage()));

  // live updates
  ["area","phone","formLink","sign","times","cycleStart"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ renderPrompts(); renderLaterPlan(); renderCycle(); });
    $(id).addEventListener("change", ()=>{ renderPrompts(); renderLaterPlan(); renderCycle(); });
  });

  // init
  load();
</script>
</body>
</html>
