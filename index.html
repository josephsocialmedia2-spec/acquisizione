<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vertical Creator Studio (9:16) + Teleprompter</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --card:#11172a;
      --muted:#97a3b6;
      --text:#e9eef7;
      --acc:#7c5cff;
      --good:#3ddc97;
      --bad:#ff4d6d;
      --warn:#ffcc66;
      --line: rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(61,220,151,.15), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 18px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0; background: rgba(11,15,26,.85); backdrop-filter: blur(10px);
      z-index:10;
    }
    header .title{display:flex; gap:10px; align-items:center}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      background: rgba(255,255,255,.04); color:var(--muted); font-size:12px;
    }
    .dot{width:8px; height:8px; border-radius:999px; background: var(--good); box-shadow:0 0 0 4px rgba(61,220,151,.15)}
    main{
      padding:18px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      max-width: 1320px;
      margin:0 auto;
    }
    @media (max-width: 1050px){
      main{grid-template-columns: 1fr; }
    }
    .card{
      background: rgba(17,23,42,.75);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 10px; font-size:14px; letter-spacing:.2px; color: #cfe0ff}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input[type="text"], textarea, select{
      width:100%;
      background: rgba(255,255,255,.04);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      font-weight:600;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button:active{transform: scale(.98)}
    .primary{background: rgba(124,92,255,.22); border-color: rgba(124,92,255,.35)}
    .danger{background: rgba(255,77,109,.18); border-color: rgba(255,77,109,.35)}
    .good{background: rgba(61,220,151,.16); border-color: rgba(61,220,151,.35)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color: var(--muted);
      user-select:none;
    }
    .pill strong{color:var(--text)}
    .split{
      display:grid; grid-template-columns: 1fr; gap:12px;
    }
    .previewWrap{
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 1050px){
      .previewWrap{grid-template-columns: 1fr;}
    }
    .phone{
      width: 360px; max-width: 100%;
      aspect-ratio: 9 / 16;
      border-radius: 26px;
      overflow:hidden;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.35);
      position: relative;
      box-shadow: 0 20px 80px rgba(0,0,0,.35);
    }
    .phone video, .phone canvas{
      width:100%; height:100%;
      display:block;
      object-fit: cover;
    }
    .phone .overlayHint{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color: rgba(233,238,247,.75);
      text-align:center; padding:18px;
      background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.15) 40%, rgba(0,0,0,.35));
      pointer-events:none;
      font-size:13px;
    }
    .status{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }
    .tiny{font-size:12px; color:var(--muted)}
    .hr{height:1px; background: var(--line); margin:12px 0}
    .list{
      display:grid; gap:10px;
    }
    .item{
      display:grid; grid-template-columns: 110px 1fr; gap:10px;
      padding:10px; border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      align-items:center;
    }
    .thumb{
      width:110px; aspect-ratio: 9/16; border-radius: 12px;
      background: rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      color: rgba(233,238,247,.55);
      font-size:12px;
      border:1px solid var(--line);
      overflow:hidden;
      position:relative;
    }
    .item h3{margin:0; font-size:13px}
    .meta{font-size:12px; color:var(--muted); margin-top:4px}
    .item .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .modal{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.65);
      z-index:999;
      padding:16px;
    }
    .modal.open{display:flex}
    .modal .panel{
      width:min(1000px, 100%);
      background: rgba(17,23,42,.92);
      border:1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 30px 100px rgba(0,0,0,.45);
    }
    .panelHead{
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid var(--line);
    }
    .panelBody{padding:14px; display:grid; grid-template-columns: 360px 1fr; gap:14px}
    @media (max-width: 900px){ .panelBody{grid-template-columns:1fr} }
    .panelBody video{width:100%; aspect-ratio: 9/16; border-radius: 16px; border:1px solid var(--line); background:black}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:11px; color: rgba(233,238,247,.8)}
  </style>
</head>
<body>
<header>
  <div class="title">
    <div style="width:34px;height:34px;border-radius:12px;background:rgba(124,92,255,.25);border:1px solid rgba(124,92,255,.35);display:flex;align-items:center;justify-content:center;">
      üé¨
    </div>
    <div>
      <div style="font-weight:800; letter-spacing:.2px">Vertical Creator Studio</div>
      <div class="tiny">Idea ‚Üí domanda ‚Üí teleprompter ‚Üí registrazione ‚Üí libreria ‚Üí download</div>
    </div>
  </div>
  <div class="badge" title="Stato dispositivo">
    <span class="dot" id="dot"></span>
    <span id="deviceStatus">Pronto (non connesso)</span>
  </div>
</header>

<main>
  <!-- LEFT: Controls -->
  <section class="card">
    <h2>1) Setup contenuto</h2>

    <div class="row">
      <span class="pill">Canale: <strong id="channelNow">TikTok</strong></span>
      <button id="btnRotate" title="Ruota al prossimo canale">Ruota canale</button>
      <button id="btnResetRotation" title="Torna al primo canale">Reset</button>
    </div>

    <label>Domanda (preset / Q&A)</label>
    <div class="row">
      <select id="presetSelect" style="flex:1">
        <!-- filled by JS -->
      </select>
      <button id="btnNewQuestion" class="primary">Genera</button>
    </div>

    <label>Domanda corrente (overlay a schermo)</label>
    <input id="questionInput" type="text" placeholder="Es: Qual √® l‚Äôerrore n.1 quando si vende casa?" />

    <label>Risposta (diventa teleprompter)</label>
    <textarea id="answerInput" placeholder="Scrivi qui la tua risposta: verr√† trasformata in teleprompter che scorre mentre registri."></textarea>

    <div class="grid2">
      <div>
        <label>Durata teleprompter</label>
        <select id="speedSelect">
          <option value="90">90 sec</option>
          <option value="105" selected>105 sec</option>
          <option value="120">120 sec</option>
        </select>
      </div>
      <div>
        <label>Dimensione testo</label>
        <select id="fontSizeSelect">
          <option value="28">Grande</option>
          <option value="24" selected>Media</option>
          <option value="20">Piccola</option>
        </select>
      </div>
    </div>

    <div class="hr"></div>

    <h2>2) Caption + hashtag</h2>
    <label>Caption (auto-hashtag inclusi)</label>
    <textarea id="captionInput" placeholder="Esempio: 3 cose che nessuno ti dice prima di comprare casa‚Ä¶"></textarea>
    <div class="row">
      <button id="btnAutoCaption">Genera hashtag</button>
      <button id="btnCopyCaption">Copia</button>
    </div>

    <div class="hr"></div>

    <h2>3) Registrazione</h2>
    <div class="row">
      <button id="btnConnect" class="good">Connetti webcam</button>
      <button id="btnStart" class="primary">REC + Teleprompter</button>
      <button id="btnStop" class="danger" disabled>Stop</button>
    </div>

    <div class="status">
      <span class="pill">Formato: <strong>9:16</strong></span>
      <span class="pill">Risoluzione: <strong>720√ó1280</strong></span>
      <span class="pill">FPS: <strong>30</strong></span>
      <span class="pill">Codec: <strong id="codecLabel">auto</strong></span>
    </div>

    <p class="tiny" style="margin-top:10px">
      Suggerimento: metti il telefono/laptop a circa 60‚Äì90cm, guarda la lente e parla ‚Äúsopra‚Äù il testo.
      Shortcut: <span class="kbd">Space</span> start/stop (quando connesso).
    </p>

    <div class="hr"></div>

    <h2>4) Upload manuale</h2>
    <div class="row">
      <input id="uploadInput" type="file" accept="video/*" />
      <button id="btnImport">Importa in libreria</button>
    </div>
    <p class="tiny">Carica video gi√† registrati e gestiscili insieme a quelli creati qui.</p>
  </section>

  <!-- RIGHT: Preview + Library -->
  <section class="split">
    <div class="card">
      <h2>Anteprima (come verr√† registrato)</h2>
      <div class="previewWrap">
        <div class="phone">
          <video id="cam" playsinline muted></video>
          <canvas id="recCanvas" width="720" height="1280" style="display:none"></canvas>
          <div class="overlayHint" id="hint">
            Connetti la webcam per vedere l‚Äôanteprima.<br><br>
            Poi premi <b>REC + Teleprompter</b>.
          </div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between">
            <div class="pill">Teleprompter: <strong id="tpState">idle</strong></div>
            <div class="pill">Tempo: <strong id="timer">00:00</strong></div>
          </div>

          <label>Preview teleprompter (testo che scorre)</label>
          <div class="card" style="padding:12px; background: rgba(0,0,0,.22)">
            <div id="tpPreview" style="height:280px; overflow:hidden; position:relative; border:1px dashed rgba(255,255,255,.12); border-radius:14px; padding:10px;">
              <div id="tpPreviewInner" style="position:absolute; left:0; right:0; top:0; white-space:pre-wrap; line-height:1.25; font-size:24px; color:rgba(233,238,247,.92);"></div>
            </div>
            <p class="tiny" style="margin:10px 0 0">
              Questo √® solo un‚Äôanteprima: in registrazione il testo verr√† sovrapposto al video.
            </p>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btnQuickFill">Template risposta (educational)</button>
            <button id="btnClear">Pulisci campi</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h2 style="margin:0">Libreria video</h2>
        <div class="row">
          <button id="btnRefresh">Aggiorna</button>
          <button id="btnWipe" class="danger" title="Cancella tutti i video salvati">Svuota</button>
        </div>
      </div>
      <p class="tiny" style="margin-top:8px">I video vengono salvati in locale (IndexedDB). Nessun upload automatico.</p>
      <div class="list" id="library"></div>
      <div class="tiny" id="libraryEmpty" style="display:none; padding:12px; border:1px dashed rgba(255,255,255,.12); border-radius:14px;">
        Nessun video ancora. Registra il primo e comparir√† qui ‚ú®
      </div>
    </div>
  </section>
</main>

<!-- Modal player -->
<div class="modal" id="modal">
  <div class="panel">
    <div class="panelHead">
      <div>
        <div style="font-weight:800" id="modalTitle">Video</div>
        <div class="tiny" id="modalMeta"></div>
      </div>
      <div class="row">
        <button id="modalDownload" class="primary">Scarica</button>
        <button id="modalClose">Chiudi</button>
      </div>
    </div>
    <div class="panelBody">
      <video id="modalVideo" controls playsinline></video>
      <div>
        <h3 style="margin:0 0 8px; font-size:14px; color:#cfe0ff">Dati contenuto</h3>
        <div class="card" style="background: rgba(0,0,0,.18)">
          <div class="tiny" style="margin-bottom:6px">Domanda</div>
          <div id="modalQ" style="white-space:pre-wrap; line-height:1.35"></div>
          <div class="hr"></div>
          <div class="tiny" style="margin-bottom:6px">Caption</div>
          <div id="modalCap" style="white-space:pre-wrap; line-height:1.35"></div>
          <div class="hr"></div>
          <div class="row">
            <span class="pill">Canale: <strong id="modalChan"></strong></span>
            <span class="pill">Durata TP: <strong id="modalDur"></strong></span>
          </div>
          <div style="margin-top:10px" class="row">
            <button id="modalCopyCaption">Copia caption</button>
            <button id="modalDelete" class="danger">Elimina</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ---------- Preset domande ----------
  const PRESETS = [
    "Qual √® l‚Äôerrore n.1 che vedi fare pi√π spesso nel tuo settore?",
    "Se potessi dare 1 consiglio a chi inizia oggi, quale sarebbe?",
    "Quali sono 3 falsi miti che la gente crede su questo tema?",
    "Come si evita l‚Äôerrore pi√π comune in 30 secondi?",
    "La tua checklist in 5 step per ottenere un risultato migliore.",
    "Cosa avresti voluto sapere 5 anni fa su questo argomento?",
    "Esempio pratico: racconta un caso reale (senza dati sensibili).",
    "Domanda rapida: vale la pena fare X? Dipende: spiega quando s√¨/no.",
    "Qual √® la differenza tra chi ottiene risultati e chi no?",
    "3 segnali che stai facendo bene (o male) in questo processo."
  ];

  const CHANNELS = ["TikTok", "Instagram", "Shorts", "Facebook"];

  // ---------- UI refs ----------
  const el = (id) => document.getElementById(id);
  const presetSelect = el("presetSelect");
  const btnNewQuestion = el("btnNewQuestion");
  const questionInput = el("questionInput");
  const answerInput = el("answerInput");
  const speedSelect = el("speedSelect");
  const fontSizeSelect = el("fontSizeSelect");
  const captionInput = el("captionInput");
  const btnAutoCaption = el("btnAutoCaption");
  const btnCopyCaption = el("btnCopyCaption");
  const btnConnect = el("btnConnect");
  const btnStart = el("btnStart");
  const btnStop = el("btnStop");
  const btnRotate = el("btnRotate");
  const btnResetRotation = el("btnResetRotation");
  const channelNow = el("channelNow");
  const cam = el("cam");
  const canvas = el("recCanvas");
  const hint = el("hint");
  const deviceStatus = el("deviceStatus");
  const dot = el("dot");
  const tpPreviewInner = el("tpPreviewInner");
  const tpState = el("tpState");
  const timerEl = el("timer");
  const codecLabel = el("codecLabel");
  const library = el("library");
  const libraryEmpty = el("libraryEmpty");
  const btnRefresh = el("btnRefresh");
  const btnWipe = el("btnWipe");
  const btnQuickFill = el("btnQuickFill");
  const btnClear = el("btnClear");
  const uploadInput = el("uploadInput");
  const btnImport = el("btnImport");

  // Modal
  const modal = el("modal");
  const modalClose = el("modalClose");
  const modalVideo = el("modalVideo");
  const modalTitle = el("modalTitle");
  const modalMeta = el("modalMeta");
  const modalQ = el("modalQ");
  const modalCap = el("modalCap");
  const modalChan = el("modalChan");
  const modalDur = el("modalDur");
  const modalDownload = el("modalDownload");
  const modalCopyCaption = el("modalCopyCaption");
  const modalDelete = el("modalDelete");

  // ---------- State ----------
  let mediaStream = null;       // webcam stream
  let audioStream = null;       // mic-only stream (we'll reuse same getUserMedia)
  let recorder = null;
  let chunks = [];
  let recording = false;

  let rafId = null;
  let drawId = null;

  // teleprompter state
  let tpStart = 0;
  let tpDuration = 105; // seconds
  let tpOffsetY = 0;
  let tpTextHeight = 0;
  let tpRunning = false;

  // channel rotation persisted
  const ROT_KEY = "vcs_channel_index";
  let channelIndex = parseInt(localStorage.getItem(ROT_KEY) || "0", 10);
  if (isNaN(channelIndex) || channelIndex < 0) channelIndex = 0;

  // ---------- IndexedDB ----------
  const DB_NAME = "vertical_creator_studio";
  const DB_VER = 1;
  const STORE = "videos";

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)){
          const os = db.createObjectStore(STORE, { keyPath: "id" });
          os.createIndex("createdAt", "createdAt", { unique:false });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function dbPut(record){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).put(record);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }

  async function dbGetAll(){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readonly");
      const req = tx.objectStore(STORE).getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  }

  async function dbDelete(id){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).delete(id);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }

  async function dbClear(){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).clear();
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }

  // ---------- Helpers ----------
  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(sec){
    const m = Math.floor(sec/60);
    const s = Math.floor(sec%60);
    return `${pad2(m)}:${pad2(s)}`;
  }
  function nowISO(){ return new Date().toISOString(); }
  function niceDate(iso){
    const d = new Date(iso);
    return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }

  function setStatus(ok, msg){
    deviceStatus.textContent = msg;
    dot.style.background = ok ? "var(--good)" : "var(--warn)";
    dot.style.boxShadow = ok ? "0 0 0 4px rgba(61,220,151,.15)" : "0 0 0 4px rgba(255,204,102,.15)";
  }

  function currentChannel(){
    const idx = ((channelIndex % CHANNELS.length) + CHANNELS.length) % CHANNELS.length;
    return CHANNELS[idx];
  }
  function updateChannelUI(){
    channelNow.textContent = currentChannel();
  }

  // Basic hashtag generator: channel + keywords from question + generic set
  function extractKeywords(text){
    const stop = new Set(["che","per","con","senza","come","qual","quale","quali","quando","dove","cosa","perch√©","perche","del","della","delle","dei","degli","dello","alla","alle","agli","allo","il","lo","la","i","gli","le","un","una","uno","da","di","a","e","o","in","su","tra","fra","pi√π","meno","oggi","sempre","mai","solo"]);
    return (text || "")
      .toLowerCase()
      .replace(/[^\p{L}\p{N}\s]/gu," ")
      .split(/\s+/)
      .filter(w => w.length >= 4 && !stop.has(w))
      .slice(0, 6);
  }

  function makeHashtags(){
    const chan = currentChannel().toLowerCase();
    const q = questionInput.value || "";
    const cap = captionInput.value || "";
    const kws = Array.from(new Set([...extractKeywords(q), ...extractKeywords(cap)]));
    const base = ["contentcreator","socialmedia","marketing","reels","shorts","tiktokitalia","instagramitalia","creatoritalia"];
    const chanTags =
      chan === "tiktok" ? ["tiktok","tiktoktips"] :
      chan === "instagram" ? ["instagram","reels"] :
      chan === "shorts" ? ["youtubeshorts","youtube"] :
      ["facebook","facebookreels"];

    const all = Array.from(new Set([...chanTags, ...kws, ...base]))
      .slice(0, 14) // non esageriamo
      .map(t => "#" + t.replace(/\s+/g,""));

    return all.join(" ");
  }

  function autoCaption(){
    const base = captionInput.value.trim();
    const hash = makeHashtags();
    if (!base) {
      captionInput.value = `${questionInput.value.trim()}\n\n${hash}`.trim();
    } else {
      // evita duplicare hashtag se gi√† presenti
      const hasHash = /#\w+/.test(base);
      captionInput.value = hasHash ? base : `${base}\n\n${hash}`.trim();
    }
  }

  function copyText(text){
    navigator.clipboard?.writeText(text).catch(() => {
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    });
  }

  function pickBestMimeType(){
    // Prefer webm vp9, then vp8, else mp4 (often unsupported for MediaRecorder)
    const candidates = [
      "video/webm;codecs=vp9,opus",
      "video/webm;codecs=vp8,opus",
      "video/webm;codecs=vp9",
      "video/webm;codecs=vp8",
      "video/webm",
      "video/mp4" // last resort (may fail)
    ];
    for (const t of candidates){
      if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
    }
    return "";
  }

  // ---------- Teleprompter preview ----------
  function updateTpPreview(){
    const fs = parseInt(fontSizeSelect.value, 10) || 24;
    tpPreviewInner.style.fontSize = fs + "px";
    tpPreviewInner.textContent = (answerInput.value || "").trim() || "Scrivi una risposta per vedere il teleprompter‚Ä¶";
  }

  // ---------- Canvas render & recording ----------
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  function drawFrame(tpProgress01){
    // Background
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,W,H);

    // If video ready, draw crop to 9:16
    if (cam.readyState >= 2){
      const vw = cam.videoWidth || 1280;
      const vh = cam.videoHeight || 720;

      // We want to fill 9:16 frame with webcam while preserving aspect ratio.
      // Compute crop rectangle from source video.
      const targetAR = W / H; // 0.5625
      const srcAR = vw / vh;

      let sx=0, sy=0, sw=vw, sh=vh;
      if (srcAR > targetAR){
        // source too wide -> crop left/right
        sh = vh;
        sw = Math.round(vh * targetAR);
        sx = Math.round((vw - sw)/2);
        sy = 0;
      } else {
        // source too tall -> crop top/bottom
        sw = vw;
        sh = Math.round(vw / targetAR);
        sx = 0;
        sy = Math.round((vh - sh)/2);
      }
      ctx.drawImage(cam, sx, sy, sw, sh, 0, 0, W, H);
    } else {
      // placeholder
      ctx.fillStyle = "rgba(255,255,255,.08)";
      ctx.fillRect(40,40,W-80,H-80);
      ctx.fillStyle = "rgba(233,238,247,.75)";
      ctx.font = "700 28px ui-sans-serif, system-ui";
      ctx.textAlign = "center";
      ctx.fillText("Connetti la webcam", W/2, H/2);
    }

    // Overlay gradient for readability
    const gTop = ctx.createLinearGradient(0,0,0,260);
    gTop.addColorStop(0, "rgba(0,0,0,.65)");
    gTop.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = gTop;
    ctx.fillRect(0,0,W,320);

    const gBottom = ctx.createLinearGradient(0,H-380,0,H);
    gBottom.addColorStop(0, "rgba(0,0,0,0)");
    gBottom.addColorStop(1, "rgba(0,0,0,.72)");
    ctx.fillStyle = gBottom;
    ctx.fillRect(0,H-420,W,420);

    // Question (top)
    const q = (questionInput.value || "").trim();
    ctx.fillStyle = "rgba(233,238,247,.95)";
    ctx.font = "800 34px ui-sans-serif, system-ui";
    ctx.textAlign = "left";
    wrapText(ctx, q ? "Q: " + q : "Q: (seleziona o scrivi una domanda)", 36, 60, W-72, 40);

    // Channel pill (top right)
    const chan = currentChannel();
    drawPill(chan, W-36, 36);

    // Teleprompter (bottom)
    const fs = parseInt(fontSizeSelect.value, 10) || 24;
    const lineH = Math.round(fs * 1.28);
    const padding = 36;
    const boxTop = 360;
    const boxH = H - boxTop - 90;

    // box bg
    ctx.fillStyle = "rgba(0,0,0,.25)";
    roundRect(ctx, padding, boxTop, W - padding*2, boxH, 18, true, false);

    // text
    const text = (answerInput.value || "").trim() || "Scrivi la risposta: verr√† mostrata qui in scorrimento‚Ä¶";
    ctx.save();
    ctx.beginPath();
    roundRect(ctx, padding, boxTop, W - padding*2, boxH, 18, false, false);
    ctx.clip();

    ctx.fillStyle = "rgba(233,238,247,.92)";
    ctx.font = `700 ${fs}px ui-sans-serif, system-ui`;
    ctx.textAlign = "left";

    // measure total height for scroll
    const lines = wrapLines(ctx, text, W - padding*2 - 28);
    const totalTextH = lines.length * lineH + 20;
    tpTextHeight = totalTextH;

    // scroll offset based on progress: start below box, end above box
    // offsetY is top of first line inside clipped box.
    const startY = boxTop + boxH + 20;            // starts off-screen bottom
    const endY   = boxTop - totalTextH - 20;      // ends off-screen top
    const y = lerp(startY, endY, clamp01(tpProgress01));

    let yy = y;
    const x = padding + 14;
    for (const ln of lines){
      ctx.fillText(ln, x, yy);
      yy += lineH;
    }
    ctx.restore();

    // recording indicator
    if (recording){
      ctx.fillStyle = "rgba(255,77,109,.95)";
      ctx.beginPath();
      ctx.arc(36, 36, 10, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(233,238,247,.92)";
      ctx.font = "700 18px ui-sans-serif, system-ui";
      ctx.fillText("REC", 58, 42);
    }
  }

  function animateDraw(){
    const t = performance.now();
    const elapsed = (t - tpStart) / 1000;
    const progress = tpRunning ? (elapsed / tpDuration) : 0;
    drawFrame(progress);
    drawId = requestAnimationFrame(animateDraw);
  }

  function startTeleprompter(){
    tpDuration = parseInt(speedSelect.value, 10) || 105;
    tpStart = performance.now();
    tpRunning = true;
    tpState.textContent = "running";
    startTimer();
  }

  function stopTeleprompter(){
    tpRunning = false;
    tpState.textContent = "idle";
    stopTimer();
  }

  // timer
  let timerInterval = null;
  function startTimer(){
    const t0 = performance.now();
    timerEl.textContent = "00:00";
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      const s = Math.floor((performance.now() - t0)/1000);
      timerEl.textContent = fmtTime(s);
    }, 250);
  }
  function stopTimer(){
    clearInterval(timerInterval);
    timerInterval = null;
  }

  // text wrapping utilities
  function wrapLines(ctx, text, maxWidth){
    const words = text.replace(/\r/g,"").split(/\s+/);
    const lines = [];
    let line = "";
    for (const w of words){
      const test = line ? line + " " + w : w;
      if (ctx.measureText(test).width <= maxWidth){
        line = test;
      } else {
        if (line) lines.push(line);
        line = w;
      }
    }
    if (line) lines.push(line);
    // also handle explicit newlines
    const withNewlines = [];
    for (const ln of lines.join("\n").split("\n")){
      const parts = ln.split("\\n");
      for (const p of parts) withNewlines.push(p);
    }
    return withNewlines.filter(Boolean);
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const words = (text || "").split(" ");
    let line = "";
    for (let n=0; n<words.length; n++){
      const testLine = line + words[n] + " ";
      const w = ctx.measureText(testLine).width;
      if (w > maxWidth && n > 0){
        ctx.fillText(line, x, y);
        line = words[n] + " ";
        y += lineHeight;
      } else {
        line = testLine;
      }
    }
    ctx.fillText(line, x, y);
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    if (w < 2*r) r = w/2;
    if (h < 2*r) r = h/2;
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  function drawPill(text, rightX, topY){
    ctx.save();
    ctx.font = "700 18px ui-sans-serif, system-ui";
    const padX = 12, padY = 8;
    const tw = ctx.measureText(text).width;
    const w = tw + padX*2;
    const h = 34;
    const x = rightX - w;
    const y = topY;
    ctx.fillStyle = "rgba(124,92,255,.28)";
    ctx.strokeStyle = "rgba(124,92,255,.35)";
    ctx.lineWidth = 2;
    roundRect(ctx, x, y, w, h, 999, true, true);
    ctx.fillStyle = "rgba(233,238,247,.92)";
    ctx.textAlign = "center";
    ctx.fillText(text, x + w/2, y + 24);
    ctx.restore();
  }

  const clamp01 = (v)=> Math.max(0, Math.min(1, v));
  const lerp = (a,b,t)=> a + (b-a)*t;

  // ---------- Connect webcam ----------
  async function connect(){
    try{
      setStatus(false, "Richiesta permessi‚Ä¶");
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: "user" },
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
      });
      mediaStream = stream;
      cam.srcObject = stream;
      await cam.play();

      hint.style.display = "none";

      setStatus(true, "Webcam connessa");
      // start drawing loop always (preview)
      if (!drawId) animateDraw();

    }catch(err){
      console.error(err);
      setStatus(false, "Permesso negato o device non disponibile");
      alert("Non riesco ad accedere a webcam/microfono. Controlla permessi del browser e riprova.");
    }
  }

  // ---------- Recording (canvas + audio) ----------
  function buildRecordStream(){
    const fps = 30;
    const canvasStream = canvas.captureStream(fps);

    // add audio track from getUserMedia stream (same stream)
    const audioTracks = (mediaStream?.getAudioTracks?.() || []);
    if (audioTracks.length){
      canvasStream.addTrack(audioTracks[0]);
    }
    return canvasStream;
  }

  async function startRecording(){
    if (recording) return;
    if (!mediaStream){
      await connect();
      if (!mediaStream) return;
    }

    const mimeType = pickBestMimeType();
    codecLabel.textContent = mimeType || "auto";
    const recStream = buildRecordStream();

    chunks = [];
    try{
      recorder = new MediaRecorder(recStream, mimeType ? { mimeType } : undefined);
    }catch(e){
      console.error(e);
      alert("MediaRecorder non supportato in questo browser con i codec disponibili. Prova Chrome/Edge.");
      return;
    }

    recorder.ondataavailable = (ev) => {
      if (ev.data && ev.data.size > 0) chunks.push(ev.data);
    };

    recorder.onstop = async () => {
      const blob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
      const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2);

      const record = {
        id,
        createdAt: nowISO(),
        channel: currentChannel(),
        tpDuration: parseInt(speedSelect.value, 10) || 105,
        question: (questionInput.value || "").trim(),
        caption: (captionInput.value || "").trim(),
        mime: blob.type || "video/webm",
        blob
      };

      await dbPut(record);
      await refreshLibrary();

      // auto-rotate channel for serial production
      channelIndex = (channelIndex + 1) % CHANNELS.length;
      localStorage.setItem(ROT_KEY, String(channelIndex));
      updateChannelUI();

      // reset UI
      btnStop.disabled = true;
      btnStart.disabled = false;
      recording = false;
      stopTeleprompter();
      setStatus(true, "Salvato ‚úÖ (canale ruotato)");
    };

    recorder.start(200); // timeslice
    recording = true;
    btnStart.disabled = true;
    btnStop.disabled = false;
    setStatus(true, "REC in corso‚Ä¶");

    startTeleprompter();
  }

  function stopRecording(){
    if (!recording) return;
    try{
      recorder.stop();
    }catch(e){
      console.error(e);
    }
    btnStop.disabled = true;
    setStatus(true, "Sto finalizzando‚Ä¶");
  }

  // ---------- Library UI ----------
  function makeThumb(){
    // simple placeholder thumb (no extraction)
    const d = document.createElement("div");
    d.className = "thumb";
    d.textContent = "9:16";
    return d;
  }

  async function refreshLibrary(){
    const all = await dbGetAll();
    all.sort((a,b) => (b.createdAt||"").localeCompare(a.createdAt||""));
    library.innerHTML = "";
    libraryEmpty.style.display = all.length ? "none" : "block";

    for (const it of all){
      const row = document.createElement("div");
      row.className = "item";

      const thumb = makeThumb();
      row.appendChild(thumb);

      const right = document.createElement("div");
      const title = document.createElement("h3");
      title.textContent = it.question ? it.question : "Video (senza domanda)";
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${niceDate(it.createdAt)} ‚Ä¢ ${it.channel || "‚Äî"} ‚Ä¢ TP ${it.tpDuration || "‚Äî"}s`;
      const actions = document.createElement("div");
      actions.className = "actions";

      const btnPlay = document.createElement("button");
      btnPlay.textContent = "Rivedi";
      btnPlay.className = "primary";
      btnPlay.onclick = () => openModal(it);

      const btnDl = document.createElement("button");
      btnDl.textContent = "Scarica";
      btnDl.onclick = () => downloadItem(it);

      const btnDel = document.createElement("button");
      btnDel.textContent = "Elimina";
      btnDel.className = "danger";
      btnDel.onclick = async () => {
        if (confirm("Eliminare questo video dalla libreria locale?")){
          await dbDelete(it.id);
          await refreshLibrary();
        }
      };

      actions.append(btnPlay, btnDl, btnDel);

      right.append(title, meta, actions);
      row.appendChild(right);
      library.appendChild(row);
    }
  }

  function downloadItem(it){
    const blob = it.blob;
    const ext = (it.mime || "").includes("mp4") ? "mp4" : "webm";
    const name = `video_${(it.channel||"channel").toLowerCase()}_${(it.createdAt||"").slice(0,19).replace(/[:T]/g,"-")}.${ext}`;
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  }

  let modalCurrent = null;
  function openModal(it){
    modalCurrent = it;
    modalTitle.textContent = "Video";
    modalMeta.textContent = `${niceDate(it.createdAt)} ‚Ä¢ ${it.channel || "‚Äî"} ‚Ä¢ ${it.mime || ""}`;
    modalQ.textContent = it.question || "‚Äî";
    modalCap.textContent = it.caption || "‚Äî";
    modalChan.textContent = it.channel || "‚Äî";
    modalDur.textContent = (it.tpDuration || "‚Äî") + " sec";

    const url = URL.createObjectURL(it.blob);
    modalVideo.src = url;
    modalVideo.onloadeddata = () => {};
    modal.classList.add("open");

    modalDownload.onclick = () => downloadItem(it);
    modalCopyCaption.onclick = () => copyText(it.caption || "");
    modalDelete.onclick = async () => {
      if (!modalCurrent) return;
      if (confirm("Eliminare questo video?")){
        await dbDelete(modalCurrent.id);
        closeModal();
        await refreshLibrary();
      }
    };

    // clean old object URL on close
    modal.dataset.url = url;
  }

  function closeModal(){
    modal.classList.remove("open");
    try{
      const url = modal.dataset.url;
      if (url) URL.revokeObjectURL(url);
    }catch{}
    modalVideo.pause();
    modalVideo.src = "";
    modalCurrent = null;
  }

  // ---------- Upload import ----------
  async function importVideo(){
    const f = uploadInput.files?.[0];
    if (!f){
      alert("Seleziona prima un file video.");
      return;
    }
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2);
    const record = {
      id,
      createdAt: nowISO(),
      channel: currentChannel(),
      tpDuration: parseInt(speedSelect.value, 10) || 105,
      question: (questionInput.value || "").trim(),
      caption: (captionInput.value || "").trim(),
      mime: f.type || "video/*",
      blob: f
    };
    await dbPut(record);
    uploadInput.value = "";
    await refreshLibrary();
    setStatus(true, "Import completato ‚úÖ");
  }

  // ---------- Events ----------
  // presets dropdown
  function initPresets(){
    presetSelect.innerHTML = "";
    for (let i=0; i<PRESETS.length; i++){
      const o = document.createElement("option");
      o.value = String(i);
      o.textContent = PRESETS[i];
      presetSelect.appendChild(o);
    }
  }

  function generateQuestion(){
    const idx = parseInt(presetSelect.value, 10);
    const q = PRESETS[(isNaN(idx) ? 0 : idx)] || PRESETS[0];
    questionInput.value = q;
    // if caption is empty, prefill lightly
    if (!captionInput.value.trim()){
      captionInput.value = q;
    }
  }

  btnNewQuestion.onclick = generateQuestion;

  btnRotate.onclick = () => {
    channelIndex = (channelIndex + 1) % CHANNELS.length;
    localStorage.setItem(ROT_KEY, String(channelIndex));
    updateChannelUI();
  };

  btnResetRotation.onclick = () => {
    channelIndex = 0;
    localStorage.setItem(ROT_KEY, "0");
    updateChannelUI();
  };

  btnAutoCaption.onclick = autoCaption;
  btnCopyCaption.onclick = () => copyText(captionInput.value || "");

  btnConnect.onclick = connect;
  btnStart.onclick = startRecording;
  btnStop.onclick = stopRecording;

  btnRefresh.onclick = refreshLibrary;

  btnWipe.onclick = async () => {
    if (confirm("Vuoi davvero svuotare TUTTA la libreria locale?")){
      await dbClear();
      await refreshLibrary();
    }
  };

  btnQuickFill.onclick = () => {
    const q = (questionInput.value || "").trim() || "Tema del video";
    answerInput.value =
`Hook (1 frase): ${q} ‚Äî ecco la cosa che quasi tutti sbagliano.

Punto 1: (spiega in modo semplice)
Punto 2: (fai un esempio pratico)
Punto 3: (cosa fare subito oggi)

Chiusura + CTA: Se vuoi la checklist / template, scrivi "CHECK" nei commenti.`;
    updateTpPreview();
  };

  btnClear.onclick = () => {
    if (confirm("Pulire domanda/risposta/caption?")){
      questionInput.value = "";
      answerInput.value = "";
      captionInput.value = "";
      updateTpPreview();
    }
  };

  btnImport.onclick = importVideo;

  // Live preview update
  answerInput.addEventListener("input", updateTpPreview);
  fontSizeSelect.addEventListener("change", updateTpPreview);

  // keyboard shortcut
  window.addEventListener("keydown", (e) => {
    if (e.code === "Space" && !e.repeat){
      // don‚Äôt interfere when typing
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      if (tag === "textarea" || tag === "input" || tag === "select") return;

      e.preventDefault();
      if (!mediaStream) return;
      if (!recording) startRecording();
      else stopRecording();
    }
    if (e.key === "Escape" && modal.classList.contains("open")){
      closeModal();
    }
  });

  modalClose.onclick = closeModal;
  modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

  // init
  initPresets();
  updateChannelUI();
  updateTpPreview();
  refreshLibrary();

  // draw loop starts once connected, but we also render first frame for layout
  drawFrame(0);

})();
</script>
</body>
</html>
