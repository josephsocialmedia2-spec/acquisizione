<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sottotitoli Live (Mobile)</title>

  <!-- Suggerimento "app-like" -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    :root { --bg:#000; --fg:#fff; --accent:#00e5ff; }
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--fg); min-height:100vh;
      display:flex; flex-direction:column;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    header, footer{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    footer{
      border-bottom:none;
      border-top:1px solid rgba(255,255,255,.12);
    }
    button{
      background:var(--fg); color:#000; border:0; border-radius:12px;
      padding:10px 12px; font-weight:800; cursor:pointer;
      touch-action: manipulation;
    }
    button.secondary{
      background: rgba(255,255,255,.12); color: var(--fg);
      border:1px solid rgba(255,255,255,.18);
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .pill{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      font-size:13px;
    }
    .pill b{ color: var(--accent); }
    main{
      flex:1; display:flex; align-items:center; justify-content:center;
      padding: 12px;
    }
    .box{
      width: min(1100px, 96vw);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
    }
    .subtitle{
      font-size: clamp(30px, 6vw, 72px);
      line-height: 1.15;
      font-weight: 900;
      letter-spacing: .2px;
      word-break: break-word;
    }
    .final{ opacity:.96; }
    .interim{ opacity:.62; margin-top: 10px; }
    input[type="range"]{ width: 220px; }
    textarea{
      width: min(1100px, 96vw);
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color: var(--fg);
      padding:12px;
      font-size:16px;
      min-height:54px;
      resize: vertical;
    }
    .small{ opacity:.75; font-size: 12px; }
  </style>
</head>
<body>

<header>
  <button id="startBtn">üéôÔ∏è Avvia</button>
  <button id="stopBtn" class="secondary" disabled>‚èπÔ∏è Ferma</button>
  <button id="fsBtn" class="secondary">‚õ∂ Full screen</button>
  <button id="wakeBtn" class="secondary">üîí Schermo acceso</button>
  <button id="clearBtn" class="secondary">üßΩ Pulisci</button>
  <span class="pill">Stato: <b id="status">pronto</b></span>
</header>

<main>
  <div class="box" id="box" aria-live="polite" aria-atomic="true">
    <div class="subtitle final" id="finalText">Tocca ‚ÄúAvvia‚Äù e parla‚Ä¶</div>
    <div class="subtitle interim" id="interimText"></div>
  </div>
</main>

<footer>
  <label class="pill">Testo:
    <input id="sizeRange" type="range" min="26" max="96" value="60" />
    <span id="sizeLabel">60px</span>
  </label>
  <span class="small">Se l‚Äôaudio non va (spesso su iPhone), scrivi qui sotto: apparir√† come sottotitolo.</span>
  <textarea id="manual" placeholder="Sottotitoli manuali‚Ä¶"></textarea>
</footer>

<script>
(() => {
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const fsBtn    = document.getElementById('fsBtn');
  const wakeBtn  = document.getElementById('wakeBtn');
  const clearBtn = document.getElementById('clearBtn');
  const statusEl = document.getElementById('status');
  const finalEl  = document.getElementById('finalText');
  const interimEl= document.getElementById('interimText');
  const sizeRange= document.getElementById('sizeRange');
  const sizeLabel= document.getElementById('sizeLabel');
  const manual   = document.getElementById('manual');

  function setStatus(s){ statusEl.textContent = s; }

  function setFontSize(px){
    finalEl.style.fontSize = px + "px";
    interimEl.style.fontSize = px + "px";
    sizeLabel.textContent = px + "px";
  }
  setFontSize(parseInt(sizeRange.value,10));
  sizeRange.addEventListener('input', () => setFontSize(parseInt(sizeRange.value,10)));

  clearBtn.addEventListener('click', () => {
    finalEl.textContent = "‚Äî";
    interimEl.textContent = "";
    manual.value = "";
  });

  manual.addEventListener('input', () => {
    finalEl.textContent = manual.value.trim() || "‚Äî";
    interimEl.textContent = "";
  });

  // Fullscreen (funziona meglio su Android; su iOS √® limitato)
  fsBtn.addEventListener('click', async () => {
    try {
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    } catch(e){ console.warn(e); }
  });

  // Wake Lock (tiene lo schermo acceso, solo su HTTPS + browser compatibili)
  let wakeLock = null;
  async function enableWakeLock(){
    try{
      if (!('wakeLock' in navigator)) {
        setStatus("wake lock non supportato");
        return;
      }
      wakeLock = await navigator.wakeLock.request('screen');
      setStatus("schermo acceso");
      wakeBtn.textContent = "üîì Sblocca schermo";
    } catch(e){
      console.warn(e);
      setStatus("wake lock negato");
    }
  }
  async function disableWakeLock(){
    try{
      if (wakeLock) await wakeLock.release();
      wakeLock = null;
      setStatus("wake lock off");
      wakeBtn.textContent = "üîí Schermo acceso";
    } catch(e){ console.warn(e); }
  }
  wakeBtn.addEventListener('click', () => (wakeLock ? disableWakeLock() : enableWakeLock()));
  document.addEventListener('visibilitychange', () => {
    // se lo schermo si spegne e riapri, prova a riprendere
    if (wakeLock && document.visibilityState === 'visible') enableWakeLock();
  });

  // Speech recognition
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    setStatus("STT non supportato");
    startBtn.disabled = true;
    stopBtn.disabled = true;
    finalEl.textContent = "Questo browser non supporta sottotitoli automatici. Usa la casella in basso per inserirli manualmente.";
    return;
  }

  let recognition = null;
  let listening = false;
  let finalTranscript = "";

  function createRecognition(){
    const r = new SpeechRecognition();
    r.lang = "it-IT";
    r.continuous = true;
    r.interimResults = true;

    r.onstart = () => {
      listening = true;
      setStatus("in ascolto");
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };
    r.onend = () => {
      listening = false;
      setStatus("fermato");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
    r.onerror = (e) => {
      console.warn("STT error:", e);
      setStatus("errore: " + (e.error || "sconosciuto"));
    };
    r.onresult = (event) => {
      let interim = "";
      for (let i = event.resultIndex; i < event.results.length; i++){
        const txt = event.results[i][0].transcript;
        if (event.results[i].isFinal) finalTranscript += txt + " ";
        else interim += txt;
      }
      finalEl.textContent = finalTranscript.trim() || "‚Äî";
      interimEl.textContent = interim.trim();
    };
    return r;
  }

  async function start(){
    try{
      await navigator.mediaDevices.getUserMedia({ audio:true });
    } catch(e){
      setStatus("permesso microfono negato");
      return;
    }
    finalTranscript = "";
    interimEl.textContent = "";
    finalEl.textContent = "‚Äî";
    recognition = createRecognition();
    try { recognition.start(); } catch(e){ console.warn(e); }
  }

  function stop(){
    if (recognition && listening) recognition.stop();
  }

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
})();
</script>
</body>
</html>
