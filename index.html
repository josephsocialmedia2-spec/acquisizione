<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Video Creator Pro ‚Äì ChatGPT Auto + Scheduling + Multi-Platform + Approvazioni + Analytics</title>

  <style>
    :root{
      --bg:#0b1120;
      --text:#f3f4f6;
      --muted:#a0adb8;
      --gold:#d8a23a;
      --border: rgba(225,225,225,0.18);
      --shadow: 0 14px 50px rgba(0,0,0,0.45);
      --radius: 18px;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --stage-w: min(420px, 92vw);
      --zoom: 1;
      --wa:#25D366;
      --success:#4a8f72;
      --warning:#d8a23a;
      --error:#ff2d2d;
      --info:#5788d4;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(216,162,58,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(123,79,189,.14), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(74,143,114,.14), transparent 55%),
        var(--bg);
    }

    .wrap{ max-width:1400px; margin:0 auto; padding:14px 12px 84px; }

    header{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:950;
      letter-spacing:.2px;
      font-size:11px;
      line-height:1;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      position:relative;
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease, border-color .14s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .btn:hover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(216,162,58,.22);
      box-shadow: 0 14px 34px rgba(0,0,0,.30);
      filter: brightness(1.06);
    }
    .btn:active{ transform: translateY(0px) scale(.99); filter: brightness(0.98); }
    .btn.tiny{ padding:6px 9px; font-size:10px; border-radius:11px; box-shadow:none; }
    .btn.primary{
      background: linear-gradient(135deg, rgba(216,162,58,.95), rgba(216,162,58,.72));
      color:#111;
      border-color: rgba(216,162,58,.55);
    }
    .btn.blue{
      background: linear-gradient(135deg, rgba(57,90,140,.95), rgba(57,90,140,.70));
      border-color: rgba(57,90,140,.55);
    }
    .btn.violet{
      background: linear-gradient(135deg, rgba(123,79,189,.95), rgba(123,79,189,.70));
      border-color: rgba(123,79,189,.55);
    }
    .btn.gray{ background: rgba(255,255,255,.04); }
    .btn.wa{
      background: linear-gradient(135deg, rgba(37,211,102,.95), rgba(37,211,102,.70));
      border-color: rgba(37,211,102,.55);
      color:#07120b;
      font-weight:1000;
    }
    .btn.success{
      background: linear-gradient(135deg, rgba(74,143,114,.95), rgba(74,143,114,.70));
      border-color: rgba(74,143,114,.55);
    }

    /* Modal */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.75);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal-content{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      max-width:900px;
      width:100%;
      max-height:90vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .modal-title{
      font-weight:1000;
      font-size:14px;
      letter-spacing:.4px;
    }
    .modal-close{
      background:none;
      border:none;
      color:var(--muted);
      font-size:20px;
      cursor:pointer;
      padding:0;
      width:28px;
      height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
    }
    .modal-close:hover{ background:rgba(255,255,255,.08); }
    .modal-body{
      flex:1;
      overflow:auto;
      padding:16px;
    }
    .modal-footer{
      padding:12px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:2px;
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:4px;
      margin-bottom:16px;
    }
    .tab{
      flex:1;
      padding:10px 14px;
      border:none;
      background:none;
      color:var(--muted);
      font-weight:950;
      font-size:11px;
      letter-spacing:.4px;
      text-align:center;
      border-radius:10px;
      cursor:pointer;
      transition: all .14s ease;
    }
    .tab:hover{ color:var(--text); }
    .tab.active{
      background:rgba(255,255,255,.08);
      color:var(--text);
    }

    /* Calendar */
    .calendar{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
    }
    .calendar-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .calendar-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
    }
    .calendar-day{
      padding:8px 4px;
      text-align:center;
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      border-radius:8px;
    }
    .calendar-slot{
      padding:6px 4px;
      text-align:center;
      font-size:10px;
      border-radius:8px;
      cursor:pointer;
      background:rgba(255,255,255,.05);
      border:1px solid transparent;
      transition: all .14s ease;
    }
    .calendar-slot:hover{
      background:rgba(255,255,255,.08);
      border-color:rgba(216,162,58,.22);
    }
    .calendar-slot.occupied{
      background:rgba(216,162,58,.15);
      border-color:rgba(216,162,58,.35);
    }
    .calendar-slot.selected{
      background:rgba(74,143,114,.25);
      border-color:rgba(74,143,114,.45);
    }

    /* Multi-platform selector */
    .platform-selector{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:12px 0;
    }
    .platform-check{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      cursor:pointer;
      user-select:none;
    }
    .platform-check input{ display:none; }
    .platform-check span{
      font-size:10px;
      font-weight:950;
      letter-spacing:.4px;
    }
    .platform-check.active{
      background:rgba(57,90,140,.25);
      border-color:rgba(57,90,140,.45);
    }

    /* Approval badges */
    .approval-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:999px;
      font-size:9px;
      font-weight:1000;
      letter-spacing:.4px;
      margin-left:8px;
    }
    .badge-pending{
      background:rgba(216,162,58,.15);
      color:rgba(216,162,58,.95);
    }
    .badge-approved{
      background:rgba(74,143,114,.15);
      color:rgba(74,143,114,.95);
    }
    .badge-revision{
      background:rgba(255,45,45,.15);
      color:rgba(255,45,45,.95);
    }

    /* Analytics dashboard */
    .stats-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
      margin:16px 0;
    }
    .stat-card{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:14px;
    }
    .stat-value{
      font-size:28px;
      font-weight:1000;
      line-height:1;
      margin-bottom:6px;
    }
    .stat-label{
      font-size:10px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .stat-trend{
      font-size:11px;
      margin-top:8px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .trend-up{ color:var(--success); }
    .trend-down{ color:var(--error); }

    /* Notification */
    .notification{
      position:fixed;
      top:20px;
      right:20px;
      background:rgba(0,0,0,.85);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 16px;
      max-width:320px;
      backdrop-filter:blur(10px);
      z-index:10000;
      transform:translateX(400px);
      transition:transform .3s ease;
      box-shadow:var(--shadow);
    }
    .notification.show{ transform:translateX(0); }
    .notification-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .notification-title{
      font-weight:1000;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .notification-close{
      background:none;
      border:none;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
      padding:0;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:6px;
    }

    /* Resto dello stile mantenuto dal codice originale */
    .pill{
      font-size:10px;
      color:var(--muted);
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      font-weight:900;
      letter-spacing:.2px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    .layout{
      display:grid;
      grid-template-columns: 1fr 460px;
      gap:12px;
      align-items:start;
      margin-top:12px;
    }
    @media (max-width: 1050px){ .layout{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .section{ padding:12px; }
    .section + .section{ border-top:1px solid rgba(255,255,255,.10); }

    .h{
      margin:0 0 8px;
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.8px;
      font-weight:950;
    }

    .hintTop{
      margin: 6px 0 10px;
      font-size:11px;
      color: var(--muted);
      line-height: 1.35;
    }

    .field textarea, .field input, .field select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:850;
      resize: vertical;
      font-size:12px;
      line-height:1.25;
    }
    .field textarea{ min-height: 120px; }
    .field textarea:focus, .field input:focus, .field select:focus{
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    .bar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .bar.between{ justify-content:space-between; }
    .bar.left{ justify-content:flex-start; }
    .bar.center{ justify-content:center; }

    .mini{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px;
    }
    .subtle{
      font-size:11px;
      color: var(--muted);
      line-height:1.35;
      margin-top:6px;
    }

    .chk{
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      color:var(--muted);
      font-weight:950;
      font-size:10px;
      white-space:nowrap;
    }
    .check{ width:16px;height:16px; accent-color: var(--gold); cursor:pointer; }

    .stageBlock{
      width: var(--stage-w);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      align-items:stretch;
    }
    #stage916{
      width: 100%;
      aspect-ratio: 9 / 16;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      overflow: hidden;
      position: relative;
      background:#000;
      box-shadow: var(--shadow);
    }
    #cam{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scale(var(--zoom));
      transform-origin: center;
    }

    /* PREVIEW overlay only */
    #overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index: 2;
    }

    /* Place question + phone at 1/4 height */
    #qZone{
      position:absolute;
      left:10px; right:10px;
      top:25%;
      transform: translateY(-50%);
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }
    #questionOverlay{
      width: calc(100% - 20px);
      max-width: 92%;
      font-size: 12px;
      font-weight: 1000;
      line-height: 1.18;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.34);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(6px);
      white-space: pre-wrap;
      text-align:center;
    }

    #logoZone{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-top:6px;
    }
    #logoWrap{
      width:50px;height:50px;
      border-radius:14px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    #logoImg{
      width:50px;height:50px;
      object-fit:contain;
      display:none;
      background:transparent;
    }

    #categoryOverlay{
      text-align:center;
      font-size:11px;
      font-weight:1000;
      letter-spacing:.6px;
      color: rgba(243,244,246,.92);
      padding: 8px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      width: fit-content;
      max-width: 92%;
    }

    #waPhoneOverlay{
      text-align:center;
      font-size:12px;
      font-weight:1100;
      letter-spacing:.2px;
      padding: 8px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      width: fit-content;
      max-width: 92%;
      color: var(--wa);
    }

    /* Teleprompter preview (NOT recorded) */
    #teleprompterPreview{
      position:absolute;
      left:10px; right:10px;
      bottom:12px;
      display:flex;
      justify-content:center;
      z-index:3;
    }
    #teleText{
      max-width: 100%;
      width: calc(100% - 20px);
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.28;
      font-weight: 900;
      color: rgba(243,244,246,.95);
      text-shadow: 0 2px 12px rgba(0,0,0,.75);
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
      backdrop-filter: blur(6px);
      max-height: 22%;
      overflow:auto;
    }
    #teleText .w{ padding: 1px 2px; border-radius: 6px; }
    #teleText .w.on{
      background: rgba(216,162,58,.35);
      border: 1px solid rgba(216,162,58,.25);
    }

    /* HUD REC */
    #recHud{
      position:absolute;
      top:12px; right:12px;
      display:none;
      align-items:center;
      gap:10px;
      z-index: 10;
    }
    #recCamIcon{
      width:34px;height:34px;border-radius:12px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      font-size: 16px;
    }
    #countdownHud{
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      font-weight: 1000;
      font-size: 12px;
      min-width: 86px;
      text-align:center;
    }

    .sliderRow{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:10px;
      font-weight:950;
      flex-wrap:wrap;
      justify-content:center;
    }
    input[type="range"]{ width:170px; accent-color: var(--gold); }

    .bottomBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px;
      background: rgba(0,0,0,.35);
      border-top: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      display:flex;
      justify-content:flex-end;
      z-index: 50;
      gap:8px;
      flex-wrap:wrap;
    }

    /* Video list item */
    .vItem{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
      background: rgba(0,0,0,.12);
    }
    .vTop{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .vTitle{ font-weight:1000; font-size:12px; }
    .vMeta{ font-size:11px; color:var(--muted); line-height:1.35; margin-top:6px; white-space:pre-wrap; }
    .vBtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    .recCircle{
      width:72px;height:72px;border-radius:999px;
      border: 1px solid rgba(255,255,255,.16);
      background: radial-gradient(140px 140px at 35% 30%, rgba(255,110,110,.95), rgba(255,45,45,.82));
      color:#120707;
      font-weight:1000;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      user-select:none;
      gap:8px;
    }
    .recCircle .dot{
      width:10px;height:10px;border-radius:999px;background:#ff2d2d;
      box-shadow: 0 0 0 0 rgba(255,45,45,.55);
      animation: pulseDot 1.15s ease-in-out infinite;
    }
    .recCircle.running{ outline: 2px solid rgba(255,45,45,.35); filter: saturate(1.05); }
    @keyframes pulseDot{
      0%{ box-shadow: 0 0 0 0 rgba(255,45,45,.55); transform: scale(1); }
      60%{ box-shadow: 0 0 0 12px rgba(255,45,45,0); transform: scale(1.06); }
      100%{ box-shadow: 0 0 0 0 rgba(255,45,45,0); transform: scale(1); }
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="row" style="flex:1;">
      <button class="btn primary" id="btnNext" type="button">‚ú® Nuova domanda</button>
      <button class="btn blue" id="btnOpenChatGPT" type="button">ü§ñ Apri ChatGPT (Auto)</button>
      <button class="btn gray" id="btnCopyQ" type="button">üìã Copia domanda</button>
      <button class="btn violet" id="btnPasteAnswer" type="button">üìã Incolla risposta</button>
      
      <button class="btn success" id="btnAnalytics" type="button">üìä Analytics</button>
      <button class="btn" id="btnMultiPlatform" type="button">üîÑ Multi-piattaforma</button>

      <span class="pill">
        <span id="videoCounter">Video: 0</span>
        <span>‚Ä¢</span>
        <span id="platformLabel">Piattaforma: ‚Äî</span>
        <span>‚Ä¢</span>
        <span id="nextSlotPill">Slot: ‚Äî</span>
      </span>
    </div>

    <div class="row">
      <button class="btn tiny gray" id="btnBackTop" type="button">‚Üê Gestionale</button>
      <button class="btn tiny" id="btnCalendar" type="button">üìÖ Calendario</button>
    </div>
  </header>

  <div class="hintTop">
    <b>Novit√†:</b> 1) ChatGPT Auto-copiatura risposta | 2) Scheduling visivo | 3) Multi-piattaforma simultanea | 
    4) Sistema approvazioni | 5) Dashboard analytics
  </div>

  <!-- BLOCCO RISPOSTA -->
  <div class="card">
    <div class="section">
      <p class="h">Risposta (ChatGPT Auto-detection attivo)</p>
      <div class="field">
        <textarea id="answerBox" placeholder="Incolla qui la risposta‚Ä¶ (oppure usa ChatGPT Auto)"></textarea>
      </div>

      <div class="bar left" style="margin-top:10px;">
        <button class="btn primary" id="btnUseAnswer" type="button">‚û°Ô∏è Usa risposta</button>
        <button class="btn gray" id="btnCopyCaption" type="button">üìã Copia caption</button>
        <button class="btn" id="btnScheduleMulti" type="button">üìÖ Pianifica Multi</button>
      </div>

      <div class="subtle">
        <label class="chk">
          <input type="checkbox" id="chkAutoDetectGPT" checked /> Auto-rileva risposta ChatGPT
        </label>
        <span style="margin-left:12px; color:var(--success);" id="autoDetectStatus">‚úì Attivo</span>
      </div>
    </div>
  </div>

  <div class="layout">

    <!-- MAIN -->
    <div class="card">
      <div class="section">
        <p class="h">Video 9:16 + REC (60s)</p>

        <div class="stageBlock">
          <div id="stage916">
            <video id="cam" autoplay playsinline muted></video>

            <div id="recHud">
              <div id="recCamIcon">üé•</div>
              <div id="countdownHud">REC 60s</div>
            </div>

            <div id="overlay">
              <div id="qZone">
                <div id="questionOverlay">Premi "Nuova domanda".</div>

                <div id="logoZone">
                  <div id="logoWrap"><img id="logoImg" alt="logo"></div>
                  <div id="categoryOverlay">ATTUALIT√Ä</div>
                  <div id="waPhoneOverlay">WHATSAPP: +393713708294</div>
                </div>
              </div>

              <div id="teleprompterPreview">
                <div id="teleText">Incolla una risposta ‚Üí "Usa risposta" ‚Üí "REC".</div>
              </div>
            </div>
          </div>

          <div class="bar between" style="margin-top:10px;">
            <div class="bar left">
              <button class="btn gray" id="btnCam" type="button">üì∑ Camera</button>
              <button class="btn gray" id="btnFlip" type="button">üîÑ Gira</button>
              <button class="btn gray" id="btnFlash" type="button">üí° Flash</button>
            </div>

            <div class="bar">
              <button class="btn gray" id="btnStop" type="button">‚èπ Stop</button>
              <div class="recCircle" id="btnREC" title="Registra 60 secondi"><span class="dot"></span>REC</div>
            </div>
          </div>

          <div class="sliderRow" style="margin-top:10px;">
            <span>Zoom</span>
            <input id="zoom" type="range" min="1" max="2.5" step="0.1" value="1" />
            <span id="zoomVal">1.0x</span>
          </div>

          <canvas id="recCanvas" width="1080" height="1920" style="display:none;"></canvas>
        </div>
      </div>
    </div>

    <!-- SIDE -->
    <div class="card">

      <!-- INVIO / IDENT -->
      <div class="section">
        <p class="h">Invio WhatsApp a Joseph</p>

        <div class="bar">
          <div class="field" style="flex:1; min-width: 180px;">
            <input id="operatorName" placeholder="Nome funzionario (es. Marco)" />
          </div>
          <div class="field" style="flex:1; min-width: 180px;">
            <input id="josephWa" placeholder="Numero Joseph E164 senza +" value="393713708294" />
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <input id="groupInvite" placeholder="(Opz.) Link invito gruppo WhatsApp PUBBLICAZIONI" />
        </div>

        <div class="bar left" style="margin-top:10px;">
          <label class="chk"><input class="check" type="radio" name="destMode" id="destGroup" /> Gruppo</label>
          <label class="chk"><input class="check" type="radio" name="destMode" id="destJoseph" checked /> Joseph</label>
        </div>

        <div class="bar left" style="margin-top:10px;">
          <label class="chk"><input class="check" type="checkbox" id="chkAutoMark" checked /> Auto "slot usato"</label>
          <label class="chk"><input class="check" type="checkbox" id="chkRequireDownloaded" checked /> Richiedi "video scaricato"</label>
        </div>

        <div class="bar left" style="margin-top:10px;">
          <button class="btn wa" id="btnOpenWhatsApp" type="button">üí¨ Apri WhatsApp</button>
          <button class="btn gray" id="btnWhere" type="button">üìÅ Dove sono i video</button>
        </div>
      </div>

      <!-- FREQUENZA PER PIATTAFORMA -->
      <div class="section">
        <p class="h">Frequenza pubblicazioni</p>
        <div class="bar">
          <div class="field" style="flex:1; min-width: 160px;">
            <select id="platform">
              <option value="TIKTOK">TikTok</option>
              <option value="INSTAGRAM">Instagram</option>
              <option value="SHORTS">YouTube Shorts</option>
              <option value="FACEBOOK">Facebook</option>
            </select>
          </div>
          <div class="field" style="flex:1; min-width: 170px;">
            <select id="frequencyMode">
              <option value="per_day">Tot post al giorno</option>
              <option value="every_hours">Ogni X ore</option>
              <option value="custom_minutes">Minuti minimi tra post</option>
            </select>
          </div>
          <div class="field" style="flex:1; min-width: 120px;">
            <input id="frequencyValue" type="number" min="1" step="1" value="2" />
          </div>
        </div>

        <div class="bar left" style="margin-top:10px;">
          <button class="btn gray" id="btnClearHistory" type="button">üßπ Pulisci storico</button>
        </div>
      </div>

      <!-- OVERLAY -->
      <div class="section">
        <p class="h">Overlay</p>
        <div class="field">
          <input id="phoneInput" placeholder="Numero WhatsApp in video" />
        </div>

        <div class="bar left" style="margin-top:10px;">
          <input id="logoUpload" type="file" accept="image/*" style="display:none;" />
          <button class="btn gray" id="btnLogo" type="button">üñº Carica logo (50√ó50)</button>
        </div>
      </div>

      <!-- LISTA VIDEO CON APPROVAZIONI -->
      <div class="section">
        <p class="h">Video creati <span class="approval-badge badge-pending" id="pendingCount">0 in attesa</span></p>
        <video id="playback" controls style="width:100%; border-radius:14px; background:#000; margin-top:10px;"></video>

        <div class="bar left" style="margin-top:10px;">
          <button class="btn" id="btnDownloadVideo" type="button">üì• Scarica video</button>
          <button class="btn tiny gray" id="btnClearList" type="button">üóë Svuota lista</button>
          <button class="btn tiny success" id="btnMarkApproved" type="button">‚úÖ Approva</button>
          <button class="btn tiny" id="btnAddComment" type="button">üí¨ Commenta</button>
        </div>

        <div class="mini" id="recList" style="margin-top:10px; max-height:340px; overflow:auto;">‚Äî</div>
      </div>

    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal" id="modalCalendar">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üìÖ Calendario Scheduling</div>
      <button class="modal-close" id="closeCalendar">&times;</button>
    </div>
    <div class="modal-body">
      <div class="tabs">
        <button class="tab active" data-tab="week">Questa settimana</button>
        <button class="tab" data-tab="month">Questo mese</button>
        <button class="tab" data-tab="platform">Per piattaforma</button>
      </div>
      <div id="calendarWeek" class="calendar">
        <div class="calendar-header">
          <div><strong>Prossimi 7 giorni</strong></div>
          <button class="btn tiny" id="btnExportSchedule">üì§ Esporta CSV</button>
        </div>
        <div id="calendarGrid"></div>
      </div>
      <div id="calendarMonth" class="calendar" style="display:none;">
        <!-- Sar√† popolato dinamicamente -->
      </div>
      <div id="calendarPlatform" class="calendar" style="display:none;">
        <!-- Sar√† popolato dinamicamente -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn gray" id="btnCloseCalendar">Chiudi</button>
    </div>
  </div>
</div>

<div class="modal" id="modalMultiPlatform">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üîÑ Pianificazione Multi-piattaforma</div>
      <button class="modal-close" id="closeMultiPlatform">&times;</button>
    </div>
    <div class="modal-body">
      <p class="h">Seleziona piattaforme per questo video:</p>
      <div class="platform-selector">
        <label class="platform-check active" data-platform="TIKTOK">
          <input type="checkbox" checked /> <span>TikTok</span>
        </label>
        <label class="platform-check active" data-platform="INSTAGRAM">
          <input type="checkbox" checked /> <span>Instagram</span>
        </label>
        <label class="platform-check" data-platform="SHORTS">
          <input type="checkbox" /> <span>YouTube Shorts</span>
        </label>
        <label class="platform-check" data-platform="FACEBOOK">
          <input type="checkbox" /> <span>Facebook</span>
        </label>
      </div>
      
      <p class="h" style="margin-top:20px;">Offset temporali tra piattaforme:</p>
      <div class="mini">
        <label class="chk"><input type="radio" name="offsetMode" value="simultaneo" checked /> Pubblicazione simultanea</label>
        <label class="chk"><input type="radio" name="offsetMode" value="scaglionato" /> Scaglionato (30 min tra piattaforme)</label>
        <label class="chk"><input type="radio" name="offsetMode" value="personalizzato" /> Personalizzato (specifica sotto)</label>
      </div>
      
      <div id="customOffsets" style="margin-top:12px; display:none;">
        <!-- Sar√† popolato dinamicamente -->
      </div>
      
      <div class="calendar" style="margin-top:20px;">
        <div class="calendar-header">
          <div><strong>Slot disponibili multi-piattaforma</strong></div>
        </div>
        <div id="multiPlatformSlots"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn gray" id="btnCancelMulti">Annulla</button>
      <button class="btn primary" id="btnConfirmMulti">Conferma pianificazione</button>
    </div>
  </div>
</div>

<div class="modal" id="modalAnalytics">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üìä Dashboard Analytics</div>
      <button class="modal-close" id="closeAnalytics">&times;</button>
    </div>
    <div class="modal-body">
      <div class="tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="platforms">Per piattaforma</button>
        <button class="tab" data-tab="operators">Per operatore</button>
        <button class="tab" data-tab="time">Analisi temporale</button>
      </div>
      
      <div id="analyticsOverview">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotalVideos">0</div>
            <div class="stat-label">Video totali</div>
            <div class="stat-trend trend-up" id="statTrendVideos">+0% vs settimana scorsa</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statApproved">0</div>
            <div class="stat-label">Approvati</div>
            <div class="stat-label" style="font-size:9px; margin-top:4px;">Tasso: <span id="statApprovalRate">0%</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPending">0</div>
            <div class="stat-label">In attesa</div>
            <div class="stat-label" style="font-size:9px; margin-top:4px;">Tempo medio: <span id="statAvgPendingTime">0h</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statProductivity">0</div>
            <div class="stat-label">Video/giorno</div>
            <div class="stat-trend trend-up" id="statTrendProductivity">+0%</div>
          </div>
        </div>
        
        <div class="mini" style="margin-top:20px;">
          <strong>Distribuzione per piattaforma (ultimi 30 giorni):</strong>
          <div id="platformDistribution"></div>
        </div>
        
        <div class="mini" style="margin-top:20px;">
          <strong>Top operatori per produzione:</strong>
          <div id="topOperators"></div>
        </div>
      </div>
      
      <div id="analyticsPlatforms" style="display:none;">
        <!-- Sar√† popolato dinamicamente -->
      </div>
      
      <div id="analyticsOperators" style="display:none;">
        <!-- Sar√† popolato dinamicamente -->
      </div>
      
      <div id="analyticsTime" style="display:none;">
        <!-- Sar√† popolato dinamicamente -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn gray" id="btnCloseAnalytics">Chiudi</button>
      <button class="btn" id="btnExportAnalytics">üì§ Esporta Report</button>
    </div>
  </div>
</div>

<div class="modal" id="modalApproval">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">‚úÖ Sistema Approvazioni</div>
      <button class="modal-close" id="closeApproval">&times;</button>
    </div>
    <div class="modal-body">
      <p class="h">Video selezionato: <span id="approvalVideoTitle">‚Äî</span></p>
      
      <div class="bar" style="margin:16px 0;">
        <button class="btn success" data-approval="approved">‚úÖ Approva</button>
        <button class="btn" data-approval="pending">‚è≥ Metti in attesa</button>
        <button class="btn" style="background:rgba(255,45,45,.15);border-color:rgba(255,45,45,.35);" data-approval="revision">‚úèÔ∏è Richiedi revisione</button>
      </div>
      
      <div class="field">
        <textarea id="approvalComment" placeholder="Commento (opzionale)..." rows="3"></textarea>
      </div>
      
      <div class="mini" style="margin-top:16px;">
        <strong>Cronologia approvazioni:</strong>
        <div id="approvalHistory"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn gray" id="btnCloseApproval">Chiudi</button>
    </div>
  </div>
</div>

<!-- NOTIFICATION SYSTEM -->
<div class="notification" id="notification">
  <div class="notification-header">
    <div class="notification-title">
      <span id="notificationIcon">üí°</span>
      <span id="notificationTitle">Notifica</span>
    </div>
    <button class="notification-close" id="notificationClose">&times;</button>
  </div>
  <div id="notificationMessage">Messaggio di notifica</div>
</div>

<div class="bottomBar">
  <button class="btn tiny gray" id="btnBackBottom" type="button">‚Üê Gestionale</button>
  <div style="flex:1; text-align:center; font-size:10px; color:var(--muted);">
    <span id="clipboardMonitor">üìã Monitor clipboard: <span style="color:var(--success);">Attivo</span></span>
  </div>
  <button class="btn tiny" id="btnNotifications" type="button">üîî Notifiche</button>
</div>

<script>
/* ==========================
   CONFIG ENHANCED
========================== */
const GESTIONALE_URL = "https://tuo-gestionale.com";
const JOSEPH_DEFAULT_WA = "393713708294";

const GPT_PROMPT_BASE = `
Sei un assistente per creare video verticali 9:16 in italiano.
Scrivi un testo da leggere in 60 secondi massimo, naturale, parlato, senza "ciao ragazzi".
Struttura:
1) Hook fortissimo (2-3 secondi)
2) Target chiaro
3) Una sola idea (1 takeaway)
4) Ritmo alto (frasi brevi)
5) Chiusura con CTA (Scrivimi su WhatsApp)
Rispondi SOLO col testo da leggere.
`.trim();

const HIDDEN_HASHTAGS = [
  "#immobiliarelasacra","#josephcretorlab","#realmediapro","#amamy",
  "#immobiliare","#realestateitalia","#marketingdigitale","#socialmediastrategy","#personalbranding"
].join(" ");

/* ==========================
   DOMANDE (300) - SAME AS BEFORE
========================== */
function buildQuestions300Natural(){
  const phases = [
    { code:"A", name:"ACQUISIZIONE", topics:[
      "valutazione casa","incarico in esclusiva","foto annuncio","prezzo di partenza","tempi di vendita",
      "annuncio che non porta chiamate","proprietario indeciso","vendere da privato","open house","documenti","zona/mercato","strategia marketing"
    ]},
    { code:"L", name:"LEAD", topics:[
      "lead freddi","prima chiamata","messaggio WhatsApp","qualifica cliente","budget reale",
      "motivazione e urgenza","finanziamento e mutuo","criteri di scelta","obiezioni iniziali","comparazione immobili","appuntamento visita","follow-up immediato"
    ]},
    { code:"F", name:"FOLLOW-UP", topics:[
      "dopo la visita","cliente sparito","seconda visita","paura di sbagliare","rimandare la decisione",
      "silenzio dopo proposta","ricontatto elegante","micro-impegno","urgenza percepita","riproporre valore","timeline decisione","riattivazione"
    ]},
    { code:"T", name:"TRATTATIVA", topics:[
      "offerta bassa","controproposta","negoziazione","caparra e condizioni","tempi di risposta",
      "clausole mutuo","obiezioni sul prezzo","chiudere senza scontare troppo","gestire emozioni","win-win","firme e step","chiusura"
    ]},
    { code:"R", name:"FIDELIZZAZIONE", topics:[
      "post-vendita","recensioni","passaparola","contenuti utili","aggiornamenti mercato",
      "opportunit√† future","community locale","relazione continua","assistenza documenti","consigli pratici casa","referral","nuovi incarichi da clienti"
    ]},
  ];
  const templates = [
    (t)=>`Quando parli di ${t}, qual √® la cosa che quasi tutti sottovalutano?`,
    (t)=>`Se ${t} non sta funzionando, qual √® la prima verifica che fai?`,
    (t)=>`Cosa dire (in modo semplice) per spiegare ${t} a un cliente scettico?`,
    (t)=>`Qual √® il segnale pi√π chiaro che ${t} √® impostato male?`,
    (t)=>`Se vuoi migliorare ${t} gi√† da oggi, qual √® un'azione concreta da fare subito?`,
    (t)=>`Qual √® la domanda giusta da fare per sbloccare ${t}?`,
    (t)=>`Perch√© su ${t} le persone si bloccano? E come le aiuti a decidere?`,
    (t)=>`Cosa cambia davvero i risultati su ${t}, senza spendere di pi√π?`,
    (t)=>`Qual √® l'errore pi√π comune su ${t}‚Ä¶ detto in modo chiaro e pratico?`,
    (t)=>`Se ti capita spesso un blocco su ${t}, come lo risolvi in 2 mosse?`,
  ];
  const out = [];
  for(const ph of phases){
    let i = 0;
    while(i < 60){
      for(const topic of ph.topics){
        for(const makeQ of templates){
          if(i >= 60) break;
          const id = `${ph.code}${String(i+1).padStart(3,"0")}`;
          out.push({ id, fase: ph.name, categoria: topic, domanda: makeQ(topic) });
          i++;
        }
        if(i >= 60) break;
      }
    }
  }
  return out.slice(0,300);
}
const QUESTION_BANK = buildQuestions300Natural();

/* ==========================
   ENHANCED STORAGE KEYS
========================== */
const DB_KEY   = "vc_videos_db_v6";
const CAP_KEY  = "vc_caption_clean_v6";
const PHONE_KEY= "vc_phone_v6";
const LOGO_KEY = "vc_logo_v6";

const OP_KEY   = "vc_operator_v6";
const JO_KEY   = "vc_josephwa_v6";
const GROUP_KEY= "vc_groupinvite_v6";
const DEST_KEY = "vc_destmode_v6";

const PUBSET_KEY = "vc_pub_settings_by_platform_v6";
const HIST_KEY = "vc_pub_history_v6";

// NEW KEYS FOR ENHANCED FEATURES
const APPROVAL_KEY = "vc_approvals_v6"; // {videoId: {status, comment, date, by}}
const COMMENTS_KEY = "vc_comments_v6"; // {videoId: [{text, date, by}]}
const MULTI_SCHEDULE_KEY = "vc_multi_schedule_v6"; // Multi-platform scheduling
const ANALYTICS_KEY = "vc_analytics_v6"; // Analytics data
const AUTO_GPT_KEY = "vc_autogpt_settings_v6"; // Auto-GPT detection settings

/* ==========================
   ENHANCED STATE
========================== */
let qIdx = -1;
let currentQuestionObj = null;
let currentQuestion = "";
let lastCaptionClean = "";
let totalVideos = 0;

const PLATFORMS = ["TIKTOK","INSTAGRAM","SHORTS","FACEBOOK"];
let selectedPlatform = "TIKTOK";
let multiPlatformSelection = ["TIKTOK","INSTAGRAM"]; // Default multi-platform

let logoDataUrl = "";
let logoImgObj = new Image();
let phoneValue = "";
let operatorName = "";
let josephWa = JOSEPH_DEFAULT_WA;
let groupInvite = "";
let destMode = "joseph";

let facingMode = "user";
let torchOn = false;

let recordings = [];
let currentRecIndex = -1;

let karaokeWords = [];
let karaokeIndex = 0;

let camStream = null;
let recorder = null;
let chunks = [];
let rafCanvasId = null;
let recTimerId = null;
let remaining = 60;
let isRecording = false;

let zoomValue = 1.0;
const camEl = $("cam");
const canvas = $("recCanvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

// Auto-GPT detection
let autoGPTObserver = null;
let lastClipboardCheck = "";

/* ==========================
   ENHANCED HELPERS
========================== */
const $ = (id) => document.getElementById(id);

function pad2(n){ return String(n).padStart(2,"0"); }
function nowStamp(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}-${pad2(d.getHours())}-${pad2(d.getMinutes())}-${pad2(d.getSeconds())}`;
}
function toISO(ms){ return new Date(ms).toISOString(); }
function fmtLocal(iso){
  const d = new Date(iso);
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function slugify(it){
  return String(it || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s-]/g,"")
    .trim()
    .replace(/\s+/g,"-")
    .replace(/-+/g,"-")
    .slice(0, 60);
}
function keywordsFromQuestion(q){
  const stop = new Set(["perche","perch√©","che","cosa","come","se","e","o","il","lo","la","i","gli","le","un","una","da","di","del","della","delle","dei","dello","in","su","a","al","alla","alle","agli","ai","con","senza","poi","subito","solo","nessuna","nessun","meglio","ha","senso","dopo","non","piu","pi√π","anche"]);
  const words = slugify(q).split("-").filter(w => w && !stop.has(w));
  return words.slice(0, 5).join("-");
}
async function copyText(text){
  const t = String(text || "");
  if(!t.trim()) return false;
  try{
    await navigator.clipboard.writeText(t);
    return true;
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    return true;
  }
}
async function readClipboardText(){
  return await navigator.clipboard.readText();
}
function captionWithHashtagsIfNeeded(clean){
  const c = String(clean || "").trim();
  if(!c) return "";
  const lower = c.toLowerCase();
  if (lower.includes("#immobiliarelasacra") || lower.includes("#josephcretorlab") || lower.includes("#realmediapro")){
    return c;
  }
  return `${c}\n\n${HIDDEN_HASHTAGS}`.trim();
}

/* ==========================
   MODAL SYSTEM
========================== */
function showModal(id){
  $(id).style.display = "flex";
  setTimeout(() => $(id).style.opacity = "1", 10);
}
function hideModal(id){
  $(id).style.opacity = "0";
  setTimeout(() => $(id).style.display = "none", 300);
}

/* ==========================
   NOTIFICATION SYSTEM
========================== */
function showNotification(title, message, icon = "üí°", duration = 5000){
  $("#notificationIcon").textContent = icon;
  $("#notificationTitle").textContent = title;
  $("#notificationMessage").textContent = message;
  
  const notif = $("#notification");
  notif.classList.add("show");
  
  setTimeout(() => {
    notif.classList.remove("show");
  }, duration);
}

$("#notificationClose").addEventListener("click", () => {
  $("#notification").classList.remove("show");
});

/* ==========================
   FEATURE 1: AUTO-GPT DETECTION
========================== */
function isGPTResponse(text){
  const gptPatterns = [
    /^Certo!?/i,
    /^Ecco (la risposta|un testo)/i,
    /^Come assistente AI/i,
    /^Sulla base della tua domanda/i,
    /^Per creare un video efficace/i,
    /^Testo da leggere in 60 secondi/i
  ];
  
  const lines = text.split('\n');
  if(lines.length < 2) return false;
  
  // Check for GPT patterns
  for(const pattern of gptPatterns){
    if(pattern.test(text.trim())) return true;
  }
  
  // Check for structured response (hook, target, takeaway, CTA)
  const hasStructure = 
    (text.includes("Hook") || text.includes("hook")) ||
    (text.includes("Target") || text.includes("target")) ||
    (text.includes("Takeaway") || text.includes("takeaway")) ||
    (text.includes("CTA") || text.includes("Scrivimi"));
  
  return hasStructure;
}

function cleanGPTResponse(text){
  // Remove common GPT prefixes
  let cleaned = text
    .replace(/^Certo!?\s*/i, '')
    .replace(/^Ecco (la risposta|un testo):?\s*/i, '')
    .replace(/^Come assistente AI[^,]+,/i, '')
    .replace(/^Sulla base della tua domanda[^,]+,/i, '')
    .replace(/^Per creare un video efficace[^,]+,/i, '')
    .trim();
  
  // Remove markdown formatting if present
  cleaned = cleaned.replace(/\*\*(.*?)\*\*/g, '$1');
  cleaned = cleaned.replace(/\*(.*?)\*/g, '$1');
  
  return cleaned;
}

async function monitorClipboardForGPT(){
  if(!$("chkAutoDetectGPT").checked) return;
  
  try {
    const current = await readClipboardText();
    if(current && current !== lastClipboardCheck && current.length > 50){
      if(isGPTResponse(current)){
        const cleaned = cleanGPTResponse(current);
        $("answerBox").value = cleaned;
        lastClipboardCheck = current;
        
        showNotification(
          "ü§ñ ChatGPT Rilevato",
          "Risposta pulita e inserita automaticamente nel box!",
          "‚úÖ",
          3000
        );
        
        // Auto-use answer
        setTimeout(() => {
          if($("answerBox").value.trim()){
            applyAnswer($("answerBox").value);
          }
        }, 500);
      }
    }
  } catch(e) {
    // Clipboard access might be blocked in some contexts
  }
}

// Start clipboard monitoring
setInterval(monitorClipboardForGPT, 2000);

/* ==========================
   FEATURE 2: VISUAL SCHEDULING CALENDAR
========================== */
function generateCalendar(days = 7){
  const now = new Date();
  const calendar = [];
  
  for(let i = 0; i < days; i++){
    const date = new Date(now);
    date.setDate(now.getDate() + i);
    
    const slots = [];
    // Generate time slots (8:00 to 20:00, every 2 hours)
    for(let hour = 8; hour <= 20; hour += 2){
      const slotTime = new Date(date);
      slotTime.setHours(hour, 0, 0, 0);
      
      // Check if slot is occupied
      const isOccupied = isSlotOccupied(slotTime);
      
      slots.push({
        time: slotTime,
        label: `${pad2(hour)}:00`,
        occupied: isOccupied,
        available: !isOccupied && slotTime > now
      });
    }
    
    calendar.push({
      date: date,
      dayLabel: date.toLocaleDateString('it-IT', { weekday: 'short' }),
      dateLabel: `${pad2(date.getDate())}/${pad2(date.getMonth()+1)}`,
      slots: slots
    });
  }
  
  return calendar;
}

function isSlotOccupied(dateTime){
  const h = getHistory();
  const iso = dateTime.toISOString();
  
  for(const platform of PLATFORMS){
    const platformHistory = h[platform] || [];
    if(platformHistory.some(slot => {
      const slotTime = new Date(slot);
      return Math.abs(slotTime - dateTime) < 60 * 60 * 1000; // Within 1 hour
    })){
      return true;
    }
  }
  
  return false;
}

function renderCalendar(){
  const calendar = generateCalendar(7);
  const grid = $("#calendarGrid");
  
  // Create header (days)
  let html = `<div class="calendar-grid" style="grid-template-columns: 80px repeat(6, 1fr); margin-bottom:12px;">`;
  html += `<div class="calendar-day">Ora</div>`;
  calendar.forEach(day => {
    html += `<div class="calendar-day">${day.dayLabel}<br>${day.dateLabel}</div>`;
  });
  html += `</div>`;
  
  // Create time slots
  for(let slotIndex = 0; slotIndex < 7; slotIndex++){ // 8:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00
    html += `<div class="calendar-grid" style="grid-template-columns: 80px repeat(6, 1fr);">`;
    html += `<div class="calendar-slot" style="background:transparent;border:none;font-weight:1000;">${8 + slotIndex*2}:00</div>`;
    
    calendar.forEach(day => {
      const slot = day.slots[slotIndex];
      if(slot){
        const classes = ["calendar-slot"];
        if(slot.occupied) classes.push("occupied");
        if(slot.available) classes.push("available");
        
        html += `<div class="${classes.join(' ')}" data-time="${slot.time.toISOString()}">
          ${slot.occupied ? 'üìå Occupato' : (slot.available ? 'üü¢ Libero' : '‚è≥ Passato')}
        </div>`;
      } else {
        html += `<div class="calendar-slot" style="opacity:0.3;">‚Äî</div>`;
      }
    });
    
    html += `</div>`;
  }
  
  grid.innerHTML = html;
  
  // Add click handlers
  grid.querySelectorAll('.calendar-slot.available').forEach(slot => {
    slot.addEventListener('click', () => {
      const time = slot.dataset.time;
      showNotification(
        "üìÖ Slot Selezionato",
        `Slot selezionato per ${new Date(time).toLocaleString('it-IT')}`,
        "‚úÖ",
        3000
      );
      
      // Update selected platform's next slot
      markSlotUsed(selectedPlatform, time);
      refreshPlatformUI();
    });
  });
}

/* ==========================
   FEATURE 3: MULTI-PLATFORM SIMULTANEOUS
========================== */
function setupMultiPlatformUI(){
  const selector = document.querySelector('.platform-selector');
  selector.innerHTML = '';
  
  PLATFORMS.forEach(platform => {
    const isActive = multiPlatformSelection.includes(platform);
    const label = document.createElement('label');
    label.className = `platform-check ${isActive ? 'active' : ''}`;
    label.dataset.platform = platform;
    label.innerHTML = `
      <input type="checkbox" ${isActive ? 'checked' : ''} />
      <span>${platform}</span>
    `;
    
    label.addEventListener('click', (e) => {
      e.preventDefault();
      const checkbox = label.querySelector('input');
      checkbox.checked = !checkbox.checked;
      
      if(checkbox.checked){
        label.classList.add('active');
        if(!multiPlatformSelection.includes(platform)){
          multiPlatformSelection.push(platform);
        }
      } else {
        label.classList.remove('active');
        multiPlatformSelection = multiPlatformSelection.filter(p => p !== platform);
      }
    });
    
    selector.appendChild(label);
  });
}

function scheduleMultiPlatform(videoId, baseTime){
  const offsets = {
    "simultaneo": [0, 0, 0, 0],
    "scaglionato": [0, 30, 60, 90], // minutes
    "personalizzato": [0, 60, 120, 180] // default personalizzato
  };
  
  const offsetMode = document.querySelector('input[name="offsetMode"]:checked').value;
  const offsetValues = offsets[offsetMode];
  
  multiPlatformSelection.forEach((platform, index) => {
    if(index < offsetValues.length){
      const offsetMinutes = offsetValues[index];
      const scheduledTime = new Date(baseTime);
      scheduledTime.setMinutes(scheduledTime.getMinutes() + offsetMinutes);
      
      // Mark slot for this platform
      markSlotUsed(platform, scheduledTime.toISOString());
      
      // Update video metadata if this is the current video
      if(recordings[0] && recordings[0].meta.id === videoId){
        if(!recordings[0].meta.multiPlatform){
          recordings[0].meta.multiPlatform = [];
        }
        recordings[0].meta.multiPlatform.push({
          platform: platform,
          scheduledAt: scheduledTime.toISOString(),
          offsetMinutes: offsetMinutes
        });
        
        // Persist updated metadata
        persistVideoMeta(recordings[0].meta);
      }
    }
  });
  
  showNotification(
    "üîÑ Multi-piattaforma",
    `Video schedulato su ${multiPlatformSelection.length} piattaforme`,
    "‚úÖ",
    4000
  );
  
  refreshPlatformUI();
  renderRecList();
}

/* ==========================
   FEATURE 4: APPROVAL SYSTEM
========================== */
function getApprovalStatus(videoId){
  try{
    const approvals = JSON.parse(localStorage.getItem(APPROVAL_KEY) || "{}");
    return approvals[videoId] || { status: "pending", comment: "", date: null, by: "" };
  }catch(e){
    return { status: "pending", comment: "", date: null, by: "" };
  }
}

function setApprovalStatus(videoId, status, comment = "", by = ""){
  try{
    const approvals = JSON.parse(localStorage.getItem(APPROVAL_KEY) || "{}");
    approvals[videoId] = {
      status: status,
      comment: comment.trim(),
      date: new Date().toISOString(),
      by: by || operatorName || "System"
    };
    localStorage.setItem(APPROVAL_KEY, JSON.stringify(approvals));
    
    // Update video metadata
    const videoIndex = recordings.findIndex(r => r.meta.id === videoId);
    if(videoIndex !== -1){
      recordings[videoIndex].meta.approval = approvals[videoId];
      persistVideoMeta(recordings[videoIndex].meta);
    }
    
    return true;
  }catch(e){
    return false;
  }
}

function getComments(videoId){
  try{
    const comments = JSON.parse(localStorage.getItem(COMMENTS_KEY) || "{}");
    return comments[videoId] || [];
  }catch(e){
    return [];
  }
}

function addComment(videoId, text, by = ""){
  try{
    const comments = JSON.parse(localStorage.getItem(COMMENTS_KEY) || "{}");
    if(!comments[videoId]) comments[videoId] = [];
    
    comments[videoId].push({
      text: text.trim(),
      date: new Date().toISOString(),
      by: by || operatorName || "Anonymous"
    });
    
    localStorage.setItem(COMMENTS_KEY, JSON.stringify(comments));
    return true;
  }catch(e){
    return false;
  }
}

function updatePendingCount(){
  const pending = recordings.filter(r => {
    const approval = getApprovalStatus(r.meta.id);
    return approval.status === "pending";
  }).length;
  
  $("#pendingCount").textContent = `${pending} in attesa`;
  return pending;
}

/* ==========================
   FEATURE 5: ANALYTICS DASHBOARD
========================== */
function calculateAnalytics(){
  const videos = recordings;
  const now = new Date();
  const thirtyDaysAgo = new Date(now);
  thirtyDaysAgo.setDate(now.getDate() - 30);
  
  // Filter videos from last 30 days
  const recentVideos = videos.filter(v => {
    const videoDate = new Date(v.meta.createdAt);
    return videoDate >= thirtyDaysAgo;
  });
  
  // Calculate statistics
  const totalVideosCount = videos.length;
  const recentCount = recentVideos.length;
  
  const approvedVideos = videos.filter(v => {
    const approval = getApprovalStatus(v.meta.id);
    return approval.status === "approved";
  }).length;
  
  const pendingVideos = videos.filter(v => {
    const approval = getApprovalStatus(v.meta.id);
    return approval.status === "pending";
  }).length;
  
  const approvalRate = totalVideosCount > 0 ? Math.round((approvedVideos / totalVideosCount) * 100) : 0;
  
  // Platform distribution
  const platformDistribution = {};
  PLATFORMS.forEach(p => platformDistribution[p] = 0);
  
  recentVideos.forEach(v => {
    const platform = v.meta.platform;
    if(platformDistribution[platform] !== undefined){
      platformDistribution[platform]++;
    }
  });
  
  // Operator productivity
  const operatorStats = {};
  recentVideos.forEach(v => {
    const operator = v.meta.operator || "Sconosciuto";
    if(!operatorStats[operator]) operatorStats[operator] = 0;
    operatorStats[operator]++;
  });
  
  // Calculate trends (simple week-over-week)
  const lastWeekVideos = videos.filter(v => {
    const videoDate = new Date(v.meta.createdAt);
    const oneWeekAgo = new Date(now);
    oneWeekAgo.setDate(now.getDate() - 7);
    return videoDate >= oneWeekAgo;
  }).length;
  
  const twoWeeksVideos = videos.filter(v => {
    const videoDate = new Date(v.meta.createdAt);
    const twoWeeksAgo = new Date(now);
    twoWeeksAgo.setDate(now.getDate() - 14);
    const oneWeekAgo = new Date(now);
    oneWeekAgo.setDate(now.getDate() - 7);
    return videoDate >= oneWeekAgo && videoDate < twoWeeksAgo;
  }).length;
  
  const trend = twoWeeksVideos > 0 ? 
    Math.round(((lastWeekVideos - twoWeeksVideos) / twoWeeksVideos) * 100) : 0;
  
  const avgVideosPerDay = recentCount > 0 ? (recentCount / 30).toFixed(1) : "0";
  
  return {
    totalVideos: totalVideosCount,
    approved: approvedVideos,
    pending: pendingVideos,
    approvalRate: approvalRate,
    platformDistribution: platformDistribution,
    operatorStats: operatorStats,
    trend: trend,
    avgVideosPerDay: avgVideosPerDay,
    recentCount: recentCount,
    lastWeekVideos: lastWeekVideos
  };
}

function renderAnalytics(){
  const analytics = calculateAnalytics();
  
  // Update stats cards
  $("#statTotalVideos").textContent = analytics.totalVideos;
  $("#statApproved").textContent = analytics.approved;
  $("#statPending").textContent = analytics.pending;
  $("#statApprovalRate").textContent = `${analytics.approvalRate}%`;
  $("#statProductivity").textContent = analytics.avgVideosPerDay;
  
  // Update trends
  const trendElem = $("#statTrendVideos");
  trendElem.textContent = `${analytics.trend >= 0 ? '+' : ''}${analytics.trend}% vs settimana scorsa`;
  trendElem.className = `stat-trend ${analytics.trend >= 0 ? 'trend-up' : 'trend-down'}`;
  
  // Platform distribution
  const platformDistElem = $("#platformDistribution");
  let platformHTML = "";
  for(const platform in analytics.platformDistribution){
    const count = analytics.platformDistribution[platform];
    if(count > 0){
      const percentage = Math.round((count / analytics.recentCount) * 100) || 0;
      platformHTML += `
        <div style="margin:6px 0; display:flex; align-items:center;">
          <div style="width:100px; font-weight:900; font-size:10px;">${platform}</div>
          <div style="flex:1; background:rgba(255,255,255,.1); height:8px; border-radius:4px; overflow:hidden;">
            <div style="width:${percentage}%; height:100%; background:var(--gold);"></div>
          </div>
          <div style="width:40px; text-align:right; font-size:10px; margin-left:8px;">${count} (${percentage}%)</div>
        </div>
      `;
    }
  }
  platformDistElem.innerHTML = platformHTML || "<div style='opacity:0.7;'>Nessun dato</div>";
  
  // Top operators
  const topOpsElem = $("#topOperators");
  const sortedOperators = Object.entries(analytics.operatorStats)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  let operatorsHTML = "";
  sortedOperators.forEach(([operator, count]) => {
    operatorsHTML += `
      <div style="margin:6px 0; display:flex; align-items:center; justify-content:space-between;">
        <div style="font-weight:900; font-size:10px;">${operator}</div>
        <div style="font-size:10px; color:var(--gold);">${count} video</div>
      </div>
    `;
  });
  topOpsElem.innerHTML = operatorsHTML || "<div style='opacity:0.7;'>Nessun dato</div>";
  
  // Calculate average pending time
  const pendingVideos = recordings.filter(r => {
    const approval = getApprovalStatus(r.meta.id);
    return approval.status === "pending";
  });
  
  let totalPendingHours = 0;
  pendingVideos.forEach(v => {
    const created = new Date(v.meta.createdAt);
    const now = new Date();
    const hours = Math.round((now - created) / (1000 * 60 * 60));
    totalPendingHours += hours;
  });
  
  const avgPendingTime = pendingVideos.length > 0 ? 
    Math.round(totalPendingHours / pendingVideos.length) : 0;
  $("#statAvgPendingTime").textContent = `${avgPendingTime}h`;
}

/* ==========================
   ENHANCED SETTINGS & HISTORY (from original)
========================== */
function getPubSettings(){
  try{
    const s = JSON.parse(localStorage.getItem(PUBSET_KEY) || "{}");
    for(const p of PLATFORMS){
      if(!s[p]) s[p] = { mode:"per_day", value:2 };
      if(!s[p].mode) s[p].mode = "per_day";
      if(!Number.isFinite(Number(s[p].value))) s[p].value = 2;
    }
    return s;
  }catch(e){
    const s = {};
    for(const p of PLATFORMS) s[p] = { mode:"per_day", value:2 };
    return s;
  }
}
function setPubSetting(platform, mode, value){
  const all = getPubSettings();
  all[platform] = { mode, value: Number(value) || 1 };
  localStorage.setItem(PUBSET_KEY, JSON.stringify(all));
  return all;
}
function getHistory(){
  try{
    return JSON.parse(localStorage.getItem(HIST_KEY) || "") || { TIKTOK:[], INSTAGRAM:[], SHORTS:[], FACEBOOK:[] };
  }catch(e){
    return { TIKTOK:[], INSTAGRAM:[], SHORTS:[], FACEBOOK:[] };
  }
}
function setHistory(h){
  localStorage.setItem(HIST_KEY, JSON.stringify(h));
}
function minGapMinutesFor(platform){
  const all = getPubSettings();
  const s = all[platform] || { mode:"per_day", value:2 };
  const v = Math.max(1, Number(s.value) || 1);
  if(s.mode === "per_day") return Math.round((24*60)/v);
  if(s.mode === "every_hours") return v * 60;
  return v;
}
function calcNextSlot(platform){
  const gap = minGapMinutesFor(platform);
  const h = getHistory();
  const list = (h[platform] || []).slice().sort((a,b)=> new Date(b) - new Date(a));
  const now = Date.now();
  if(list.length === 0) return toISO(now);
  const last = new Date(list[0]).getTime();
  return toISO(Math.max(now, last + gap*60*1000));
}
function markSlotUsed(platform, iso){
  const h = getHistory();
  h[platform] = h[platform] || [];
  h[platform].unshift(iso);
  setHistory(h);
}
function refreshPlatformUI(){
  $("platformLabel").textContent = "Piattaforma: " + selectedPlatform;
  $("nextSlotPill").textContent = "Slot: " + fmtLocal(calcNextSlot(selectedPlatform));
}

/* ==========================
   ENHANCED QUESTIONS + CATEGORY
========================== */
function showQuestion(q){
  $("questionOverlay").textContent = q ? q : "Premi 'Nuova domanda'.";
}
function getCategoryForQuestion(qObj){
  if(!qObj || !qObj.fase) return "ATTUALIT√Ä";
  const fase = qObj.fase || "ATTUALIT√Ä";
  const cat = qObj.categoria ? ` ‚Ä¢ ${qObj.categoria}` : "";
  return (fase + cat).toUpperCase();
}
function nextQuestion(){
  qIdx = (qIdx + 1) % QUESTION_BANK.length;
  currentQuestionObj = QUESTION_BANK[qIdx];
  currentQuestion = currentQuestionObj.domanda;
  showQuestion(currentQuestion);
  $("categoryOverlay").textContent = getCategoryForQuestion(currentQuestionObj);
}

/* ==========================
   ENHANCED ChatGPT
========================== */
function buildChatGPTPayload(){
  const qText = (currentQuestionObj && currentQuestionObj.domanda) ? currentQuestionObj.domanda : "ATTUALIT√Ä";
  const cat = getCategoryForQuestion(currentQuestionObj) || "ATTUALIT√Ä";
  const wa = phoneValue ? `Numero WhatsApp: ${phoneValue}` : "Numero WhatsApp: +393713708294";
  return `${GPT_PROMPT_BASE}\n\nCONTESTO:\nCategoria: ${cat}\n${wa}\n\nDOMANDA:\n${qText}`.trim();
}
async function openChatGPTAndCopy(){
  if(!currentQuestionObj) nextQuestion();
  const payload = buildChatGPTPayload();
  await copyText(payload);
  
  showNotification(
    "ü§ñ ChatGPT Pronto",
    "Prompt copiato negli appunti! Incolla in ChatGPT e la risposta verr√† auto-rilevata.",
    "üìã",
    4000
  );
  
  window.open("https://chat.openai.com/", "_blank", "noopener,noreferrer");
}

/* ==========================
   ENHANCED Teleprompter
========================== */
function buildKaraokeSpans(text){
  const container = $("teleText");
  container.innerHTML = "";
  const tokens = String(text || "").replace(/\s+/g," ").trim().split(" ").filter(Boolean);
  karaokeWords = tokens;
  karaokeIndex = 0;

  if(tokens.length === 0){
    container.textContent = "Incolla una risposta ‚Üí 'Usa risposta' ‚Üí 'REC'.";
    karaokeWords = [];
    return;
  }

  for(const w of tokens){
    const span = document.createElement("span");
    span.className = "w";
    span.textContent = w + " ";
    container.appendChild(span);
  }
}
function karaokeStep(n=1){
  const el = $("teleText");
  const spans = el.querySelectorAll(".w");
  if(!spans.length) return;
  for(let k=0;k<n;k++){
    if(karaokeIndex > 0 && spans[karaokeIndex-1]) spans[karaokeIndex-1].classList.remove("on");
    if(spans[karaokeIndex]){
      spans[karaokeIndex].classList.add("on");
      spans[karaokeIndex].scrollIntoView({ block:"nearest", inline:"nearest" });
      karaokeIndex = Math.min(karaokeIndex + 1, spans.length);
    }
  }
}

function applyAnswer(answer){
  const a = String(answer || "").trim();
  if(!a) return false;

  lastCaptionClean = a;
  try{ localStorage.setItem(CAP_KEY, lastCaptionClean); }catch(e){}

  buildKaraokeSpans(a);

  $("categoryOverlay").textContent = getCategoryForQuestion(currentQuestionObj) || "ATTUALIT√Ä";

  return true;
}

function buildFinalCaption(){
  const phoneLine = phoneValue ? `\n\nWHATSAPP: ${phoneValue}` : `\n\nWHATSAPP: +393713708294`;
  const base = `[${selectedPlatform}] ${lastCaptionClean || ""}`.trim();
  return captionWithHashtagsIfNeeded((base + phoneLine).trim());
}

/* ==========================
   ENHANCED Logo + Phone
========================== */
function setLogoDataUrl(dataUrl){
  logoDataUrl = String(dataUrl || "");
  if(logoDataUrl){
    $("logoImg").src = logoDataUrl;
    $("logoImg").style.display = "block";
    logoImgObj = new Image();
    logoImgObj.crossOrigin = "anonymous";
    logoImgObj.src = logoDataUrl;
    try{ localStorage.setItem(LOGO_KEY, logoDataUrl); }catch(e){}
  }else{
    $("logoImg").style.display = "none";
    try{ localStorage.removeItem(LOGO_KEY); }catch(e){}
  }
}
function renderPhone(){
  if(phoneValue){
    $("waPhoneOverlay").textContent = `WHATSAPP: ${phoneValue}`;
  }else{
    $("waPhoneOverlay").textContent = `WHATSAPP: +393713708294`;
  }
}

/* ==========================
   ENHANCED Camera & Recording (from original)
========================== */
async function applyZoom(v){
  zoomValue = Number(v) || 1;
  $("zoomVal").textContent = `${zoomValue.toFixed(1)}x`;
  document.documentElement.style.setProperty("--zoom", String(zoomValue));
}

function drawRecordingCanvas(){
  const W = canvas.width, H = canvas.height;

  if(camEl.readyState < 2){
    ctx.fillStyle = "black";
    ctx.fillRect(0,0,W,H);
    return;
  }

  const vw = camEl.videoWidth || 1280;
  const vh = camEl.videoHeight || 720;

  const z = Math.max(1, Math.min(zoomValue, 5));
  const srcW = vw / z;
  const srcH = vh / z;
  const srcX = (vw - srcW)/2;
  const srcY = (vh - srcH)/2;

  ctx.drawImage(camEl, srcX, srcY, srcW, srcH, 0, 0, W, H);

  // Overlay at 1/4 height
  ctx.save();
  ctx.textBaseline = "top";

  const q = (currentQuestionObj && currentQuestionObj.domanda) ? currentQuestionObj.domanda : "ATTUALIT√Ä";
  const cat = (getCategoryForQuestion(currentQuestionObj) || "ATTUALIT√Ä").toUpperCase();
  const wa = phoneValue ? `WHATSAPP: ${phoneValue}` : "WHATSAPP: +393713708294";

  const centerY = Math.round(H * 0.25);
  let y = centerY - 220;

  const qBoxW = W - 120;
  const qBoxX = (W - qBoxW)/2;
  const qBoxH = 150;

  ctx.fillStyle = "rgba(0,0,0,.35)";
  ctx.strokeStyle = "rgba(255,255,255,.18)";
  ctx.lineWidth = 2;
  roundRect(ctx, qBoxX, y, qBoxW, qBoxH, 26);
  ctx.fill(); ctx.stroke();

  ctx.font = "1000 36px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillStyle = "rgba(243,244,246,.95)";
  const qLines = wrapText(ctx, q, qBoxW - 70);
  for(let i=0;i<Math.min(2, qLines.length);i++){
    const line = truncateText(ctx, qLines[i], qBoxW - 70);
    const lw = measureTextWidth(ctx, line);
    ctx.fillText(line, qBoxX + (qBoxW - lw)/2, y + 22 + i*48);
  }

  y += qBoxH + 22;

  const logoBox = 90;
  const logoX = (W - logoBox)/2;
  ctx.fillStyle = "rgba(0,0,0,.30)";
  ctx.strokeStyle = "rgba(255,255,255,.18)";
  roundRect(ctx, logoX, y, logoBox, logoBox, 26);
  ctx.fill(); ctx.stroke();

  if(logoDataUrl && logoImgObj && logoImgObj.complete){
    const size = 50;
    const cx = logoX + (logoBox - size)/2;
    const cy = y + (logoBox - size)/2;

    const iw = logoImgObj.naturalWidth || size;
    const ih = logoImgObj.naturalHeight || size;
    const scale = Math.min(size/iw, size/ih);
    const dw = iw * scale;
    const dh = ih * scale;
    const dx = cx + (size - dw)/2;
    const dy = cy + (size - dh)/2;

    ctx.drawImage(logoImgObj, dx, dy, dw, dh);
  }

  y += logoBox + 18;

  ctx.font = "1000 28px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const catW = Math.min(W - 160, measureTextWidth(ctx, cat) + 56);
  const catX = (W - catW)/2;
  const catH = 62;

  ctx.fillStyle = "rgba(0,0,0,.26)";
  ctx.strokeStyle = "rgba(255,255,255,.14)";
  roundRect(ctx, catX, y, catW, catH, 22);
  ctx.fill(); ctx.stroke();

  ctx.fillStyle = "rgba(243,244,246,.95)";
  const catText = truncateText(ctx, cat, catW - 40);
  const catTw = measureTextWidth(ctx, catText);
  ctx.fillText(catText, catX + (catW - catTw)/2, y + 16);

  y += catH + 14;

  ctx.font = "1100 30px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const waW = Math.min(W - 160, measureTextWidth(ctx, wa) + 56);
  const waX = (W - waW)/2;
  const waH = 62;

  ctx.fillStyle = "rgba(0,0,0,.22)";
  ctx.strokeStyle = "rgba(255,255,255,.12)";
  roundRect(ctx, waX, y, waW, waH, 22);
  ctx.fill(); ctx.stroke();

  ctx.fillStyle = "rgba(37,211,102,.98)";
  const waText = truncateText(ctx, wa, waW - 40);
  const waTw = measureTextWidth(ctx, waText);
  ctx.fillText(waText, waX + (waW - waTw)/2, y + 16);

  ctx.restore();
}

function measureTextWidth(ctx, t){ return ctx.measureText(String(t||"")).width; }
function truncateText(ctx, t, maxW){
  let s = String(t||"");
  if(measureTextWidth(ctx, s) <= maxW) return s;
  while(s.length > 0 && measureTextWidth(ctx, s + "‚Ä¶") > maxW) s = s.slice(0,-1);
  return s + "‚Ä¶";
}
function wrapText(ctx, text, maxWidth){
  const words = String(text||"").split(/\s+/).filter(Boolean);
  const lines = [];
  let line = "";
  for(const w of words){
    const test = line ? (line + " " + w) : w;
    if(ctx.measureText(test).width <= maxWidth){
      line = test;
    }else{
      if(line) lines.push(line);
      line = w;
    }
  }
  if(line) lines.push(line);
  return lines;
}
function roundRect(ctx,x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

function startCanvasLoop(){
  function loop(){
    drawRecordingCanvas();
    rafCanvasId = requestAnimationFrame(loop);
  }
  loop();
}

async function startCamera(){
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      audio:true,
      video:{ facingMode: facingMode, width:{ideal:1280}, height:{ideal:720} }
    });
    camEl.srcObject = camStream;
    await new Promise(res => camEl.onloadedmetadata = () => res());
    try{ await camEl.play(); }catch(e){}
    if(!rafCanvasId) startCanvasLoop();
    return true;
  }catch(err){
    alert("Errore camera: " + err.message);
    return false;
  }
}

async function ensureReady(){
  if(!camStream){
    const ok = await startCamera();
    if(!ok) return false;
  }
  if(!rafCanvasId) startCanvasLoop();
  return true;
}

async function toggleTorch(){
  if(!camStream) return;
  const track = camStream.getVideoTracks?.()[0];
  if(!track) return;
  const caps = track.getCapabilities?.() || {};
  if(!caps.torch){
    alert("Flash (torch) non supportato su questo dispositivo/browser.");
    return;
  }
  torchOn = !torchOn;
  try{
    await track.applyConstraints({ advanced: [{ torch: torchOn }] });
  }catch(e){
    torchOn = !torchOn;
    alert("Impossibile attivare il flash.");
  }
}

async function flipCamera(){
  facingMode = (facingMode === "user") ? "environment" : "user";
  await startCamera();
}

/* ==========================
   ENHANCED DB + LIST with Approvals
========================== */
function persistVideoMeta(meta){
  const db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
  
  // Find and update existing or add new
  const index = db.findIndex(v => v.id === meta.id);
  if(index !== -1){
    db[index] = meta;
  } else {
    db.unshift(meta);
  }
  
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}
function buildVideoId(){
  const p = selectedPlatform;
  const qkey = keywordsFromQuestion(currentQuestion || "attualita") || "video";
  return `VID_${p}_${qkey}_${nowStamp()}`;
}
function buildFileName(id){ return `${id}.webm`; }
function buildVideoTitle(videoNum, platform, question){
  const k = keywordsFromQuestion(question) || "video";
  const p = platform || "MANUALE";
  return `#${String(videoNum).padStart(3,"0")} ‚Ä¢ ${p} ‚Ä¢ ${k}`;
}
function updateCounters(){
  totalVideos = recordings.length;
  $("videoCounter").textContent = `Video: ${totalVideos}`;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

/* ==========================
   ENHANCED WhatsApp message
========================== */
function buildWhatsAppMessage(meta){
  const op = (meta.operator || operatorName || "‚Äî").trim() || "‚Äî";
  const whenIso = meta.scheduledAtISO || calcNextSlot(meta.platform || selectedPlatform);
  const when = fmtLocal(whenIso);
  const header = `[${meta.platform}] [${when}] [${op}] [${meta.id}]`;
  const body = (meta.captionFinal || buildFinalCaption()).trim();
  return `${header}\n\n${body}`.trim();
}

function openWhatsAppToNumber(numberNoPlus, text){
  const url = `https://wa.me/${encodeURIComponent(numberNoPlus)}?text=${encodeURIComponent(text)}`;
  window.location.href = url;
}

async function openWhatsAppGroup(inviteLink, text){
  await copyText(text);
  window.location.href = inviteLink;
}

/* ==========================
   ENHANCED Render list with Approvals
========================== */
function renderRecList(){
  const box = $("recList");
  if(!recordings.length){ box.textContent = "‚Äî"; return; }

  box.innerHTML = "";
  recordings.forEach((r, i)=>{
    const meta = r.meta || {};
    const approval = getApprovalStatus(meta.id);
    const comments = getComments(meta.id);
    
    const div = document.createElement("div");
    div.className = "vItem";
    const selected = i===currentRecIndex;

    const msg = buildWhatsAppMessage(meta);
    
    // Approval badge
    const approvalBadge = approval.status === "approved" ? 
      `<span class="approval-badge badge-approved">‚úÖ Approvato</span>` :
      approval.status === "revision" ?
      `<span class="approval-badge badge-revision">‚úèÔ∏è Da revisionare</span>` :
      `<span class="approval-badge badge-pending">‚è≥ In attesa</span>`;
    
    // Multi-platform indicator
    const multiPlatformIndicator = meta.multiPlatform && meta.multiPlatform.length > 0 ?
      `<span style="font-size:9px; color:var(--gold); margin-left:6px;">üîÑ ${meta.multiPlatform.length} piattaforme</span>` : "";
    
    div.innerHTML = `
      <div class="vTop">
        <div class="vTitle" style="${selected ? 'color:#d8a23a;' : ''}">
          ${r.title} ${approvalBadge} ${multiPlatformIndicator}
        </div>
        <div class="pill">${meta.platform} ‚Ä¢ ${fmtLocal(meta.scheduledAtISO)}</div>
      </div>
      <div class="vMeta">
ID: ${meta.id}
Operatore: ${meta.operator || "‚Äî"}
Slot: ${fmtLocal(meta.scheduledAtISO)}
Scaricato: ${meta.downloaded ? "‚úÖ SI" : "‚ùå NO"}
${approval.comment ? `\nCommento: ${approval.comment}` : ''}
${comments.length > 0 ? `\nCommenti: ${comments.length}` : ''}
      </div>

      <div class="vBtns">
        <button class="btn tiny gray" data-act="select">‚ñ∂Ô∏é Seleziona</button>
        <button class="btn tiny gray" data-act="download">üì• Scarica</button>
        <button class="btn tiny gray" data-act="copymsg">üìã Copia msg</button>
        <button class="btn tiny wa" data-act="send">üì§ Invia a Joseph</button>
        <button class="btn tiny success" data-act="approve">‚úÖ Approva</button>
        <button class="btn tiny" data-act="comment">üí¨ Commenta</button>
      </div>
    `;

    div.querySelector('[data-act="select"]').addEventListener("click", ()=>{
      currentRecIndex = i;
      $("playback").src = r.url;
      $("playback").play().catch(()=>{});
      renderRecList();
    });

    div.querySelector('[data-act="download"]').addEventListener("click", ()=>{
      recordings[i].meta.downloaded = true;
      downloadBlob(r.blob, r.name);
      showNotification("üì• Download", "Video scaricato con successo", "‚úÖ", 3000);
      renderRecList();
      updatePendingCount();
    });

    div.querySelector('[data-act="copymsg"]').addEventListener("click", async ()=>{
      await copyText(msg);
      showNotification("üìã Copiato", "Messaggio copiato negli appunti", "‚úÖ", 2000);
    });

    div.querySelector('[data-act="send"]').addEventListener("click", async ()=>{
      const requireDownloaded = $("chkRequireDownloaded").checked;
      if(requireDownloaded && !meta.downloaded){
        alert("Prima scarica il video (flag Scaricato = SI).");
        return;
      }

      const autoMark = $("chkAutoMark").checked;
      const text = msg;

      if(destMode === "group"){
        if(!groupInvite.trim()){
          alert("Inserisci il link invito del gruppo WhatsApp PUBBLICAZIONI.");
          return;
        }
        await openWhatsAppGroup(groupInvite.trim(), text);
      }else{
        if(!josephWa.trim()){
          alert("Inserisci il numero WhatsApp di Joseph (E164 senza +).");
          return;
        }
        openWhatsAppToNumber(josephWa.trim(), text);
      }

      if(autoMark){
        markSlotUsed(meta.platform, meta.scheduledAtISO);
        refreshPlatformUI();
      }
    });
    
    div.querySelector('[data-act="approve"]').addEventListener("click", ()=>{
      $("#approvalVideoTitle").textContent = r.title;
      
      // Load approval history
      const historyElem = $("#approvalHistory");
      const history = getComments(meta.id).map(c => 
        `${fmtLocal(c.date)} - ${c.by}: ${c.text}`
      ).join('\n');
      historyElem.textContent = history || "Nessuna cronologia";
      
      // Set up approval buttons
      document.querySelectorAll('[data-approval]').forEach(btn => {
        btn.onclick = () => {
          const status = btn.dataset.approval;
          const comment = $("#approvalComment").value;
          
          setApprovalStatus(meta.id, status, comment, operatorName);
          
          showNotification(
            status === "approved" ? "‚úÖ Approvato" : 
            status === "revision" ? "‚úèÔ∏è Da revisionare" : "‚è≥ In attesa",
            `Video ${status === "approved" ? "approvato" : "aggiornato"} con successo`,
            status === "approved" ? "‚úÖ" : "‚ÑπÔ∏è",
            3000
          );
          
          renderRecList();
          updatePendingCount();
          hideModal("modalApproval");
        };
      });
      
      showModal("modalApproval");
    });
    
    div.querySelector('[data-act="comment"]').addEventListener("click", ()=>{
      const comment = prompt("Aggiungi un commento al video:");
      if(comment && comment.trim()){
        addComment(meta.id, comment.trim(), operatorName);
        showNotification("üí¨ Commento", "Commento aggiunto con successo", "‚úÖ", 2000);
        renderRecList();
      }
    });

    box.appendChild(div);
  });
  
  updatePendingCount();
}

/* ==========================
   ENHANCED REC 60s + HUD
========================== */
function updateRecHud(){
  $("countdownHud").textContent = `REC ${remaining}s`;
}
function stopRecording(){
  if(recorder && recorder.state !== "inactive") recorder.stop();
}

function startRecording60(){
  if(!camStream){ alert("Attiva la camera."); return; }
  if(recorder && recorder.state !== "inactive") return;

  const ans = String($("answerBox").value || "").trim();
  if(!ans){
    alert("Scrivi o incolla una risposta prima.");
    return;
  }

  if(!currentQuestionObj){
    currentQuestionObj = null;
    currentQuestion = "";
    showQuestion("ATTUALIT√Ä");
    $("categoryOverlay").textContent = "ATTUALIT√Ä";
  }

  applyAnswer(ans);

  $("recHud").style.display = "flex";
  $("btnREC").classList.add("running");

  remaining = 60;
  updateRecHud();
  isRecording = true;

  chunks = [];

  const stream = canvas.captureStream(30);
  const audioTrack = camStream.getAudioTracks?.()[0];
  if(audioTrack) stream.addTrack(audioTrack);

  const mimeCandidates = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  const mimeType = mimeCandidates.find(m => MediaRecorder.isTypeSupported(m)) || "";

  recorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
  recorder.ondataavailable = (e)=>{ if(e.data.size) chunks.push(e.data); };

  const videoId = buildVideoId();
  const videoName = buildFileName(videoId);
  const questionText = (currentQuestionObj && currentQuestionObj.domanda) ? currentQuestionObj.domanda : "ATTUALIT√Ä";
  const categoryText = $("categoryOverlay").textContent || "ATTUALIT√Ä";
  const phoneNow = phoneValue || "";
  const scheduledAtISO = calcNextSlot(selectedPlatform);

  recorder.onstop = ()=>{
    if(recTimerId) clearInterval(recTimerId);
    recTimerId = null;

    $("recHud").style.display = "none";
    $("btnREC").classList.remove("running");
    isRecording = false;

    const blob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });

    const url = URL.createObjectURL(blob);
    const title = buildVideoTitle(recordings.length + 1, selectedPlatform, questionText);

    const meta = {
      id: videoId,
      filename: videoName,
      createdAt: new Date().toISOString(),
      platform: selectedPlatform,
      scheduledAtISO,
      operator: operatorName || "",
      question: questionText,
      category: categoryText,
      whatsapp: phoneNow,
      captionClean: lastCaptionClean,
      captionFinal: buildFinalCaption(),
      downloaded: false,
      approval: { status: "pending", comment: "", date: null, by: "" }
    };
    persistVideoMeta(meta);

    recordings.unshift({ title, name: videoName, url, blob, meta });
    currentRecIndex = 0;

    $("playback").src = url;
    $("playback").load();

    renderRecList();
    updateCounters();
    refreshPlatformUI();
    updatePendingCount();
    
    showNotification(
      "üé• Video Creato",
      "Video registrato con successo! Ora puoi scaricarlo o inviarlo.",
      "‚úÖ",
      4000
    );
  };

  recorder.start(1000);

  recTimerId = setInterval(()=>{
    remaining -= 1;
    const spans = $("teleText").querySelectorAll(".w");
    const total = spans.length || 0;
    if(total > 0){
      const stepsPerSec = Math.max(1, Math.round(total / 60));
      karaokeStep(stepsPerSec);
    }
    updateRecHud();
    if(remaining <= 0){
      stopRecording();
    }
  }, 1000);
}

/* ==========================
   NAV
========================== */
function goToGestionale(){
  if(confirm("Vuoi tornare al gestionale?")){
    if(isRecording) stopRecording();
    setTimeout(()=> window.location.href = GESTIONALE_URL, 250);
  }
}

/* ==========================
   ENHANCED INITIALIZATION
========================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  // Restore enhanced settings
  try{
    const savedCap = localStorage.getItem(CAP_KEY) || "";
    if(savedCap.trim()){
      lastCaptionClean = savedCap.trim();
      buildKaraokeSpans(lastCaptionClean);
    }
  }catch(e){}

  try{
    const sp = localStorage.getItem(PHONE_KEY) || "";
    if(sp.trim()){
      phoneValue = sp.trim();
      $("phoneInput").value = phoneValue;
    }
  }catch(e){}
  renderPhone();

  try{
    const sl = localStorage.getItem(LOGO_KEY) || "";
    if(sl.trim()) setLogoDataUrl(sl.trim());
  }catch(e){}

  // Restore operator + joseph + group + dest mode
  operatorName = (localStorage.getItem(OP_KEY) || "").trim();
  josephWa = (localStorage.getItem(JO_KEY) || JOSEPH_DEFAULT_WA).trim();
  groupInvite = (localStorage.getItem(GROUP_KEY) || "").trim();
  destMode = (localStorage.getItem(DEST_KEY) || "joseph").trim();

  $("operatorName").value = operatorName;
  $("josephWa").value = josephWa;
  $("groupInvite").value = groupInvite;
  if(destMode === "group") $("destGroup").checked = true; else $("destJoseph").checked = true;

  // Restore per-platform settings
  const all = getPubSettings();
  $("platform").value = selectedPlatform;
  $("frequencyMode").value = all[selectedPlatform].mode;
  $("frequencyValue").value = all[selectedPlatform].value;

  // Initialize enhanced features
  setupMultiPlatformUI();
  updatePendingCount();

  // Event Listeners for enhanced features
  
  // Calendar
  $("#btnCalendar").addEventListener("click", () => {
    renderCalendar();
    showModal("modalCalendar");
  });
  
  $("#closeCalendar").addEventListener("click", () => hideModal("modalCalendar"));
  $("#btnCloseCalendar").addEventListener("click", () => hideModal("modalCalendar"));
  
  // Multi-platform
  $("#btnMultiPlatform").addEventListener("click", () => {
    showModal("modalMultiPlatform");
  });
  
  $("#btnScheduleMulti").addEventListener("click", () => {
    if(!recordings.length){
      alert("Prima crea un video!");
      return;
    }
    showModal("modalMultiPlatform");
  });
  
  $("#closeMultiPlatform").addEventListener("click", () => hideModal("modalMultiPlatform"));
  $("#btnCancelMulti").addEventListener("click", () => hideModal("modalMultiPlatform"));
  
  $("#btnConfirmMulti").addEventListener("click", () => {
    if(!recordings.length){
      alert("Nessun video da pianificare!");
      return;
    }
    
    const baseTime = new Date();
    baseTime.setMinutes(baseTime.getMinutes() + 30); // Default: schedule 30 minutes from now
    
    scheduleMultiPlatform(recordings[0].meta.id, baseTime);
    hideModal("modalMultiPlatform");
  });
  
  // Offset mode change
  document.querySelectorAll('input[name="offsetMode"]').forEach(radio => {
    radio.addEventListener('change', () => {
      $("#customOffsets").style.display = 
        radio.value === "personalizzato" ? "block" : "none";
    });
  });
  
  // Analytics
  $("#btnAnalytics").addEventListener("click", () => {
    renderAnalytics();
    showModal("modalAnalytics");
  });
  
  $("#closeAnalytics").addEventListener("click", () => hideModal("modalAnalytics"));
  $("#btnCloseAnalytics").addEventListener("click", () => hideModal("modalAnalytics"));
  
  $("#btnExportAnalytics").addEventListener("click", () => {
    const analytics = calculateAnalytics();
    const csvContent = [
      ["Metrica", "Valore"],
      ["Video totali", analytics.totalVideos],
      ["Video approvati", analytics.approved],
      ["Video in attesa", analytics.pending],
      ["Tasso approvazione", `${analytics.approvalRate}%`],
      ["Media video/giorno", analytics.avgVideosPerDay],
      ["Trend settimanale", `${analytics.trend}%`],
      ["", ""],
      ["Piattaforma", "Conteggio"],
      ...Object.entries(analytics.platformDistribution).map(([p, c]) => [p, c])
    ].map(row => row.join(",")).join("\n");
    
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `analytics_${nowStamp()}.csv`;
    a.click();
    
    showNotification("üìä Esportazione", "Report analytics esportato come CSV", "‚úÖ", 3000);
  });
  
  // Approval modal
  $("#closeApproval").addEventListener("click", () => hideModal("modalApproval"));
  $("#btnCloseApproval").addEventListener("click", () => hideModal("modalApproval"));
  
  $("#btnMarkApproved").addEventListener("click", () => {
    if(currentRecIndex < 0 || !recordings[currentRecIndex]){
      alert("Seleziona un video dalla lista.");
      return;
    }
    
    const meta = recordings[currentRecIndex].meta;
    $("#approvalVideoTitle").textContent = recordings[currentRecIndex].title;
    
    const historyElem = $("#approvalHistory");
    const history = getComments(meta.id).map(c => 
      `${fmtLocal(c.date)} - ${c.by}: ${c.text}`
    ).join('\n');
    historyElem.textContent = history || "Nessuna cronologia";
    
    showModal("modalApproval");
  });
  
  $("#btnAddComment").addEventListener("click", () => {
    if(currentRecIndex < 0 || !recordings[currentRecIndex]){
      alert("Seleziona un video dalla lista.");
      return;
    }
    
    const comment = prompt("Aggiungi un commento al video:");
    if(comment && comment.trim()){
      addComment(recordings[currentRecIndex].meta.id, comment.trim(), operatorName);
      showNotification("üí¨ Commento", "Commento aggiunto con successo", "‚úÖ", 2000);
      renderRecList();
    }
  });
  
  // Tabs in modals
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabId = tab.dataset.tab;
      const modal = tab.closest('.modal-content');
      
      // Deactivate all tabs in this modal
      modal.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // Show corresponding content
      if(modal.id.includes('Calendar')){
        modal.querySelectorAll('.calendar').forEach(c => c.style.display = 'none');
        $(`calendar${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).style.display = 'block';
      } else if(modal.id.includes('Analytics')){
        modal.querySelectorAll('[id^="analytics"]').forEach(c => c.style.display = 'none');
        $(`analytics${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).style.display = 'block';
      }
    });
  });

  // Original event listeners (preserved from original code)
  $("btnBackTop").addEventListener("click", goToGestionale);
  $("btnBackBottom").addEventListener("click", goToGestionale);

  $("btnNext").addEventListener("click", ()=> nextQuestion());

  $("btnCopyQ").addEventListener("click", async ()=>{
    if(!currentQuestionObj) nextQuestion();
    const payload = `DOMANDA (${currentQuestionObj.id} - ${currentQuestionObj.fase}):\n${currentQuestionObj.domanda}`.trim();
    await copyText(payload);
    showNotification("üìã Copiato", "Domanda copiata negli appunti", "‚úÖ", 2000);
  });

  $("btnOpenChatGPT").addEventListener("click", openChatGPTAndCopy);

  $("btnPasteAnswer").addEventListener("click", async ()=>{
    try{
      const t = await readClipboardText();
      $("answerBox").value = (t || "");
      
      // Auto-clean if GPT detected
      if($("chkAutoDetectGPT").checked && isGPTResponse(t)){
        const cleaned = cleanGPTResponse(t);
        $("answerBox").value = cleaned;
        applyAnswer(cleaned);
        showNotification("ü§ñ Auto-clean", "Risposta ChatGPT pulita automaticamente", "‚úÖ", 3000);
      }
    }catch(e){
      alert("Clipboard bloccata: incolla manualmente nel box Risposta.");
    }
  });

  $("btnUseAnswer").addEventListener("click", ()=>{
    const ans = $("answerBox").value || "";
    const ok = applyAnswer(ans);
    if(!ok) return alert("Scrivi o incolla una risposta prima.");
    showNotification("‚úÖ Risposta applicata", "Testo pronto per la registrazione", "üé§", 2000);
  });

  $("btnCopyCaption").addEventListener("click", async ()=>{
    const out = buildFinalCaption();
    if(!out){ alert("Niente da copiare."); return; }
    await copyText(out);
    showNotification("üìã Caption copiata", "Caption con hashtag copiata negli appunti", "‚úÖ", 2000);
  });

  // WhatsApp open
  $("btnOpenWhatsApp").addEventListener("click", ()=>{
    window.location.href = "whatsapp://";
  });

  $("btnWhere").addEventListener("click", ()=>{
    alert("In browser i video vengono scaricati: li trovi nella cartella Download del dispositivo.");
  });

  // Dest mode
  $("destGroup").addEventListener("change", ()=>{
    if($("destGroup").checked){
      destMode = "group";
      localStorage.setItem(DEST_KEY, destMode);
    }
  });
  $("destJoseph").addEventListener("change", ()=>{
    if($("destJoseph").checked){
      destMode = "joseph";
      localStorage.setItem(DEST_KEY, destMode);
    }
  });

  // Operator/Joseph/Group inputs
  $("operatorName").addEventListener("input", ()=>{
    operatorName = String($("operatorName").value || "").trim();
    localStorage.setItem(OP_KEY, operatorName);
  });
  $("josephWa").addEventListener("input", ()=>{
    josephWa = String($("josephWa").value || "").trim();
    localStorage.setItem(JO_KEY, josephWa);
  });
  $("groupInvite").addEventListener("input", ()=>{
    groupInvite = String($("groupInvite").value || "").trim();
    localStorage.setItem(GROUP_KEY, groupInvite);
  });

  // Per-platform scheduling UI
  $("platform").addEventListener("change", ()=>{
    selectedPlatform = $("platform").value;
    const all = getPubSettings();
    $("frequencyMode").value = all[selectedPlatform].mode;
    $("frequencyValue").value = all[selectedPlatform].value;
    refreshPlatformUI();
  });
  $("frequencyMode").addEventListener("change", ()=>{
    setPubSetting(selectedPlatform, $("frequencyMode").value, $("frequencyValue").value);
    refreshPlatformUI();
  });
  $("frequencyValue").addEventListener("input", ()=>{
    setPubSetting(selectedPlatform, $("frequencyMode").value, $("frequencyValue").value);
    refreshPlatformUI();
  });

  $("btnClearHistory").addEventListener("click", ()=>{
    if(!confirm("Cancellare lo storico slot (tutte le piattaforme)?")) return;
    setHistory({ TIKTOK:[], INSTAGRAM:[], SHORTS:[], FACEBOOK:[] });
    refreshPlatformUI();
  });

  // Phone overlay
  $("phoneInput").addEventListener("input", ()=>{
    phoneValue = String($("phoneInput").value || "").trim();
    try{ localStorage.setItem(PHONE_KEY, phoneValue); }catch(e){}
    renderPhone();
  });

  // Logo upload
  $("btnLogo").addEventListener("click", ()=> $("logoUpload").click());
  $("logoUpload").addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const fr = new FileReader();
    fr.onload = ()=> setLogoDataUrl(fr.result);
    fr.readAsDataURL(file);
    e.target.value = "";
  });

  // Camera controls
  $("btnCam").addEventListener("click", async ()=>{ await ensureReady(); });
  $("btnFlip").addEventListener("click", async ()=>{ await flipCamera(); });
  $("btnFlash").addEventListener("click", async ()=>{ await toggleTorch(); });

  $("btnREC").addEventListener("click", async ()=>{
    const okCam = await ensureReady();
    if(!okCam) return;

    if(recorder && recorder.state !== "inactive"){
      stopRecording();
      return;
    }
    startRecording60();
  });

  $("btnStop").addEventListener("click", ()=> stopRecording());

  // Zoom
  $("zoom").addEventListener("input", (e)=> applyZoom(e.target.value));
  await applyZoom(1.0);

  // Download selected video
  $("btnDownloadVideo").addEventListener("click", ()=>{
    if(currentRecIndex < 0 || !recordings[currentRecIndex]){
      alert("Seleziona un video dalla lista.");
      return;
    }
    const r = recordings[currentRecIndex];
    recordings[currentRecIndex].meta.downloaded = true;
    downloadBlob(r.blob, r.name);
    showNotification("üì• Download", "Video scaricato con successo", "‚úÖ", 3000);
    renderRecList();
    updatePendingCount();
  });

  // Clear list (session)
  $("btnClearList").addEventListener("click", ()=>{
    if(!recordings.length) return;
    if(confirm("Svuotare la lista (sessione)?")){
      recordings.forEach(r => { try{ URL.revokeObjectURL(r.url); }catch(e){} });
      recordings = [];
      currentRecIndex = -1;
      $("playback").removeAttribute("src");
      $("playback").load();
      renderRecList();
      updateCounters();
      updatePendingCount();
    }
  });

  // Auto-GPT detection toggle
  $("chkAutoDetectGPT").addEventListener("change", ()=>{
    if($("chkAutoDetectGPT").checked){
      $("#autoDetectStatus").textContent = "‚úì Attivo";
      $("#autoDetectStatus").style.color = "var(--success)";
    } else {
      $("#autoDetectStatus").textContent = "‚úó Disattivo";
      $("#autoDetectStatus").style.color = "var(--muted)";
    }
  });

  // Defaults
  if(!lastCaptionClean) $("teleText").textContent = "Incolla una risposta ‚Üí 'Usa risposta' ‚Üí 'REC'.";
  showQuestion("Premi 'Nuova domanda'.");
  $("categoryOverlay").textContent = "ATTUALIT√Ä";
  renderPhone();
  refreshPlatformUI();
  renderRecList();
  updateCounters();
  updatePendingCount();
  
  // Show welcome notification
  setTimeout(() => {
    showNotification(
      "üöÄ Video Creator Pro Attivo",
      "5 nuove funzionalit√† attive: 1) ChatGPT Auto 2) Scheduling 3) Multi-piattaforma 4) Approvazioni 5) Analytics",
      "üéâ",
      6000
    );
  }, 1000);
});
</script>
</body>
</html>
