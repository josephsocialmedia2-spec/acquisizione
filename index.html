<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Archivio Domande & Risposte</title>

<style>
/* ======================
   DARK MODE
====================== */
body{
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:#0e0e0e;
  color:#eaeaea;
}

h1,h2,h3{ margin-top:0; }

.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}

.card{
  background:#161616;
  border:1px solid #2a2a2a;
  border-radius:10px;
  padding:16px;
  margin-bottom:16px;
}

button{
  background:#1f1f1f;
  color:#fff;
  border:1px solid #333;
  border-radius:6px;
  padding:8px 12px;
  cursor:pointer;
}

button:hover{ background:#2a2a2a; }

input,select,textarea{
  width:100%;
  background:#111;
  color:#fff;
  border:1px solid #333;
  border-radius:6px;
  padding:8px;
  margin-top:6px;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.row button{ flex:1; }

.small{ font-size:13px; opacity:.8 }

.highlight{
  color:#4da3ff;
  font-weight:600;
}

#outputDomanda{
  font-size:22px;
  font-weight:600;
  margin-bottom:10px;
}

#outputRisposta{
  font-size:18px;
  line-height:1.4;
}

/* toast */
#toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#222;
  padding:10px 14px;
  border-radius:8px;
  border:1px solid #333;
  display:none;
}
</style>
</head>

<body>
<div class="container">

<h1>ðŸŽ¥ Archivio Domande & Risposte</h1>

<!-- ================= ARCHIVIO ================= -->
<div class="card">
  <h2>ðŸ“‚ Archivio</h2>

  <input type="file" id="csvFile" accept=".csv">

  <div class="row" style="margin-top:10px">
    <button id="btnGenerate">ðŸŽ² Genera domanda</button>
    <button id="btnClear">ðŸ§¹ Reset domande</button>
  </div>

  <p class="small">
    Le domande non si ripetono finchÃ© non finiscono tutte.
  </p>
</div>

<!-- ================= OUTPUT ================= -->
<div class="card">
  <h2>ðŸŽ¤ Output</h2>

  <div id="outputDomanda"></div>
  <div id="outputRisposta"></div>
</div>

</div>

<div id="toast"></div>

<script>
/* ======================
   ARCHIVIO
====================== */
let ARCHIVIO = [];
let USATE = [];

const STORAGE_KEY = "archivio_locale_v1";
const USED_KEY = "archivio_usate_v1";

/* ======================
   DEFAULT (fallback)
====================== */
const ARCHIVIO_DEFAULT = [
  {id:1, area:"Prezzo", domanda:"Come capisco se il prezzo Ã¨ troppo alto?",
   risposta:"Se ricevi visite ma nessuna proposta, il prezzo Ã¨ spesso fuori mercato. Il mercato parla sempre."},
  {id:2, area:"Visite", domanda:"PerchÃ© le visite non portano offerte?",
   risposta:"Spesso il problema Ã¨ una discrepanza tra annuncio e realtÃ : foto, spazi o aspettative."}
];

/* ======================
   UTILS
====================== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=>t.style.display="none",1800);
}

function saveLocal(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(ARCHIVIO));
  localStorage.setItem(USED_KEY, JSON.stringify(USATE));
}

function loadLocal(){
  const a = localStorage.getItem(STORAGE_KEY);
  const u = localStorage.getItem(USED_KEY);
  if(a){
    ARCHIVIO = JSON.parse(a);
    USATE = u ? JSON.parse(u) : [];
    toast("Archivio caricato dal device");
  }else{
    ARCHIVIO = ARCHIVIO_DEFAULT;
  }
}

/* ======================
   CSV LOADER
====================== */
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  const header = lines.shift().split(";");
  const idxD = header.indexOf("domanda");
  const idxR = header.indexOf("risposta");
  const idxA = header.indexOf("area");

  return lines.map((l,i)=>{
    const c = l.split(";");
    return {
      id:i+1,
      area: idxA>=0 ? c[idxA] : "",
      domanda:c[idxD],
      risposta:c[idxR]
    };
  });
}

document.getElementById("csvFile").addEventListener("change",async e=>{
  const file = e.target.files[0];
  if(!file) return;
  const txt = await file.text();
  ARCHIVIO = parseCSV(txt);
  USATE = [];
  saveLocal();
  toast("Archivio CSV caricato");
});

/* ======================
   GENERA (NO REPEAT)
====================== */
document.getElementById("btnGenerate").addEventListener("click",()=>{
  if(ARCHIVIO.length===0) return;

  const disponibili = ARCHIVIO.filter(d=>!USATE.includes(d.id));

  if(disponibili.length===0){
    USATE = [];
    toast("Finite! Riparto da capo ðŸ”");
    return;
  }

  const pick = disponibili[Math.floor(Math.random()*disponibili.length)];
  USATE.push(pick.id);
  saveLocal();

  document.getElementById("outputDomanda").textContent = pick.domanda;
  document.getElementById("outputRisposta").textContent = pick.risposta;
});

/* ======================
   RESET
====================== */
document.getElementById("btnClear").addEventListener("click",()=>{
  if(!confirm("Reset domande usate?")) return;
  USATE = [];
  saveLocal();
  toast("Reset completato");
});

/* ======================
   INIT
====================== */
loadLocal();
</script>
</body>
</html>
