<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini TikTok Recorder (Web)</title>
  <style>
    :root { color-scheme: dark; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#0b0b0f; color:#fff; height:100vh; display:flex; justify-content:center;
    }
    .app{
      width:min(420px, 100vw); height:100vh; position:relative; overflow:hidden;
      background:#000;
    }
    video, canvas{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
    }
    canvas{ display:none; } /* lo usiamo per registrare con overlay */
    .hud{
      position:absolute; inset:0; pointer-events:none;
      display:flex; flex-direction:column; justify-content:space-between;
      padding:16px;
      background: linear-gradient(to top, rgba(0,0,0,.55), transparent 35%),
                  linear-gradient(to bottom, rgba(0,0,0,.35), transparent 35%);
    }
    .topRow{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      pointer-events:auto;
    }
    .pill{
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      padding:10px 12px; border-radius:14px;
      display:flex; gap:8px; align-items:center;
      width:100%;
    }
    input{
      width:100%;
      background:transparent; border:0; outline:0; color:#fff;
      font-size:14px;
    }
    .topicOverlay{
      pointer-events:none;
      font-weight:800;
      font-size:28px;
      line-height:1.1;
      text-shadow: 0 4px 18px rgba(0,0,0,.75);
      max-width:90%;
    }
    .bottomRow{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:12px; pointer-events:auto;
    }
    .btnCol{ display:flex; flex-direction:column; gap:10px; }
    button{
      border:0; border-radius:16px; padding:12px 14px;
      background:rgba(255,255,255,.12);
      color:#fff; font-weight:700; cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
    }
    button.primary{
      background:#ff2d55; border-color:#ff2d55;
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .recordDot{
      width:10px; height:10px; border-radius:50%;
      background:#ff2d55; display:inline-block;
      box-shadow: 0 0 0 6px rgba(255,45,85,.18);
      margin-right:8px;
      animation: pulse 1.2s infinite;
    }
    .hidden{ display:none !important; }
    @keyframes pulse{
      0%{ transform:scale(1); opacity:1 }
      50%{ transform:scale(1.08); opacity:.85 }
      100%{ transform:scale(1); opacity:1 }
    }
    .toast{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:92px;
      background:rgba(0,0,0,.65); border:1px solid rgba(255,255,255,.14);
      padding:10px 12px; border-radius:14px; font-size:13px;
      max-width:90%; text-align:center;
      display:none;
    }
    .downloadLink{
      display:block; margin-top:8px; color:#7ee787; font-weight:800;
      text-decoration:none;
    }
  </style>
</head>
<body>
  <div class="app">
    <video id="preview" playsinline muted autoplay></video>
    <canvas id="recCanvas"></canvas>

    <div class="hud">
      <div class="topRow">
        <div class="pill">
          <span>üéØ</span>
          <input id="topicInput" placeholder="Scrivi l‚Äôargomento (es: 'Allenamento spalle')" maxlength="60" />
        </div>
      </div>

      <div class="bottomRow">
        <div class="topicOverlay" id="topicOverlay"></div>

        <div class="btnCol">
          <button id="btnStartCam">Attiva camera</button>
          <button id="btnFlip" disabled>Flip</button>
          <button id="btnRecord" class="primary" disabled>Registra</button>
          <button id="btnStop" disabled>Stop</button>
          <button id="btnDownload" disabled>Download</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
(() => {
  const preview = document.getElementById('preview');
  const canvas = document.getElementById('recCanvas');
  const ctx = canvas.getContext('2d');

  const topicInput = document.getElementById('topicInput');
  const topicOverlay = document.getElementById('topicOverlay');

  const btnStartCam = document.getElementById('btnStartCam');
  const btnFlip = document.getElementById('btnFlip');
  const btnRecord = document.getElementById('btnRecord');
  const btnStop = document.getElementById('btnStop');
  const btnDownload = document.getElementById('btnDownload');

  const toast = document.getElementById('toast');

  let stream = null;
  let facingMode = 'user'; // 'user' or 'environment'
  let recorder = null;
  let chunks = [];
  let recordedBlob = null;

  // aggiorna testo overlay ‚Äúlive‚Äù
  function syncTopic() {
    const t = (topicInput.value || '').trim();
    topicOverlay.textContent = t;
  }
  topicInput.addEventListener('input', syncTopic);
  syncTopic();

  function showToast(html, ms=3500){
    toast.innerHTML = html;
    toast.style.display = 'block';
    if (ms) setTimeout(() => toast.style.display = 'none', ms);
  }

  async function startCamera() {
    // stop stream precedente
    if (stream) {
      stream.getTracks().forEach(tr => tr.stop());
      stream = null;
    }

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode },
        audio: true
      });
      preview.srcObject = stream;

      btnFlip.disabled = false;
      btnRecord.disabled = false;
      btnStop.disabled = true;
      btnDownload.disabled = true;
      recordedBlob = null;

      showToast(`Camera attiva (${facingMode === 'user' ? 'frontale' : 'posteriore'}).`);
    } catch (e) {
      console.error(e);
      showToast(`‚ö†Ô∏è Non riesco ad attivare la camera. Apri la pagina su <b>https</b> o <b>localhost</b> e concedi i permessi.`);
    }
  }

  function fitCanvasToVideo() {
    // usa dimensioni reali del video, non quelle CSS
    const w = preview.videoWidth || 720;
    const h = preview.videoHeight || 1280;
    canvas.width = w;
    canvas.height = h;
  }

  function drawFrame() {
    // disegna il frame video
    ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);

    // overlay testo (tipo TikTok)
    const text = (topicInput.value || '').trim();
    if (text) {
      const pad = Math.round(canvas.width * 0.06);
      const maxWidth = canvas.width - pad * 2;

      // font responsive
      const fontSize = Math.max(28, Math.round(canvas.width * 0.07));
      ctx.font = `800 ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.textBaseline = 'bottom';
      ctx.textAlign = 'left';

      // wrap semplice su 2-3 righe
      const words = text.split(/\s+/);
      const lines = [];
      let line = '';
      for (const w of words) {
        const test = line ? line + ' ' + w : w;
        if (ctx.measureText(test).width <= maxWidth) {
          line = test;
        } else {
          if (line) lines.push(line);
          line = w;
        }
      }
      if (line) lines.push(line);

      const maxLines = 3;
      const finalLines = lines.slice(0, maxLines);

      const lineHeight = Math.round(fontSize * 1.12);
      const x = pad;
      const yBase = canvas.height - pad; // in basso a sinistra

      // shadow
      ctx.save();
      ctx.shadowColor = 'rgba(0,0,0,0.75)';
      ctx.shadowBlur = Math.round(fontSize * 0.55);
      ctx.fillStyle = '#ffffff';

      // disegna dal basso verso l‚Äôalto
      for (let i = 0; i < finalLines.length; i++) {
        const idx = finalLines.length - 1 - i;
        const y = yBase - (i * lineHeight);
        ctx.fillText(finalLines[idx], x, y);
      }
      ctx.restore();
    }

    // indicatore REC quando sta registrando
    if (recorder && recorder.state === 'recording') {
      ctx.save();
      ctx.fillStyle = 'rgba(255,45,85,1)';
      ctx.beginPath();
      ctx.arc(24, 24, 10, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }
  }

  let rafId = null;
  function startDrawingLoop() {
    const loop = () => {
      drawFrame();
      rafId = requestAnimationFrame(loop);
    };
    loop();
  }
  function stopDrawingLoop() {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
  }

  function bestMimeType() {
    const candidates = [
      'video/webm;codecs=vp9,opus',
      'video/webm;codecs=vp8,opus',
      'video/webm'
    ];
    return candidates.find(t => MediaRecorder.isTypeSupported(t)) || '';
  }

  function setRecordingUI(isRec) {
    btnRecord.disabled = isRec;
    btnStop.disabled = !isRec;
    btnFlip.disabled = isRec;
    btnStartCam.disabled = isRec;
    if (isRec) {
      btnRecord.innerHTML = `<span class="recordDot"></span>REC`;
    } else {
      btnRecord.textContent = 'Registra';
    }
  }

  async function startRecording() {
    if (!stream) return;

    // aspetta che il video abbia dimensioni
    if (!preview.videoWidth) {
      await new Promise(r => preview.onloadedmetadata = () => r());
    }
    fitCanvasToVideo();

    // loop di disegno su canvas
    startDrawingLoop();

    // canvas stream + audio stream => recorder
    const canvasStream = canvas.captureStream(30); // 30fps
    const audioTracks = stream.getAudioTracks();
    const mixedStream = new MediaStream([
      ...canvasStream.getVideoTracks(),
      ...audioTracks
    ]);

    chunks = [];
    recordedBlob = null;

    const mimeType = bestMimeType();
    recorder = new MediaRecorder(mixedStream, mimeType ? { mimeType } : undefined);

    recorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) chunks.push(e.data);
    };

    recorder.onstop = () => {
      stopDrawingLoop();
      setRecordingUI(false);

      recordedBlob = new Blob(chunks, { type: recorder.mimeType || 'video/webm' });
      btnDownload.disabled = false;

      const sizeMB = (recordedBlob.size / (1024*1024)).toFixed(2);
      showToast(`‚úÖ Registrazione pronta (${sizeMB} MB).<br/>Premi <b>Download</b> per esportare.`);
    };

    recorder.start(250); // chunk ogni 250ms
    setRecordingUI(true);
    btnDownload.disabled = true;
  }

  function stopRecording() {
    if (recorder && recorder.state === 'recording') {
      recorder.stop();
    }
  }

  function download() {
    if (!recordedBlob) return;

    const topic = (topicInput.value || 'video').trim().replace(/[^\w\-]+/g, '_').slice(0, 40);
    const filename = `${topic || 'video'}_${new Date().toISOString().replace(/[:.]/g,'-')}.webm`;

    const url = URL.createObjectURL(recordedBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1500);

    showToast(`‚¨áÔ∏è Download avviato: <b>${filename}</b>`);
  }

  // UI handlers
  btnStartCam.addEventListener('click', startCamera);

  btnFlip.addEventListener('click', async () => {
    facingMode = (facingMode === 'user') ? 'environment' : 'user';
    await startCamera();
  });

  btnRecord.addEventListener('click', startRecording);
  btnStop.addEventListener('click', stopRecording);
  btnDownload.addEventListener('click', download);

  // hint iniziale
  showToast(`üëã Premi <b>Attiva camera</b>. Poi scrivi l‚Äôargomento e registra.`, 4500);
})();
</script>
</body>
</html>
