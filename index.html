<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema Acquisizione Incarichi ‚Äî Operativo (Fare/Dire/Preparare)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#243045;
      --accent:#60a5fa;
      --ok:#34d399;
      --warn:#fbbf24;
      --danger:#f87171;
      --shadow: 0 12px 34px rgba(0,0,0,.40);
      --radius: 16px;
      --radius2: 20px;
      --max: 1200px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(1000px 500px at 80% 0%, rgba(52,211,153,.14), transparent 55%),
        radial-gradient(900px 500px at 50% 110%, rgba(248,113,113,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: rgba(11,15,23,.72);
      border-bottom:1px solid rgba(36,48,69,.6);
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:18px 16px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(96,165,250,.9), rgba(52,211,153,.9));
      box-shadow: var(--shadow);
    }
    h1{font-size:16px; margin:0;}
    .sub{margin:2px 0 0; font-size:12px; color:var(--muted);}
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(17,24,39,.65);
      border-radius:999px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .pill label{font-size:12px; color:var(--muted);}
    input[type="datetime-local"]{
      background: transparent; border: none; color: var(--text);
      font-family: var(--mono); font-size: 12px; outline: none;
      min-width: 210px;
    }
    .btn{
      cursor:pointer;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(17,24,39,.7);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(96,165,250,.9);}
    .btn.primary{background: rgba(96,165,250,.18); border-color: rgba(96,165,250,.55);}
    .btn.ok{background: rgba(52,211,153,.16); border-color: rgba(52,211,153,.55);}
    .btn.warn{background: rgba(251,191,36,.14); border-color: rgba(251,191,36,.55);}
    main{padding: 18px 0 50px;}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }
    .card{
      background: linear-gradient(180deg, rgba(17,24,39,.78), rgba(15,23,42,.70));
      border: 1px solid rgba(36,48,69,.9);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding: 14px 14px 12px;
      border-bottom:1px solid rgba(36,48,69,.75);
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .card .head h2{margin:0; font-size:14px;}
    .tag{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(36,48,69,.9);
      color: var(--muted);
      background: rgba(11,15,23,.25);
    }
    .card .body{padding: 14px;}
    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{
      cursor:pointer; user-select:none;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(11,15,23,.20);
      color: var(--muted);
      font-size:12px;
      transition: all .12s ease;
    }
    .tab.active{
      background: rgba(96,165,250,.18);
      border-color: rgba(96,165,250,.55);
      color: var(--text);
    }
    .timeline{display:flex; flex-direction:column; gap:10px; padding: 10px 0 0;}
    .event{
      display:flex; gap:12px;
      padding: 12px 12px;
      border-radius: var(--radius);
      border:1px solid rgba(36,48,69,.85);
      background: rgba(11,15,23,.20);
      cursor:pointer;
      transition: transform .10s ease, border-color .10s ease, background .10s ease;
    }
    .event:hover{
      transform: translateY(-1px);
      border-color: rgba(96,165,250,.65);
      background: rgba(96,165,250,.06);
    }
    .event .left{
      min-width: 135px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      display:flex; flex-direction:column; gap:6px;
    }
    .event .left .rel{font-weight:800; color: rgba(229,231,235,.95);}
    .event .title{font-weight:800; font-size:13px; margin: 0 0 4px;}
    .event .desc{margin:0; font-size:12px; color: var(--muted); line-height:1.35;}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:11px; color: var(--muted);
      border:1px solid rgba(36,48,69,.9);
      background: rgba(11,15,23,.25);
      padding:4px 8px; border-radius:999px; width: fit-content;
    }
    .badge .dot{width:7px;height:7px;border-radius:99px;background: var(--accent);}
    .badge.ok .dot{background: var(--ok);}
    .badge.warn .dot{background: var(--warn);}
    .badge.danger .dot{background: var(--danger);}

    .rules{display:flex; flex-direction:column; gap:10px;}
    .rule{
      border:1px solid rgba(36,48,69,.85);
      background: rgba(11,15,23,.18);
      border-radius: var(--radius);
      padding: 12px;
    }
    .rule h3{margin:0 0 6px; font-size:13px;}
    .rule p{margin:0; color: var(--muted); font-size:12px; line-height:1.35;}
    .mini{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(229,231,235,.85);
      margin-top: 8px;
      padding:8px;
      border-radius: 12px;
      border:1px solid rgba(36,48,69,.8);
      background: rgba(0,0,0,.22);
      white-space: pre-wrap;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none; align-items:center; justify-content:center;
      padding: 16px; z-index: 999;
    }
    .backdrop.show{display:flex;}
    .modal{
      width: min(1100px, 100%);
      max-height: min(88vh, 900px);
      overflow:auto;
      background: linear-gradient(180deg, rgba(17,24,39,.97), rgba(15,23,42,.97));
      border:1px solid rgba(36,48,69,.95);
      border-radius: 22px;
      box-shadow: var(--shadow);
    }
    .modal header{
      position:sticky; top:0;
      background: rgba(17,24,39,.92);
      border-bottom:1px solid rgba(36,48,69,.8);
      padding: 14px 14px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modal header .m-title{margin:0; font-size:14px; line-height:1.25; font-weight:900;}
    .modal header .m-sub{
      margin:4px 0 0;
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
      white-space: pre-wrap;
    }
    .close{
      cursor:pointer;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(11,15,23,.25);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-size:12px;
      white-space:nowrap;
    }
    .modal .content{padding: 14px;}
    .m-tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 10px;}
    .m-tab{
      cursor:pointer; user-select:none;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(36,48,69,.9);
      background: rgba(11,15,23,.20);
      color: var(--muted);
      font-size:12px;
    }
    .m-tab.active{
      background: rgba(96,165,250,.18);
      border-color: rgba(96,165,250,.55);
      color: var(--text);
    }
    .section{
      border:1px solid rgba(36,48,69,.85);
      background: rgba(11,15,23,.18);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .section h4{margin:0 0 8px; font-size:13px; font-weight:900;}
    .section ul{margin:0; padding-left: 18px; color: var(--muted); font-size:12px; line-height:1.55;}
    .script{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(36,48,69,.85);
      border-radius: 14px;
      padding: 10px;
      font-family: var(--mono);
      color: rgba(229,231,235,.92);
      font-size: 12px;
      white-space: pre-wrap;
      line-height:1.5;
    }
    .checklist{display:flex; flex-direction:column; gap:8px;}
    .chk{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px;
      border:1px solid rgba(36,48,69,.8);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
    }
    .chk input{margin-top: 2px;}
    .chk .t{font-size:12px; font-weight:800;}
    .chk .d{font-size:12px; color: var(--muted); margin-top:2px; line-height:1.45;}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 900px){ .two{grid-template-columns:1fr;} input[type="datetime-local"]{min-width: 180px;} .event .left{min-width:120px;} }
    .footer-note{margin-top: 10px; color: var(--muted); font-size:11px; line-height:1.4;}
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Sistema Acquisizione Incarichi ‚Äî Operativo (Cosa fare / dire / preparare)</h1>
        <div class="sub">Imposta l‚Äôora dell‚Äôappuntamento ‚Üí clicca ogni blocco ‚Üí popup con azioni e script parola per parola.</div>
      </div>
    </div>
    <div class="controls">
      <div class="pill">
        <label for="appt">Ora appuntamento (CASA o UFFICIO):</label>
        <input id="appt" type="datetime-local" />
      </div>
      <button class="btn primary" id="apply">Applica orari</button>
      <button class="btn" id="reset">Reset</button>
      <button class="btn ok" id="exportTxt">Copia tutto (testo)</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="head">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <h2>Timeline operativa (cliccabile)</h2>
          <span class="tag" id="modeTag">Processo: Standard (90‚Äì95%)</span>
        </div>
        <div class="tabs" role="tablist" aria-label="Seleziona processo">
          <div class="tab active" id="tab-standard" role="tab" tabindex="0">Standard</div>
          <div class="tab" id="tab-previsita" role="tab" tabindex="0">Con previsita</div>
          <div class="tab" id="tab-kit" role="tab" tabindex="0">Kit & Script</div>
        </div>
      </div>
      <div class="body">
        <div id="timeline" class="timeline" aria-live="polite"></div>
        <div class="footer-note">
          Regola: se il venditore NON ha letto ci√≤ che gli hai mandato, l‚Äôappuntamento si sposta. Sempre.
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="head">
        <h2>Regole non negoziabili (sempre)</h2>
        <span class="tag">Status + Controllo</span>
      </div>
      <div class="body rules">
        <div class="rule">
          <h3>1) Se NON legge ‚Üí si rinvia</h3>
          <p>Non ti presenti finch√© non ha letto (o almeno guardato con attenzione) relazione/pacchetto. Se vai lo stesso, entri in difesa e perdi status.</p>
        </div>
        <div class="rule">
          <h3>2) Relazione inviata ‚â• 48 ore prima</h3>
          <p>Serve a ‚Äúsbollentare‚Äù aspettative sul prezzo, far emergere domande, e mostrare metodo professionale prima dell‚Äôincontro.</p>
        </div>
        <div class="rule">
          <h3>3) Presentazione ‚â§ 30 minuti</h3>
          <p>Oltre 30 minuti stai chiacchierando. Conduci, vai dritto, e in chiusura sii deciso.</p>
        </div>
        <div class="rule">
          <h3>4) Tu selezioni chi rappresenti</h3>
          <p>Inversione preda/predatore: non sei legato al risultato. Educato, ma mai subordinato.</p>
        </div>
        <div class="rule">
          <h3>5) ‚ÄúShow time‚Äù √® il momento pi√π importante</h3>
          <p>Il proprietario sceglie l‚Äôagente. Qui comunichi valore (e quindi commissioni), molto pi√π che in trattativa.</p>
          <div class="mini">‚ÄúNon sono un costo: sono il miglior investimento per il miglior risultato economico.‚Äù</div>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- Modal -->
<div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-label="Dettaglio operazione">
  <div class="modal">
    <header>
      <div>
        <p class="m-title" id="mTitle"></p>
        <p class="m-sub" id="mSub"></p>
      </div>
      <button class="close" id="close">Chiudi ‚úï</button>
    </header>

    <div class="content">
      <div class="m-tabs" id="mTabs"></div>
      <div id="mBody"></div>
    </div>
  </div>
</div>

<script>
/* -------------------------------------------------
   DATA ‚Äî SUPER OPERATIVO (Fare/Dire/Preparare/Materiali)
   ------------------------------------------------- */

const DATA = {
  standard: [
    {
      id:"std-96",
      relativeHours:-96,
      relLabel:"-96h",
      importance:"info",
      title:"Primo contatto: impostazione controllo + fissaggio appuntamenti (‚â• 4 giorni)",
      short:"Blocchi prequalifica telefonica + appuntamento dal vivo. Niente improvvisazione.",
      popup:{
        obiettivo:[
          "Impostare immediatamente status e controllo del processo.",
          "Fissare 2 appuntamenti: (1) prequalifica telefonica (2) appuntamento dal vivo (a casa).",
          "Evitare appuntamenti inutili e difensivi."
        ],
        fareChecklist:[
          {t:"Tono e ritmo: calmo, sicuro, senza fretta", d:"Devi sembrare ‚Äòin controllo‚Äô, non un venditore che corre dietro al cliente."},
          {t:"Mai fissare prima di 4 giorni", d:"Se oggi √® luned√¨, non prima di gioved√¨. Anticipo = status + tempo per processo."},
          {t:"Blocca 2 slot: prequalifica + incontro a casa", d:"Lo dici come standard operativo, non come opzione."},
          {t:"Chiudi con prossimi step chiari", d:"‚ÄòDopo la prequalifica preparo la relazione e gliela anticipo‚Äô."}
        ],
        direScript:`
APERTURA (posizionamento):
"Perfetto. Per lavorare bene e farle risparmiare tempo, io faccio sempre una breve prequalifica telefonica prima dell‚Äôincontro. Cos√¨ arrivo preparato e lei capisce subito il mio metodo."

IMPOSTAZIONE DOPPIO APPUNTAMENTO:
"Facciamo cos√¨: ci sentiamo al telefono [giorno/ora] per le domande sulla casa e sulle sue esigenze, e poi ci vediamo a casa sua [giorno/ora]."

CREAZIONE ASPETTATIVA (relazione + recall):
"Dopo la prequalifica, se ha senso procedere, preparo una relazione di mercato professionale e gliela anticipo. Poi la richiamo il giorno prima per le sue impressioni, cos√¨ all‚Äôappuntamento siamo gi√† allineati."

CHIUSURA DELLA CHIAMATA:
"Perfetto, segno tutto. Tra poco le mando un SMS riepilogativo e un breve video cos√¨ vede come lavoro."`,
        preparare:[
          "Agenda: fissare 2 eventi (prequalifica + appuntamento a casa).",
          "Template SMS riepilogo (pronto da copiare/incollare).",
          "Link al video informativo (incarico/collaborazione + metodo).",
          "Modulo prequalifica (digitale o cartaceo)."
        ],
        materiali:[
          "SMS template (riepilogo appuntamenti).",
          "Video informativo (incarico/collaborazione + come lavori).",
          "Modulo prequalifica (domande immobile + motivazioni)."
        ],
        errori:[
          "Accettare appuntamento ‚Äòsubito‚Äô perch√© il cliente spinge.",
          "Parlare di prezzo prima del contesto e della relazione.",
          "Fissare un solo appuntamento (ti sfugge la regia)."
        ]
      }
    },

    {
      id:"std-90",
      relativeHours:-90,
      relLabel:"-90h",
      importance:"ok",
      title:"SMS riepilogo + invio video informativo (subito dopo la chiamata)",
      short:"Il cliente entra nel tuo metodo prima ancora di vederti. Impatto professionale.",
      popup:{
        obiettivo:[
          "Confermare appuntamenti e posizionarti come professionista strutturato.",
          "Educare il venditore sul significato di incarico/collaborazione."
        ],
        fareChecklist:[
          {t:"Invia SMS riepilogo entro 5 minuti", d:"La velocit√† comunica controllo e precisione."},
          {t:"Allega video informativo", d:"Il video ‚Äòprepara la mente‚Äô del venditore al tuo metodo e al concetto di incarico."},
          {t:"Scrivi che il recall √® parte del processo", d:"Cos√¨ domani non sembri ‚Äòinsistente‚Äô: sei coerente con il metodo."}
        ],
        direScript:`
SMS PRONTO (copia/incolla):
"Ciao [Nome], come anticipato: prequalifica telefonica [DATA/ORA] e appuntamento a casa [DATA/ORA]. 
Intanto ti mando un breve video dove spiego come lavoro e cosa significa affidarmi l‚Äôincarico, cos√¨ arriviamo all‚Äôappuntamento con le idee chiarissime."`,
        preparare:[
          "Video pronto (link WhatsApp/SMS).",
          "Template SMS salvato nelle note.",
          "Cartella cliente (nome, indirizzo, recapiti, note)."
        ],
        materiali:[
          "Video ‚ÄòIncarico/Collaborazione: cosa significa e come lavoro‚Äô.",
          "Template SMS.",
          "CRM/Note per registrare info cliente."
        ],
        errori:[
          "Inviare un papiro confuso.",
          "Non inviare il video: perdi ‚Äònovit√†‚Äô e pre-educazione.",
          "Non fissare aspettative sulla lettura futura dei materiali."
        ]
      }
    },

    {
      id:"std-72",
      relativeHours:-72,
      relLabel:"-72h",
      importance:"warn",
      title:"Prequalifica telefonica (decidi se √® in target)",
      short:"Domande precise: immobile + motivazioni + tempistiche + obiettivo economico + vincoli.",
      popup:{
        obiettivo:[
          "Capire se il cliente √® in target e vale la pena investire tempo.",
          "Raccogliere dati per relazione e presentazione.",
          "Impostare leadership: tu guidi, non chiacchieri."
        ],
        fareChecklist:[
          {t:"Apri con ‚Äòperch√© lo faccio‚Äô", d:"Rende la prequalifica un passaggio ‚Äònaturale‚Äô e autorevole."},
          {t:"Fai domande su motivazione e tempistica", d:"Senza motivazione/tempo chiaro, l‚Äôincarico √® fragile."},
          {t:"Chiedi cifra desiderata (obiettivo)", d:"Serve per gestire aspettative e obiezioni sul prezzo."},
          {t:"Verifica vincoli (mutuo/eredi/abusi/documenti)", d:"Problemi nascosti = ritardi e conflitti."},
          {t:"Decidi: target s√¨/no", d:"Se non √® in target, chiudi elegante. Se s√¨, procedi con relazione."}
        ],
        direScript:`
SET INIZIALE:
"Le faccio domande specifiche perch√© voglio arrivare da lei con una relazione di mercato seria e una strategia precisa."

MOTIVAZIONE:
"Qual √® il motivo principale per cui sta valutando la vendita?"

TEMPISTICA:
"Entro quando vorrebbe aver concluso lo spostamento?"

OBIETTIVO ECONOMICO:
"Qual √® la cifra che vuole realizzare? √à un obiettivo netto o ha margine?"

SITUAZIONE IMMOBILE:
"Mi descrive metratura, piano, stato interno, pertinenze, esposizione, spese, eventuali lavori fatti?"

VINCOLI/PROBLEMI:
"Ci sono mutui, ipoteche, eredi, vincoli o situazioni documentali da considerare?"

CHIUSURA PREQUALIFICA:
"Perfetto. Con questi dati posso costruire una relazione di mercato professionale. Se procediamo, gliela anticipo almeno 2 giorni prima e poi la richiamo il giorno prima per le sue impressioni."`,
        preparare:[
          "Modulo prequalifica compilato (con campi: obiettivo prezzo, motivazione, tempo, vincoli, obiezioni potenziali).",
          "Criteri ‚Äòtarget‚Äô (minimi) per decidere rapidamente.",
          "Cartella cliente aggiornata."
        ],
        materiali:[
          "Modulo prequalifica.",
          "CRM/Note.",
          "Checklist target."
        ],
        errori:[
          "Fare la chiamata ‚Äòa braccio‚Äô e dimenticare domande chiave.",
          "Non prendere appunti: perdi potere nella presentazione.",
          "Andare avanti anche se non √® in target (ti abbassi di status)."
        ]
      }
    },

    {
      id:"std-48",
      relativeHours:-48,
      relLabel:"-48h",
      importance:"danger",
      title:"Relazione di mercato + pacchetto (invio/consegna ‚â• 48h prima)",
      short:"Qui si vince: allinei prezzo, mostri metodo, ‚Äòsbollisci‚Äô aspettative e prepari obiezioni.",
      popup:{
        obiettivo:[
          "Far arrivare il venditore all‚Äôappuntamento con aspettative realistiche.",
          "Anticipare il tuo modo di lavorare e aumentare percezione di valore.",
          "Far emergere obiezioni PRIMA (tramite recall)."
        ],
        fareChecklist:[
          {t:"Costruisci relazione professionale", d:"Comparabili, range di mercato, logica prezzo, strategia, tempistiche."},
          {t:"Inserisci ‚Äòcome lavoro‚Äô (metodo)", d:"Deve capire che sei diverso dalla concorrenza."},
          {t:"Inserisci sezione ‚Äòincarico/collaborazione‚Äô", d:"Pre-educazione: non scopre tutto in faccia a te."},
          {t:"Invia/consegna ‚â• 48 ore prima", d:"Regola d‚Äôoro. Se no arrivi in difesa il giorno dell‚Äôincontro."},
          {t:"Pre-annuncia recall del giorno prima", d:"Serve a raccogliere impressioni e obiezioni."}
        ],
        direScript:`
MESSAGGIO DI INVIO:
"Ciao [Nome], ti ho inviato la relazione di mercato e il pacchetto informativo. Ti chiedo di leggerli con attenzione: domani ti richiamo per sentire le tue impressioni e rispondere a eventuali domande, cos√¨ all‚Äôappuntamento arriviamo gi√† allineati."`,
        preparare:[
          "Relazione di mercato (PDF + versione stampabile).",
          "Pacchetto incarico/collaborazione (1 pagina chiara + link video).",
          "Book di presentazione pronto e in ordine.",
          "Prove sociali: 3 casi simili (prima/dopo, tempi, risultati)."
        ],
        materiali:[
          "Relazione di mercato professionale.",
          "Pacchetto informativo incarico/collaborazione.",
          "Book di presentazione.",
          "Prove sociali (case study, incarichi, risultati, testimonianze).",
          "Materiali ‚Äòpubblicitari‚Äô professionali (consigliati):",
          "‚Ä¢ Brochure servizi (1 pagina): cosa fai, come, perch√© sei diverso.",
          "‚Ä¢ Scheda ‚ÄòMetodo di vendita‚Äô (timeline marketing e gestione visite).",
          "‚Ä¢ QR code al video (stampato nella brochure)."
        ],
        errori:[
          "Inviare la relazione il giorno prima o la mattina stessa.",
          "Fare una relazione ‚Äòfuffa‚Äô senza numeri e senza conclusione operativa.",
          "Non includere metodo e incarico: poi ti fanno guerra sul ‚Äòperch√© dovrei firmare con te‚Äô."
        ]
      }
    },

    {
      id:"std-24",
      relativeHours:-24,
      relLabel:"-24h",
      importance:"danger",
      title:"Recall: verifica lettura + impressioni + obiezioni (se NON ha letto ‚Üí rinvio)",
      short:"Il recall non √® conferma orario: √® controllo qualit√† e anticipo obiezioni.",
      popup:{
        obiettivo:[
          "Verificare che abbia letto e far emergere obiezioni prima.",
          "Rinviare se non ha letto: non entri mai a freddo."
        ],
        fareChecklist:[
          {t:"Chiama 1 giorno prima", d:"Non messaggino. Telefonata breve e ferma."},
          {t:"Domande in sequenza: ricevuta ‚Üí letta ‚Üí impressioni ‚Üí domande", d:"√à un mini-colloquio di allineamento."},
          {t:"Se non ha letto: sposta", d:"√à non negoziabile. Protegge status e risultato."},
          {t:"Annota obiezioni", d:"Prezzo, incarico, tempistiche, commissioni, ‚Äòci penso‚Äô."}
        ],
        direScript:`
RECALL STANDARD:
"Ciao [Nome], ti chiamo al volo: hai ricevuto la relazione? L‚Äôhai letta con attenzione? Che impressione ti sei fatto e quali domande vuoi farmi?"

SE OBIEZIONE SUL PREZZO:
"Perfetto, √® normale. Domani ti faccio vedere esattamente come arriviamo a quel valore e come proteggiamo il miglior risultato."

SE NON HA LETTO (rinvio):
"Capito. Allora spostiamo l‚Äôappuntamento: per me √® fondamentale che tu abbia letto almeno con attenzione le informazioni, cos√¨ domani non perdiamo tempo e arriviamo gi√† allineati."`,
        preparare:[
          "Lista obiezioni emerse (3-5 punti).",
          "Scaletta presentazione con ‚Äòpunti caldi‚Äô in evidenza.",
          "Chiusura pronta (frase diretta per firma)."
        ],
        materiali:[
          "Relazione + pacchetto inviato.",
          "Note/CRM per obiezioni."
        ],
        errori:[
          "Andare comunque se non ha letto (ti troverai a difenderti su prezzo e commissione).",
          "Fare discussione infinita al telefono: raccogli, non ‚Äòpresentare‚Äô tutto."
        ]
      }
    },

    {
      id:"std-0_10",
      relativeHours:-0.1667,
      relLabel:"-10m",
      importance:"warn",
      title:"Pre-routine (10 minuti prima di entrare) ‚Äî immagine, controllo emotivo, materiali",
      short:"√à come un primo appuntamento: immagine perfetta + anticipo + ripasso + book + screening.",
      popup:{
        obiettivo:[
          "Entrare con status alto e controllo emotivo.",
          "Non dimenticare nulla (materiali e informazioni)."
        ],
        fareChecklist:[
          {t:"Arriva 10 minuti prima", d:"Niente fretta = status."},
          {t:"Immagine perfetta", d:"Il venditore si aspetta ‚Äògrande agente‚Äô. No trasandato."},
          {t:"Ripassa prequalifica", d:"Motivazione, tempo, obiettivo ‚Ç¨, vincoli."},
          {t:"Ripassa obiezioni (recall)", d:"Cos√¨ le gestisci con calma e leadership."},
          {t:"Controlla book (ordine)", d:"Book pronto, prove sociali pronte."},
          {t:"Ripassa screening venditore", d:"Interessi/lavoro/affinit√†: aggancio umano solo se serve."}
        ],
        direScript:`
SELF-TALK (mentale):
"Oggi √® show time. Io seleziono chi rappresento. Conduco io. 30 minuti. Chiusura decisa."`,
        preparare:[
          "Book fisico o tablet carico.",
          "Moduli incarico pronti (se previsti).",
          "Prove sociali (3 casi).",
          "Brochure servizi + QR video (se usi kit)."
        ],
        materiali:[
          "Book di presentazione.",
          "Relazione (anche solo per riferimento).",
          "Prove sociali.",
          "Brochure servizi / scheda metodo / QR video."
        ],
        errori:[
          "Arrivare tardi e in affanno.",
          "Non ricordare obiettivo economico e motivazione: perdi leadership."
        ]
      }
    },

    {
      id:"std-0",
      relativeHours:0,
      relLabel:"0h",
      importance:"danger",
      title:"Appuntamento a casa ‚Äî Presentazione (‚â§ 30 min) + Chiusura incarico",
      short:"Qui firmi. Script: status ‚Üí novit√† ‚Üí inversione ‚Üí distacco ‚Üí tensione ‚Üí storytelling ‚Üí chiusura.",
      popup:{
        obiettivo:[
          "Uscire con incarico firmato il giorno stesso (possibilmente in esclusiva).",
          "Comunicare valore (commissione 3‚Äì4% / franchigia) come conseguenza del metodo."
        ],
        fareChecklist:[
          {t:"Conduci tu la conversazione", d:"Se diventa chiacchiera, perdi controllo."},
          {t:"Tieni il tempo (max 30 min)", d:"Se sfori, stai solo parlando."},
          {t:"Usa le 7 funzioni dello script", d:"Status, novit√†, inversione, distacco, tensione, immedesimazione, non subordinato."},
          {t:"Mostra prove sociali (risultati)", d:"Fai immedesimare: ‚Äòaltri come te‚Äô ‚Üí ‚Äòrisultato‚Äô."},
          {t:"Gestisci obiezioni gi√† note", d:"Prezzo e incarico si gestiscono con calma perch√© li hai ‚Äòpreparati‚Äô."},
          {t:"Chiusura decisa", d:"Non tentennare: chiedi la firma."}
        ],
        direScript:`
APERTURA (STATUS):
"Perfetto. Oggi facciamo una cosa molto semplice: le do un quadro chiaro del mercato e del mio metodo, e poi lei decide se sono l‚Äôagente giusto per rappresentarla."

NOVIT√Ä (attiva attenzione):
"Le anticipo che il mio modo di lavorare √® diverso da quello che trova normalmente: √® un processo strutturato che protegge il miglior risultato economico."

INVERSIONE PREDA/PREDATORE:
"Io prendo pochi incarichi: devo capire se qui posso darle un vantaggio reale. Se s√¨, procediamo. Se no, glielo dico con onest√†."

DISTACCO DAL RISULTATO:
"Non ho bisogno di prendere questo incarico: mi interessa prendere incarichi che posso portare a risultato con metodo."

TENSIONE/DESIDERIO:
"Se l‚Äôobiettivo √® massimizzare il prezzo e non ‚Äòsvendere‚Äô, allora dobbiamo seguire un processo preciso, non improvvisare."

IMMEDESIMAZIONE (storytelling + prove):
"Guardi questi casi: clienti con lo stesso problema iniziale. Le faccio vedere cosa √® successo quando hanno seguito il metodo."

GESTIONE COMMISSIONE/VALORE (se esce):
"Capisco. Il punto non √® ‚Äòquanto costo‚Äô, ma quanto le faccio guadagnare e quanto rischio le tolgo. Se sono un investimento che aumenta il risultato, la commissione diventa la parte pi√π semplice."

CHIUSURA (DECISA):
"Se √® d‚Äôaccordo sul prezzo corretto e sul mio metodo operativo, firmiamo l‚Äôincarico oggi cos√¨ partiamo subito."`,
        preparare:[
          "Scaletta 30 minuti (con timer).",
          "Book in ordine (metodo ‚Üí prove sociali ‚Üí casi).",
          "Moduli incarico pronti (penna, documenti).",
          "Obiezioni previste: prezzo / esclusiva / commissione / tempistiche."
        ],
        materiali:[
          "Book di presentazione (strutturato).",
          "Prove sociali (incarichi, risultati, testimonianze).",
          "Relazione di mercato (gi√† letta).",
          "Moduli incarico + penna.",
          "Materiale ‚Äòpubblicitario‚Äô pro: brochure servizi + scheda metodo + QR video."
        ],
        errori:[
          "Sforare 30 minuti.",
          "Chiusura timida (‚Äòci pensi‚Äô = perdi).",
          "Cercare approvazione (ti mette sotto)."
        ]
      }
    },

    {
      id:"std+1",
      relativeHours:1,
      relLabel:"+1h",
      importance:"ok",
      title:"Debrief post appuntamento (in auto) + Allenamento continuo",
      short:"Scrivi cosa migliorare. Role play 30 min/die. Registrazione mensile.",
      popup:{
        obiettivo:[
          "Migliorare appuntamento dopo appuntamento, fino a standardizzare conversione incarichi."
        ],
        fareChecklist:[
          {t:"Fermati 5 minuti e scrivi subito", d:"Se aspetti, dimentichi dettagli."},
          {t:"Annota 1 cosa da migliorare", d:"Una sola, concreta, per volta: cos√¨ migliori davvero."},
          {t:"Role play 30 min al giorno", d:"Allenamento deliberato: non ‚Äòesperienza‚Äô generica."},
          {t:"Registrati 1 volta al mese", d:"Per vedere tono, esitazioni, linguaggio non verbale."}
        ],
        direScript:`
DEBRIEF (scrivi in 3 minuti):
- Dove ho perso controllo?
- Quale obiezione mi ha rallentato?
- Ho sforato i tempi? Perch√©?
- Quale frase va migliorata?
- Come posso rendere la chiusura pi√π pulita?`,
        preparare:[
          "Template debrief in note.",
          "Calendario allenamento (30 min/die).",
          "Promemoria registrazione mensile."
        ],
        materiali:[
          "Note/CRM.",
          "Telefono per registrazione."
        ],
        errori:[
          "Non debriefare ‚Üí ripeti gli stessi errori.",
          "Pensare che ‚Äòbasti fare tanti appuntamenti‚Äô senza allenamento."
        ]
      }
    }
  ],

  previsita: [
    {
      id:"pre-96",
      relativeHours:-96,
      relLabel:"-96h",
      importance:"info",
      title:"Primo contatto (immobile speciale): fissa PREVISITA a casa",
      short:"Attici/villa/pregio: devi vedere l‚Äôoggetto prima di fare la relazione.",
      popup:{
        obiettivo:[
          "Fissare appuntamento di perlustrazione per conoscere immobile e proprietario.",
          "Impostare che dopo prepari relazione e poi fai recall."
        ],
        fareChecklist:[
          {t:"Fissa previsita", d:"Spiega che √® necessaria per una relazione seria."},
          {t:"Definisci gi√† il percorso", d:"Previsita ‚Üí relazione ‚Üí invio ‚â• 48h ‚Üí recall ‚Üí firma (ufficio o step successivo)."}
        ],
        direScript:`
"Per immobili come questo, prima devo vederlo di persona: solo cos√¨ posso costruire una relazione di mercato seria e una strategia corretta. 
Dopo la previsita preparo la relazione, gliela anticipo e la richiamo il giorno prima per le sue impressioni."`,
        preparare:[
          "Checklist sopralluogo (punti forti/critici).",
          "Modulo raccolta dati immobile."
        ],
        materiali:[
          "Checklist previsita/sopralluogo.",
          "Scheda immobile."
        ],
        errori:[
          "Fare relazione senza vedere l‚Äôoggetto (nei casi speciali)."
        ]
      }
    },

    {
      id:"pre-72",
      relativeHours:-72,
      relLabel:"-72h",
      importance:"warn",
      title:"PREVISITA a casa: perlustrazione + conoscenza venditore",
      short:"Raccogli info reali, motivazioni, obiettivo ‚Ç¨, criticit√†: decidi se procedere.",
      popup:{
        obiettivo:[
          "Conoscere oggetto e proprietario e raccogliere tutto per una relazione professionale.",
          "Capire se il cliente √® in target."
        ],
        fareChecklist:[
          {t:"Perlustra: punti forti e criticit√†", d:"L‚Äôobiettivo √® capire cosa vendere e come."},
          {t:"Chiedi motivazione e tempi", d:"Se manca urgenza/motivazione, la vendita ‚Äòmuore‚Äô."},
          {t:"Chiedi obiettivo economico", d:"Serve per gestione aspettative."},
          {t:"Decidi se procedere", d:"Se non √® in target, ti fermi."}
        ],
        direScript:`
"Oggi raccolgo tutte le informazioni reali dell‚Äôimmobile e delle sue esigenze. 
Poi le preparo una relazione di mercato professionale e gliela anticipo, cos√¨ al prossimo incontro saremo gi√† allineati."`,
        preparare:[
          "Note/Foto (se consentite).",
          "Scheda immobile completa."
        ],
        materiali:[
          "Checklist sopralluogo.",
          "Scheda immobile."
        ],
        errori:[
          "Trasformare la previsita in una presentazione lunga: oggi raccogli, non ‚Äòvendi‚Äô."
        ]
      }
    },

    {
      id:"pre-48",
      relativeHours:-48,
      relLabel:"-48h",
      importance:"danger",
      title:"Relazione post-previsita + invio ‚â• 48h prima",
      short:"Identico allo standard: qui abbassi emozione e anticipi obiezioni.",
      popup:{
        obiettivo:[
          "Allineare aspettative (prezzo) e metodo (incarico) prima della firma."
        ],
        fareChecklist:[
          {t:"Prepara relazione su misura", d:"Oggetto speciale = analisi pi√π accurata e spiegazione chiara."},
          {t:"Invia/consegna ‚â• 48h prima", d:"Non si discute."},
          {t:"Prepara recall 24h prima", d:"Tiri fuori obiezioni prima dell‚Äôincontro."}
        ],
        direScript:`
"Le ho inviato la relazione di mercato. La guardi con attenzione: domani la richiamo per le sue impressioni e le eventuali domande."`,
        preparare:[
          "Relazione + book + casi simili (pregio).",
          "Pacchetto incarico/collaborazione."
        ],
        materiali:[
          "Relazione di mercato.",
          "Book + prove sociali.",
          "Brochure servizi + QR video."
        ],
        errori:[
          "Inviare tardi e gestire shock prezzo il giorno dell‚Äôincontro."
        ]
      }
    },

    {
      id:"pre-24",
      relativeHours:-24,
      relLabel:"-24h",
      importance:"danger",
      title:"Recall (se non ha letto ‚Üí rinvio)",
      short:"Verifica lettura e impressioni. Se non legge, non ti presenti.",
      popup:{
        obiettivo:["Assicurarti che arrivi preparato e che le obiezioni emergano prima."],
        fareChecklist:[
          {t:"Chiama", d:"Ricevuta? Letta? Impressioni? Domande?"},
          {t:"Se non letto ‚Üí rinvia", d:"Protegge status e chiusura."}
        ],
        direScript:`
"Ciao [Nome], hai ricevuto e letto la relazione? Che impressione ti sei fatto e che domande vuoi farmi prima dell‚Äôappuntamento?"
Se NON letta:
"Allora spostiamo: per me √® fondamentale che lei la legga prima, cos√¨ ci troviamo gi√† allineati."`,
        preparare:["Lista obiezioni emerse + scaletta presentazione."],
        materiali:["Note/CRM."],
        errori:["Andare a freddo."]
      }
    },

    {
      id:"pre-0",
      relativeHours:0,
      relLabel:"0h",
      importance:"danger",
      title:"Appuntamento in UFFICIO: firma incarico",
      short:"Arriva gi√† educato dal processo: relazione + recall = firma pulita.",
      popup:{
        obiettivo:["Firmare incarico con controllo e chiarezza su prezzo e metodo."],
        fareChecklist:[
          {t:"Ricapitola 3 punti chiave", d:"Mercato, prezzo corretto, metodo operativo."},
          {t:"Gestisci eventuali dubbi", d:"Incarico, collaborazione, tempistiche."},
          {t:"Firma", d:"Chiusura diretta."}
        ],
        direScript:`
"Abbiamo gi√† un quadro chiaro del mercato e del mio metodo. Se √® d‚Äôaccordo su prezzo e strategia, firmiamo l‚Äôincarico oggi e partiamo subito."`,
        preparare:["Moduli incarico, penna, book, prove sociali."],
        materiali:["Moduli incarico + book + relazione."],
        errori:["Riaprire tutto da capo (la relazione serve a evitarlo)."]
      }
    }
  ],

  kit: [
    {
      id:"kit-1",
      relativeHours:null,
      relLabel:"KIT",
      importance:"ok",
      title:"Materiali OBBLIGATORI (pronti sempre, prima di qualunque appuntamento)",
      short:"Se manca uno di questi, stai improvvisando.",
      popup:{
        obiettivo:["Avere un kit completo per impatto professionale e chiusura immediata."],
        fareChecklist:[
          {t:"Relazione di mercato (template + personalizzazione)", d:"Comparabili, range, logica prezzo, strategia."},
          {t:"Book di presentazione (ordine fisso)", d:"Metodo ‚Üí prove sociali ‚Üí casi ‚Üí processo operativo."},
          {t:"Video informativo incarico/collaborazione", d:"Pre-educazione del venditore."},
          {t:"Template SMS", d:"Riepilogo appuntamenti + invio relazione + follow-up."},
          {t:"Modulo prequalifica", d:"Domande immobile + motivazioni + obiettivo ‚Ç¨ + vincoli."},
          {t:"Prove sociali", d:"3 casi simili: risultati, tempi, testimonianze."},
          {t:"Moduli incarico pronti", d:"Quando decidi di chiudere, devi poter firmare subito."},
          {t:"Materiali ‚Äòpubblicitari‚Äô professionali", d:"Brochure 1 pagina + scheda metodo + QR video."}
        ],
        direScript:`
BROCHURE (testo consigliato - 1 pagina):
- Cosa faccio: vendita strutturata per massimizzare risultato economico
- Come: analisi + posizionamento + marketing + gestione visite + negoziazione
- Perch√© io: prove sociali + metodo + controllo del processo
- QR video: ‚ÄúCome funziona l‚Äôincarico e cosa faccio per vendere bene‚Äù`,
        preparare:[
          "Cartellina fisica (o cartella digitale) con: book, prove, moduli, brochure.",
          "QR code stampato e funzionante.",
          "Tablet/telefono carico."
        ],
        materiali:[
          "Relazione (PDF + stampa).",
          "Book (PDF/tablet + stampa).",
          "Brochure servizi (1 pagina).",
          "Scheda metodo (timeline operativa marketing).",
          "QR code al video.",
          "Prove sociali (3 casi).",
          "Moduli incarico + penna."
        ],
        errori:[
          "Presentarsi senza prove sociali.",
          "Non avere moduli pronti: perdi l‚Äôattimo della firma."
        ]
      }
    },

    {
      id:"kit-2",
      relativeHours:null,
      relLabel:"SCRIPT",
      importance:"warn",
      title:"Script completo: 7 funzioni psicologiche (da usare SEMPRE)",
      short:"√à lo scheletro che ti fa chiudere senza ‚Äòsupplicare‚Äô.",
      popup:{
        obiettivo:["Avere uno script che alza status, crea novit√† e ti porta alla firma con leadership."],
        fareChecklist:[
          {t:"Allenati 30 min/die (role play)", d:"Come uno sport: ripetizione, non improvvisazione."},
          {t:"Registrati 1 volta al mese", d:"Vedi esitazioni e punti deboli."},
          {t:"Taglia a 30 minuti", d:"Timer sempre."}
        ],
        direScript:`
1) STATUS:
"Oggi le do un quadro chiaro e poi lei decide se sono la persona giusta."

2) NOVIT√Ä:
"Il mio modo di lavorare √® diverso: √® un processo che protegge risultato e tempo."

3) INVERSIONE PREDA/PREDATORE:
"Io rappresento pochi immobili: devo capire se qui posso dare un vantaggio reale."

4) DISTACCO:
"Non ho bisogno dell‚Äôincarico: prendo solo incarichi che posso portare a risultato."

5) TENSIONE/DESIDERIO:
"Se vuole massimizzare il prezzo, dobbiamo seguire un processo preciso."

6) IMMEDESIMAZIONE (storytelling + prove):
"Guardi questi casi: stessi problemi, risultato ottenuto applicando il metodo."

7) NON SUBORDINATO (educato):
"Mi fa piacere conoscerla, ma la mia priorit√† √® lavorare con criteri chiari."`,
        preparare:[
          "3 varianti di chiusura (tutte dirette).",
          "3 risposte brevi a: prezzo / esclusiva / commissione."
        ],
        materiali:[
          "Timer.",
          "Book con prove sociali.",
          "Appunti obiezioni standard."
        ],
        errori:[
          "Diventare ‚Äòtroppo amico‚Äô e perdere status.",
          "Parlare senza struttura."
        ]
      }
    }
  ]
};

/* -------------------------------------------------
   UI
   ------------------------------------------------- */
const $ = (s)=>document.querySelector(s);
const timelineEl = $("#timeline");
const backdrop = $("#backdrop");
const mTitle = $("#mTitle");
const mSub = $("#mSub");
const mTabs = $("#mTabs");
const mBody = $("#mBody");
let activeMode = "standard";
let activeTab = "fare";

function pad2(n){ return String(n).padStart(2,"0"); }
function formatDateTime(dt){
  const y = dt.getFullYear();
  const m = pad2(dt.getMonth()+1);
  const d = pad2(dt.getDate());
  const hh = pad2(dt.getHours());
  const mm = pad2(dt.getMinutes());
  return `${y}-${m}-${d} ${hh}:${mm}`;
}
function formatLocalInputValue(dt){
  const y = dt.getFullYear();
  const m = pad2(dt.getMonth()+1);
  const d = pad2(dt.getDate());
  const hh = pad2(dt.getHours());
  const mm = pad2(dt.getMinutes());
  return `${y}-${m}-${d}T${hh}:${mm}`;
}
function relToAbsolute(appt, relativeHours){
  if(!appt || relativeHours === null || relativeHours === undefined) return null;
  return new Date(appt.getTime() + relativeHours * 3600 * 1000);
}
function badgeClass(importance){
  if(importance==="ok") return "badge ok";
  if(importance==="warn") return "badge warn";
  if(importance==="danger") return "badge danger";
  return "badge";
}
function badgeText(importance){
  if(importance==="ok") return "Operativo";
  if(importance==="warn") return "Attenzione";
  if(importance==="danger") return "Critico";
  return "Info";
}
function esc(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function setMode(mode){
  activeMode = mode;
  $("#tab-standard").classList.toggle("active", mode==="standard");
  $("#tab-previsita").classList.toggle("active", mode==="previsita");
  $("#tab-kit").classList.toggle("active", mode==="kit");
  $("#modeTag").textContent =
    mode==="standard" ? "Processo: Standard (90‚Äì95%)" :
    mode==="previsita" ? "Processo: Con previsita (immobili particolari)" :
    "Sezione: Kit & Script (sempre)";
  renderTimeline();
}

function renderTimeline(){
  const apptVal = $("#appt").value;
  const appt = apptVal ? new Date(apptVal) : null;

  const items = DATA[activeMode] ?? [];
  timelineEl.innerHTML = "";

  items.forEach(item=>{
    const abs = (appt && item.relativeHours !== null && item.relativeHours !== undefined)
      ? relToAbsolute(appt, item.relativeHours) : null;

    const leftTop = abs ? `${formatDateTime(abs)}` : "Orario assoluto: ‚Äî";
    const el = document.createElement("div");
    el.className = "event";
    el.setAttribute("role","button");
    el.setAttribute("tabindex","0");

    el.innerHTML = `
      <div class="left">
        <div class="rel">${esc(item.relLabel)}</div>
        <div>${esc(leftTop)}</div>
        <div class="${badgeClass(item.importance)}"><span class="dot"></span>${esc(badgeText(item.importance))}</div>
      </div>
      <div class="right">
        <div class="title">${esc(item.title)}</div>
        <p class="desc">${esc(item.short)}</p>
      </div>
    `;
    el.addEventListener("click", ()=> openModal(item, abs));
    el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openModal(item, abs);} });
    timelineEl.appendChild(el);
  });
}

function renderTabs(popup){
  const tabs = [
    {id:"fare", label:"‚úÖ Cosa fare"},
    {id:"dire", label:"üó£Ô∏è Cosa dire"},
    {id:"prep", label:"üß∞ Cosa preparare"},
    {id:"mat", label:"üì¶ Materiali"},
    {id:"err", label:"üö´ Errori"},
    {id:"obj", label:"üéØ Obiettivo"}
  ];
  mTabs.innerHTML = "";
  tabs.forEach(t=>{
    const b = document.createElement("div");
    b.className = "m-tab" + (t.id===activeTab ? " active":"");
    b.textContent = t.label;
    b.tabIndex = 0;
    b.addEventListener("click", ()=>{ activeTab=t.id; renderModalBody(popup); renderTabs(popup); });
    b.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ activeTab=t.id; renderModalBody(popup); renderTabs(popup);} });
    mTabs.appendChild(b);
  });
}

function listSection(title, items){
  const li = (items||[]).map(x=>`<li>${esc(x)}</li>`).join("");
  return `<div class="section"><h4>${esc(title)}</h4><ul>${li}</ul></div>`;
}
function checklistSection(title, rows){
  const html = (rows||[]).map((r,i)=>`
    <div class="chk">
      <input type="checkbox" id="chk-${Math.random().toString(16).slice(2)}" />
      <div>
        <div class="t">${esc(r.t)}</div>
        <div class="d">${esc(r.d||"")}</div>
      </div>
    </div>
  `).join("");
  return `<div class="section"><h4>${esc(title)}</h4><div class="checklist">${html}</div></div>`;
}
function scriptSection(title, text){
  return `<div class="section"><h4>${esc(title)}</h4><div class="script">${esc(text||"")}</div></div>`;
}

function renderModalBody(popup){
  const p = popup || {};
  if(activeTab==="fare"){
    mBody.innerHTML = checklistSection("‚úÖ Cosa fare (passi eseguibili)", p.fareChecklist);
  } else if(activeTab==="dire"){
    mBody.innerHTML = scriptSection("üó£Ô∏è Cosa dire (script parola per parola)", p.direScript || "");
  } else if(activeTab==="prep"){
    mBody.innerHTML = listSection("üß∞ Cosa preparare (prima di muoverti)", p.preparare);
  } else if(activeTab==="mat"){
    mBody.innerHTML = listSection("üì¶ Materiali (inclusi materiali ‚Äòpubblicitari‚Äô)", p.materiali);
  } else if(activeTab==="err"){
    mBody.innerHTML = listSection("üö´ Errori da evitare (ti fanno perdere status)", p.errori);
  } else if(activeTab==="obj"){
    mBody.innerHTML = listSection("üéØ Obiettivo del blocco (perch√© lo fai)", p.obiettivo);
  }
}

function openModal(item, abs){
  const apptVal = $("#appt").value;
  const appt = apptVal ? new Date(apptVal) : null;

  const absLine = abs ? `Orario: ${formatDateTime(abs)}` : "Orario: (imposta l‚Äôappuntamento in alto per calcolarlo)";
  const relLine = item.relLabel + (item.relativeHours !== null && item.relativeHours !== undefined ? " (relativo)" : "");

  mTitle.textContent = item.title;
  mSub.textContent = `${relLine}\n${absLine}`;

  activeTab = "fare";
  renderTabs(item.popup);
  renderModalBody(item.popup);

  backdrop.classList.add("show");
}
function closeModal(){ backdrop.classList.remove("show"); }

$("#close").addEventListener("click", closeModal);
backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) closeModal(); });
window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });

$("#apply").addEventListener("click", renderTimeline);
$("#reset").addEventListener("click", ()=>{
  $("#appt").value = "";
  renderTimeline();
});

$("#tab-standard").addEventListener("click", ()=> setMode("standard"));
$("#tab-previsita").addEventListener("click", ()=> setMode("previsita"));
$("#tab-kit").addEventListener("click", ()=> setMode("kit"));

$("#tab-standard").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") setMode("standard"); });
$("#tab-previsita").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") setMode("previsita"); });
$("#tab-kit").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") setMode("kit"); });

$("#exportTxt").addEventListener("click", ()=>{
  const apptVal = $("#appt").value;
  const appt = apptVal ? new Date(apptVal) : null;
  const items = DATA[activeMode] ?? [];
  let out = `=== ${activeMode.toUpperCase()} ===\n`;
  out += appt ? `Appuntamento: ${formatDateTime(appt)}\n\n` : `Appuntamento: (non impostato)\n\n`;

  for(const it of items){
    const abs = (appt && it.relativeHours !== null && it.relativeHours !== undefined)
      ? relToAbsolute(appt, it.relativeHours) : null;

    out += `--- ${it.relLabel} ${abs ? "(" + formatDateTime(abs) + ")" : ""}\n`;
    out += `${it.title}\n\n`;

    const p = it.popup || {};
    out += `OBIETTIVO:\n- ${(p.obiettivo||[]).join("\n- ")}\n\n`;
    out += `COSA FARE:\n- ${(p.fareChecklist||[]).map(r=>r.t + (r.d? " ‚Äî " + r.d:"")).join("\n- ")}\n\n`;
    out += `COSA DIRE:\n${(p.direScript||"")}\n\n`;
    out += `COSA PREPARARE:\n- ${(p.preparare||[]).join("\n- ")}\n\n`;
    out += `MATERIALI:\n- ${(p.materiali||[]).join("\n- ")}\n\n`;
    out += `ERRORI:\n- ${(p.errori||[]).join("\n- ")}\n\n`;
  }

  navigator.clipboard?.writeText(out).then(()=> alert("Copiato negli appunti ‚úÖ"))
    .catch(()=>{
      const w = window.open("", "_blank");
      w.document.write(`<pre>${esc(out)}</pre>`);
      w.document.close();
    });
});

/* Init: default a domani 16:00 */
(function init(){
  const now = new Date();
  const d = new Date(now);
  d.setHours(16,0,0,0);
  if(now.getTime() > d.getTime()) d.setDate(d.getDate()+1);
  $("#appt").value = formatLocalInputValue(d);
  renderTimeline();
})();
</script>
</body>
</html>
