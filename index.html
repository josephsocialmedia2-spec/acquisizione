 <!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIDEO ACQ - Sistema Acquisizione Video per Immobiliare</title>
    <style>
        :root {
            --bg: #0f172a;
            --text: #f1f5f9;
            --gold: #fbbf24;
            --red: #ef4444;
            --green: #10b981;
            --border: rgba(255,255,255,0.1);
            --radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* HEADER */
        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--gold);
        }
        
        .header p {
            color: #94a3b8;
            font-size: 1.1rem;
        }
        
        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: var(--gold);
            color: #0f172a;
            border-color: var(--gold);
        }
        
        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* VIDEO ACQUISITION TAB */
        .video-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .video-section {
                grid-template-columns: 1fr;
            }
        }
        
        .video-preview {
            background: #000;
            border-radius: var(--radius);
            overflow: hidden;
            aspect-ratio: 9/16;
            position: relative;
        }
        
        #videoLive {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .rec-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 20px;
            display: none;
            align-items: center;
            gap: 8px;
            color: white;
        }
        
        .rec-dot {
            width: 12px;
            height: 12px;
            background: var(--red);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .control-group {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }
        
        .control-group h3 {
            margin-bottom: 15px;
            color: var(--gold);
            font-size: 1.2rem;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--gold);
            color: #0f172a;
        }
        
        .btn-primary:hover {
            background: #f59e0b;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-success {
            background: var(--green);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-disabled {
            background: #475569;
            color: #94a3b8;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .device-select {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            margin-top: 10px;
        }
        
        /* UPLOAD SECTION */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--gold);
            background: rgba(251, 191, 36, 0.05);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        /* WHATSAPP BUTTON */
        .whatsapp-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #25D366;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(37, 211, 102, 0.3);
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .whatsapp-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(37, 211, 102, 0.4);
        }
        
        /* RECORDINGS LIST */
        .recordings-list {
            display: grid;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .recording-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .recording-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .recording-name {
            font-weight: 600;
        }
        
        .recording-size {
            font-size: 0.9rem;
            color: #94a3b8;
        }
        
        /* DASHBOARD TAB */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        /* SIMPLE TAB */
        .simple-instructions {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .instructions-list {
            margin: 20px 0;
            padding-left: 20px;
        }
        
        .instructions-list li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        /* FOOTER */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: #94a3b8;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- WhatsApp Button -->
    <a href="https://wa.me/393713708294" class="whatsapp-btn" target="_blank" id="whatsappLink">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.373 0 0 5.373 0 12c0 2.126.549 4.125 1.517 5.861L0 24l6.339-1.517A11.936 11.936 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm6.5 17.5c-.324.896-1.603 1.639-2.625 1.86-1.016.22-2.229.297-3.175-.343-.897-.604-1.397-1.625-2.098-2.416-.78-.871-1.678-1.54-2.32-2.548C7.03 13.22 6.5 11.678 6.5 10.5c0-2.278 1.795-4.14 4.035-4.14 1.02 0 1.97.434 2.717 1.19.745.755 1.248 1.715 1.248 2.78 0 1.065-.503 2.025-1.248 2.78-.747.756-1.697 1.19-2.717 1.19-.432 0-.855-.09-1.248-.265.18.576.503 1.098.975 1.515.78.697 1.697 1.19 2.717 1.19.432 0 .855-.09 1.248-.265.18.576.503 1.098.975 1.515.324.29.747.434 1.17.434.432 0 .855-.09 1.248-.265.18.09.36.18.503.29z"/>
        </svg>
        Invia a Joseph
    </a>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>VIDEO ACQ</h1>
            <p>Sistema di acquisizione video per immobiliare - Crea, salva, invia in 3 click</p>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="acquisizione">üé• Acquisizione Video</button>
            <button class="tab-btn" data-tab="dashboard">üìä Dashboard</button>
            <button class="tab-btn" data-tab="istruzioni">üìã Come Funziona</button>
        </div>

        <!-- TAB 1: ACQUISIZIONE VIDEO -->
        <div class="tab-content active" id="acquisizione">
            <div class="video-section">
                <!-- Video Preview -->
                <div class="video-preview">
                    <video id="videoLive" autoplay playsinline muted></video>
                    <div class="rec-indicator" id="recIndicator">
                        <div class="rec-dot"></div>
                        <span id="recTimer">00:00</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <!-- Camera Controls -->
                    <div class="control-group">
                        <h3>üì∑ Controlli Camera</h3>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="startCamera">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
                                    <path d="M20 4h-3.17L15 2H9L7.17 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm-8 13a5 5 0 110-10 5 5 0 010 10z"/>
                                </svg>
                                Accendi Camera
                            </button>
                            <select class="device-select" id="cameraSelect">
                                <option value="">Scegli camera...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Recording Controls -->
                    <div class="control-group">
                        <h3>üî¥ Registrazione</h3>
                        <div class="btn-group">
                            <button class="btn btn-danger" id="startRecording" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="12" cy="12" r="8"/>
                                </svg>
                                INIZIA REC
                            </button>
                            <button class="btn" id="stopRecording" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <rect x="6" y="6" width="12" height="12"/>
                                </svg>
                                STOP
                            </button>
                        </div>
                    </div>

                    <!-- Video List -->
                    <div class="control-group">
                        <h3>üé¨ Video Salvati</h3>
                        <div class="recordings-list" id="recordingsList">
                            <div style="text-align: center; color: #94a3b8; padding: 20px;">
                                Nessun video salvato
                            </div>
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div class="control-group">
                        <h3>üì§ Carica Video</h3>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">üìÅ</div>
                            <p>Trascina un video qui o clicca per selezionare</p>
                            <input type="file" id="fileInput" accept="video/*" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: DASHBOARD -->
        <div class="tab-content" id="dashboard">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalVideos">0</div>
                    <div class="stat-label">Video Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDuration">0s</div>
                    <div class="stat-label">Durata Totale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lastRecording">-</div>
                    <div class="stat-label">Ultima Registrazione</div>
                </div>
            </div>

            <div class="control-group">
                <h3>üìã Azioni Rapide</h3>
                <div class="btn-group">
                    <button class="btn btn-success" id="sendAllVideos">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                        Invia Tutti i Video
                    </button>
                    <button class="btn" id="clearAllVideos">
                        üóëÔ∏è Cancella Tutto
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB 3: ISTRUZIONI -->
        <div class="tab-content" id="istruzioni">
            <div class="simple-instructions">
                <h2>Come Funziona - 3 Passi</h2>
                <ol class="instructions-list">
                    <li><strong>Accendi la Camera</strong> - Clicca "Accendi Camera" e seleziona la webcam</li>
                    <li><strong>Registra</strong> - Clicca "INIZIA REC" e parla davanti alla camera</li>
                    <li><strong>Invia</strong> - Clicca il bottone WhatsApp per inviare il video a Joseph</li>
                </ol>
                <p>I video si salvano automaticamente e puoi inviarli quando vuoi.</p>
            </div>

            <div class="control-group">
                <h3>üìû Supporto</h3>
                <p>Problemi? Contatta Joseph direttamente su WhatsApp:</p>
                <a href="https://wa.me/393713708294" class="btn btn-success" target="_blank" style="margin-top: 15px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0C5.373 0 0 5.373 0 12c0 2.126.549 4.125 1.517 5.861L0 24l6.339-1.517A11.936 11.936 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm6.5 17.5c-.324.896-1.603 1.639-2.625 1.86-1.016.22-2.229.297-3.175-.343-.897-.604-1.397-1.625-2.098-2.416-.78-.871-1.678-1.54-2.32-2.548C7.03 13.22 6.5 11.678 6.5 10.5c0-2.278 1.795-4.14 4.035-4.14 1.02 0 1.97.434 2.717 1.19.745.755 1.248 1.715 1.248 2.78 0 1.065-.503 2.025-1.248 2.78-.747.756-1.697 1.19-2.717 1.19-.432 0-.855-.09-1.248-.265.18.576.503 1.098.975 1.515.78.697 1.697 1.19 2.717 1.19.432 0 .855-.09 1.248-.265.18.576.503 1.098.975 1.515.324.29.747.434 1.17.434.432 0 .855-.09 1.248-.265.18.09.36.18.503.29z"/>
                    </svg>
                    Chiama Joseph (+39 371 3708294)
                </a>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <p>VIDEO ACQ ¬© 2024 - Sistema professionale di acquisizione video per immobiliare</p>
            <p>Nessuna installazione richiesta - Funziona direttamente nel browser</p>
        </div>
    </div>

    <script>
        // ============================================
        // VARIABILI GLOBALI
        // ============================================
        let mediaStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordings = [];
        let recordingTimer = null;
        let recordingStartTime = null;
        
        // Elementi DOM
        const videoLive = document.getElementById('videoLive');
        const cameraSelect = document.getElementById('cameraSelect');
        const startCameraBtn = document.getElementById('startCamera');
        const startRecordingBtn = document.getElementById('startRecording');
        const stopRecordingBtn = document.getElementById('stopRecording');
        const recIndicator = document.getElementById('recIndicator');
        const recTimer = document.getElementById('recTimer');
        const recordingsList = document.getElementById('recordingsList');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const whatsappLink = document.getElementById('whatsappLink');
        
        // ============================================
        // FUNZIONI UTILITY
        // ============================================
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ============================================
        // GESTIONE TAB
        // ============================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Rimuovi active da tutti
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Aggiungi active al tab cliccato
                btn.classList.add('active');
                const tabId = btn.dataset.tab;
                document.getElementById(tabId).classList.add('active');
                
                // Aggiorna dashboard se necessario
                if (tabId === 'dashboard') {
                    updateDashboard();
                }
            });
        });
        
        // ============================================
        // GESTIONE CAMERA
        // ============================================
        async function getCameraDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                cameraSelect.innerHTML = '<option value="">Scegli camera...</option>';
                
                devices.forEach(device => {
                    if (device.kind === 'videoinput') {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${cameraSelect.options.length}`;
                        cameraSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Errore lista dispositivi:', error);
            }
        }
        
        async function startCamera(deviceId = null) {
            try {
                // Ferma stream esistente
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        deviceId: deviceId ? { exact: deviceId } : undefined,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoLive.srcObject = mediaStream;
                
                // Abilita pulsante REC
                startRecordingBtn.disabled = false;
                startRecordingBtn.classList.remove('btn-disabled');
                startRecordingBtn.classList.add('btn-danger');
                
                // Aggiorna testo bottone
                startCameraBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
                        <path d="M20 4h-3.17L15 2H9L7.17 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm-8 13a5 5 0 110-10 5 5 0 010 10z"/>
                    </svg>
                    Camera Accesa
                `;
                
                return true;
            } catch (error) {
                alert('Errore accesso camera: ' + error.message);
                console.error('Errore camera:', error);
                return false;
            }
        }
        
        // ============================================
        // GESTIONE REGISTRAZIONE
        // ============================================
        function startRecording() {
            if (!mediaStream) {
                alert('Accendi prima la camera!');
                return;
            }
            
            recordedChunks = [];
            
            // Crea MediaRecorder
            const options = {
                mimeType: 'video/webm;codecs=vp9,opus',
                audioBitsPerSecond: 128000,
                videoBitsPerSecond: 2500000
            };
            
            // Prova codec alternativi
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/webm;codecs=vp8,opus';
            }
            
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/webm';
            }
            
            mediaRecorder = new MediaRecorder(mediaStream, options);
            
            // Gestione dati
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            // Fine registrazione
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                saveRecording(blob);
                
                // Reset indicator
                recIndicator.style.display = 'none';
                clearInterval(recordingTimer);
                
                // Riabilita pulsanti
                startRecordingBtn.disabled = false;
                stopRecordingBtn.disabled = true;
            };
            
            // Start recording
            mediaRecorder.start(1000); // Raccolta dati ogni secondo
            
            // Mostra indicatore
            recIndicator.style.display = 'flex';
            recordingStartTime = Date.now();
            
            // Aggiorna timer
            recordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                recTimer.textContent = formatTime(elapsed);
            }, 1000);
            
            // Disabilita pulsante start, abilita stop
            startRecordingBtn.disabled = true;
            stopRecordingBtn.disabled = false;
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }
        
        // ============================================
        // SALVATAGGIO VIDEO
        // ============================================
        function saveRecording(blob) {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `video-${timestamp}.webm`;
            
            const recording = {
                id: Date.now(),
                filename: filename,
                blob: blob,
                size: blob.size,
                date: new Date().toLocaleString(),
                duration: Math.floor((Date.now() - recordingStartTime) / 1000)
            };
            
            recordings.unshift(recording);
            updateRecordingsList();
            updateDashboard();
            
            // Prepara link WhatsApp con l'ultimo video
            const url = URL.createObjectURL(blob);
            whatsappLink.href = `https://wa.me/393713708294?text=${encodeURIComponent('Ecco il video registrato con VIDEO ACQ')}`;
            
            // For download instead of direct send (browser limitations)
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
        
        // ============================================
        // LISTA VIDEO
        // ============================================
        function updateRecordingsList() {
            if (recordings.length === 0) {
                recordingsList.innerHTML = `
                    <div style="text-align: center; color: #94a3b8; padding: 20px;">
                        Nessun video salvato
                    </div>
                `;
                return;
            }
            
            recordingsList.innerHTML = recordings.map(rec => `
                <div class="recording-item" data-id="${rec.id}">
                    <div class="recording-info">
                        <div class="recording-name">${rec.filename}</div>
                        <div class="recording-size">
                            ${rec.date} ‚Ä¢ ${formatFileSize(rec.size)} ‚Ä¢ ${rec.duration}s
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="playRecording(${rec.id})">
                            ‚ñ∂Ô∏è
                        </button>
                        <button class="btn" onclick="downloadRecording(${rec.id})">
                            ‚¨áÔ∏è
                        </button>
                        <button class="btn" onclick="shareRecording(${rec.id})">
                            üì§
                        </button>
                        <button class="btn" onclick="deleteRecording(${rec.id})">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function playRecording(id) {
            const recording = recordings.find(r => r.id === id);
            if (recording) {
                const url = URL.createObjectURL(recording.blob);
                window.open(url, '_blank');
            }
        }
        
        function downloadRecording(id) {
            const recording = recordings.find(r => r.id === id);
            if (recording) {
                const url = URL.createObjectURL(recording.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = recording.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }
        }
        
        function shareRecording(id) {
            const recording = recordings.find(r => r.id === id);
            if (recording) {
                const text = encodeURIComponent(`Video registrato: ${recording.filename}`);
                window.open(`https://wa.me/393713708294?text=${text}`, '_blank');
            }
        }
        
        function deleteRecording(id) {
            if (confirm('Eliminare questo video?')) {
                recordings = recordings.filter(r => r.id !== id);
                updateRecordingsList();
                updateDashboard();
            }
        }
        
        // ============================================
        // UPLOAD VIDEO
        // ============================================
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('video/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const blob = new Blob([event.target.result], { type: file.type });
                    
                    const recording = {
                        id: Date.now(),
                        filename: file.name,
                        blob: blob,
                        size: file.size,
                        date: new Date().toLocaleString(),
                        duration: 0 // Non possiamo sapere la durata senza analisi
                    };
                    
                    recordings.unshift(recording);
                    updateRecordingsList();
                    updateDashboard();
                    
                    alert('Video caricato con successo!');
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('Seleziona un file video valido');
            }
            
            // Reset input
            fileInput.value = '';
        });
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#fbbf24';
            uploadArea.style.background = 'rgba(251, 191, 36, 0.1)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = 'var(--border)';
            uploadArea.style.background = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--border)';
            uploadArea.style.background = '';
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const blob = new Blob([event.target.result], { type: file.type });
                    
                    const recording = {
                        id: Date.now(),
                        filename: file.name,
                        blob: blob,
                        size: file.size,
                        date: new Date().toLocaleString(),
                        duration: 0
                    };
                    
                    recordings.unshift(recording);
                    updateRecordingsList();
                    updateDashboard();
                    
                    alert('Video caricato con successo!');
                };
                reader.readAsArrayBuffer(file);
            }
        });
        
        // ============================================
        // DASHBOARD
        // ============================================
        function updateDashboard() {
            document.getElementById('totalVideos').textContent = recordings.length;
            
            const totalDuration = recordings.reduce((sum, rec) => sum + rec.duration, 0);
            document.getElementById('totalDuration').textContent = `${totalDuration}s`;
            
            if (recordings.length > 0) {
                const last = recordings[0];
                document.getElementById('lastRecording').textContent = 
                    `${last.duration}s - ${last.date.split(' ')[0]}`;
            } else {
                document.getElementById('lastRecording').textContent = '-';
            }
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        startCameraBtn.addEventListener('click', async () => {
            const success = await startCamera();
            if (success) {
                getCameraDevices();
            }
        });
        
        cameraSelect
