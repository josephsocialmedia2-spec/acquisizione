<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Video Creator ‚Äì Teleprompter (MERGE B+ A)</title>

  <style>
    :root{
      /* === BASE B === */
      --bg:#0b6b3a;
      --text:#f3f4f6;
      --muted:#a0adb8;
      --gold:#ffd400;
      --border: rgba(225,225,225,0.18);
      --shadow: 0 14px 50px rgba(0,0,0,0.45);
      --radius: 18px;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      --tele-font: 26px;
      --tele-line: 1.45;
      --stage-w: min(420px, 92vw);
      --zoom: 1;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(216,162,58,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(123,79,189,.14), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(74,143,114,.14), transparent 55%),
        var(--bg);
    }

    .wrap{ max-width:1150px; margin:0 auto; padding:14px 12px 84px; }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:950;
      letter-spacing:.2px;
      font-size:11px;
      line-height:1;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      position:relative;
      transform: translateY(0) scale(1);
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease, border-color .14s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .btn:hover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(216,162,58,.22);
      box-shadow: 0 14px 34px rgba(0,0,0,.30);
      filter: brightness(1.06);
    }
    .btn:active{ transform: translateY(0px) scale(.99); filter: brightness(0.98); }
    .btn.tiny{ padding:6px 9px; font-size:10px; border-radius:11px; box-shadow:none; }

    .btn.primary{
      background: linear-gradient(135deg, rgba(255,212,0,.98), rgba(255,212,0,.78));
      color:#141414;
      border-color: rgba(255,212,0,.65);
    }
    .btn.blue{ background: linear-gradient(135deg, rgba(57,90,140,.95), rgba(57,90,140,.70)); border-color: rgba(57,90,140,.55); }
    .btn.violet{ background: linear-gradient(135deg, rgba(123,79,189,.95), rgba(123,79,189,.70)); border-color: rgba(123,79,189,.55); }
    .btn.gray{ background: rgba(255,255,255,.04); }

    .btn.green{
      background: linear-gradient(135deg, rgba(37,211,102,.95), rgba(37,211,102,.70));
      border-color: rgba(37,211,102,.55);
      color:#08140c;
      font-weight: 1000;
    }

    .btn.rec{
      background: linear-gradient(135deg, rgba(255,45,45,.95), rgba(255,45,45,.55));
      border-color: rgba(255,45,45,.55);
      color:#120707;
      font-weight: 1000;
    }
    .btn.rec .dot{
      width:10px; height:10px; border-radius:999px;
      background:#ff2d2d;
      box-shadow: 0 0 0 0 rgba(255,45,45,.45);
      animation: pulseDot 1.15s ease-in-out infinite;
    }
    @keyframes pulseDot{
      0%{ box-shadow: 0 0 0 0 rgba(255,45,45,.45); transform: scale(1); }
      60%{ box-shadow: 0 0 0 10px rgba(255,45,45,0); transform: scale(1.06); }
      100%{ box-shadow: 0 0 0 0 rgba(255,45,45,0); transform: scale(1); }
    }

    .pill{
      font-size:10px;
      color:var(--muted);
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      font-weight:900;
      letter-spacing:.2px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    .hintTop{
      margin: 6px 0 10px;
      font-size:11px;
      color: var(--muted);
      line-height: 1.35;
    }

    .layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:12px;
      align-items:start;
      margin-top:12px;
    }
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .section{ padding:12px; }
    .section + .section{ border-top:1px solid rgba(255,255,255,.10); }

    .h{
      margin:0 0 8px;
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.8px;
      font-weight:950;
    }

    .bar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center; }
    .bar.left{ justify-content:flex-start; }
    .bar.between{ justify-content:space-between; }

    .field textarea, .field input, .field select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:850;
      resize: vertical;
      font-size:12px;
      line-height:1.25;
    }
    .field textarea{ min-height: 120px; }
    .field textarea:focus, .field input:focus, .field select:focus{
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    .mini{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px;
    }

    .stageRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){ .stageRow{ grid-template-columns:1fr; } }

    .stageBlock{
      width: var(--stage-w);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      align-items:stretch;
    }

    #stage916{
      width: 100%;
      aspect-ratio: 9 / 16;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      overflow: hidden;
      position: relative;
      background:#000;
      box-shadow: var(--shadow);
    }

    #cam{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scale(var(--zoom));
      transform-origin: center;
    }

    #overlay{
      position:absolute;
      inset:0;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      pointer-events:none;
      z-index: 2;
    }

    #questionBoxOverlay{
      font-size: 11px;
      font-weight: 950;
      line-height: 1.15;
      padding: 7px 9px;
      border-radius: 12px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(6px);
      white-space:pre-wrap;
    }

    #teleprompterOverlay{
      flex: 1;
      position: relative;
      overflow: hidden;
      border-radius: 12px;
    }

    #teleText{
      position:absolute;
      left:0; right:0;
      white-space: pre-wrap;
      font-size: var(--tele-font);
      line-height: var(--tele-line);
      font-weight: 800;
      color: rgba(243,244,246,.94);
      text-shadow: 0 2px 12px rgba(0,0,0,.75);
      transform: translateY(20px);
      padding: 24px;
    }

    /* keyword emphasis */
    .tele-strong{
      color: #ffd166;
      font-weight: 900;
    }

    .controlsRow{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }

    .sliderRow{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:10px;
      font-weight:950;
      flex-wrap:wrap;
      justify-content:center;
    }
    input[type="range"]{ width:170px; accent-color: var(--gold); }

    .chk{
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      color:var(--muted);
      font-weight:950;
      font-size:10px;
      white-space:nowrap;
    }
    .check{ width:16px; height:16px; accent-color: var(--gold); cursor:pointer; }

    /* Profili piccoli */
    .profiles{
      display:grid;
      grid-template-columns: 1fr;
      gap:7px;
      margin-top:8px;
    }
    .profileRow{
      display:flex;
      gap:8px;
      align-items:center;
      padding:7px 8px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      background:rgba(0,0,0,.14);
    }
    .profileMeta{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      flex:1;
    }
    .profileMeta b{
      font-size:11px;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .nextBadge{
      font-size:9px;
      font-weight:1000;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(255,45,45,.55);
      color: rgba(255,235,235,.95);
      background: rgba(255,45,45,.18);
      white-space:nowrap;
      display:none;
      pointer-events:none;
      user-select:none;
    }
    .nextBadge.show{ display:inline-flex; }

    #recLamp{
      position:absolute; top:12px; right:12px;
      padding:7px 9px; border-radius:12px;
      background:rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.18);
      font-weight:950; font-size:11px;
      display:none; align-items:center; gap:8px;
      backdrop-filter: blur(6px);
      z-index: 6;
    }

    /* Bottom bar */
    .bottomBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px;
      background: rgba(0,0,0,.35);
      border-top: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      display:flex;
      justify-content:flex-end;
      z-index: 50;
      gap:8px;
      flex-wrap:wrap;
    }

    /* ==========================
       MODALIT√Ä SIMPLE / PRO (B)
    ========================== */
    .proOnly{ display:block; }
    .simpleOnly{ display:none; }
    body.modeSimple .proOnly{ display:none !important; }
    body.modeSimple .simpleOnly{ display:block !important; }

    body.modeSimple header{ display:none !important; }
    body.modeSimple #promptDetails{ display:none !important; }
    body.modeSimple .hintTop{ display:none !important; }
    body.modeSimple .card.simpleOnly{ display:none !important; } /* (B: rigid minimal) */
    body.modeSimple #recList{ max-height:200px; }

    /* B: hide some buttons in simple */
    body.modeSimple #btnOpenChatGPTPasteQ,
    body.modeSimple #btnPasteTop,
    body.modeSimple #btnSendTele,
    body.modeSimple #btnCopyCaption{ display:none !important; }

    /* B: hide answerBox visually (storage only) */
    #answerBox{ display:none !important; }

    /* Wizard */
    .wizard{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-start; }
    .wizStep{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight:1000;
      font-size:11px;
      color: rgba(243,244,246,.88);
      user-select:none;
    }
    .wizStep.active{
      border-color: rgba(216,162,58,.55);
      box-shadow: 0 0 0 6px rgba(216,162,58,.10);
      background: rgba(216,162,58,.12);
      color: rgba(255,255,255,.98);
    }
    .wizStep.done{ border-color: rgba(37,211,102,.45); background: rgba(37,211,102,.10); }

    #toast{
      position: fixed;
      left: 50%;
      bottom: 84px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      color: rgba(243,244,246,.98);
      font-weight: 950;
      font-size: 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display:none;
      z-index: 2000;
      max-width: min(560px, 92vw);
      text-align:center;
    }

    /* Countdown pill */
    #countdownPill{
      border-color: rgba(255,255,255,.18);
      background: rgba(0,0,0,.24);
      font-weight: 1000;
      min-width:120px;
      justify-content:center;
    }
    body.isRecording #countdownPill{
      border-color: rgba(255,59,48,.55);
      background: rgba(255,59,48,.12);
    }

    /* Prompt accordion */
    details{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(0,0,0,.14);
      padding:10px;
    }
    summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      font-weight:950;
      color: var(--text);
      font-size:11px;
    }
    summary::-webkit-details-marker{ display:none; }
    .subtle{ font-size:11px; color: var(--muted); line-height:1.35; margin-top:6px; }
    .codeRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .codeRow input{
      flex:1;
      min-width: 160px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:900;
      font-size:12px;
    }
    .codeRow input:focus{
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    /* ==========================
       MODAL ISTRUZIONI (B)
    ========================== */
    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 14px;
    }
    .modalBackdrop.show{ display:flex; }
    .modalCard{
      width: min(920px, 96vw);
      max-height: min(82vh, 760px);
      overflow: auto;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      position: sticky;
      top: 0;
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(8px);
      z-index: 2;
    }
    .modalHeader .title{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .modalBody{
      padding: 12px;
      color: rgba(243,244,246,.95);
      font-size: 12px;
      line-height: 1.35;
    }
    .modalBody h3{
      margin: 12px 0 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing:.8px;
      color: var(--muted);
    }
    .modalBody ol, .modalBody ul{ margin: 8px 0 10px 18px; padding: 0; }
    .modalBody li{ margin: 6px 0; }
    .callout{
      border: 1px solid rgba(216,162,58,.25);
      background: rgba(216,162,58,.10);
      border-radius: 14px;
      padding: 10px 12px;
      margin: 10px 0;
      color: rgba(243,244,246,.96);
    }
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(243,244,246,.92);
      white-space: nowrap;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- ARCHIVIO CSV (B) -->
  <div class="card" id="archiveCard" style="margin-top:14px;">
    <div class="section">
      <div class="bar between" style="width:100%; gap:10px; flex-wrap:wrap;">
        <div class="bar left" style="gap:10px; flex-wrap:wrap;">
          <label class="btn gray" style="cursor:pointer;">
            <span class="ico">üìÅ</span> Carica archivio CSV
            <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none">
          </label>

          <button class="btn blue" id="btnGenerateQuestion" type="button">
            <span class="ico">üé≤</span> Genera domanda
          </button>
        </div>

        <div class="bar left" style="gap:10px; flex:1; min-width:260px; flex-wrap:wrap;">
          <select id="questionSelect" style="min-width:260px; flex:1; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:var(--text); font-weight:850;">
            <option value="">Seleziona una domanda‚Ä¶</option>
          </select>
          <span class="pill" id="archiveCountPill">Archivio: 0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- TOP ROW (B) -->
  <header>
    <div class="row" style="flex:1;">
      <button class="btn primary" id="btnNext" type="button"><span class="ico">‚ú®</span> Nuova domanda</button>

      <button class="btn blue" id="btnOpenChatGPTPasteQ" type="button" title="Copia PROMPT + domanda e apre ChatGPT">
        <span class="ico">üí¨</span> Apri ChatGPT + copia domanda
      </button>

      <button class="btn violet" id="btnPasteTop" type="button" title="Incolla dagli appunti nel blocco risposta">
        <span class="ico">üìã</span> Incolla risposta
      </button>

      <button class="btn gray proOnly" id="btnInstructions" type="button" title="Apri guida operativa">
        <span class="ico">üìò</span> Istruzioni
      </button>

      <span class="pill" style="gap:10px;">
        <span style="display:inline-flex;align-items:center;gap:8px;">
          <span style="font-weight:1000;font-size:10px;color:var(--muted);">Modalit√†</span>
          <button class="btn tiny primary" id="btnModeSimple" type="button" title="Interfaccia semplificata">Semplice</button>
          <button class="btn tiny gray" id="btnModePro" type="button" title="Mostra tutte le impostazioni">Pro</button>
        </span>
      </span>

      <span class="pill">
        <span id="videoCounter">Video: 0</span>
        <span>‚Ä¢</span>
        <span id="activeProfileLabel">Prossimo: ‚Äî</span>
      </span>
    </div>

    <div class="row">
      <button class="btn tiny gray" id="btnBackTop" type="button">‚Üê Gestionale</button>
    </div>
  </header>

  <div class="hintTop proOnly">
    1) <b>Nuova domanda</b> ‚Üí 2) <b>Apri ChatGPT + copia domanda</b> ‚Üí 3) copia risposta ‚Üí 4) <b>Incolla risposta</b> ‚Üí 5) <b>Invia al teleprompter</b> ‚Üí 6) <b>Teleprompter + REC</b>
  </div>

  <!-- Wizard (B) -->
  <div class="card simpleOnly" style="margin-top:10px;">
    <div class="section" style="padding:10px 12px;">
      <div class="wizard">
        <div class="wizStep" data-step="1">1) Domanda</div>
        <div class="wizStep" data-step="2">2) ChatGPT</div>
        <div class="wizStep" data-step="3">3) Incolla</div>
        <div class="wizStep" data-step="4">4) Teleprompter</div>
        <div class="wizStep" data-step="5">5) REC</div>
        <div class="wizStep" data-step="6">6) Scarica / WhatsApp</div>
      </div>
      <div class="subtle" id="wizardHint" style="margin-top:8px;">Premi <b>Nuova domanda</b> per iniziare.</div>
    </div>
  </div>

  <!-- BLOCCO RISPOSTA (answerBox nascosto via CSS, ma serve come storage compatibile) -->
  <div class="card">
    <div class="section">
      <p class="h">Risposta (storage)</p>

      <div class="field">
        <textarea id="answerBox" placeholder="Risposta‚Ä¶"></textarea>
      </div>

      <div class="field" style="margin-top:10px;">
        <p style="margin:0 0 6px; opacity:.85;"><b>Testo libero (opzionale)</b> ‚Äî per video senza domanda</p>
        <input id="freeTextBox" type="text" placeholder="Scrivi qui un testo libero‚Ä¶" />
      </div>

      <div class="bar left" style="margin-top:10px;">
        <button class="btn primary proOnly" id="btnSendTele" type="button"><span class="ico">‚û°Ô∏è</span> Invia al teleprompter</button>
        <button class="btn gray proOnly" id="btnCopyCaption" type="button" title="Copia caption con hashtag (se non gi√† presenti)">
          <span class="ico">üìã</span> Copia caption
        </button>
        <button class="btn green" id="btnWhatsApp" type="button" title="Invia la caption completa su WhatsApp">
          <span class="ico">üü¢</span> Invia WhatsApp
        </button>
      </div>

      <div class="subtle proOnly">
        ‚ÄúInvia al teleprompter‚Äù aggiorna anche caption e testo del teleprompter.
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- MAIN -->
    <div class="card">
      <div class="section">
        <p class="h">Video 9:16 + teleprompter</p>

        <div class="stageRow">
          <div class="stageBlock">
            <div id="stage916">
              <video id="cam" autoplay playsinline muted></video>

              <div id="recLamp">
                <span style="width:10px;height:10px;border-radius:999px;background:#ff2d2d;display:inline-block;"></span>
                <span id="recTime">REC 00:00</span>
              </div>

              <div id="overlay">
                <div id="questionBoxOverlay">Premi ‚ÄúNuova domanda‚Äù.</div>
                <div id="teleprompterOverlay">
                  <div id="teleText">Incolla/scrivi una risposta ‚Üí ‚ÄúInvia al teleprompter‚Äù ‚Üí ‚ÄúTeleprompter + REC‚Äù.</div>
                </div>
              </div>
            </div>

            <div class="controlsRow">
              <div class="bar between" style="width:100%;">
                <div class="bar left" style="justify-content:flex-start;">
                  <button class="btn rec" id="btnTeleRec" type="button" title="Avvia teleprompter e registrazione">
                    <span class="dot"></span> Teleprompter + REC
                  </button>
                  <span class="pill" id="countdownPill">‚è±Ô∏è 120</span>
                  <button class="btn gray" id="btnCam" type="button"><span class="ico">üì∑</span> Camera</button>
                </div>

                <div class="bar" style="justify-content:center;">
                  <button class="btn gray" id="btnStop" type="button"><span class="ico">‚èπ</span> Stop</button>
                  <button class="btn gray proOnly" id="btnRestart" type="button"><span class="ico">‚Üª</span> Riavvia</button>
                </div>
              </div>

              <div class="bar proOnly">
                <label class="chk"><input class="check" type="checkbox" id="speed120"> 120</label>
                <label class="chk"><input class="check" type="checkbox" id="speed105" checked> 105</label>
                <label class="chk"><input class="check" type="checkbox" id="speed90"> 90</label>
                <span class="pill" id="speedLabel">Vel: 105s</span>
              </div>

              <div class="sliderRow proOnly">
                <span>Zoom</span>
                <input id="zoom" type="range" min="1" max="2.5" step="0.1" value="1" />
                <span id="zoomVal">1.0x</span>
              </div>
            </div>
          </div>

          <div class="proOnly">
            <p class="h">Rotazione profili (piccola)</p>
            <div class="profiles">
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_tiktok" checked>
                <div class="profileMeta"><b>üì± TikTok</b></div>
                <span class="nextBadge" id="badge_tiktok">PROSSIMO</span>
              </div>
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_instagram" checked>
                <div class="profileMeta"><b>üì∏ Instagram</b></div>
                <span class="nextBadge" id="badge_instagram">PROSSIMO</span>
              </div>
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_shorts">
                <div class="profileMeta"><b>üé• Shorts</b></div>
                <span class="nextBadge" id="badge_shorts">PROSSIMO</span>
              </div>
              <div class="profileRow">
                <input class="check" type="checkbox" id="rot_facebook">
                <div class="profileMeta"><b>üíº Facebook</b></div>
                <span class="nextBadge" id="badge_facebook">PROSSIMO</span>
              </div>
            </div>
            <div class="subtle">‚ÄúPROSSIMO‚Äù √® solo indicatore.</div>
          </div>
        </div>

        <canvas id="recCanvas" width="1080" height="1920" style="display:none;"></canvas>
      </div>
    </div>

    <!-- SIDE -->
    <div class="card">
      <!-- A feature preserved: remember caption clean + preview -->
      <div class="section">
        <div class="bar between">
          <p class="h" style="margin:0;">Caption (memorizzata)</p>
          <label class="chk" title="Memorizza la caption pulita per il prossimo avvio">
            <input type="checkbox" id="chkRememberCaption" class="check" checked />
            Memorizza
          </label>
        </div>

        <div class="mini" id="captionPreview" style="margin-top:10px;">‚Äî</div>
        <div class="subtle">Gli hashtag automatici vengono aggiunti solo in copia/WhatsApp (se mancanti).</div>
      </div>

      <div class="section">
        <p class="h">Video creati</p>
        <div class="subtle">Seleziona un elemento per rivederlo.</div>

        <video id="playback" controls style="width:100%; border-radius:14px; background:#000; margin-top:10px;"></video>

        <div class="bar left" style="margin-top:10px;">
          <button class="btn" id="btnDownloadVideo" type="button"><span class="ico">üì•</span> Scarica video</button>

          <input id="videoUpload" type="file" accept="video/*" style="display:none;" />
          <button class="btn proOnly" id="btnUploadVideo" type="button" title="Carica un video e aggiungilo alla lista">
            <span class="ico">‚¨ÜÔ∏è</span> Carica video
          </button>

          <button class="btn tiny gray proOnly" id="btnClearList" type="button">üóëÔ∏è Svuota</button>
        </div>

        <!-- Caption completa (B) -->
        <div class="card" id="captionCard" style="margin-top:14px;">
          <div class="section">
            <p class="h">Caption (Domanda + Risposta)</p>
            <textarea id="captionBox" rows="4" readonly style="width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:var(--text); outline:none; font-weight:850; resize: vertical; min-height: 120px; font-size:12px; line-height:1.25;"></textarea>

            <div class="field" style="margin-top:10px;">
              <p style="margin:0 0 6px; opacity:.85;"><b>Hashtag (opzionale)</b></p>
              <textarea id="hashtagsBox" rows="2" placeholder="#hashtag1 #hashtag2" style="min-height:70px;"></textarea>
            </div>

            <div class="bar left" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
              <button class="btn gray" id="btnCopyCaption2" type="button"><span class="ico">üìã</span> Copia caption</button>
            </div>
          </div>
        </div>

        <div id="recList" style="margin-top:10px; max-height:260px; overflow:auto;">‚Äî</div>
      </div>

      <!-- PROMPT (B) -->
      <div class="section">
        <details id="promptDetails" class="proOnly">
          <summary>
            <span>üß† Prompt ChatGPT (clicca per aprire)</span>
            <span class="pill" id="promptStatePill">Bloccato</span>
          </summary>

          <div class="subtle">
            Questo prompt viene sempre inserito <b>prima</b> della domanda quando premi ‚ÄúApri ChatGPT + copia domanda‚Äù.
          </div>

          <div class="field" style="margin-top:10px;">
            <textarea id="promptBox" readonly></textarea>
          </div>

          <div class="codeRow">
            <input id="unlockCode" placeholder="Codice per modificare il prompt" />
            <button class="btn tiny primary" id="btnUnlock" type="button">Sblocca</button>
            <button class="btn tiny" id="btnSavePrompt" type="button" disabled>Salva</button>
            <button class="btn tiny" id="btnResetPrompt" type="button" disabled>Ripristina</button>
          </div>

          <div class="subtle">Per modificare serve il codice: <b>16091979Jm</b>.</div>
        </details>
      </div>
    </div>
  </div>
</div>

<!-- Bottom bar -->
<div class="bottomBar">
  <button class="btn tiny gray" id="btnBackBottom" type="button">‚Üê Gestionale</button>
  <button class="btn tiny gray" id="btnInstructionsBottom" type="button"><span class="ico">üìò</span> Istruzioni</button>
</div>

<!-- MODAL ISTRUZIONI -->
<div class="modalBackdrop" id="instructionsModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="instrTitle">
    <div class="modalHeader">
      <div class="title" id="instrTitle">üìò Istruzioni operative ‚Äì Video Creator</div>
      <button class="btn tiny gray" id="btnCloseInstructions" type="button">‚úï Chiudi</button>
    </div>

    <div class="modalBody">
      <div class="callout">
        Obiettivo: creare video verticali <b>9:16</b> in serie con <b>domanda ‚Üí risposta ‚Üí teleprompter ‚Üí REC ‚Üí caption ‚Üí download</b>.
      </div>

      <h3>Flusso standard</h3>
      <ol>
        <li><b>Nuova domanda</b> ‚Üí <span class="kbd">‚ú® Nuova domanda</span></li>
        <li><b>ChatGPT</b> ‚Üí <span class="kbd">üí¨ Apri ChatGPT + copia domanda</span> (incolla e invia)</li>
        <li><b>Incolla risposta</b> ‚Üí <span class="kbd">üìã Incolla risposta</span></li>
        <li><b>Invia al teleprompter</b> ‚Üí <span class="kbd">‚û°Ô∏è Invia al teleprompter</span></li>
        <li><b>Registra</b> ‚Üí <span class="kbd">üî¥ Teleprompter + REC</span> (stop automatico a fine countdown)</li>
        <li><b>Stop</b> ‚Üí <span class="kbd">‚èπ Stop</span></li>
        <li><b>Scarica</b> ‚Üí <span class="kbd">üì• Scarica video</span> e/o <span class="kbd">üü¢ WhatsApp</span></li>
      </ol>

      <div class="subtle">Tip: premi <span class="kbd">ESC</span> per chiudere.</div>
    </div>
  </div>
</div>

<div id="toast">‚Äî</div>

<script>
/* ==========================
   CONFIG
========================== */
const GESTIONALE_URL = "https://tuo-gestionale.com";
const WHATSAPP_NUMBER = "39XXXXXXXXXXX"; // es: "393713708294"
const CHATGPT_URL = "https://chatgpt.com/";

/* Hashtag base (A/B) */
const HIDDEN_HASHTAGS = [
  "#immobiliarelasacra","#josephcretorlab","#realmediapro","#amamy","#immobiliare","#realestateitalia",
  "#mercatoimmobiliare","#agenziaimmobiliare","#casainvendita","#venditacasa","#investimentiimmobiliari",
  "#property","#realestate","#digitalstrategist","#digitalstrategy","#marketingdigitale","#strategiamarketing",
  "#brandstrategy","#contentstrategy","#socialmediastrategy","#growthmarketing","#personalbranding","#branding",
  "#businessdigitale","#marketingonline"
].join(" ");

/* Prompt base (B) */
const BASE_PROMPT = `üß© PROMPT ADATTIVO ‚Äì VERSIONE FINALE (250 PAROLE + HASHTAG)

Agisci come un consulente immobiliare esperto, con uno stile friendly, chiaro e professionale, adatto anche a un ragazzo di 15 anni.
Rispondi con testi di massimo 250 parole, semplici e concreti.
Struttura: problema ‚Üí spiegazione con esempi ‚Üí conclusione con consiglio.
Alla fine aggiungi hashtag pertinenti + la lista base.
Regole: max 250 parole, niente tecnicismi inutili.`;

/* Codice sblocco prompt */
const UNLOCK_CODE = "16091979Jm";

/* Fallback domande */
const QUESTION_BANK = [
  { q:"Perch√© ricevo poche chiamate anche se l'annuncio √® online da settimane?" },
  { q:"Se arrivano solo curiosi e nessuna proposta, cosa significa?" },
  { q:"Come capisco se il prezzo sta bloccando la vendita?" },
  { q:"Meglio partire alto e poi scendere o partire subito con il prezzo giusto?" },
  { q:"Ha senso provare a vendere da privato oppure rischio solo di perdere tempo?" },
];

/* Teleprompter speed */
const TELE_SPEEDS = { s120:120, s105:105, s90:90 };
let teleprompterSeconds = TELE_SPEEDS.s105;

/* ==========================
   STATE
========================== */
const $ = (id) => document.getElementById(id);

let qIdx = -1;
let currentQuestion = "";
let totalVideos = 0;
let rotationIndex = 0;
let promptText = "";

let ARCHIVIO = [];        // [{id, area, domanda, risposta}]
let currentItem = null;

let lastCaptionClean = "";

let startTimeSec = null;
let isTeleprompterRunning = false;
let teleprompterAnimationId = null;

let camStream = null;
let chunks = [];
let rafCanvasId = null;

let zoomValue = 1.0;
let recorder = null;
let recStartTs = null;
let recTimerId = null;

let countdownTimer = null;
let countdownRemaining = 120;

let recordings = [];
let currentRecIndex = -1;

/* ==========================
   HELPERS
========================== */
function pad2(n){ return String(n).padStart(2,"0"); }
function nowStamp(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}-${pad2(d.getHours())}-${pad2(d.getMinutes())}-${pad2(d.getSeconds())}`;
}
function slugify(it){
  return String(it || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s-]/g,"")
    .trim()
    .replace(/\s+/g,"-")
    .replace(/-+/g,"-")
    .slice(0, 50);
}
function keywordsFromQuestion(q){
  const stop = new Set(["perche","perch√©","che","cosa","come","se","e","o","il","lo","la","i","gli","le","un","una","da","di","del","della","delle","dei","dello","in","su","a","al","alla","alle","agli","ai","con","senza","poi","subito","solo","nessuna","nessun","meglio","ha","senso","dopo","non","piu","pi√π","anche"]);
  const words = slugify(q).split("-").filter(w => w && !stop.has(w));
  return words.slice(0, 4).join("-") || "video";
}

async function copyText(text){
  const t = String(text || "");
  if(!t.trim()) return false;
  try{ await navigator.clipboard.writeText(t); return true; }
  catch(e){
    const ta = document.createElement("textarea");
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    return true;
  }
}
async function readClipboardText(){
  return await navigator.clipboard.readText();
}
function showToast(msg, ms=1600){
  const el = $("toast");
  if(!el) return;
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>{ el.style.display="none"; }, ms);
}

function captionWithHashtagsIfNeeded(clean){
  const c = String(clean || "").trim();
  if(!c) return "";
  const lower = c.toLowerCase();
  if (lower.includes("#immobiliarelasacra") || lower.includes("#josephcretorlab") || lower.includes("#realmediapro")){
    return c;
  }
  return `${c}\n\n${HIDDEN_HASHTAGS}`.trim();
}

/* A feature preserved: remember caption clean */
function setCaptionClean(clean){
  lastCaptionClean = String(clean || "").trim();
  $("captionPreview").textContent = lastCaptionClean || "‚Äî";
  if ($("chkRememberCaption").checked){
    try{ localStorage.setItem("vc_caption_clean", lastCaptionClean); }catch(e){}
  }
}
function loadCaptionClean(){
  try{
    const c = localStorage.getItem("vc_caption_clean");
    if(c && c.trim()){
      lastCaptionClean = c.trim();
      $("captionPreview").textContent = lastCaptionClean;
    }
  }catch(e){}
}

/* ==========================
   CSV (B)
========================== */
function normalizeHeader(h){ return String(h||"").trim().toLowerCase(); }
function detectDelimiter(text){
  const firstLine = String(text || "").split(/\r?\n/)[0] || "";
  const commas = (firstLine.match(/,/g) || []).length;
  const semis  = (firstLine.match(/;/g) || []).length;
  return semis > commas ? ";" : ",";
}
function parseCSV(text){
  const delim = detectDelimiter(text);
  const rows = [];
  let row = [], cell = "", inQuotes = false;

  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const next = text[i+1];

    if(ch === '"'){
      if(inQuotes && next === '"'){ cell += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if(ch === delim && !inQuotes){
      row.push(cell); cell = "";
    } else if((ch === "\n" || ch === "\r") && !inQuotes){
      if(ch === "\r" && next === "\n") i++;
      row.push(cell); cell = "";
      if(row.some(v => String(v).trim().length)) rows.push(row);
      row = [];
    } else {
      cell += ch;
    }
  }
  if(cell.length || row.length){
    row.push(cell);
    if(row.some(v => String(v).trim().length)) rows.push(row);
  }
  return rows;
}
function refreshArchiveUI(){
  const sel = $("questionSelect");
  sel.innerHTML = '<option value="">Seleziona una domanda‚Ä¶</option>';
  ARCHIVIO.forEach((it, i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = it.area ? `[${it.area}] ${it.domanda}` : it.domanda;
    sel.appendChild(opt);
  });
  $("archiveCountPill").textContent = `Archivio: ${ARCHIVIO.length}`;
}
function loadArchiveFromCSV(csvText){
  const rows = parseCSV(csvText);
  if(!rows.length) return { ok:false, err:"CSV vuoto" };

  const headers = rows[0].map(normalizeHeader);
  const idxDom = headers.findIndex(h => ["domanda","question","q"].includes(h));
  const idxRis = headers.findIndex(h => ["risposta","answer","a"].includes(h));
  const idxArea = headers.findIndex(h => ["area","categoria","category"].includes(h));

  if(idxDom === -1) return { ok:false, err:"Manca la colonna 'domanda' (o 'question')" };
  if(idxRis === -1) return { ok:false, err:"Manca la colonna 'risposta' (o 'answer')" };

  const out = [];
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    const domanda = (r[idxDom]||"").trim();
    const risposta = (r[idxRis]||"").trim();
    const area = idxArea>-1 ? (r[idxArea]||"").trim() : "";
    if(!domanda || !risposta) continue;
    out.push({ id: out.length+1, area, domanda, risposta });
  }
  ARCHIVIO = out;
  refreshArchiveUI();
  return { ok:true, count: ARCHIVIO.length };
}
function pickRandomItem(){
  if(!ARCHIVIO.length) return null;
  if(ARCHIVIO.length === 1) return ARCHIVIO[0];
  let it = null;
  for(let k=0;k<10;k++){
    const cand = ARCHIVIO[Math.floor(Math.random()*ARCHIVIO.length)];
    if(!currentItem || cand !== currentItem){ it = cand; break; }
  }
  return it || ARCHIVIO[Math.floor(Math.random()*ARCHIVIO.length)];
}

/* ==========================
   MODE / WIZARD (B)
========================== */
function setMode(mode){
  const isSimple = mode === "simple";
  document.body.classList.toggle("modeSimple", isSimple);
  $("btnModeSimple").classList.toggle("primary", isSimple);
  $("btnModeSimple").classList.toggle("gray", !isSimple);
  $("btnModePro").classList.toggle("primary", !isSimple);
  $("btnModePro").classList.toggle("gray", isSimple);
  try{ localStorage.setItem("vc_mode", isSimple ? "simple" : "pro"); }catch(e){}
  if(document.body.classList.contains("modeSimple")){ window.__step = 5; }
  updateWizard();
}
function updateWizard(){
  const isSimple = document.body.classList.contains("modeSimple");
  if(!isSimple) return;

  const hasQ = !!String(currentQuestion||"").trim();
  const hasA = !!String(($("answerBox")?.value||"")).trim() || !!String($("freeTextBox")?.value||"").trim();
  const hasRec = recordings.length > 0;

  if(typeof window.__step === "undefined") window.__step = 1;
  const setStep = (n)=>{ window.__step = Math.max(1, Math.min(6, n)); };

  if(!hasQ) setStep(1);
  else if(hasQ && !hasA) setStep(2);
  else if(hasQ && hasA && !hasRec) setStep(5);
  else if(hasRec) setStep(6);

  const steps = Array.from(document.querySelectorAll(".wizStep"));
  steps.forEach(s=>{
    const n = Number(s.dataset.step||0);
    s.classList.toggle("active", n===window.__step);
    s.classList.toggle("done", n < window.__step);
  });

  $("wizardHint").innerHTML =
    window.__step===1 ? 'Premi <b>Nuova domanda</b> o scegli dal CSV.' :
    window.__step===2 ? 'Vai su <b>ChatGPT</b> e copia la risposta.' :
    window.__step===5 ? 'Premi <b>Teleprompter + REC</b>.' :
                        'Ora puoi <b>Scarica</b> e/o <b>WhatsApp</b>.';
}

/* ==========================
   PROMPT (B)
========================== */
function loadPrompt(){
  try{
    const saved = localStorage.getItem("vc_prompt_text");
    promptText = (saved && saved.trim()) ? saved : BASE_PROMPT;
  }catch(e){
    promptText = BASE_PROMPT;
  }
  $("promptBox").value = promptText;
}
function lockPromptUI(){
  $("promptBox").readOnly = true;
  $("btnSavePrompt").disabled = true;
  $("btnResetPrompt").disabled = true;
  $("promptStatePill").textContent = "Bloccato";
}
function unlockPromptUI(){
  $("promptBox").readOnly = false;
  $("btnSavePrompt").disabled = false;
  $("btnResetPrompt").disabled = false;
  $("promptStatePill").textContent = "Sbloccato";
}
function savePrompt(){
  promptText = $("promptBox").value || BASE_PROMPT;
  try{ localStorage.setItem("vc_prompt_text", promptText); }catch(e){}
}

/* ==========================
   QUESTIONS + CAPTION (B + A storage)
========================== */
function showQuestionInOverlay(q){ $("questionBoxOverlay").textContent = q ? q : "Premi ‚ÄúNuova domanda‚Äù."; }

function getFreeText(){ return String($("freeTextBox")?.value || "").trim(); }
function getHashtags(){ return String($("hashtagsBox")?.value || "").trim(); }

function buildCaptionFull(){
  const tags = getHashtags();
  const free = getFreeText();
  if(free){
    return (tags ? (free + "\n\n" + tags) : free).trim();
  }
  const q = String(currentItem?.domanda || currentQuestion || "").trim();
  const a = String(currentItem?.risposta || ($("answerBox")?.value||"")).trim();
  const parts = [];
  if(q) parts.push("Domanda: " + q);
  if(a) parts.push("Risposta: " + a);
  let txt = parts.join("\n");
  if(tags) txt = (txt ? (txt + "\n\n" + tags) : tags);
  return String(txt || "").trim();
}
function refreshCaptionBox(){
  const c = $("captionBox");
  if(c) c.value = buildCaptionFull();
  setCaptionClean(buildCaptionFull());
}

function highlightKeywordsHTML(text){
  const keywords = ["io","decido","responsabilit√†","prezzo","trattativa","mercato","scelte","intervengo","gestisco","proteggo"];
  let out = String(text||"");
  keywords.forEach(k=>{
    const re = new RegExp("\\b("+k+")\\b","gi");
    out = out.replace(re, '<span class="tele-strong">$1</span>');
  });
  return out;
}

function applyAnswer(answer){
  const a = String(answer || "").trim();
  if(!a) return false;
  // safe-ish: we only inject spans, no user HTML (we escape then re-inject highlight)
  const escaped = a.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  $("teleText").innerHTML = highlightKeywordsHTML(escaped);
  resetTeleprompter();
  stopTeleprompter();
  refreshCaptionBox();
  return true;
}

function setCurrentItem(it){
  currentItem = it;
  if(!it) return;
  currentQuestion = it.domanda;
  showQuestionInOverlay(currentQuestion);

  $("answerBox").value = it.risposta;
  applyAnswer(it.risposta);

  refreshCaptionBox();
  if(document.body.classList.contains("modeSimple")) window.__step = 5;
  updateWizard();
  showToast("Domanda pronta ‚úÖ", 1200);
}

function nextQuestion(){
  if(ARCHIVIO.length){
    const it = pickRandomItem();
    $("questionSelect").value = String(ARCHIVIO.indexOf(it));
    setCurrentItem(it);
    return;
  }
  qIdx = (qIdx + 1) % QUESTION_BANK.length;
  currentItem = null;
  currentQuestion = QUESTION_BANK[qIdx].q;
  showQuestionInOverlay(currentQuestion);
  updateWizard();
  showToast("Carica il CSV per avere anche le risposte üìÅ", 2200);
}

function composeChatGPTInput(){
  const q = String(currentQuestion || "").trim();
  const p = (promptText || BASE_PROMPT).trim();
  if(!q) return p;
  return `${p}\n\nInput:\nüëâ ${q}`.trim();
}

/* ==========================
   ROTAZIONE PROFILI (B)
========================== */
function getRotationPlatforms(){
  const items = [
    { id:"rot_tiktok", platform:"tiktok" },
    { id:"rot_instagram", platform:"instagram" },
    { id:"rot_shorts", platform:"shorts" },
    { id:"rot_facebook", platform:"facebook" },
  ];
  return items.filter(x => $(x.id).checked);
}
function setNextBadge(platform){
  const map = {
    tiktok: $("badge_tiktok"),
    instagram: $("badge_instagram"),
    shorts: $("badge_shorts"),
    facebook: $("badge_facebook"),
  };
  Object.values(map).forEach(el => el.classList.remove("show"));
  if(platform && map[platform]) map[platform].classList.add("show");
}
function getActivePlatform(){
  const list = getRotationPlatforms();
  if(list.length === 0) return null;
  rotationIndex = rotationIndex % list.length;
  return list[rotationIndex].platform;
}
function advancePlatform(){
  const list = getRotationPlatforms();
  if(list.length === 0) return;
  rotationIndex = (rotationIndex + 1) % list.length;
}
function refreshProfileUI(){
  const active = getActivePlatform();
  setNextBadge(active);
  $("activeProfileLabel").textContent = "Prossimo: " + (active ? active : "‚Äî");
}

/* ==========================
   TELEPROMPTER SCROLL (B)
========================== */
function resetTeleprompter(){ $("teleText").style.transform = "translateY(20px)"; }
function startTeleprompter(){
  if(isTeleprompterRunning) return;
  isTeleprompterRunning = true;
  startTimeSec = performance.now() / 1000;
  animateTele();
}
function stopTeleprompter(){
  isTeleprompterRunning = false;
  if(teleprompterAnimationId) cancelAnimationFrame(teleprompterAnimationId);
  teleprompterAnimationId = null;
}
function restartTeleprompter(){
  stopTeleprompter();
  resetTeleprompter();
  setTimeout(()=> startTeleprompter(), 120);
}
function animateTele(){
  if(!isTeleprompterRunning) return;

  const teleEl = $("teleText");
  const now = performance.now()/1000;
  const elapsed = now - startTimeSec;
  const progress = (elapsed % teleprompterSeconds) / teleprompterSeconds;

  const th = teleEl.scrollHeight || 900;
  const startY = 20;
  const endY = -th - 20;

  const y = startY + (endY - startY) * progress;
  teleEl.style.transform = `translateY(${y}px)`;

  teleprompterAnimationId = requestAnimationFrame(animateTele);
}

/* SPEED UI radio-like (B) */
function setSpeed(seconds){
  teleprompterSeconds = seconds;
  $("speedLabel").textContent = `Vel: ${seconds}s`;
  $("speed120").checked = seconds === 120;
  $("speed105").checked = seconds === 105;
  $("speed90").checked  = seconds === 90;

  // countdown resets to match speed group, but recording uses 120 in B; here we align to speed:
  countdownRemaining = seconds;
  renderCountdown();
}

/* ==========================
   CAMERA + REC (B)
========================== */
const camEl = $("cam");
const canvas = $("recCanvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

async function applyZoom(v){
  zoomValue = Number(v) || 1;
  $("zoomVal").textContent = `${zoomValue.toFixed(1)}x`;
  document.documentElement.style.setProperty("--zoom", String(zoomValue));
}

function drawFrame(){
  const W = canvas.width, H = canvas.height;
  if(camEl.readyState < 2){
    ctx.fillStyle="black"; ctx.fillRect(0,0,W,H);
    return;
  }
  const vw = camEl.videoWidth || 1280;
  const vh = camEl.videoHeight || 720;

  const z = Math.max(1, Math.min(zoomValue, 5));
  const srcW = vw / z;
  const srcH = vh / z;
  const srcX = (vw - srcW)/2;
  const srcY = (vh - srcH)/2;

  ctx.drawImage(camEl, srcX, srcY, srcW, srcH, 0, 0, W, H);
}
function startCanvasLoop(){
  function loop(){
    drawFrame();
    rafCanvasId = requestAnimationFrame(loop);
  }
  loop();
}

async function startCamera(){
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      audio:true,
      video:{ facingMode:"user", width:{ideal:1280}, height:{ideal:720} }
    });
    camEl.srcObject = camStream;
    await new Promise(res => camEl.onloadedmetadata = () => res());
    try{ await camEl.play(); }catch(e){}
    if(!rafCanvasId) startCanvasLoop();
    return true;
  }catch(err){
    alert("Errore camera: " + err.message);
    return false;
  }
}
async function ensureReady(){
  if(!camStream){
    const ok = await startCamera();
    if(!ok) return false;
  }
  if(!rafCanvasId) startCanvasLoop();
  return true;
}

/* REC lamp */
function fmtTime(ms){
  const sec = Math.floor(ms/1000);
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function startRecLamp(){
  recStartTs = Date.now();
  $("recLamp").style.display = "flex";
  $("recTime").textContent = "REC 00:00";
  recTimerId = setInterval(()=> {
    $("recTime").textContent = `REC ${fmtTime(Date.now()-recStartTs)}`;
  }, 250);
}
function stopRecLamp(){
  $("recLamp").style.display = "none";
  if(recTimerId) clearInterval(recTimerId);
  recTimerId = null;
  recStartTs = null;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

function renderCountdown(){
  $("countdownPill").textContent = `‚è±Ô∏è ${String(countdownRemaining).padStart(3,"0")}`;
}
function stopCountdown(){
  if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
  countdownRemaining = teleprompterSeconds;
  renderCountdown();
  document.body.classList.remove("isRecording");
}
function startCountdown(){
  stopCountdown();
  document.body.classList.add("isRecording");
  countdownRemaining = teleprompterSeconds;
  renderCountdown();
  countdownTimer = setInterval(()=>{
    countdownRemaining -= 1;
    if(countdownRemaining <= 0){
      countdownRemaining = 0;
      renderCountdown();
      stopRecording();
      stopCountdown();
      return;
    }
    renderCountdown();
  }, 1000);
}

/* Recordings */
function updateCounters(){ $("videoCounter").textContent = `Video: ${totalVideos}`; }

function renderRecList(){
  const box = $("recList");
  if(!recordings.length){ box.textContent = "‚Äî"; return; }

  box.innerHTML = recordings.map((r,i)=>{
    const active = i===currentRecIndex ? " style='color:#d8a23a; font-weight:950;'" : "";
    return `
      <div ${active} style="margin-bottom:10px;">
        <div>
          <a href="#" data-i="${i}" style="color:inherit; text-decoration:none;">
            ${r.title}
          </a>
        </div>
        <div style="opacity:.85; margin-top:6px;">${(r.question||"").slice(0,95)}</div>
      </div>
    `;
  }).join("");

  box.querySelectorAll("a[data-i]").forEach(a => a.addEventListener("click", (e)=>{
    e.preventDefault();
    const i = +a.dataset.i;
    currentRecIndex = i;
    $("playback").src = recordings[i].url;
    $("playback").play().catch(()=>{});
    renderRecList();
  }));
}

function buildTitleForRec(n, platform, q){
  const p = platform || "‚Äî";
  const k = keywordsFromQuestion(q||"");
  return `#${String(n).padStart(3,"0")} ‚Ä¢ ${p} ‚Ä¢ ${k}`;
}
function buildFileNameForRec(n, platform, q){
  const p = platform || "nop";
  const k = keywordsFromQuestion(q||"");
  return `video_${String(n).padStart(3,"0")}_${p}_${k}_${nowStamp()}.webm`;
}

function startRecording(){
  if(!camStream){ alert("Attiva la camera."); return; }
  const free = getFreeText();
  const a = String($("answerBox").value||"").trim();
  const useText = (free || a || currentItem?.risposta || "").trim();
  if(!useText){
    alert("Inserisci una risposta o un testo libero prima di REC.");
    return;
  }

  applyAnswer(useText);
  startTeleprompter();
  startCountdown();

  chunks = [];

  const stream = canvas.captureStream(30);
  const audioTrack = camStream.getAudioTracks?.()[0];
  if(audioTrack) stream.addTrack(audioTrack);

  const mimeCandidates = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  const mimeType = mimeCandidates.find(m => MediaRecorder.isTypeSupported(m)) || "";
  recorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

  recorder.ondataavailable = (e)=>{ if(e.data.size) chunks.push(e.data); };
  recorder.onstart = ()=>{ startRecLamp(); };

  recorder.onstop = ()=>{
    stopRecLamp();
    stopTeleprompter();
    stopCountdown();

    const blob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
    totalVideos += 1;

    const platformNow = getActivePlatform();
    const qNow = String(currentQuestion||"Senza domanda").trim();

    const url = URL.createObjectURL(blob);
    const title = buildTitleForRec(totalVideos, platformNow, qNow);
    const name  = buildFileNameForRec(totalVideos, platformNow, qNow);

    recordings.unshift({ title, name, url, blob, question: qNow });
    currentRecIndex = 0;

    $("playback").src = url;
    $("playback").load();
    renderRecList();
    updateCounters();
    updateWizard();

    advancePlatform();
    refreshProfileUI();

    showToast("Video salvato ‚úÖ", 1200);
  };

  recorder.start(1000);
}

function stopRecording(){
  if(recorder && recorder.state !== "inactive") recorder.stop();
}

/* Upload video (A/B) */
function addUploadedVideo(file){
  if(!file) return;
  const url = URL.createObjectURL(file);
  totalVideos += 1;

  const platformNow = getActivePlatform();
  const qNow = String(currentQuestion || "Upload video").trim();
  const title = `#${String(totalVideos).padStart(3,"0")} ‚Ä¢ ${(platformNow||"upload")} ‚Ä¢ ${keywordsFromQuestion(qNow)} ‚Ä¢ UPLOAD`;
  const safeName = (file.name && file.name.trim()) ? file.name.trim() : `upload_${nowStamp()}.mp4`;

  recordings.unshift({ title, name: safeName, url, blob: file, question: qNow });
  currentRecIndex = 0;
  $("playback").src = url;
  $("playback").load();
  renderRecList();
  updateCounters();
  updateWizard();
}

/* WhatsApp */
function buildWhatsAppMessage(){
  return captionWithHashtagsIfNeeded(buildCaptionFull());
}
function openWhatsApp(){
  const msg = buildWhatsAppMessage();
  if(!msg){ alert("Niente da inviare."); return; }
  if(!WHATSAPP_NUMBER || WHATSAPP_NUMBER.includes("X")){
    alert("Configura WHATSAPP_NUMBER in alto (es. 3937...).");
    return;
  }
  const url = `https://wa.me/${encodeURIComponent(WHATSAPP_NUMBER)}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank", "noopener");
}

/* ==========================
   MODAL ISTRUZIONI
========================== */
function openInstructions(){
  $("instructionsModal").classList.add("show");
  $("instructionsModal").setAttribute("aria-hidden","false");
}
function closeInstructions(){
  $("instructionsModal").classList.remove("show");
  $("instructionsModal").setAttribute("aria-hidden","true");
}

/* NAV */
function goToGestionale(){
  if(confirm("Vuoi tornare al gestionale?")){
    try{ stopRecording(); }catch(e){}
    setTimeout(()=> window.location.href = GESTIONALE_URL, 200);
  }
}

/* ==========================
   INIT
========================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  // Prompt
  loadPrompt();
  lockPromptUI();

  // Mode restore
  try{
    const m = localStorage.getItem("vc_mode");
    setMode(m === "pro" ? "pro" : "simple");
  }catch(e){
    setMode("simple");
  }

  // load remembered caption clean (A feature)
  loadCaptionClean();

  // default
  showQuestionInOverlay("Premi ‚ÄúNuova domanda‚Äù.");
  updateCounters();
  renderRecList();
  refreshProfileUI();
  applyZoom(1.0);

  // speed
  setSpeed(105);
  $("speed120").addEventListener("change", ()=> $("speed120").checked && setSpeed(120));
  $("speed105").addEventListener("change", ()=> $("speed105").checked && setSpeed(105));
  $("speed90").addEventListener("change",  ()=> $("speed90").checked  && setSpeed(90));

  // CSV
  $("csvFile").addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const res = loadArchiveFromCSV(txt);
      if(!res.ok){ alert(res.err); return; }
      showToast(`CSV caricato ‚úÖ (${res.count} righe)`, 1400);
      updateWizard();
    }catch(err){
      alert("Errore lettura CSV: " + err.message);
    }finally{
      e.target.value = "";
    }
  });
  $("questionSelect").addEventListener("change", (e)=>{
    const idx = Number(e.target.value);
    if(Number.isNaN(idx) || idx < 0 || idx >= ARCHIVIO.length) return;
    setCurrentItem(ARCHIVIO[idx]);
  });
  $("btnGenerateQuestion").addEventListener("click", ()=>{
    if(!ARCHIVIO.length){ showToast("Carica un CSV prima üìÅ", 1200); return; }
    const it = pickRandomItem();
    $("questionSelect").value = String(ARCHIVIO.indexOf(it));
    setCurrentItem(it);
  });

  // top actions
  $("btnNext").addEventListener("click", ()=> nextQuestion());

  $("btnOpenChatGPTPasteQ").addEventListener("click", async ()=>{
    if(!currentQuestion) nextQuestion();
    const payload = composeChatGPTInput();
    await copyText(payload);
    window.open(CHATGPT_URL, "_blank", "noopener");
    showToast("Prompt + domanda copiati ‚úÖ", 1200);
  });

  $("btnPasteTop").addEventListener("click", async ()=>{
    try{
      const t = await readClipboardText();
      if(!t || !t.trim()){ showToast("Appunti vuoti", 1100); return; }
      $("answerBox").value = t.trim();
      // aggiorna tele/caption
      applyAnswer(t.trim());
      refreshCaptionBox();
      showToast("Risposta incollata ‚úÖ", 1100);
      updateWizard();
    }catch(err){
      alert("Clipboard non disponibile. Usa HTTPS/localhost oppure incolla manualmente.");
    }
  });

  $("btnSendTele").addEventListener("click", ()=>{
    const free = getFreeText();
    const a = String($("answerBox").value||"").trim();
    const useText = (free || a || currentItem?.risposta || "").trim();
    if(!useText){ alert("Scrivi o incolla un testo prima."); return; }
    applyAnswer(useText);
    refreshCaptionBox();
    showToast("Inviato al teleprompter ‚úÖ", 1000);
    updateWizard();
  });

  $("btnCopyCaption").addEventListener("click", async ()=>{
    const out = captionWithHashtagsIfNeeded(buildCaptionFull());
    if(!out){ alert("Niente da copiare."); return; }
    await copyText(out);
    showToast("Caption copiata ‚úÖ", 1000);
  });
  $("btnCopyCaption2").addEventListener("click", async ()=>{
    const out = captionWithHashtagsIfNeeded(buildCaptionFull());
    if(!out){ alert("Niente da copiare."); return; }
    await copyText(out);
    showToast("Caption copiata ‚úÖ", 1000);
  });

  $("btnWhatsApp").addEventListener("click", openWhatsApp);

  // mode buttons
  $("btnModeSimple").addEventListener("click", ()=> setMode("simple"));
  $("btnModePro").addEventListener("click", ()=> setMode("pro"));

  // camera/rec
  $("btnCam").addEventListener("click", async ()=>{ await ensureReady(); updateWizard(); });
  $("btnTeleRec").addEventListener("click", async ()=>{
    const ok = await ensureReady();
    if(!ok) return;
    if(!currentQuestion) nextQuestion();
    startRecording();
  });
  $("btnStop").addEventListener("click", ()=> stopRecording());
  $("btnRestart").addEventListener("click", ()=> restartTeleprompter());

  // zoom
  $("zoom").addEventListener("input", (e)=> applyZoom(e.target.value));

  // caption inputs
  $("hashtagsBox").addEventListener("input", ()=> refreshCaptionBox());
  $("freeTextBox").addEventListener("input", ()=> refreshCaptionBox());

  // download
  $("btnDownloadVideo").addEventListener("click", ()=>{
    if(currentRecIndex < 0 || !recordings[currentRecIndex]){
      alert("Seleziona un video dalla lista.");
      return;
    }
    const r = recordings[currentRecIndex];
    downloadBlob(r.blob, r.name);
  });

  // upload
  $("btnUploadVideo").addEventListener("click", ()=> $("videoUpload").click());
  $("videoUpload").addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    if(!String(file.type||"").startsWith("video/")){
      alert("Seleziona un file video valido.");
      e.target.value = "";
      return;
    }
    addUploadedVideo(file);
    e.target.value = "";
  });

  // clear list
  $("btnClearList").addEventListener("click", ()=>{
    if(!recordings.length) return;
    if(confirm("Svuotare la lista?")){
      recordings.forEach(r => { try{ URL.revokeObjectURL(r.url); }catch(e){} });
      recordings = [];
      currentRecIndex = -1;
      $("playback").removeAttribute("src");
      $("playback").load();
      renderRecList();
      totalVideos = 0;
      updateCounters();
      rotationIndex = 0;
      refreshProfileUI();
      updateWizard();
    }
  });

  // prompt unlock/save/reset
  $("btnUnlock").addEventListener("click", ()=>{
    const code = ($("unlockCode").value || "").trim();
    if(code === UNLOCK_CODE) unlockPromptUI();
    else { alert("Codice errato."); lockPromptUI(); }
  });
  $("btnSavePrompt").addEventListener("click", ()=>{
    savePrompt();
    lockPromptUI();
    $("unlockCode").value = "";
    showToast("Prompt salvato ‚úÖ", 1000);
  });
  $("btnResetPrompt").addEventListener("click", ()=>{
    $("promptBox").value = BASE_PROMPT;
    savePrompt();
    lockPromptUI();
    $("unlockCode").value = "";
    showToast("Prompt ripristinato ‚úÖ", 1000);
  });

  // rotation reset
  ["rot_tiktok","rot_instagram","rot_shorts","rot_facebook"].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("change", ()=>{
      rotationIndex = 0;
      refreshProfileUI();
    });
  });

  // instructions modal
  $("btnInstructions").addEventListener("click", openInstructions);
  $("btnInstructionsBottom").addEventListener("click", openInstructions);
  $("btnCloseInstructions").addEventListener("click", closeInstructions);
  $("instructionsModal").addEventListener("click", (e)=>{
    if(e.target === $("instructionsModal")) closeInstructions();
  });
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeInstructions(); });

  // nav
  $("btnBackTop").addEventListener("click", goToGestionale);
  $("btnBackBottom").addEventListener("click", goToGestionale);

  // countdown init
  countdownRemaining = teleprompterSeconds;
  renderCountdown();

  // initial caption render
  refreshCaptionBox();
  updateWizard();
});
</script>
</body>
</html>
