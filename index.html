<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Video Creator ‚Äì Teleprompter</title>

  <style>
    :root{
      --bg:#0b1120;
      --text:#f3f4f6;
      --muted:#a0adb8;
      --gold:#d8a23a;
      --border: rgba(225,225,225,0.18);
      --shadow: 0 14px 50px rgba(0,0,0,0.45);
      --radius: 18px;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      --tele-font: 12px;
      --tele-line: 1.22;
      --stage-w: min(420px, 92vw);
      --zoom: 1;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(216,162,58,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(123,79,189,.14), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(74,143,114,.14), transparent 55%),
        var(--bg);
    }

    .wrap{ max-width:1150px; margin:0 auto; padding:14px 12px 84px; }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    /* ---------- Buttons (friendly + animazioni) ---------- */
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:950;
      letter-spacing:.2px;
      font-size:11px;
      line-height:1;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      position:relative;

      transform: translateY(0) scale(1);
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease, border-color .14s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .btn::after{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(500px 140px at 20% 0%, rgba(255,255,255,.14), transparent 60%),
                  radial-gradient(500px 140px at 80% 100%, rgba(255,255,255,.10), transparent 55%);
      opacity:0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    .btn:hover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(216,162,58,.22);
      box-shadow: 0 14px 34px rgba(0,0,0,.30);
      filter: brightness(1.06);
    }
    .btn:hover::after{ opacity:1; }
    .btn:active{
      transform: translateY(0px) scale(.99);
      filter: brightness(0.98);
    }

    .btn.tiny{
      padding:6px 9px;
      font-size:10px;
      border-radius:11px;
      box-shadow:none;
    }

    .btn.primary{
      background: linear-gradient(135deg, rgba(216,162,58,.95), rgba(216,162,58,.72));
      color:#111;
      border-color: rgba(216,162,58,.55);
    }
    .btn.blue{
      background: linear-gradient(135deg, rgba(57,90,140,.95), rgba(57,90,140,.70));
      border-color: rgba(57,90,140,.55);
    }
    .btn.violet{
      background: linear-gradient(135deg, rgba(123,79,189,.95), rgba(123,79,189,.70));
      border-color: rgba(123,79,189,.55);
    }
    .btn.gray{ background: rgba(255,255,255,.04); }

    .btn.green{
      background: linear-gradient(135deg, rgba(37,211,102,.95), rgba(37,211,102,.70));
      border-color: rgba(37,211,102,.55);
      color:#08140c;
      font-weight: 1000;
    }

    /* REC button (rosso, ‚Äúalive‚Äù) */
    .btn.rec{
      background: linear-gradient(135deg, rgba(255,45,45,.95), rgba(255,45,45,.55));
      border-color: rgba(255,45,45,.55);
      color:#120707;
      font-weight: 1000;
    }
    .btn.rec .dot{
      width:10px; height:10px; border-radius:999px;
      background:#ff2d2d;
      box-shadow: 0 0 0 0 rgba(255,45,45,.45);
      animation: pulseDot 1.15s ease-in-out infinite;
    }
    @keyframes pulseDot{
      0%{ box-shadow: 0 0 0 0 rgba(255,45,45,.45); transform: scale(1); }
      60%{ box-shadow: 0 0 0 10px rgba(255,45,45,0); transform: scale(1.06); }
      100%{ box-shadow: 0 0 0 0 rgba(255,45,45,0); transform: scale(1); }
    }

    .btn .ico{
      display:inline-flex;
      transform: translateY(0);
      transition: transform .16s ease;
    }
    .btn:hover .ico{
      transform: translateY(-1px) rotate(-2deg);
    }

    .pill{
      font-size:10px;
      color:var(--muted);
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      font-weight:900;
      letter-spacing:.2px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    .layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:12px;
      align-items:start;
      margin-top:12px;
    }
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .section{ padding:12px; }
    .section + .section{ border-top:1px solid rgba(255,255,255,.10); }

    .h{
      margin:0 0 8px;
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.8px;
      font-weight:950;
    }

    .stageRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){ .stageRow{ grid-template-columns:1fr; } }

    .stageBlock{
      width: var(--stage-w);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      align-items:stretch;
    }

    #stage916{
      width: 100%;
      aspect-ratio: 9 / 16;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      overflow: hidden;
      position: relative;
      background:#000;
      box-shadow: var(--shadow);
    }

    #cam{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scale(var(--zoom));
      transform-origin: center;
    }

    #overlay{
      position:absolute;
      inset:0;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      pointer-events:none;
      z-index: 2;
    }

    #questionBoxOverlay{
      font-size: 11px;
      font-weight: 950;
      line-height: 1.15;
      padding: 7px 9px;
      border-radius: 12px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(6px);
      white-space:pre-wrap;
    }

    #teleprompterOverlay{
      flex: 1;
      position: relative;
      overflow: hidden;
      border-radius: 12px;
    }

    #teleText{
      position:absolute;
      left:0; right:0;
      white-space: pre-wrap;
      font-size: var(--tele-font);
      line-height: var(--tele-line);
      font-weight: 800;
      color: rgba(243,244,246,.94);
      text-shadow: 0 2px 12px rgba(0,0,0,.75);
      transform: translateY(20px);
    }

    .controlsRow{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    .bar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    .bar.left{ justify-content:flex-start; }
    .bar.between{ justify-content:space-between; }

    .sliderRow{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:10px;
      font-weight:950;
      flex-wrap:wrap;
      justify-content:center;
    }
    input[type="range"]{ width:170px; accent-color: var(--gold); }

    .chk{
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      color:var(--muted);
      font-weight:950;
      font-size:10px;
      white-space:nowrap;
    }
    .check{
      width:16px; height:16px;
      accent-color: var(--gold);
      cursor:pointer;
    }

    .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:850;
      resize: vertical;
      min-height: 120px;
      font-size:12px;
      line-height:1.25;
    }
    .field textarea:focus{
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    .mini{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px;
    }

    /* Profili piccoli */
    .profiles{
      display:grid;
      grid-template-columns: 1fr;
      gap:7px;
      margin-top:8px;
    }
    .profileRow{
      display:flex;
      gap:8px;
      align-items:center;
      padding:7px 8px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      background:rgba(0,0,0,.14);
    }
    .profileMeta{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      flex:1;
    }
    .profileMeta b{
      font-size:11px;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .nextBadge{
      font-size:9px;
      font-weight:1000;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(255,45,45,.55);
      color: rgba(255,235,235,.95);
      background: rgba(255,45,45,.18);
      white-space:nowrap;
      display:none;
      pointer-events:none;
      user-select:none;
    }
    .nextBadge.show{ display:inline-flex; }

    #recLamp{
      position:absolute; top:12px; right:12px;
      padding:7px 9px; border-radius:12px;
      background:rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.18);
      font-weight:950; font-size:11px;
      display:none; align-items:center; gap:8px;
      backdrop-filter: blur(6px);
      z-index: 6;
    }

    .bottomBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px;
      background: rgba(0,0,0,.35);
      border-top: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      display:flex;
      justify-content:flex-end;
      z-index: 50;
      gap:8px;
      flex-wrap:wrap;
    }

    .ctrlLeft{ display:flex; gap:8px; align-items:center; }
    .ctrlMid{ display:flex; gap:8px; align-items:center; justify-content:center; }
    .ctrlRight{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-left:auto; }

    /* Countdown pill */
    #countdownPill{
      border-color: rgba(255,255,255,.18);
      background: rgba(0,0,0,.24);
      font-weight: 1000;
    }
    body.isRecording #countdownPill{
      border-color: rgba(255,59,48,.55);
      background: rgba(255,59,48,.12);
    }

    /* TELEPROMPTER UPGRADE */
    #teleWrap{
      height: 70vh !important;
    }
    #teleText{
      font-size: 26px !important;
      line-height: 1.45 !important;
      padding: 24px !important;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    /* keyword emphasis */
    .tele-strong{
      color: #ffd166;
      font-weight: 900;
    }

    /* Minimal UI */
    .hintTop, .wizard, #wizardHint, #promptDetails, #instructionsModal { display:none !important; }
    #btnOpenChatGPTPasteQ, #btnPasteTop, #btnSendTele { display:none !important; }
    #answerBox{ display:none !important; }

    /* Solo modalit√† semplice */
    body.modeSimple .proOnly{ display:none !important; }
    body.modeSimple .simpleOnly{ display:block !important; }

    body.modeSimple header{ display:none !important; }
    body.modeSimple .hintTop{ display:none !important; }
    body.modeSimple .card.simpleOnly{ display:none !important; }
    body.modeSimple #recList{ max-height:200px; }
    body.modeSimple .btn{ font-size:14px; padding:12px 14px; }
    body.modeSimple textarea{ font-size:14px; }

    #captionCard{ display:block !important; }
    #captionBox{ display:block !important; }
    #btnCopyCaption{ display:inline-flex !important; }

  </style>
</head>

<body class="modeSimple">
<div class="wrap">

  <!-- MINI ARCHIVIO DOMANDE -->
  <div class="card" style="margin-top:14px;">
    <div class="section">
      <div class="bar between" style="width:100%; gap:10px; flex-wrap:wrap;">
        <div class="bar left" style="gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="btnGenerateQuestion" type="button">
            <span class="ico">üé≤</span> Genera domanda e risposta
          </button>
        </div>

        <div class="bar left" style="gap:10px; flex:1; min-width:260px; flex-wrap:wrap;">
          <select id="questionSelect" class="sel" style="min-width:260px; flex:1;">
            <option value="">Seleziona una domanda‚Ä¶</option>
          </select>
          <span class="pill" id="archiveCountPill">Archivio: 10</span>
        </div>
      </div>
    </div>
  </div>

  <!-- BLOCCO RISPOSTA (nascosto) -->
  <div class="card" style="display:none;">
    <div class="section">
      <p class="h">Risposta</p>
      <div class="field">
        <textarea id="answerBox"></textarea>
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- MAIN -->
    <div class="card">
      <div class="section">
        <p class="h">Video 9:16 + teleprompter</p>

        <div class="stageRow">
          <div class="stageBlock">
            <div id="stage916">
              <video id="cam" autoplay playsinline muted></video>

              <div id="recLamp">
                <span style="width:10px;height:10px;border-radius:999px;background:#ff2d2d;display:inline-block;"></span>
                <span id="recTime">REC 00:00</span>
              </div>

              <div id="overlay">
                <div id="questionBoxOverlay">Premi ‚ÄúGenera domanda e risposta‚Äù.</div>
                <div id="teleprompterOverlay">
                  <div id="teleText">Il testo della risposta apparir√† qui automaticamente.</div>
                </div>
              </div>
            </div>

            <div class="controlsRow">
              <div class="bar between" style="width:100%;">
                <div class="ctrlLeft">
                  <button class="btn rec" id="btnTeleRec" type="button" title="Avvia teleprompter e registrazione">
                    <span class="dot"></span> Teleprompter + REC
                  </button>
                  <span class="pill" id="countdownPill" style="min-width:120px; text-align:center;">‚è±Ô∏è 120</span>
                  <button class="btn gray" id="btnCam" type="button"><span class="ico">üì∑</span> Camera</button>
                </div>

                <div class="ctrlMid">
                  <button class="btn gray" id="btnStop" type="button"><span class="ico">‚èπ</span> Stop</button>
                  <button class="btn gray" id="btnRestart" type="button"><span class="ico">‚Üª</span> Riavvia</button>
                </div>

                <div class="ctrlRight"></div>
              </div>

              <div class="sliderRow">
                <span>Zoom</span>
                <input id="zoom" type="range" min="1" max="2.5" step="0.1" value="1" />
                <span id="zoomVal">1.0x</span>
              </div>
            </div>
          </div>
        </div>

        <canvas id="recCanvas" width="1080" height="1920" style="display:none;"></canvas>
      </div>
    </div>

    <!-- SIDE -->
    <div class="card">
      <div class="section">
        <p class="h">Caption (Domanda + Risposta)</p>
        <textarea id="captionBox" class="ta" rows="4" readonly></textarea>
        <div class="bar left" style="margin-top:10px; gap:10px; flex-wrap:wrap;">
          <button class="btn gray" id="btnCopyCaption" type="button"><span class="ico">üìã</span> Copia caption</button>
        </div>
      </div>

      <div class="section">
        <p class="h">Video creati</p>
        <div class="subtle">Seleziona un elemento (qui sotto) per rivederlo.</div>

        <video id="playback" controls style="width:100%; border-radius:14px; background:#000; margin-top:10px;"></video>

        <div class="bar left" style="margin-top:10px;">
          <button class="btn" id="btnDownloadVideo" type="button"><span class="ico">üì•</span> Scarica video</button>
        </div>

        <div id="recList" style="margin-top:10px; max-height:260px; overflow:auto;">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom bar -->
<div class="bottomBar">
  <button class="btn tiny gray" id="btnBackBottom" type="button">‚Üê Gestionale</button>
</div>

<script>
/* ==========================
   CONFIG
========================== */
const GESTIONALE_URL = "https://tuo-gestionale.com";

/* Hashtag automatici */
const HIDDEN_HASHTAGS = [
  "#immobiliarelasacra","#josephcretorlab","#realmediapro","#amamy","#immobiliare","#realestateitalia",
  "#mercatoimmobiliare","#agenziaimmobiliare","#casainvendita","#venditacasa","#investimentiimmobiliari",
  "#property","#realestate","#digitalstrategist","#digitalstrategy","#marketingdigitale","#strategiamarketing",
  "#brandstrategy","#contentstrategy","#socialmediastrategy","#growthmarketing","#personalbranding","#branding",
  "#businessdigitale","#marketingonline"
].join(" ");

/* Mini archivio domande e risposte */
const ARCHIVIO = [
  {
    domanda: "Come posso valorizzare la mia casa prima di metterla in vendita?",
    risposta: "Per valorizzare la tua casa, concentrati su tre cose: pulizia profonda, illuminazione e piccole riparazioni. Pulisci ogni angolo, dalle finestre ai pavimenti. Aggiungi lampade per creare atmosfera accogliente. Sistema quelle piccole cose che trascuri ogni giorno: una maniglia che si allenta, un rubinetto che perde. Non serve ristrutturare completamente, basta far vedere che la casa √® curata. Investi in un servizio fotografico professionale: le foto belle attirano pi√π visitatori online. Infine, chiedi a un amico di fiducia di fare un tour critico: noter√† dettagli che tu non vedi pi√π."
  },
  {
    domanda: "Qual √® il momento migliore per vendere una casa?",
    risposta: "Il momento migliore √® quando il mercato √® attivo e tu sei pronto. In generale, la primavera √® ottima perch√© le giornate sono pi√π lunghe, i giardini fioriscono e le persone sono pi√π motivate a cercare casa. Ma non aspettare il periodo perfetto se ne hai bisogno ora. Piuttosto, prepara bene la casa e il prezzo giusto. Un immobile ben presentato e prezzato correttamente vende in qualsiasi stagione. La cosa pi√π importante √® non avere fretta: meglio aspettare qualche settimana in pi√π per ottenere il prezzo giusto che svendere per sbrigarsi."
  },
  {
    domanda: "Come faccio a capire se il prezzo della mia casa √® giusto?",
    risposta: "Il prezzo giusto non √® quello che vorresti tu, n√© quello che dice il vicino. √à quello che il mercato √® disposto a pagare. Fai una ricerca su portali immobiliari per case simili nella tua zona, stessi metri quadrati, stesse condizioni. Poi sottrai un 5-10% per essere competitivo. Se dopo 3-4 settimane non ricevi chiamate, il prezzo √® troppo alto. Se ricevi solo offerte bassissime, forse la presentazione non convince. Chiedi feedback ai visitatori: spesso dicono onestamente cosa non convince. Un prezzo realistico attira seri acquirenti e riduce i tempi di vendita."
  },
  {
    domanda: "Devo fare ristrutturazioni prima di vendere?",
    risposta: "Dipende. Ristrutturazioni pesanti raramente si recuperano nella vendita. Concentrati su interventi low-cost ad alto impatto: vernice fresca sulle pareti (colori neutri), sostituzione di vecchi sanitari, illuminazione moderna. Se la cucina √® datata ma funzionale, puliscila bene e cambia le maniglie. Se il bagno ha piastrelle anni '70 ma √® integro, lascialo cos√¨. Investire 50.000‚Ç¨ per una ristrutturazione che ne aumenta il valore di 30.000‚Ç¨ non conviene. Meglio abbassare il prezzo e lasciare che l'acquirente scelga come ristrutturare."
  },
  {
    domanda: "Come gestisco le trattative con i potenziali acquirenti?",
    risposta: "Mantieni la calma e non mostrare fretta. Ascolta tutte le offerte, anche quelle basse: ogni offerta √® un punto di partenza. Non rifiutare subito, chiedi tempo per valutare. Se l'offerta √® molto bassa, rispondi con educazione: 'Grazie per l'offerta, la valuter√≤ con il mio consulente'. Crea competizione: se hai pi√π interessati, fallo sapere (senza mentire). Fissa una scadenza per le offerte. Ricorda: tutto √® negoziabile, non solo il prezzo. Puoi trattare sui tempi di consegna, su mobili inclusi, su piccoli lavori. L'obiettivo √® chiudere con soddisfazione di entrambi."
  },
  {
    domanda: "Vendere da privato o con agenzia?",
    risposta: "Se hai tempo, esperienza e pazienza, prova da privato. Ma considera che un'agenzia ti d√†: visibilit√† su pi√π portali, filtro dei visitatori seri, supporto nella trattativa, gestione documentale. Le commissioni si ripagano se ottieni un prezzo migliore e eviti errori costosi. Se decidi per l'agenzia, scegline una che comunichi spesso e abbia un piano marketing chiaro. Chiedi referenze di vendite recenti nella tua zona. In molti casi, l'agenzia paga se stessa con il prezzo pi√π alto che riesce a ottenere."
  },
  {
    domanda: "Cosa devo dichiarare obbligatoriamente a chi compra?",
    risposta: "Devi essere trasparente su: vizi occulti (problemi strutturali, umidit√†, infiltrazioni), conformit√† urbanistica, impianti (elettrico, idraulico, gas), eventuali condoni. Nascondere problemi pu√≤ portare a cause legali. Meglio dichiarare tutto e eventualmente abbassare il prezzo. Prepara una lista di cosa funziona e cosa no. Se c'√® un problema noto, discuti se sistemarlo tu o fare uno sconto. La fiducia √® fondamentale: un acquirente che si fida √® pi√π propenso a chiudere e a non rinegoziare all'ultimo."
  },
  {
    domanda: "Quanto tempo ci vuole per vendere una casa?",
    risposta: "Dipende da zona, prezzo e mercato. In media 3-6 mesi. Se dopo 2 mesi non hai visite, rivedi prezzo e presentazione. Le prime 4-6 settimane sono cruciali: se la casa √® nuova sul mercato e ben prezzata, attira i cercatori pi√π attivi. Non demoralizzarti se all'inizio √® lento. Fatti un piano: settimana 1-2: promozione online; settimana 3-4: prime visite; settimana 5-6: feedback e eventuale aggiustamento. Una casa in vendita da troppo tempo (oltre 6 mesi) viene percepita come 'problematia', quindi meglio ritirarla e ripresentarla dopo un periodo."
  },
  {
    domanda: "Come preparo la casa per le visite?",
    risposta: "Crea un'atmosfera accogliente: luci accese (anche di giorno), temperatura confortevole, profumo neutro (no cucina pesante). Rimuovi oggetti personali (foto, troppi soprammobili) per permettere all'acquirente di immaginarsi a casa sua. Pulisci ogni superficie, soprattutto bagni e cucina. Togli il disordine: armadi pieni al 70% danno idea di spazio. Se hai animali, assicurati che non ci siano odori. Prepara un opuscoletto con informazioni utili: bollette medie, manutenzione caldaia, vicinato. Accompagna la visita senza essere invadente, lascia che si muovano liberamente."
  },
  {
    domanda: "Cosa succede dopo aver accettato un'offerta?",
    risposta: "Firma un preliminare di vendita con acconto (di solito 10-20%). Questo impegna entrambe le parti. Poi inizia il percorso notarile: il notaio verifica tutti i documenti (catasto, urbanistica, eventuali ipoteche). Se serve un mutuo, l'acquirente lo richiede. Tu intanto prepara lo stato di fatto: bollette pagate, certificazioni impianti. Programma la consegna delle chiavi, di solito al rogito. Il giorno del rogito, tutti dal notaio: si firma l'atto, l'acquirente paga il resto, tu consegni le chiavi. Ricorda di dare disdetta per utenze e cambiare domicilio."
  }
];

/* Teleprompter speed */
const TELE_SPEEDS = { s120:120, s105:105, s90:90 };
let teleprompterSeconds = TELE_SPEEDS.s105;

/* State */
let qIdx = -1;
let currentQuestion = "";
let lastCaptionClean = "";
let totalVideos = 0;
let currentItem = null;

/* Countdown */
let countdownTimer = null;
let countdownRemaining = 120;

/* ==========================
   HELPERS
========================== */
const $ = (id) => document.getElementById(id);

function pad2(n){ return String(n).padStart(2,"0"); }
function nowStamp(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}-${pad2(d.getHours())}-${pad2(d.getMinutes())}-${pad2(d.getSeconds())}`;
}
function slugify(it){
  return String(it || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s-]/g,"")
    .trim()
    .replace(/\s+/g,"-")
    .replace(/-+/g,"-")
    .slice(0, 50);
}
function keywordsFromQuestion(q){
  const stop = new Set(["perche","perch√©","che","cosa","come","se","e","o","il","lo","la","i","gli","le","un","una","da","di","del","della","delle","dei","dello","in","su","a","al","alla","alle","aggi","ai","con","senza","poi","subito","solo","nessuna","nessun","meglio","ha","senso","dopo","non","piu","pi√π","anche"]);
  const words = slugify(q).split("-").filter(w => w && !stop.has(w));
  return words.slice(0, 4).join("-");
}

function showToast(msg, ms=1600){
  const el = $("toast");
  if(!el) return;
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>{ el.style.display="none"; }, ms);
}

function renderCountdown(){
  const pill = $("countdownPill");
  if(!pill) return;
  pill.textContent = `‚è±Ô∏è ${String(countdownRemaining).padStart(3,"0")}`;
}
function stopCountdown(){
  if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
  countdownRemaining = 120;
  renderCountdown();
}
function startCountdown(){
  stopCountdown();
  document.body.classList.add("isRecording");
  countdownRemaining = 120;
  renderCountdown();
  countdownTimer = setInterval(()=>{
    countdownRemaining -= 1;
    if(countdownRemaining <= 0){
      countdownRemaining = 0;
      renderCountdown();
      try{ stopRecording(); }catch(e){}
      stopCountdown();
      document.body.classList.remove("isRecording");
      return;
    }
    renderCountdown();
  }, 1000);
}

function buildCaptionQA(){
  const q = String(currentItem?.domanda || currentQuestion || "").trim();
  const a = String(currentItem?.risposta || ($("answerBox")?.value||"")).trim();
  const parts = [];
  if(q) parts.push("Domanda: " + q);
  if(a) parts.push("Risposta: " + a);
  return parts.join("\n");
}

function captionWithHashtagsIfNeeded(clean){
  const c = String(clean || "").trim();
  if(!c) return "";
  const lower = c.toLowerCase();
  if (lower.includes("#immobiliarelasacra") || lower.includes("#josephcretorlab") || lower.includes("#realmediapro")){
    return c;
  }
  return `${c}\n\n${HIDDEN_HASHTAGS}`.trim();
}

function setCurrentItem(it){
  currentItem = it;
  if(!it) return;

  currentQuestion = it.domanda;
  showQuestionInOverlay(currentQuestion);

  // Imposta risposta nel teleprompter
  applyAnswer(it.risposta);
  
  // Aggiorna caption
  const captionText = buildCaptionQA();
  $("captionBox").value = captionText;
  
  showToast("Domanda e risposta caricate ‚úÖ", 1200);
}

function showQuestionInOverlay(q){
  $("questionBoxOverlay").textContent = q ? q : "Premi 'Genera domanda e risposta'.";
}

function pickRandomItem(){
  return ARCHIVIO[Math.floor(Math.random() * ARCHIVIO.length)];
}

function refreshArchiveUI(){
  const sel = $("questionSelect");
  if(!sel) return;
  sel.innerHTML = '<option value="">Seleziona una domanda‚Ä¶</option>';
  ARCHIVIO.forEach((it, i)=>{
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = it.domanda.length > 60 ? it.domanda.substring(0, 60) + "..." : it.domanda;
    sel.appendChild(opt);
  });
  $("archiveCountPill").textContent = `Archivio: ${ARCHIVIO.length}`;
}

/* ==========================
   TELEPROMPTER SCROLL
========================== */
let startTimeSec = null;
let isTeleprompterRunning = false;
let teleprompterAnimationId = null;

function resetTeleprompter(){
  $("teleText").style.transform = "translateY(20px)";
}
function startTeleprompter(){
  if(isTeleprompterRunning) return;
  isTeleprompterRunning = true;
  startTimeSec = performance.now() / 1000;
  animateTele();
}
function stopTeleprompter(){
  isTeleprompterRunning = false;
  if(teleprompterAnimationId) cancelAnimationFrame(teleprompterAnimationId);
  teleprompterAnimationId = null;
}
function restartTeleprompter(){
  stopTeleprompter();
  resetTeleprompter();
  setTimeout(()=> startTeleprompter(), 120);
}
function animateTele(){
  if(!isTeleprompterRunning) return;

  const teleEl = $("teleText");
  if(!teleEl){
    teleprompterAnimationId = requestAnimationFrame(animateTele);
    return;
  }

  const now = performance.now()/1000;
  const elapsed = now - startTimeSec;
  const progress = (elapsed % teleprompterSeconds) / teleprompterSeconds;

  const th = teleEl.scrollHeight || 900;
  const startY = 20;
  const endY = -th - 20;

  const y = startY + (endY - startY) * progress;
  teleEl.style.transform = `translateY(${y}px)`;

  teleprompterAnimationId = requestAnimationFrame(animateTele);
}

function applyAnswer(answer){
  const a = String(answer || "").trim();
  if(!a) return false;
  $("teleText").textContent = a;
  resetTeleprompter();
  stopTeleprompter();
  return true;
}

/* ==========================
   CAMERA + REC
========================== */
let camStream = null;
let camFacing = "user";
let zoomValue = 1.0;

let chunks = [];
let rafCanvasId = null;

let recStartTs = null;
let recTimerId = null;
let isRecording = false;
let recorder = null;

const camEl = $("cam");
const canvas = $("recCanvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

async function applyZoom(v){
  zoomValue = Number(v) || 1;
  $("zoomVal").textContent = `${zoomValue.toFixed(1)}x`;
  document.documentElement.style.setProperty("--zoom", String(zoomValue));
}

function drawFrame(){
  const W = canvas.width, H = canvas.height;
  if(camEl.readyState < 2){
    ctx.fillStyle="black"; ctx.fillRect(0,0,W,H);
    return;
  }
  const vw = camEl.videoWidth || 1280;
  const vh = camEl.videoHeight || 720;

  const z = Math.max(1, Math.min(zoomValue, 5));
  const srcW = vw / z;
  const srcH = vh / z;
  const srcX = (vw - srcW)/2;
  const srcY = (vh - srcH)/2;

  ctx.drawImage(camEl, srcX, srcY, srcW, srcH, 0, 0, W, H);
}
function startCanvasLoop(){
  function loop(){
    drawFrame();
    rafCanvasId = requestAnimationFrame(loop);
  }
  loop();
}

async function startCamera(){
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      audio:true,
      video:{ facingMode:"user", width:{ideal:1280}, height:{ideal:720} }
    });
    camEl.srcObject = camStream;
    await new Promise(res => camEl.onloadedmetadata = () => res());
    try{ await camEl.play(); }catch(e){}
    if(!rafCanvasId) startCanvasLoop();
    return true;
  }catch(err){
    alert("Errore camera: " + err.message);
    return false;
  }
}
async function ensureReady(){
  if(!camStream){
    const ok = await startCamera();
    if(!ok) return false;
  }
  if(!rafCanvasId) startCanvasLoop();
  return true;
}

function fmtTime(ms){
  const sec = Math.floor(ms/1000);
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function startRecLamp(){
  recStartTs = Date.now();
  $("recLamp").style.display = "flex";
  $("recTime").textContent = "REC 00:00";
  recTimerId = setInterval(()=> {
    $("recTime").textContent = `REC ${fmtTime(Date.now()-recStartTs)}`;
  }, 250);
}
function stopRecLamp(){
  $("recLamp").style.display = "none";
  if(recTimerId) clearInterval(recTimerId);
  recTimerId = null;
  recStartTs = null;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

/* Recordings */
let recordings = [];
let currentRecIndex = -1;

function updateCounters(){
  $("videoCounter").textContent = `Video: ${totalVideos}`;
}

function renderRecList(){
  const box = $("recList");
  if(!recordings.length){ box.textContent = "‚Äî"; return; }

  box.innerHTML = recordings.map((r,i)=>{
    const active = i===currentRecIndex ? " style='color:#d8a23a; font-weight:950;'" : "";
    return `
      <div ${active} style="margin-bottom:10px;">
        <div>
          <a href="#" data-i="${i}" style="color:inherit; text-decoration:none;">
            ${r.title}
          </a>
        </div>
        <div style="opacity:.85; margin-top:6px;">${(r.question||"").slice(0,95)}</div>
      </div>
    `;
  }).join("");

  box.querySelectorAll("a[data-i]").forEach(a => a.addEventListener("click", (e)=>{
    e.preventDefault();
    const i = +a.dataset.i;
    currentRecIndex = i;
    $("playback").src = recordings[i].url;
    $("playback").play().catch(()=>{});
    renderRecList();
  }));
}

function buildVideoTitle(videoNum, question){
  const k = keywordsFromQuestion(question) || "video";
  return `#${String(videoNum).padStart(3,"0")} ‚Ä¢ ${k}`;
}
function buildFileName(videoNum, question){
  const k = keywordsFromQuestion(question) || "video";
  return `video_${String(videoNum).padStart(3,"0")}_${k}_${nowStamp()}.webm`;
}

function startRecording(){
  try{ setTimeout(()=>{ startCountdown(); }, 2000); }catch(e){}

  if(!camStream){ alert("Attiva la camera."); return; }
  if(recorder && recorder.state !== "inactive"){ return; }

  startTeleprompter();
  chunks = [];

  const stream = canvas.captureStream(30);
  const audioTrack = camStream.getAudioTracks?.()[0];
  if(audioTrack) stream.addTrack(audioTrack);

  const mimeCandidates = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  const mimeType = mimeCandidates.find(m => MediaRecorder.isTypeSupported(m)) || "";

  recorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

  recorder.ondataavailable = (e)=>{ if(e.data.size) chunks.push(e.data); };
  recorder.onstart = ()=>{ isRecording = true; startRecLamp(); };

  const qNow = String(currentQuestion || "").trim();
  const platformNow = "video";

  recorder.onstop = ()=>{
    stopRecLamp();
    stopTeleprompter();
    isRecording = false;

    const blob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
    totalVideos += 1;

    const title = buildVideoTitle(totalVideos, qNow);
    const name = buildFileName(totalVideos, qNow);
    const url = URL.createObjectURL(blob);

    recordings.unshift({ title, name, url, blob, question: qNow, kind:"recorded" });
    currentRecIndex = 0;

    $("playback").src = url;
    $("playback").load();
    renderRecList();
    updateCounters();
  };

  recorder.start(1000);
}
function stopRecording(){
  if(recorder && recorder.state !== "inactive") recorder.stop();
}

/* ==========================
   NAV
========================== */
function goToGestionale(){
  if(confirm("Vuoi tornare al gestionale?")){
    if(isRecording) stopRecording();
    setTimeout(()=> window.location.href = GESTIONALE_URL, 250);
  }
}

/* ==========================
   INIT
========================== */
document.addEventListener("DOMContentLoaded", ()=>{
  // Inizializza archivio
  refreshArchiveUI();

  // Zoom
  applyZoom(1.0);

  // Pulsanti
  $("btnBackBottom").addEventListener("click", goToGestionale);

  // Genera domanda e risposta
  $("btnGenerateQuestion").addEventListener("click", ()=>{
    const it = pickRandomItem();
    $("questionSelect").value = String(ARCHIVIO.indexOf(it));
    setCurrentItem(it);
  });

  // Selezione dal menu
  $("questionSelect").addEventListener("change", ()=>{
    const v = $("questionSelect").value;
    if(v === "") return;
    const it = ARCHIVIO[Number(v)];
    if(it) setCurrentItem(it);
  });

  // Camera
  $("btnCam").addEventListener("click", async ()=>{
    camFacing = (camFacing === "user") ? "environment" : "user";
    try{ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; } }catch(e){}
    const ok = await ensureReady();
    if(ok) showToast(camFacing === "user" ? "Camera frontale ‚úÖ" : "Camera posteriore ‚úÖ");
  });

  // Teleprompter + REC
  $("btnTeleRec").addEventListener("click", async ()=>{
    const okCam = await ensureReady();
    if(!okCam) return;

    if(!currentQuestion){
      showToast("Prima genera una domanda e risposta");
      return;
    }

    applyAnswer(currentItem?.risposta || "");
    $("questionBoxOverlay").style.display="none";
    startRecording();
  });

  $("btnStop").addEventListener("click", ()=> stopRecording());
  $("btnRestart").addEventListener("click", ()=> restartTeleprompter());
  $("zoom").addEventListener("input", (e)=> applyZoom(e.target.value));

  // Copia caption
  $("btnCopyCaption").addEventListener("click", async ()=>{
    const captionText = $("captionBox").value.trim();
    if(!captionText){ showToast("Niente da copiare",1400); return; }
    
    const textWithHashtags = captionWithHashtagsIfNeeded(captionText);
    try{
      await navigator.clipboard.writeText(textWithHashtags);
      showToast("Caption copiata con hashtag ‚úÖ",1400);
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = textWithHashtags;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast("Caption copiata con hashtag ‚úÖ",1400);
    }
  });

  // Download video
  $("btnDownloadVideo").addEventListener("click", ()=>{
    if(currentRecIndex < 0 || !recordings[currentRecIndex]){
      alert("Seleziona un video dalla lista.");
      return;
    }
    const r = recordings[currentRecIndex];
    downloadBlob(r.blob, r.name);
  });

  // Inizializzazione
  showQuestionInOverlay("Premi 'Genera domanda e risposta'.");
  updateCounters();
  renderRecList();
  resetTeleprompter();
});

// Elemento toast
const toast = document.createElement("div");
toast.id = "toast";
toast.setAttribute("aria-live", "polite");
document.body.appendChild(toast);

</script>

</body>
</html>
