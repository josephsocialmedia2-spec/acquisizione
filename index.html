<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Video Creator ‚Äì Chat + REC + Karaoke</title>

  <style>
    :root{
      --bg:#0b1120;
      --text:#f3f4f6;
      --muted:#a0adb8;
      --gold:#d8a23a;
      --border: rgba(225,225,225,0.18);
      --shadow: 0 14px 50px rgba(0,0,0,0.45);
      --radius: 18px;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --stage-w: min(420px, 92vw);
      --zoom: 1;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(216,162,58,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(123,79,189,.14), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(74,143,114,.14), transparent 55%),
        var(--bg);
    }

    .wrap{ max-width:1150px; margin:0 auto; padding:14px 12px 84px; }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:950;
      letter-spacing:.2px;
      font-size:11px;
      line-height:1;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      position:relative;
      transform: translateY(0) scale(1);
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease, border-color .14s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .btn:hover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(216,162,58,.22);
      box-shadow: 0 14px 34px rgba(0,0,0,.30);
      filter: brightness(1.06);
    }
    .btn:active{ transform: translateY(0px) scale(.99); filter: brightness(0.98); }

    .btn.tiny{
      padding:6px 9px;
      font-size:10px;
      border-radius:11px;
      box-shadow:none;
    }

    .btn.primary{
      background: linear-gradient(135deg, rgba(216,162,58,.95), rgba(216,162,58,.72));
      color:#111;
      border-color: rgba(216,162,58,.55);
    }
    .btn.blue{
      background: linear-gradient(135deg, rgba(57,90,140,.95), rgba(57,90,140,.70));
      border-color: rgba(57,90,140,.55);
    }
    .btn.gray{ background: rgba(255,255,255,.04); }
    .btn.violet{
      background: linear-gradient(135deg, rgba(123,79,189,.95), rgba(123,79,189,.70));
      border-color: rgba(123,79,189,.55);
    }

    /* REC circle */
    .recCircle{
      width:74px; height:74px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.18);
      background: radial-gradient(120px 120px at 35% 30%, rgba(255,110,110,.95), rgba(255,45,45,.85));
      color:#120707;
      font-weight: 1000;
      letter-spacing:.4px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      transform: translateY(0);
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease;
      position:relative;
      overflow:hidden;
    }
    .recCircle:hover{
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow: 0 22px 58px rgba(0,0,0,.45);
    }
    .recCircle:active{ transform: translateY(0px) scale(.99); }
    .recCircle .innerDot{
      width:14px; height:14px; border-radius:999px;
      background:#ff2d2d;
      box-shadow: 0 0 0 0 rgba(255,45,45,.55);
      animation: pulseDot 1.15s ease-in-out infinite;
      margin-right:8px;
    }
    @keyframes pulseDot{
      0%{ box-shadow: 0 0 0 0 rgba(255,45,45,.55); transform: scale(1); }
      60%{ box-shadow: 0 0 0 12px rgba(255,45,45,0); transform: scale(1.05); }
      100%{ box-shadow: 0 0 0 0 rgba(255,45,45,0); transform: scale(1); }
    }
    .recCircle.running{
      filter: saturate(1.05);
      outline: 2px solid rgba(255,45,45,.35);
    }

    .pill{
      font-size:10px;
      color:var(--muted);
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      font-weight:900;
      letter-spacing:.2px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    .hintTop{
      margin: 6px 0 10px;
      font-size:11px;
      color: var(--muted);
      line-height: 1.35;
    }

    .layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:12px;
      align-items:start;
      margin-top:12px;
    }
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .section{ padding:12px; }
    .section + .section{ border-top:1px solid rgba(255,255,255,.10); }

    .h{
      margin:0 0 8px;
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.8px;
      font-weight:950;
    }

    .stageRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){ .stageRow{ grid-template-columns:1fr; } }

    .stageBlock{
      width: var(--stage-w);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      align-items:stretch;
    }

    #stage916{
      width: 100%;
      aspect-ratio: 9 / 16;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      overflow: hidden;
      position: relative;
      background:#000;
      box-shadow: var(--shadow);
    }

    #cam{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scale(var(--zoom));
      transform-origin: center;
    }

    #overlay{
      position:absolute;
      inset:0;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      pointer-events:none;
      z-index: 2;
    }

    #topBarOverlay{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }

    #questionBoxOverlay{
      flex:1;
      font-size: 11px;
      font-weight: 950;
      line-height: 1.15;
      padding: 7px 9px;
      border-radius: 12px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(6px);
      white-space:pre-wrap;
      min-height: 40px;
    }

    /* LOGO 50x50 ‚Äì vincolo fisso */
    #logoWrap{
      width:50px;height:50px;
      border-radius:14px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    #logoImg{
      width:50px; height:50px;
      object-fit:contain; /* no deformazione */
      display:none;
      background:transparent;
    }

    /* Categoria sotto al logo (centro alto) */
    #categoryOverlay{
      text-align:center;
      font-size:10px;
      font-weight:1000;
      letter-spacing:.6px;
      color: rgba(243,244,246,.92);
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      width: fit-content;
      margin: 0 auto;
    }

    /* Karaoke (sottotitolo) */
    #teleprompterOverlay{
      flex: 1;
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 10px;
    }

    #teleText{
      max-width: 100%;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.28;
      font-weight: 900;
      color: rgba(243,244,246,.95);
      text-shadow: 0 2px 12px rgba(0,0,0,.75);
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
      backdrop-filter: blur(6px);
      max-height: 36%;
      overflow:auto;
    }

    #teleText .w{ padding: 1px 2px; border-radius: 6px; }
    #teleText .w.on{
      background: rgba(216,162,58,.35);
      border: 1px solid rgba(216,162,58,.25);
    }

    /* Phone CTA */
    #phoneOverlay{
      font-size: 12px;
      font-weight: 1000;
      letter-spacing:.2px;
      line-height: 1.1;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.36);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(6px);
      text-align:center;
    }
    #phoneOverlay b{ color: rgba(255,235,235,.96); }

    /* REC icon + countdown */
    #recHud{
      position:absolute;
      top:12px; right:12px;
      display:none;
      align-items:center;
      gap:10px;
      z-index: 10;
    }
    #recCamIcon{
      width:34px;height:34px;border-radius:12px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      font-size: 16px;
    }
    #countdownHud{
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      font-weight: 1000;
      font-size: 12px;
      min-width: 72px;
      text-align:center;
    }

    .controlsRow{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    .bar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    .bar.left{ justify-content:flex-start; }
    .bar.between{ justify-content:space-between; }

    .sliderRow{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:10px;
      font-weight:950;
      flex-wrap:wrap;
      justify-content:center;
    }
    input[type="range"]{ width:170px; accent-color: var(--gold); }

    .chk{
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      color:var(--muted);
      font-weight:950;
      font-size:10px;
      white-space:nowrap;
    }
    .check{
      width:16px; height:16px;
      accent-color: var(--gold);
      cursor:pointer;
    }

    .field textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:850;
      resize: vertical;
      min-height: 120px;
      font-size:12px;
      line-height:1.25;
    }
    .field textarea:focus{
      border-color: rgba(216,162,58,.45);
      box-shadow: 0 0 0 6px rgba(216,162,58,.12);
    }

    .mini{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px;
    }

    /* Chat */
    .chatBox{
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px;
      max-height: 220px;
      overflow:auto;
      font-size:12px;
      line-height: 1.3;
    }
    .msg{ margin: 0 0 10px; }
    .msg .who{
      font-weight:1000;
      font-size:10px;
      letter-spacing:.6px;
      color: rgba(243,244,246,.75);
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    .msg .bubble{
      display:inline-block;
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      max-width: 100%;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user .bubble{ border-color: rgba(216,162,58,.22); }
    .msg.ai .bubble{ border-color: rgba(255,255,255,.12); }

    .subtle{
      font-size:11px;
      color: var(--muted);
      line-height:1.35;
      margin-top:6px;
    }

    .bottomBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px;
      background: rgba(0,0,0,.35);
      border-top: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      display:flex;
      justify-content:flex-end;
      z-index: 50;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="row" style="flex:1;">
      <button class="btn primary" id="btnNext" type="button"><span>‚ú®</span> Nuova domanda</button>
      <button class="btn blue" id="btnCopyQ" type="button" title="Copia domanda (e prompt) per incollare in chat esterna se vuoi"><span>üìã</span> Copia domanda</button>
      <button class="btn violet" id="btnPasteAnswer" type="button" title="Incolla risposta dagli appunti nel box Risposta"><span>üìã</span> Incolla risposta</button>

      <span class="pill">
        <span id="videoCounter">Video: 0</span>
        <span>‚Ä¢</span>
        <span id="platformLabel">Piattaforma: ‚Äî</span>
      </span>
    </div>

    <div class="row">
      <button class="btn tiny gray" id="btnBackTop" type="button">‚Üê Gestionale</button>
    </div>
  </header>

  <div class="hintTop">
    1) <b>Nuova domanda</b> ‚Üí 2) Scrivi / incolla in chat esterna (se vuoi) ‚Üí 3) <b>Incolla risposta</b> ‚Üí
    4) <b>Usa risposta</b> (chat) ‚Üí 5) <b>REC</b> (60s) ‚Üí 6) <b>Scarica</b>
  </div>

  <!-- BLOCCO RISPOSTA -->
  <div class="card">
    <div class="section">
      <p class="h">Risposta (da incollare / scrivere)</p>
      <div class="field">
        <textarea id="answerBox" placeholder="Qui verr√† incollata la risposta quando premi ‚ÄúIncolla risposta‚Äù‚Ä¶"></textarea>
      </div>

      <div class="bar left" style="margin-top:10px;">
        <button class="btn primary" id="btnUseAnswer" type="button"><span>‚û°Ô∏è</span> Usa risposta (teleprompter + caption)</button>
        <button class="btn gray" id="btnCopyCaption" type="button" title="Copia caption (piattaforma + telefono + hashtag)"><span>üìã</span> Copia caption</button>
      </div>

      <div class="subtle">
        Il testo verr√† ‚Äúkaraoke‚Äù sul video e registrato per <b>60 secondi</b>. La caption inizier√† con la piattaforma (se rotazione attiva).
      </div>
    </div>
  </div>

  <div class="layout">

    <!-- MAIN -->
    <div class="card">
      <div class="section">
        <p class="h">Video 9:16 + Karaoke + REC</p>

        <div class="stageRow">
          <div class="stageBlock">
            <div id="stage916">
              <video id="cam" autoplay playsinline muted></video>

              <div id="recHud">
                <div id="recCamIcon">üé•</div>
                <div id="countdownHud">REC 60s</div>
              </div>

              <div id="overlay">
                <div id="topBarOverlay">
                  <div id="questionBoxOverlay">Premi ‚ÄúNuova domanda‚Äù.</div>
                  <div id="logoWrap"><img id="logoImg" alt="logo"></div>
                </div>

                <div id="categoryOverlay">ATTUALIT√Ä</div>

                <div id="teleprompterOverlay">
                  <div id="teleText">Incolla una risposta ‚Üí ‚ÄúUsa risposta‚Äù ‚Üí ‚ÄúREC‚Äù.</div>
                </div>

                <div id="phoneOverlay">CHIAMA AL <b>‚Äî</b></div>
              </div>
            </div>

            <div class="controlsRow">
              <div class="bar between" style="width:100%;">
                <div class="bar left" style="gap:8px;">
                  <button class="btn gray" id="btnCam" type="button"><span>üì∑</span> Camera</button>
                  <button class="btn gray" id="btnFlip" type="button" title="Gira fotocamera"><span>üîÑ</span> Gira</button>
                  <button class="btn gray" id="btnFlash" type="button" title="Flash on/off (se supportato)"><span>üí°</span> Flash</button>
                </div>

                <div class="bar" style="gap:8px;">
                  <label class="chk"><input class="check" type="checkbox" id="chkRotate" checked> Rotazione</label>
                  <button class="btn gray" id="btnStop" type="button"><span>‚èπ</span> Stop</button>
                </div>

                <div class="bar" style="gap:8px;">
                  <div class="recCircle" id="btnREC" title="Registra 60 secondi">
                    <span class="innerDot"></span> REC
                  </div>
                </div>
              </div>

              <div class="sliderRow">
                <span>Zoom</span>
                <input id="zoom" type="range" min="1" max="2.5" step="0.1" value="1" />
                <span id="zoomVal">1.0x</span>
              </div>

              <div class="subtle">
                Nota: il tasto ‚ÄúDove sono i video‚Äù non pu√≤ aprire una cartella reale in browser. Qui scarichi i file e li trovi nei download.
              </div>
            </div>
          </div>

          <div>
            <p class="h">Setup (persistente)</p>

            <div class="mini" style="margin-bottom:10px;">
              <b>Piattaforme rotazione:</b> TikTok ‚Üí Instagram ‚Üí Shorts ‚Üí Facebook
              <br><b>Durata:</b> 60s fissi
              <br><b>Logo:</b> 50x50 (proporzione fissa)
            </div>

            <p class="h">Telefono</p>
            <div class="field">
              <textarea id="phoneInput" style="min-height:54px;" placeholder="Inserisci numero (es. 3331234567)"></textarea>
            </div>

            <div class="bar left" style="margin-top:10px;">
              <input id="logoUpload" type="file" accept="image/*" style="display:none;" />
              <button class="btn gray" id="btnLogo" type="button"><span>üñº</span> Carica logo</button>
              <button class="btn gray" id="btnWhere" type="button"><span>üìÅ</span> Dove sono i video</button>
            </div>

            <div class="subtle">
              Il telefono e il logo vengono memorizzati e riutilizzati nei video successivi.
            </div>
          </div>
        </div>

        <canvas id="recCanvas" width="1080" height="1920" style="display:none;"></canvas>
      </div>
    </div>

    <!-- SIDE -->
    <div class="card">
      <div class="section">
        <p class="h">Chat (manuale, copia/incolla)</p>
        <div class="chatBox" id="chatBox"></div>

        <div class="bar left" style="margin-top:10px;">
          <button class="btn tiny gray" id="btnChatAddQ" type="button">‚ûï Domanda in chat</button>
          <button class="btn tiny gray" id="btnChatAddA" type="button">‚ûï Risposta in chat</button>
          <button class="btn tiny gray" id="btnChatClear" type="button">üóë Svuota chat</button>
        </div>

        <div class="subtle">Qui ‚ÄúIA‚Äù √® solo un‚Äôetichetta: incolli tu la risposta.</div>
      </div>

      <div class="section">
        <div class="bar between">
          <p class="h" style="margin:0;">Caption (preview)</p>
          <label class="chk"><input type="checkbox" id="chkRememberCaption" class="check" checked /> Memorizza</label>
        </div>
        <div class="mini" id="captionPreview" style="margin-top:10px;">‚Äî</div>
        <div class="subtle">La caption copiata include: piattaforma (prima parola) + testo + telefono + hashtag.</div>
      </div>

      <div class="section">
        <p class="h">Video creati</p>
        <div class="subtle">Seleziona un video per rivederlo. Poi ‚ÄúScarica‚Äù.</div>

        <video id="playback" controls style="width:100%; border-radius:14px; background:#000; margin-top:10px;"></video>

        <div class="bar left" style="margin-top:10px;">
          <button class="btn" id="btnDownloadVideo" type="button"><span>üì•</span> Scarica video</button>
          <button class="btn tiny gray" id="btnClearList" type="button">üóë Svuota</button>
        </div>

        <div class="mini" id="recList" style="margin-top:10px; max-height:260px; overflow:auto;">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<div class="bottomBar">
  <button class="btn tiny gray" id="btnBackBottom" type="button">‚Üê Gestionale</button>
</div>

<script>
/* ==========================
   CONFIG
========================== */
const GESTIONALE_URL = "https://tuo-gestionale.com"; // cambia se vuoi

/* Hashtag automatici (aggiunti in copia caption) */
const HIDDEN_HASHTAGS = [
  "#immobiliarelasacra","#josephcretorlab","#realmediapro","#amamy","#immobiliare","#realestateitalia",
  "#mercatoimmobiliare","#agenziaimmobiliare","#casainvendita","#venditacasa","#investimentiimmobiliari",
  "#property","#realestate","#digitalstrategist","#digitalstrategy","#marketingdigitale","#strategiamarketing",
  "#brandstrategy","#contentstrategy","#socialmediastrategy","#growthmarketing","#personalbranding","#branding",
  "#businessdigitale","#marketingonline"
].join(" ");

/* ==========================
   ARCHIVIO DOMANDE (300) ‚Äì GENERATO
   Fasi: ACQUISIZIONE, LEAD, FOLLOW-UP, TRATTATIVA, FIDELIZZAZIONE (60 ciascuna)
========================== */
function buildQuestions300(){
  const phases = [
    { code:"A", name:"ACQUISIZIONE", topics:[
      "valutazione casa","annuncio che non performa","incarico in esclusiva","foto e home staging","prezzo giusto",
      "tempi di vendita","documenti","zona e domanda","strategie marketing","errori del privato","open house","posizionamento"
    ]},
    { code:"L", name:"LEAD", topics:[
      "lead freddi","curiosi senza proposta","qualifica del cliente","budget reale","motivazione all'acquisto",
      "tempistiche","finanziamento","profilo ideale","obiezioni iniziali","criteri di scelta","comparazione immobili","follow-up rapido"
    ]},
    { code:"F", name:"FOLLOW-UP", topics:[
      "nessuna risposta dopo visita","seconda visita","paura di decidere","silenzio dopo preventivo","clienti che spariscono",
      "urgenza percepita","ripresa contatto","micro-impegni","senso di fiducia","riproposta valore","timeline decisionale","re-engage"
    ]},
    { code:"T", name:"TRATTATIVA", topics:[
      "offerta bassa","controproposta","gestire emozioni","tempi di accettazione","caparra e condizioni",
      "mutuo e clausole","negoziazione win-win","urgenza venditore","urgenza acquirente","obiezioni sul prezzo","chiusura","firma e step"
    ]},
    { code:"R", name:"FIDELIZZAZIONE", topics:[
      "post-vendita","recensioni","passaparola","contenuti utili","checklist proprietario","consigli fiscali base",
      "manutenzione casa","investimenti immobiliari","nuove opportunit√†","aggiornamenti mercato","community locale","relazione continua"
    ]},
  ];

  const patterns = [
    (topic)=>`Qual √® l‚Äôerrore #1 su ${topic} che fa perdere clienti senza accorgersene?`,
    (topic)=>`Come capisco se ${topic} sta bloccando tutto?`,
    (topic)=>`Se ti succede questo su ${topic}, cosa significa davvero?`,
    (topic)=>`3 segnali che ${topic} non √® fatto bene (e cosa fare subito).`,
    (topic)=>`Meglio fare X o Y su ${topic}? Ecco la regola semplice.`,
    (topic)=>`Cosa dire (e cosa NON dire) quando parli di ${topic} con un cliente.`,
    (topic)=>`Perch√© la gente ti dice ‚Äúci penso‚Äù su ${topic} e poi sparisce?`,
    (topic)=>`Quanto conta davvero ${topic} nei risultati? Spoiler: pi√π di quanto pensi.`,
    (topic)=>`La frase che cambia tutto quando tocchi ${topic}.`,
    (topic)=>`Checklist rapida: ${topic} fatto bene in 60 secondi.`,
  ];

  const out = [];
  for(const ph of phases){
    let i = 0;
    while(i < 60){
      for(const topic of ph.topics){
        for(const makeQ of patterns){
          if(i >= 60) break;
          const id = `${ph.code}${String(i+1).padStart(3,"0")}`;
          out.push({
            id,
            fase: ph.name,
            categoria: topic,
            domanda: makeQ(topic)
          });
          i++;
        }
        if(i >= 60) break;
      }
    }
  }
  return out.slice(0,300);
}
const QUESTION_BANK = buildQuestions300();

/* ==========================
   HELPERS
========================== */
const $ = (id) => document.getElementById(id);

function pad2(n){ return String(n).padStart(2,"0"); }
function nowStamp(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}-${pad2(d.getHours())}-${pad2(d.getMinutes())}-${pad2(d.getSeconds())}`;
}
function slugify(it){
  return String(it || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s-]/g,"")
    .trim()
    .replace(/\s+/g,"-")
    .replace(/-+/g,"-")
    .slice(0, 60);
}
function keywordsFromQuestion(q){
  const stop = new Set(["perche","perch√©","che","cosa","come","se","e","o","il","lo","la","i","gli","le","un","una","da","di","del","della","delle","dei","dello","in","su","a","al","alla","alle","agli","ai","con","senza","poi","subito","solo","nessuna","nessun","meglio","ha","senso","dopo","non","piu","pi√π","anche"]);
  const words = slugify(q).split("-").filter(w => w && !stop.has(w));
  return words.slice(0, 5).join("-");
}

async function copyText(text){
  const t = String(text || "");
  if(!t.trim()) return false;
  try{
    await navigator.clipboard.writeText(t);
    return true;
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    return true;
  }
}
async function readClipboardText(){
  return await navigator.clipboard.readText();
}

/* Caption builder */
function captionWithHashtagsIfNeeded(clean){
  const c = String(clean || "").trim();
  if(!c) return "";
  const lower = c.toLowerCase();
  if (lower.includes("#immobiliarelasacra") || lower.includes("#josephcretorlab") || lower.includes("#realmediapro")){
    return c;
  }
  return `${c}\n\n${HIDDEN_HASHTAGS}`.trim();
}

/* ==========================
   STATE
========================== */
let qIdx = -1;
let currentQuestion = "";
let currentQuestionObj = null;

let lastCaptionClean = "";
let totalVideos = 0;

const PLATFORMS = ["TIKTOK","INSTAGRAM","SHORTS","FACEBOOK"];
let platformIndex = 0;

let logoDataUrl = "";
let phoneValue = "";

let facingMode = "user";
let torchOn = false;

const DB_KEY = "vc_videos_db_v1";  // metadata
const CAP_KEY = "vc_caption_clean_v1";
const PHONE_KEY = "vc_phone_v1";
const LOGO_KEY = "vc_logo_v1";

/* Recordings in-session */
let recordings = [];
let currentRecIndex = -1;

/* ==========================
   UI: Question + Category
========================== */
function showQuestionInOverlay(q){
  $("questionBoxOverlay").textContent = q ? q : "Premi ‚ÄúNuova domanda‚Äù.";
}
function getCategoryForQuestion(qObj){
  if(!qObj || !qObj.fase) return "ATTUALIT√Ä";
  // categoria = fase + topic
  const fase = qObj.fase || "ATTUALIT√Ä";
  const cat = qObj.categoria ? ` ‚Ä¢ ${qObj.categoria}` : "";
  return (fase + cat).toUpperCase();
}
function nextQuestion(){
  qIdx = (qIdx + 1) % QUESTION_BANK.length;
  currentQuestionObj = QUESTION_BANK[qIdx];
  currentQuestion = currentQuestionObj.domanda;
  showQuestionInOverlay(currentQuestion);
  $("categoryOverlay").textContent = getCategoryForQuestion(currentQuestionObj);
}
function getActivePlatform(){
  if(!$("chkRotate").checked) return "MANUALE";
  const p = PLATFORMS[platformIndex % PLATFORMS.length];
  return p;
}
function advancePlatform(){
  if(!$("chkRotate").checked) return;
  platformIndex = (platformIndex + 1) % PLATFORMS.length;
}
function refreshPlatformUI(){
  $("platformLabel").textContent = "Piattaforma: " + getActivePlatform();
}

/* ==========================
   Chat (manuale)
========================== */
function chatAdd(who, text){
  const box = $("chatBox");
  const div = document.createElement("div");
  div.className = "msg " + (who === "TU" ? "user" : "ai");
  div.innerHTML = `
    <div class="who">${who}</div>
    <div class="bubble"></div>
  `;
  div.querySelector(".bubble").textContent = String(text || "");
  box.appendChild(div);
  box.scrollTop = box.scrollHeight + 9999;
}

/* ==========================
   Caption + Teletext karaoke prep
========================== */
function setCaptionClean(clean){
  lastCaptionClean = String(clean || "").trim();
  $("captionPreview").textContent = lastCaptionClean || "‚Äî";
  if ($("chkRememberCaption").checked){
    try{ localStorage.setItem(CAP_KEY, lastCaptionClean); }catch(e){}
  }
}

/* Karaoke words */
let karaokeWords = [];
let karaokeIndex = 0;
function buildKaraokeSpans(text){
  const container = $("teleText");
  container.innerHTML = "";
  const tokens = String(text || "").replace(/\s+/g," ").trim().split(" ").filter(Boolean);
  karaokeWords = tokens;
  karaokeIndex = 0;

  if(tokens.length === 0){
    container.textContent = "Incolla una risposta ‚Üí ‚ÄúUsa risposta‚Äù ‚Üí ‚ÄúREC‚Äù.";
    karaokeWords = [];
    return;
  }

  for(const w of tokens){
    const span = document.createElement("span");
    span.className = "w";
    span.textContent = w + " ";
    container.appendChild(span);
  }
}
function karaokeStep(){
  if(karaokeWords.length === 0) return;
  const el = $("teleText");
  const spans = el.querySelectorAll(".w");
  if(karaokeIndex > 0 && spans[karaokeIndex-1]) spans[karaokeIndex-1].classList.remove("on");
  if(spans[karaokeIndex]){
    spans[karaokeIndex].classList.add("on");
    // keep visible
    spans[karaokeIndex].scrollIntoView({ block:"nearest", inline:"nearest" });
    karaokeIndex = Math.min(karaokeIndex + 1, spans.length);
  }
}

/* Build final caption (platform first word) + phone line */
function buildFinalCaption(){
  const p = getActivePlatform();
  const phoneLine = phoneValue ? `\n\nCHIAMA AL ${phoneValue}` : "";
  const base = `[${p}] ${lastCaptionClean || ""}`.trim();
  return captionWithHashtagsIfNeeded((base + phoneLine).trim());
}

/* ==========================
   Camera + Canvas recording (with overlays drawn)
========================== */
let camStream = null;
let recorder = null;
let chunks = [];
let rafCanvasId = null;

const camEl = $("cam");
const canvas = $("recCanvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

let zoomValue = 1.0;
async function applyZoom(v){
  zoomValue = Number(v) || 1;
  $("zoomVal").textContent = `${zoomValue.toFixed(1)}x`;
  document.documentElement.style.setProperty("--zoom", String(zoomValue));
}

/* load logo image for drawing */
let logoImgObj = new Image();
logoImgObj.onload = ()=>{};
function setLogoDataUrl(dataUrl){
  logoDataUrl = String(dataUrl || "");
  if(logoDataUrl){
    $("logoImg").src = logoDataUrl;
    $("logoImg").style.display = "block";
    logoImgObj = new Image();
    logoImgObj.crossOrigin = "anonymous";
    logoImgObj.src = logoDataUrl;
    try{ localStorage.setItem(LOGO_KEY, logoDataUrl); }catch(e){}
  }else{
    $("logoImg").style.display = "none";
    try{ localStorage.removeItem(LOGO_KEY); }catch(e){}
  }
}

/* draw overlays to recording */
function drawOverlayToCanvas(){
  const W = canvas.width, H = canvas.height;

  // camera frame
  if(camEl.readyState < 2){
    ctx.fillStyle = "black";
    ctx.fillRect(0,0,W,H);
    return;
  }
  const vw = camEl.videoWidth || 1280;
  const vh = camEl.videoHeight || 720;

  const z = Math.max(1, Math.min(zoomValue, 5));
  const srcW = vw / z;
  const srcH = vh / z;
  const srcX = (vw - srcW)/2;
  const srcY = (vh - srcH)/2;

  ctx.drawImage(camEl, srcX, srcY, srcW, srcH, 0, 0, W, H);

  // overlays
  // semi-transparent text boxes
  ctx.save();

  // Top question box
  const q = String(currentQuestion || "").trim() || "ATTUALIT√Ä";
  const cat = $("categoryOverlay").textContent || "ATTUALIT√Ä";
  const phone = phoneValue ? `CHIAMA AL ${phoneValue}` : "CHIAMA AL ‚Äî";

  const pad = 28;
  ctx.font = "900 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.textBaseline = "top";

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // Question box background
  const qBoxX = 36, qBoxY = 36;
  const qBoxW = W - 36 - 36 - 120; // leave space for logo at top-right
  const qBoxH = 132;

  ctx.fillStyle = "rgba(0,0,0,.35)";
  ctx.strokeStyle = "rgba(255,255,255,.18)";
  ctx.lineWidth = 2;
  roundRect(qBoxX, qBoxY, qBoxW, qBoxH, 26);
  ctx.fill(); ctx.stroke();

  ctx.fillStyle = "rgba(243,244,246,.95)";
  // wrap question
  const qLines = wrapText(ctx, q, qBoxW - pad*2);
  for(let i=0;i<Math.min(qLines.length,2);i++){
    ctx.fillText(qLines[i], qBoxX + pad, qBoxY + 18 + i*44);
  }

  // Logo 50x50 (top-right)
  const logoX = W - 36 - 90;
  const logoY = 36;
  ctx.fillStyle = "rgba(0,0,0,.30)";
  ctx.strokeStyle = "rgba(255,255,255,.18)";
  roundRect(logoX, logoY, 90, 90, 26);
  ctx.fill(); ctx.stroke();

  if(logoDataUrl && logoImgObj && logoImgObj.complete){
    // contain inside 50x50 centered
    const size = 50;
    const cx = logoX + (90-size)/2;
    const cy = logoY + (90-size)/2;

    // contain logic
    const iw = logoImgObj.naturalWidth || size;
    const ih = logoImgObj.naturalHeight || size;
    const scale = Math.min(size/iw, size/ih);
    const dw = iw * scale;
    const dh = ih * scale;
    const dx = cx + (size - dw)/2;
    const dy = cy + (size - dh)/2;

    ctx.drawImage(logoImgObj, dx, dy, dw, dh);
  }

  // Category pill centered under top row
  ctx.font = "1000 28px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const catText = String(cat).toUpperCase();
  const catW = Math.min(W - 72, measureTextWidth(ctx, catText) + 52);
  const catX = (W - catW)/2;
  const catY = 160;
  ctx.fillStyle = "rgba(0,0,0,.26)";
  ctx.strokeStyle = "rgba(255,255,255,.14)";
  roundRect(catX, catY, catW, 58, 22);
  ctx.fill(); ctx.stroke();
  ctx.fillStyle = "rgba(243,244,246,.95)";
  ctx.fillText(truncateText(ctx, catText, catW-40), catX + 20, catY + 14);

  // Karaoke line (bottom)
  const karaokeLine = currentKaraokeLine();
  ctx.font = "900 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const subW = W - 72;
  const subX = 36;
  const subH = 160;
  const subY = H - 36 - 110 - subH;
  ctx.fillStyle = "rgba(0,0,0,.28)";
  ctx.strokeStyle = "rgba(255,255,255,.14)";
  roundRect(subX, subY, subW, subH, 30);
  ctx.fill(); ctx.stroke();

  ctx.fillStyle = "rgba(243,244,246,.96)";
  const sLines = wrapText(ctx, karaokeLine, subW - 56);
  for(let i=0;i<Math.min(3, sLines.length);i++){
    ctx.fillText(sLines[i], subX + 28, subY + 22 + i*44);
  }

  // Phone CTA bottom
  ctx.font = "1000 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const phoneH = 92;
  const phoneY = H - 36 - phoneH;
  ctx.fillStyle = "rgba(0,0,0,.36)";
  ctx.strokeStyle = "rgba(255,255,255,.18)";
  roundRect(36, phoneY, W-72, phoneH, 30);
  ctx.fill(); ctx.stroke();
  ctx.fillStyle = "rgba(255,235,235,.96)";
  ctx.fillText(truncateText(ctx, phone, W-72-56), 64, phoneY + 24);

  ctx.restore();
}

function measureTextWidth(ctx, t){ return ctx.measureText(String(t||"")).width; }
function truncateText(ctx, t, maxW){
  let s = String(t||"");
  if(measureTextWidth(ctx, s) <= maxW) return s;
  while(s.length > 0 && measureTextWidth(ctx, s + "‚Ä¶") > maxW) s = s.slice(0,-1);
  return s + "‚Ä¶";
}
function wrapText(ctx, text, maxWidth){
  const words = String(text||"").split(/\s+/).filter(Boolean);
  const lines = [];
  let line = "";
  for(const w of words){
    const test = line ? (line + " " + w) : w;
    if(ctx.measureText(test).width <= maxWidth){
      line = test;
    }else{
      if(line) lines.push(line);
      line = w;
    }
  }
  if(line) lines.push(line);
  return lines;
}

/* Karaoke line helper for recording */
function currentKaraokeLine(){
  if(karaokeWords.length === 0) return "";
  const start = Math.max(0, karaokeIndex - 8);
  const end = Math.min(karaokeWords.length, karaokeIndex + 10);
  return karaokeWords.slice(start, end).join(" ");
}

/* Canvas loop */
function startCanvasLoop(){
  function loop(){
    drawOverlayToCanvas();
    rafCanvasId = requestAnimationFrame(loop);
  }
  loop();
}

async function startCamera(){
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      audio:true,
      video:{ facingMode: facingMode, width:{ideal:1280}, height:{ideal:720} }
    });
    camEl.srcObject = camStream;
    await new Promise(res => camEl.onloadedmetadata = () => res());
    try{ await camEl.play(); }catch(e){}
    if(!rafCanvasId) startCanvasLoop();
    return true;
  }catch(err){
    alert("Errore camera: " + err.message);
    return false;
  }
}
async function ensureReady(){
  if(!camStream){
    const ok = await startCamera();
    if(!ok) return false;
  }
  if(!rafCanvasId) startCanvasLoop();
  return true;
}

/* Flash (torch) */
async function toggleTorch(){
  if(!camStream) return;
  const track = camStream.getVideoTracks?.()[0];
  if(!track) return;
  const caps = track.getCapabilities?.() || {};
  if(!caps.torch){
    alert("Torch/Flash non supportato su questo dispositivo/browser.");
    return;
  }
  torchOn = !torchOn;
  try{
    await track.applyConstraints({ advanced: [{ torch: torchOn }] });
  }catch(e){
    torchOn = !torchOn;
    alert("Impossibile attivare il flash: " + (e?.message || e));
  }
}

/* Flip cam */
async function flipCamera(){
  facingMode = (facingMode === "user") ? "environment" : "user";
  await startCamera();
}

/* ==========================
   REC + Countdown 60s + DB
========================== */
let isRecording = false;
let recTimerId = null;
let remaining = 60;

function updateRecHud(){
  $("countdownHud").textContent = `REC ${remaining}s`;
}

function buildVideoId(){
  const p = getActivePlatform();
  const qkey = keywordsFromQuestion(currentQuestion || "attualita") || "video";
  return `VID_${p}_${qkey}_${nowStamp()}`;
}
function buildFileName(id){
  return `${id}.webm`;
}

function persistVideoMeta(meta){
  const db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
  db.unshift(meta);
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}

function buildVideoTitle(videoNum, platform, question){
  const k = keywordsFromQuestion(question) || "video";
  const p = platform || "MANUALE";
  return `#${String(videoNum).padStart(3,"0")} ‚Ä¢ ${p} ‚Ä¢ ${k}`;
}

function startRecording60(){
  if(!camStream){ alert("Attiva la camera."); return; }
  if(recorder && recorder.state !== "inactive") return;

  const ans = String($("answerBox").value || "").trim();
  if(!ans){
    alert("Scrivi o incolla una risposta prima.");
    return;
  }

  // ensure question/category
  if(!currentQuestion){
    // allow no question: attualit√†
    currentQuestionObj = null;
    currentQuestion = "";
    showQuestionInOverlay("ATTUALIT√Ä");
    $("categoryOverlay").textContent = "ATTUALIT√Ä";
  }

  // prepare tele/caption if not done
  applyAnswerToTeleAndCaption(ans);

  const platformNow = getActivePlatform();

  // HUD on
  $("recHud").style.display = "flex";
  $("btnREC").classList.add("running");

  remaining = 60;
  updateRecHud();
  isRecording = true;

  chunks = [];

  const stream = canvas.captureStream(30);
  const audioTrack = camStream.getAudioTracks?.()[0];
  if(audioTrack) stream.addTrack(audioTrack);

  const mimeCandidates = [
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm"
  ];
  const mimeType = mimeCandidates.find(m => MediaRecorder.isTypeSupported(m)) || "";

  recorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

  recorder.ondataavailable = (e)=>{ if(e.data.size) chunks.push(e.data); };

  const videoId = buildVideoId();
  const videoName = buildFileName(videoId);
  const questionText = String(currentQuestion || "ATTUALIT√Ä").trim() || "ATTUALIT√Ä";
  const categoryText = $("categoryOverlay").textContent || "ATTUALIT√Ä";
  const phoneNow = phoneValue || "";

  recorder.onstop = ()=>{
    if(recTimerId) clearInterval(recTimerId);
    recTimerId = null;

    $("recHud").style.display = "none";
    $("btnREC").classList.remove("running");
    isRecording = false;

    const blob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
    totalVideos += 1;

    const url = URL.createObjectURL(blob);
    const title = buildVideoTitle(totalVideos, platformNow, questionText);

    const meta = {
      id: videoId,
      filename: videoName,
      createdAt: new Date().toISOString(),
      platform: platformNow,
      question: questionText,
      category: categoryText,
      phone: phoneNow,
      captionClean: lastCaptionClean,
      captionFinal: buildFinalCaption()
    };
    persistVideoMeta(meta);

    recordings.unshift({ title, name: videoName, url, blob, meta });
    currentRecIndex = 0;

    $("playback").src = url;
    $("playback").load();

    renderRecList();
    updateCounters();

    // advance platform after each recording
    advancePlatform();
    refreshPlatformUI();
  };

  recorder.start(1000);

  // karaoke stepping over 60s: distribute steps across words
  // We do 1 word highlight per tick as baseline; if long text, it will not finish, but keeps moving.
  recTimerId = setInterval(()=>{
    remaining -= 1;

    // Step karaoke 1-2 words per second based on length
    const spans = $("teleText").querySelectorAll(".w");
    const total = spans.length || 0;
    if(total > 0){
      // target to sweep majority in 60s
      const stepsPerSec = Math.max(1, Math.round(total / 60));
      for(let s=0; s<stepsPerSec; s++) karaokeStep();
    }

    updateRecHud();
    if(remaining <= 0){
      stopRecording();
    }
  }, 1000);
}

function stopRecording(){
  if(recorder && recorder.state !== "inactive"){
    recorder.stop();
  }
}

/* ==========================
   Apply answer to tele + caption + category
========================== */
function applyAnswerToTeleAndCaption(answer){
  const a = String(answer || "").trim();
  if(!a) return false;

  // Build karaoke spans
  buildKaraokeSpans(a);

  // Caption clean
  setCaptionClean(a);

  // Category: from current question; if none, ATTUALIT√Ä
  const cat = getCategoryForQuestion(currentQuestionObj);
  $("categoryOverlay").textContent = cat || "ATTUALIT√Ä";

  return true;
}

/* ==========================
   Video list UI
========================== */
function updateCounters(){
  $("videoCounter").textContent = `Video: ${totalVideos}`;
}

function renderRecList(){
  const box = $("recList");
  if(!recordings.length){ box.textContent = "‚Äî"; return; }

  box.innerHTML = recordings.map((r,i)=>{
    const active = i===currentRecIndex ? " style='color:#d8a23a; font-weight:950;'" : "";
    const meta = r.meta || {};
    const line2 = `${meta.platform || ""} ‚Ä¢ ${String(meta.category || "").slice(0,50)}`;
    const line3 = `${String(meta.question || "").slice(0,90)}`;
    return `
      <div ${active} style="margin-bottom:12px;">
        <div>
          <a href="#" data-i="${i}" style="color:inherit; text-decoration:none;">
            ${r.title}
          </a>
        </div>
        <div style="opacity:.85; margin-top:6px;">${line2}</div>
        <div style="opacity:.85; margin-top:6px;">${line3}</div>
      </div>
    `;
  }).join("");

  box.querySelectorAll("a[data-i]").forEach(a => a.addEventListener("click", (e)=>{
    e.preventDefault();
    const i = +a.dataset.i;
    currentRecIndex = i;
    $("playback").src = recordings[i].url;
    $("playback").play().catch(()=>{});
    renderRecList();
  }));
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

/* ==========================
   NAV
========================== */
function goToGestionale(){
  if(confirm("Vuoi tornare al gestionale?")){
    if(isRecording) stopRecording();
    setTimeout(()=> window.location.href = GESTIONALE_URL, 250);
  }
}

/* ==========================
   INIT
========================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  // Restore caption
  try{
    const savedCap = localStorage.getItem(CAP_KEY) || "";
    if(savedCap.trim() && $("chkRememberCaption").checked){
      setCaptionClean(savedCap);
    }
  }catch(e){}

  // Restore phone
  try{
    const sp = localStorage.getItem(PHONE_KEY) || "";
    if(sp.trim()){
      phoneValue = sp.trim();
      $("phoneInput").value = phoneValue;
    }
  }catch(e){}
  renderPhoneOverlay();

  // Restore logo
  try{
    const sl = localStorage.getItem(LOGO_KEY) || "";
    if(sl.trim()) setLogoDataUrl(sl.trim());
  }catch(e){}

  // UI
  $("btnBackTop").addEventListener("click", goToGestionale);
  $("btnBackBottom").addEventListener("click", goToGestionale);

  $("btnNext").addEventListener("click", ()=>{
    nextQuestion();
    refreshPlatformUI();
  });

  $("btnCopyQ").addEventListener("click", async ()=>{
    if(!currentQuestion) nextQuestion();
    const payload = `DOMANDA (${currentQuestionObj?.id || "ATT"} - ${currentQuestionObj?.fase || "ATTUALIT√Ä"}):\n${currentQuestion}`.trim();
    await copyText(payload);
  });

  $("btnPasteAnswer").addEventListener("click", async ()=>{
    try{
      const t = await readClipboardText();
      $("answerBox").value = (t || "");
    }catch(e){
      alert("Clipboard bloccata: incolla manualmente nel box Risposta.");
    }
  });

  $("btnUseAnswer").addEventListener("click", ()=>{
    const ans = $("answerBox").value || "";
    const ok = applyAnswerToTeleAndCaption(ans);
    if(!ok) return alert("Scrivi o incolla una risposta prima.");

    // Also add to chat as "IA"
    chatAdd("IA", String(ans || "").trim());

    // Store platform label
    refreshPlatformUI();
  });

  $("btnCopyCaption").addEventListener("click", async ()=>{
    const out = buildFinalCaption();
    if(!out){ alert("Niente da copiare."); return; }
    await copyText(out);
  });

  // Chat buttons
  $("btnChatAddQ").addEventListener("click", ()=>{
    const q = currentQuestion || "ATTUALIT√Ä";
    chatAdd("TU", q);
  });
  $("btnChatAddA").addEventListener("click", ()=>{
    const a = String($("answerBox").value || "").trim();
    if(!a) return alert("Incolla una risposta nel box Risposta.");
    chatAdd("IA", a);
  });
  $("btnChatClear").addEventListener("click", ()=>{
    if(confirm("Svuotare la chat?")){
      $("chatBox").innerHTML = "";
    }
  });

  // Phone
  $("phoneInput").addEventListener("input", ()=>{
    phoneValue = String($("phoneInput").value || "").trim();
    try{ localStorage.setItem(PHONE_KEY, phoneValue); }catch(e){}
    renderPhoneOverlay();
  });

  function renderPhoneOverlay(){
    if(phoneValue){
      $("phoneOverlay").innerHTML = `CHIAMA AL <b>${escapeHtml(phoneValue)}</b>`;
    }else{
      $("phoneOverlay").innerHTML = `CHIAMA AL <b>‚Äî</b>`;
    }
  }

  // Logo upload
  $("btnLogo").addEventListener("click", ()=> $("logoUpload").click());
  $("logoUpload").addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const fr = new FileReader();
    fr.onload = ()=> setLogoDataUrl(fr.result);
    fr.readAsDataURL(file);
    e.target.value = "";
  });

  // Where videos
  $("btnWhere").addEventListener("click", ()=>{
    alert("In browser i video vengono scaricati: li trovi nella cartella Download del dispositivo.");
  });

  // Camera + rec
  $("btnCam").addEventListener("click", async ()=>{ await ensureReady(); });
  $("btnFlip").addEventListener("click", async ()=>{ await flipCamera(); });
  $("btnFlash").addEventListener("click", async ()=>{ await toggleTorch(); });

  $("btnREC").addEventListener("click", async ()=>{
    const okCam = await ensureReady();
    if(!okCam) return;

    if(recorder && recorder.state !== "inactive"){
      stopRecording();
      return;
    }

    // If question not set, keep ATTUALIT√Ä
    if(!currentQuestion && !currentQuestionObj){
      showQuestionInOverlay("ATTUALIT√Ä");
      $("categoryOverlay").textContent = "ATTUALIT√Ä";
    }

    startRecording60();
  });

  $("btnStop").addEventListener("click", ()=> stopRecording());

  // Zoom
  $("zoom").addEventListener("input", (e)=> applyZoom(e.target.value));
  applyZoom(1.0);

  // Download selected
  $("btnDownloadVideo").addEventListener("click", ()=>{
    if(currentRecIndex < 0 || !recordings[currentRecIndex]){
      alert("Seleziona un video dalla lista.");
      return;
    }
    const r = recordings[currentRecIndex];
    downloadBlob(r.blob, r.name);
  });

  // Clear list (session)
  $("btnClearList").addEventListener("click", ()=>{
    if(!recordings.length) return;
    if(confirm("Svuotare la lista (sessione)?")){
      recordings.forEach(r => { try{ URL.revokeObjectURL(r.url); }catch(e){} });
      recordings = [];
      currentRecIndex = -1;
      $("playback").removeAttribute("src");
      $("playback").load();
      renderRecList();
      totalVideos = 0;
      updateCounters();
      platformIndex = 0;
      refreshPlatformUI();
    }
  });

  // Remember caption toggle
  $("chkRememberCaption").addEventListener("change", ()=>{
    if(!$("chkRememberCaption").checked){
      try{ localStorage.removeItem(CAP_KEY); }catch(e){}
    }else{
      try{ localStorage.setItem(CAP_KEY, lastCaptionClean || ""); }catch(e){}
    }
  });

  // Defaults
  $("teleText").textContent = "Incolla una risposta ‚Üí ‚ÄúUsa risposta‚Äù ‚Üí ‚ÄúREC‚Äù.";
  showQuestionInOverlay("Premi ‚ÄúNuova domanda‚Äù.");
  $("categoryOverlay").textContent = "ATTUALIT√Ä";
  refreshPlatformUI();
  renderRecList();
  updateCounters();

  // If phone restored, paint overlay
  renderPhoneOverlay();
});

/* ==========================
   Small utils
========================== */
function escapeHtml(s){
  return String(s || "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
</script>
</body>
</html>
