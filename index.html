<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Video Creator PRO â€“ REC</title>

<style>
/* =======================
   THEME
======================= */
:root{
  --bg:#0b1120;
  --text:#f3f4f6;
  --muted:#9aa4af;
  --gold:#d8a23a;
  --red:#ff2d2d;
  --border:rgba(255,255,255,.14);
  --radius:18px;
  --shadow:0 14px 50px rgba(0,0,0,.45);
  --zoom:1;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:var(--bg);
}
.wrap{max-width:1100px;margin:auto;padding:12px 12px 90px}

/* =======================
   BUTTONS
======================= */
.btn{
  border:1px solid var(--border);
  background:rgba(255,255,255,.05);
  color:var(--text);
  padding:8px 12px;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}
.btn.gray{background:rgba(255,255,255,.06)}
.btn.primary{background:linear-gradient(135deg,#d8a23a,#b9892f);color:#111}
.btn.circle{
  width:72px;height:72px;border-radius:50%;
  background:radial-gradient(circle at 30% 30%,#ff6a6a,#ff2d2d);
  border:none;color:#120707;
  font-size:13px;font-weight:1000;
  box-shadow:0 0 0 0 rgba(255,45,45,.6);
}
.btn.circle.rec-active{
  animation:pulse 1.2s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,45,45,.6)}
  70%{box-shadow:0 0 0 18px rgba(255,45,45,0)}
  100%{box-shadow:0 0 0 0 rgba(255,45,45,0)}
}

/* =======================
   STAGE
======================= */
.stage{
  width:min(420px,95vw);
  aspect-ratio:9/16;
  background:#000;
  border-radius:18px;
  overflow:hidden;
  position:relative;
  box-shadow:var(--shadow);
  margin:auto;
}
video{
  position:absolute;inset:0;
  width:100%;height:100%;
  object-fit:cover;
  transform:scale(var(--zoom));
}
.overlay{
  position:absolute;inset:0;
  padding:10px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  pointer-events:none;
}

/* =======================
   OVERLAY ELEMENTS
======================= */
#logoOverlay{
  margin:auto;
  opacity:.85;
  max-width:70%;
}
#categoryOverlay{
  text-align:center;
  font-weight:900;
  font-size:12px;
}
#phoneOverlay{
  background:rgba(0,0,0,.5);
  border-radius:12px;
  padding:6px 10px;
  font-weight:1000;
  text-align:center;
}
#countdown{
  position:absolute;
  top:12px;right:12px;
  background:rgba(0,0,0,.5);
  padding:6px 10px;
  border-radius:12px;
  font-weight:1000;
}
#cameraIcon{
  position:absolute;
  top:12px;left:12px;
  font-size:18px;
  display:none;
}

/* =======================
   TELEPROMPTER KARAOKE
======================= */
#teleprompter{
  flex:1;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  overflow:hidden;
}
#teleText span{
  display:inline-block;
  padding:2px 4px;
}
#teleText span.active{
  background:rgba(216,162,58,.35);
  border-radius:6px;
}

/* =======================
   CONTROLS
======================= */
.controls{
  margin-top:14px;
  display:flex;
  gap:12px;
  justify-content:center;
  align-items:center;
}
input[type="file"],input[type="text"]{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.2);
  color:var(--text);
}
.card{
  background:rgba(255,255,255,.04);
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  margin-top:12px;
}
</style>
</head>

<body>
<div class="wrap">

<!-- INPUTS -->
<div class="card">
  <input id="phoneInput" placeholder="Numero di telefono (es. 3331234567)">
  <input id="logoInput" type="file" accept="image/*">
  <textarea id="answer" placeholder="Testo risposta / teleprompter"></textarea>
</div>

<!-- STAGE -->
<div class="stage">
  <video id="cam" autoplay muted playsinline></video>
  <div class="overlay">
    <img id="logoOverlay">
    <div id="categoryOverlay"></div>
    <div id="teleprompter"><div id="teleText"></div></div>
    <div id="phoneOverlay"></div>
  </div>
  <div id="countdown">60</div>
  <div id="cameraIcon">ðŸŽ¥</div>
</div>

<!-- CONTROLS -->
<div class="controls">
  <button class="btn gray" id="flipCam">ðŸ”„</button>
  <button class="btn gray" id="flashBtn">ðŸ’¡</button>
  <button class="btn circle" id="recBtn">REC</button>
</div>

</div>

<script>
/* =======================
   STATE & DB
======================= */
let facing="user";
let stream=null;
let recorder=null;
let chunks=[];
let countdown=60;
let timer=null;
let teleIndex=0;
let words=[];
const DB_KEY="videoDB";

/* =======================
   INIT CAMERA
======================= */
async function startCam(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:facing},
    audio:true
  });
  cam.srcObject=stream;
}
startCam();

/* =======================
   LOGO & PHONE
======================= */
logoInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{logoOverlay.src=r.result;localStorage.setItem("logo",r.result)}
  r.readAsDataURL(f);
}
const savedLogo=localStorage.getItem("logo");
if(savedLogo) logoOverlay.src=savedLogo;

phoneInput.oninput=e=>{
  phoneOverlay.textContent="CHIAMA AL "+e.target.value;
  localStorage.setItem("phone",e.target.value);
}
const savedPhone=localStorage.getItem("phone");
if(savedPhone){
  phoneInput.value=savedPhone;
  phoneOverlay.textContent="CHIAMA AL "+savedPhone;
}

/* =======================
   TELEPROMPTER KARAOKE
======================= */
function prepareTele(text){
  teleText.innerHTML="";
  words=text.split(" ");
  words.forEach(w=>{
    const s=document.createElement("span");
    s.textContent=w+" ";
    teleText.appendChild(s);
  });
}
function stepTele(){
  if(teleIndex>0) teleText.children[teleIndex-1].classList.remove("active");
  if(teleIndex<teleText.children.length){
    teleText.children[teleIndex].classList.add("active");
    teleIndex++;
  }
}

/* =======================
   REC LOGIC
======================= */
recBtn.onclick=async()=>{
  if(recorder && recorder.state==="recording"){
    recorder.stop();return;
  }
  prepareTele(answer.value);
  teleIndex=0;
  cameraIcon.style.display="block";
  recBtn.classList.add("rec-active");
  countdown=60;
  countDownTick();
  const canvas=document.createElement("canvas");
  canvas.width=1080;canvas.height=1920;
  const ctx=canvas.getContext("2d");
  const draw=()=>{
    ctx.drawImage(cam,0,0,1080,1920);
    requestAnimationFrame(draw);
  }
  draw();
  const streamOut=canvas.captureStream(30);
  stream.getAudioTracks().forEach(t=>streamOut.addTrack(t));
  recorder=new MediaRecorder(streamOut);
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=saveVideo;
  recorder.start();
}

function countDownTick(){
  countdownEl.textContent=countdown;
  timer=setInterval(()=>{
    countdown--;
    stepTele();
    countdownEl.textContent=countdown;
    if(countdown<=0){
      clearInterval(timer);
      recorder.stop();
    }
  },1000);
}

/* =======================
   SAVE VIDEO + DB
======================= */
function saveVideo(){
  cameraIcon.style.display="none";
  recBtn.classList.remove("rec-active");
  const blob=new Blob(chunks,{type:"video/webm"});
  chunks=[];
  const id="VID-"+Date.now();
  const db=JSON.parse(localStorage.getItem(DB_KEY)||"[]");
  db.push({
    id,
    date:new Date().toISOString(),
    phone:phoneInput.value,
    caption:answer.value
  });
  localStorage.setItem(DB_KEY,JSON.stringify(db));
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=id+".webm";
  a.click();
}

/* =======================
   FLIP / FLASH
======================= */
flipCam.onclick=()=>{
  facing=facing==="user"?"environment":"user";
  startCam();
}
flashBtn.onclick=()=>{
  const track=stream.getVideoTracks()[0];
  const cap=track.getCapabilities();
  if(cap.torch){
    track.applyConstraints({advanced:[{torch:!track.torchOn}]});
    track.torchOn=!track.torchOn;
  }
}
</script>
</body>
</html>
