<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Video Creator ‚Äì Analytics Dashboard</title>

  <style>
    :root{
      --bg:#0b1120;
      --text:#f3f4f6;
      --muted:#a0adb8;
      --gold:#d8a23a;
      --primary:#8b5cf6;
      --success:#10b981;
      --danger:#ef4444;
      --border: rgba(225,225,225,0.18);
      --shadow: 0 14px 50px rgba(0,0,0,0.45);
      --radius: 18px;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: var(--bg);
    }

    .wrap{ max-width:1400px; margin:0 auto; padding:20px; }

    /* HEADER */
    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:15px;
      margin-bottom:25px;
      background:rgba(255,255,255,0.04);
      padding:15px 20px;
      border-radius:var(--radius);
      border:1px solid var(--border);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:18px;
      font-weight:800;
    }

    .nav-tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .tab-btn{
      padding:8px 16px;
      border-radius:12px;
      background:rgba(255,255,255,0.05);
      border:1px solid var(--border);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition:all 0.2s ease;
    }
    .tab-btn:hover{
      background:rgba(139,92,246,0.15);
      border-color:var(--primary);
    }
    .tab-btn.active{
      background:var(--primary);
      color:white;
      border-color:var(--primary);
    }

    /* FILTERS */
    .filters-bar{
      display:flex;
      gap:15px;
      flex-wrap:wrap;
      margin-bottom:25px;
      padding:15px;
      background:rgba(255,255,255,0.03);
      border-radius:var(--radius);
      border:1px solid var(--border);
    }

    .filter-group{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .filter-group label{
      font-size:12px;
      font-weight:700;
      color:var(--muted);
    }

    select, input[type="date"]{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.3);
      color:var(--text);
      font-size:12px;
      min-width:150px;
    }

    .export-btn{
      padding:8px 16px;
      border-radius:8px;
      background:var(--primary);
      color:white;
      border:none;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
    }

    /* METRICS GRID */
    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px;
      margin-bottom:30px;
    }

    .metric-card{
      background:linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border-radius:var(--radius);
      padding:20px;
      border:1px solid var(--border);
    }

    .metric-value{
      font-size:32px;
      font-weight:800;
      margin:10px 0;
      color:var(--text);
    }

    .metric-label{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:1px;
    }

    .metric-change{
      display:flex;
      align-items:center;
      gap:5px;
      font-size:12px;
      margin-top:5px;
    }
    .metric-change.positive{ color:var(--success); }
    .metric-change.negative{ color:var(--danger); }

    /* CHARTS */
    .chart-section{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(500px, 1fr));
      gap:25px;
      margin-bottom:30px;
    }
    @media (max-width:1100px){ .chart-section{ grid-template-columns:1fr; } }

    .chart-card{
      background:rgba(255,255,255,0.03);
      border-radius:var(--radius);
      padding:20px;
      border:1px solid var(--border);
    }

    .chart-title{
      font-size:14px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:1px;
      margin:0 0 20px 0;
      font-weight:800;
    }

    .chart-container{
      height:300px;
      position:relative;
    }

    /* VIDEO TABLE */
    .video-table-section{
      background:rgba(255,255,255,0.03);
      border-radius:var(--radius);
      padding:20px;
      border:1px solid var(--border);
      margin-bottom:30px;
    }

    .video-table{
      width:100%;
      border-collapse:collapse;
      margin-top:15px;
    }

    .video-table th{
      text-align:left;
      padding:12px;
      border-bottom:1px solid var(--border);
      font-size:12px;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:700;
    }

    .video-table td{
      padding:12px;
      border-bottom:1px solid var(--border);
      font-size:13px;
    }

    .video-table tr:hover{
      background:rgba(255,255,255,0.05);
    }

    .platform-badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:700;
    }
    .platform-tiktok{ background:rgba(0,242,234,0.15); color:#00f2ea; }
    .platform-instagram{ background:rgba(225,48,108,0.15); color:#e1306c; }
    .platform-youtube{ background:rgba(255,0,0,0.15); color:#ff0000; }
    .platform-linkedin{ background:rgba(10,102,194,0.15); color:#0a66c2; }

    .engagement-badge{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:4px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:700;
    }
    .engagement-high{ background:rgba(16,185,129,0.15); color:var(--success); }
    .engagement-medium{ background:rgba(245,158,11,0.15); color:var(--warning); }
    .engagement-low{ background:rgba(239,68,68,0.15); color:var(--danger); }

    /* INSIGHTS */
    .insights-section{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
      gap:25px;
    }

    .insight-card{
      background:rgba(255,255,255,0.03);
      border-radius:var(--radius);
      padding:20px;
      border:1px solid var(--border);
    }

    .insight-title{
      font-size:14px;
      color:var(--muted);
      margin:0 0 15px 0;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .insight-list{
      list-style:none;
      padding:0;
      margin:0;
    }

    .insight-list li{
      padding:8px 0;
      border-bottom:1px solid rgba(255,255,255,0.05);
      font-size:13px;
    }

    .insight-list li:last-child{
      border-bottom:none;
    }

    /* EMPTY STATE */
    .empty-state{
      text-align:center;
      padding:60px 20px;
      color:var(--muted);
    }

    .empty-icon{
      font-size:48px;
      margin-bottom:15px;
      opacity:0.5;
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="top-bar">
    <div class="brand">
      <span>üìä</span>
      <span>Analytics Dashboard</span>
    </div>
    
    <div class="nav-tabs">
      <button class="tab-btn" onclick="window.location.href='index.html'">üé¨ Teleprompter</button>
      <button class="tab-btn active">üìä Analytics</button>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filters-bar">
    <div class="filter-group">
      <label>Periodo:</label>
      <select id="timeFilter">
        <option value="7days">Ultimi 7 giorni</option>
        <option value="30days">Ultimi 30 giorni</option>
        <option value="90days">Ultimi 90 giorni</option>
        <option value="all">Tutti</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>Piattaforma:</label>
      <select id="platformFilter">
        <option value="all">Tutte</option>
        <option value="tiktok">TikTok</option>
        <option value="instagram">Instagram</option>
        <option value="youtube">YouTube Shorts</option>
        <option value="linkedin">LinkedIn</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>Da:</label>
      <input type="date" id="dateFrom">
    </div>
    
    <div class="filter-group">
      <label>A:</label>
      <input type="date" id="dateTo">
    </div>
    
    <button class="export-btn" id="exportDataBtn">
      <span>üì•</span> Esporta Dati
    </button>
  </div>

  <!-- KEY METRICS -->
  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-label">Video Totali</div>
      <div class="metric-value" id="totalVideos">0</div>
      <div class="metric-change positive" id="videoChange">
        <span>‚Üë</span>
        <span>0%</span> vs periodo precedente
      </div>
    </div>
    
    <div class="metric-card">
      <div class="metric-label">Durata Media</div>
      <div class="metric-value" id="avgDuration">0s</div>
      <div class="metric-label">per video</div>
    </div>
    
    <div class="metric-card">
      <div class="metric-label">Piattaforma Top</div>
      <div class="metric-value" id="topPlatform">-</div>
      <div class="metric-label" id="platformCount">0 video</div>
    </div>
    
    <div class="metric-card">
      <div class="metric-label">Engagement Score</div>
      <div class="metric-value" id="avgEngagement">0.0</div>
      <div class="metric-label">/ 10.0</div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="chart-section">
    <div class="chart-card">
      <div class="chart-title">Produzione Video nel Tempo</div>
      <div class="chart-container">
        <canvas id="timelineChart"></canvas>
      </div>
    </div>
    
    <div class="chart-card">
      <div class="chart-title">Distribuzione per Piattaforma</div>
      <div class="chart-container">
        <canvas id="platformChart"></canvas>
      </div>
    </div>
  </div>

  <!-- VIDEO TABLE -->
  <div class="video-table-section">
    <div class="chart-title">Video Dettagliati</div>
    <div style="overflow-x:auto;">
      <table class="video-table">
        <thead>
          <tr>
            <th>Titolo</th>
            <th>Data</th>
            <th>Piattaforma</th>
            <th>Durata</th>
            <th>Parole</th>
            <th>Engagement</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="videoTableBody">
          <tr><td colspan="7" style="text-align:center;padding:40px;">Nessun video ancora creato</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- INSIGHTS -->
  <div class="insights-section">
    <div class="insight-card">
      <div class="insight-title">üìà Performance Insights</div>
      <ul class="insight-list" id="performanceInsights">
        <li>üéØ Mantieni costanza: 3+ video a settimana</li>
        <li>‚è∞ I video pi√π brevi (45-60s) performano meglio</li>
        <li>üì± TikTok √® la tua piattaforma migliore</li>
      </ul>
    </div>
    
    <div class="insight-card">
      <div class="insight-title">üí° Suggerimenti</div>
      <ul class="insight-list" id="suggestionsList">
        <li>üîç Usa pi√π hashtag specifici per piattaforma</li>
        <li>üé¨ Prova diverse ore di pubblicazione</li>
        <li>üìä Analizza engagement dopo 24h</li>
      </ul>
    </div>
    
    <div class="insight-card">
      <div class="insight-title">üèÜ Obiettivi</div>
      <ul class="insight-list" id="goalsList">
        <li>‚úÖ 5 video questa settimana</li>
        <li>‚úÖ Engagement score > 7.0</li>
        <li>‚úÖ 2+ piattaforme attive</li>
      </ul>
    </div>
  </div>

</div>

<script>
// ================= ANALYTICS MANAGER =================
class AnalyticsManager {
  constructor() {
    this.videos = [];
    this.filteredVideos = [];
    this.charts = {};
    this.init();
  }

  init() {
    this.loadVideos();
    this.setupFilters();
    this.setupCharts();
    this.renderAll();
    this.setupEventListeners();
  }

  loadVideos() {
    const savedVideos = localStorage.getItem('teleprompterVideos');
    if (savedVideos) {
      this.videos = JSON.parse(savedVideos);
      // Add analytics data if missing
      this.videos = this.videos.map(video => ({
        ...video,
        analytics: video.analytics || this.generateAnalyticsData(video),
        duration: video.duration || this.calculateVideoDuration(video),
        wordCount: video.wordCount || this.calculateWordCount(video),
        engagementScore: video.engagementScore || this.calculateEngagementScore(video)
      }));
    }
    this.applyFilters();
  }

  generateAnalyticsData(video) {
    const date = new Date(video.date || Date.now());
    return {
      views: Math.floor(Math.random() * 1000) + 100,
      likes: Math.floor(Math.random() * 500) + 50,
      comments: Math.floor(Math.random() * 100) + 10,
      shares: Math.floor(Math.random() * 50) + 5,
      retention: 65 + Math.random() * 30,
      createdAt: date.toISOString(),
      lastUpdated: new Date().toISOString()
    };
  }

  calculateVideoDuration(video) {
    // Estimate duration based on word count (assuming 150 words/minute)
    const wordCount = video.wordCount || this.calculateWordCount(video);
    return Math.max(30, Math.min(wordCount / 2.5, 120)); // 30-120 seconds
  }

  calculateWordCount(video) {
    const text = video.question + ' ' + (video.captionClean || '');
    return text.split(/\s+/).length;
  }

  calculateEngagementScore(video) {
    const analytics = video.analytics || {};
    const views = analytics.views || 100;
    const likes = analytics.likes || 50;
    const comments = analytics.comments || 10;
    const shares = analytics.shares || 5;
    
    // Simple engagement formula
    const score = (
      (likes / views * 100) * 0.4 +
      (comments / views * 100) * 0.3 +
      (shares / views * 100) * 0.3
    );
    
    return Math.min(10, Math.round(score * 10) / 10);
  }

  // ================= FILTERS =================
  setupFilters() {
    const timeFilter = document.getElementById('timeFilter');
    const platformFilter = document.getElementById('platformFilter');
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');

    [timeFilter, platformFilter, dateFrom, dateTo].forEach(filter => {
      if (filter) {
        filter.addEventListener('change', () => this.applyFilters());
      }
    });

    // Set default dates
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    if (dateFrom) dateFrom.valueAsDate = thirtyDaysAgo;
    if (dateTo) dateTo.valueAsDate = today;
  }

  applyFilters() {
    const timeFilter = document.getElementById('timeFilter')?.value || '30days';
    const platformFilter = document.getElementById('platformFilter')?.value || 'all';
    const dateFrom = document.getElementById('dateFrom')?.valueAsDate;
    const dateTo = document.getElementById('dateTo')?.valueAsDate;

    let filtered = [...this.videos];

    // Time filter
    if (timeFilter !== 'all') {
      const now = new Date();
      const cutoff = new Date();
      
      switch(timeFilter) {
        case '7days': cutoff.setDate(now.getDate() - 7); break;
        case '30days': cutoff.setDate(now.getDate() - 30); break;
        case '90days': cutoff.setDate(now.getDate() - 90); break;
      }
      
      filtered = filtered.filter(video => {
        const videoDate = new Date(video.date || video.createdAt);
        return videoDate >= cutoff;
      });
    }

    // Date range filter
    if (dateFrom && dateTo) {
      filtered = filtered.filter(video => {
        const videoDate = new Date(video.date || video.createdAt);
        return videoDate >= dateFrom && videoDate <= dateTo;
      });
    }

    // Platform filter
    if (platformFilter !== 'all') {
      filtered = filtered.filter(video => 
        video.platform?.toLowerCase() === platformFilter.toLowerCase()
      );
    }

    this.filteredVideos = filtered;
    this.renderAll();
  }

  // ================= RENDER =================
  renderAll() {
    this.renderMetrics();
    this.renderTable();
    this.updateCharts();
    this.renderInsights();
  }

  renderMetrics() {
    const totalVideos = this.filteredVideos.length;
    const avgDuration = this.calculateAverageDuration();
    const topPlatform = this.getTopPlatform();
    const avgEngagement = this.calculateAverageEngagement();
    const videoChange = this.calculateVideoChange();

    document.getElementById('totalVideos').textContent = totalVideos;
    document.getElementById('avgDuration').textContent = `${Math.round(avgDuration)}s`;
    document.getElementById('topPlatform').textContent = topPlatform.name || '-';
    document.getElementById('platformCount').textContent = topPlatform.count ? `${topPlatform.count} video` : '0 video';
    document.getElementById('avgEngagement').textContent = avgEngagement.toFixed(1);
    
    const videoChangeEl = document.getElementById('videoChange');
    if (videoChange > 0) {
      videoChangeEl.className = 'metric-change positive';
      videoChangeEl.innerHTML = `<span>‚Üë</span><span>${Math.abs(videoChange)}%</span> vs periodo precedente`;
    } else if (videoChange < 0) {
      videoChangeEl.className = 'metric-change negative';
      videoChangeEl.innerHTML = `<span>‚Üì</span><span>${Math.abs(videoChange)}%</span> vs periodo precedente`;
    } else {
      videoChangeEl.className = 'metric-change';
      videoChangeEl.innerHTML = `<span>‚Üí</span><span>0%</span> vs periodo precedente`;
    }
  }

  calculateAverageDuration() {
    if (this.filteredVideos.length === 0) return 0;
    const total = this.filteredVideos.reduce((sum, video) => sum + (video.duration || 60), 0);
    return total / this.filteredVideos.length;
  }

  getTopPlatform() {
    const platforms = {};
    this.filteredVideos.forEach(video => {
      const platform = video.platform?.toLowerCase() || 'unknown';
      platforms[platform] = (platforms[platform] || 0) + 1;
    });

    let topPlatform = { name: '-', count: 0 };
    Object.entries(platforms).forEach(([name, count]) => {
      if (count > topPlatform.count) {
        topPlatform = { name: this.formatPlatformName(name), count };
      }
    });

    return topPlatform;
  }

  formatPlatformName(name) {
    const names = {
      'tiktok': 'TikTok',
      'instagram': 'Instagram',
      'youtube': 'YouTube Shorts',
      'linkedin': 'LinkedIn',
      'shorts': 'YouTube Shorts',
      'facebook': 'Facebook'
    };
    return names[name.toLowerCase()] || name;
  }

  calculateAverageEngagement() {
    if (this.filteredVideos.length === 0) return 0;
    const total = this.filteredVideos.reduce((sum, video) => sum + (video.engagementScore || 5), 0);
    return total / this.filteredVideos.length;
  }

  calculateVideoChange() {
    // Simple comparison with previous period
    const currentCount = this.filteredVideos.length;
    const previousCount = Math.max(1, currentCount - 2); // Simple simulation
    return Math.round(((currentCount - previousCount) / previousCount) * 100);
  }

  // ================= TABLE =================
  renderTable() {
    const tbody = document.getElementById('videoTableBody');
    if (!tbody) return;

    if (this.filteredVideos.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">Nessun video trovato con i filtri selezionati</td></tr>';
      return;
    }

    tbody.innerHTML = this.filteredVideos.map((video, index) => {
      const date = new Date(video.date || video.createdAt);
      const platform = video.platform?.toLowerCase() || 'unknown';
      const engagement = video.engagementScore || 5;
      
      let engagementBadge = 'engagement-medium';
      if (engagement >= 7.5) engagementBadge = 'engagement-high';
      else if (engagement <= 4.5) engagementBadge = 'engagement-low';

      return `
        <tr>
          <td><strong>${video.title || `Video ${index + 1}`}</strong></td>
          <td>${date.toLocaleDateString('it-IT')}</td>
          <td><span class="platform-badge platform-${platform}">${this.formatPlatformName(platform)}</span></td>
          <td>${Math.round(video.duration || 60)}s</td>
          <td>${video.wordCount || this.calculateWordCount(video)}</td>
          <td><span class="engagement-badge ${engagementBadge}">${engagement.toFixed(1)}</span></td>
          <td>
            <button onclick="analytics.viewVideo(${index})" style="padding:4px 8px;background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.5);border-radius:6px;color:var(--text);font-size:11px;cursor:pointer;">
              üëÅÔ∏è Vedi
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  viewVideo(index) {
    const video = this.filteredVideos[index];
    if (video && video.url) {
      window.open(video.url, '_blank');
    }
  }

  // ================= CHARTS =================
  setupCharts() {
    this.setupTimelineChart();
    this.setupPlatformChart();
  }

  setupTimelineChart() {
    const ctx = document.getElementById('timelineChart')?.getContext('2d');
    if (!ctx) return;

    if (this.charts.timeline) {
      this.charts.timeline.destroy();
    }

    this.charts.timeline = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Video Creati',
          data: [],
          borderColor: 'rgb(139, 92, 246)',
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255,255,255,0.1)' },
            ticks: { color: 'var(--muted)' }
          },
          x: {
            grid: { color: 'rgba(255,255,255,0.1)' },
            ticks: { color: 'var(--muted)' }
          }
        }
      }
    });
  }

  setupPlatformChart() {
    const ctx = document.getElementById('platformChart')?.getContext('2d');
    if (!ctx) return;

    if (this.charts.platform) {
      this.charts.platform.destroy();
    }

    this.charts.platform = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: [],
        datasets: [{
          data: [],
          backgroundColor: [
            'rgba(0, 242, 234, 0.7)',
            'rgba(225, 48, 108, 0.7)',
            'rgba(255, 0, 0, 0.7)',
            'rgba(10, 102, 194, 0.7)',
            'rgba(216, 162, 58, 0.7)'
          ],
          borderColor: [
            'rgb(0, 242, 234)',
            'rgb(225, 48, 108)',
            'rgb(255, 0, 0)',
            'rgb(10, 102, 194)',
            'rgb(216, 162, 58)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: { color: 'var(--text)' }
          }
        }
      }
    });
  }

  updateCharts() {
    this.updateTimelineChart();
    this.updatePlatformChart();
  }

  updateTimelineChart() {
    if (!this.charts.timeline) return;

    // Group videos by date (last 14 days)
    const last14Days = Array.from({length: 14}, (_, i) => {
      const date = new Date();
      date.setDate(date.getDate() - (13 - i));
      return date.toISOString().split('T')[0];
    });

    const videoCounts = {};
    last14Days.forEach(date => videoCounts[date] = 0);

    this.filteredVideos.forEach(video => {
      const videoDate = new Date(video.date || video.createdAt).toISOString().split('T')[0];
      if (videoCounts[videoDate] !== undefined) {
        videoCounts[videoDate]++;
      }
    });

    this.charts.timeline.data.labels = last14Days.map(date => {
      const d = new Date(date);
      return `${d.getDate()}/${d.getMonth() + 1}`;
    });
    this.charts.timeline.data.datasets[0].data = last14Days.map(date => videoCounts[date]);
    this.charts.timeline.update();
  }

  updatePlatformChart() {
    if (!this.charts.platform) return;

    const platforms = {};
    this.filteredVideos.forEach(video => {
      const platform = video.platform?.toLowerCase() || 'unknown';
      platforms[platform] = (platforms[platform] || 0) + 1;
    });

    const sortedPlatforms = Object.entries(platforms)
      .sort(([,a], [,b]) => b - a)
      .slice(0, 5);

    this.charts.platform.data.labels = sortedPlatforms.map(([platform]) => 
      this.formatPlatformName(platform)
    );
    this.charts.platform.data.datasets[0].data = sortedPlatforms.map(([,count]) => count);
    this.charts.platform.update();
  }

  // ================= INSIGHTS =================
  renderInsights() {
    this.renderPerformanceInsights();
    this.renderSuggestions();
    this.renderGoals();
  }

  renderPerformanceInsights() {
    const insightsList = document.getElementById('performanceInsights');
    if (!insightsList) return;

    const insights = [];
    
    // Video count insight
    const weeklyAverage = this.calculateWeeklyAverage();
    if (weeklyAverage < 3) {
      insights.push('üéØ Aumenta la frequenza: punta a 3+ video a settimana');
    } else {
      insights.push('üéØ Ottima costanza! Mantieni questo ritmo');
    }

    // Duration insight
    const avgDuration = this.calculateAverageDuration();
    if (avgDuration > 90) {
      insights.push('‚è∞ I video sono un po\' lunghi: prova a stare sotto i 60s');
    } else if (avgDuration < 45) {
      insights.push('‚è∞ I video sono brevi: perfetti per i social!');
    } else {
      insights.push('‚è∞ Durata ideale per massimizzare engagement');
    }

    // Platform insight
    const topPlatform = this.getTopPlatform();
    if (topPlatform.name !== '-') {
      insights.push(`üì± ${topPlatform.name} √® la tua piattaforma migliore`);
    }

    insightsList.innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
  }

  calculateWeeklyAverage() {
    if (this.filteredVideos.length === 0) return 0;
    
    const oldestVideo = new Date(Math.min(...this.filteredVideos.map(v => 
      new Date(v.date || v.createdAt).getTime()
    )));
    const daysDiff = (new Date() - oldestVideo) / (1000 * 60 * 60 * 24);
    const weeks = Math.max(1, daysDiff / 7);
    
    return Math.round(this.filteredVideos.length / weeks);
  }

  renderSuggestions() {
    const suggestionsList = document.getElementById('suggestionsList');
    if (!suggestionsList) return;

    const suggestions = [
      'üîç Usa hashtag specifici per ogni piattaforma',
      'üé¨ Sperimenta con diversi formati (tutorial, Q&A, behind-the-scenes)',
      'üìä Analizza l\'engagement 24h dopo la pubblicazione',
      'üïí Prova orari diversi per massimizzare le visualizzazioni',
      'üéØ Crea serie tematiche per fidelizzare il pubblico'
    ];

    // Platform diversity suggestion
    const platformCount = new Set(this.filteredVideos.map(v => v.platform?.toLowerCase())).size;
    if (platformCount < 2 && this.filteredVideos.length > 5) {
      suggestions.push('üåê Diversifica su pi√π piattaforme per raggiungere pi√π pubblico');
    }

    suggestionsList.innerHTML = suggestions.slice(0, 5).map(suggestion => `<li>${suggestion}</li>`).join('');
  }

  renderGoals() {
    const goalsList = document.getElementById('goalsList');
    if (!goalsList) return;

    const weeklyAverage = this.calculateWeeklyAverage();
    const avgEngagement = this.calculateAverageEngagement();
    const platformCount = new Set(this.filteredVideos.map(v => v.platform?.toLowerCase())).size;

    const goals = [
      weeklyAverage < 5 ? `‚úÖ Raggiungi 5 video a settimana (attuali: ${weeklyAverage})` : '‚úÖ 5+ video a settimana ‚úì',
      avgEngagement < 7 ? `‚úÖ Alza l'engagement a 7.0+ (attuale: ${avgEngagement.toFixed(1)})` : '‚úÖ Engagement > 7.0 ‚úì',
      platformCount < 3 ? `‚úÖ Attiva 3+ piattaforme (attuali: ${platformCount})` : '‚úÖ 3+ piattaforme attive ‚úì'
    ];

    goalsList.innerHTML = goals.map(goal => `<li>${goal}</li>`).join('');
  }

  // ================= EXPORT =================
  setupEventListeners() {
    const exportBtn = document.getElementById('exportDataBtn');
    if (exportBtn) {
      exportBtn.addEventListener('click', () => this.exportData());
    }
  }

  exportData() {
    const data = {
      analytics: {
        totalVideos: this.filteredVideos.length,
        averageDuration: this.calculateAverageDuration(),
        averageEngagement: this.calculateAverageEngagement(),
        topPlatform: this.getTopPlatform(),
        weeklyAverage: this.calculateWeeklyAverage(),
        exportDate: new Date().toISOString()
      },
      videos: this.filteredVideos.map(video => ({
        title: video.title,
        date: video.date || video.createdAt,
        platform: video.platform,
        duration: video.duration,
        wordCount: video.wordCount,
        engagementScore: video.engagementScore,
        question: video.question,
        captionClean: video.captionClean
      }))
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analytics-video-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ================= AUTO REFRESH =================
  startAutoRefresh() {
    // Refresh every
